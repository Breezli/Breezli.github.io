<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E9%A1%B9%E7%9B%AE%E4%B8%ADz-index%E7%9A%84%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E9%A1%B9%E7%9B%AE%E4%B8%ADz-index%E7%9A%84%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="项目中z-index的规划设计"><a href="#项目中z-index的规划设计" class="headerlink" title="项目中z-index的规划设计"></a>项目中z-index的规划设计</h2><p><strong>技术规范：夹层模型</strong></p><p><strong>整个结构分为APP层和页面组件层。APP只有一个，但页面有很多。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1~999：都是页面内比较正常的元素</span><br><span class="line"></span><br><span class="line">1000~1999：弹窗的灰色遮罩背景之类的组件，或者是能够遮住全屏的加载动画</span><br><span class="line"></span><br><span class="line">2000~2999：弹窗面板，比如突然弹出来一个界面提示框，登录框、警告框之类的</span><br><span class="line"></span><br><span class="line">3000~3999：页面鼠标交互层：比如在这个界面，会有一个鼠标点击一下就能让屏幕上多出来一个小桃心的上浮动画，这个小桃心就可以用绝对定位一个div来实现。但他的z-index必须很高，比弹窗组件还要高。</span><br></pre></td></tr></table></figure><p><strong>有了界面层，其实还应该有个全局的APP层，APP层是完全高于界面层的一种层。和界面一样，也有遮罩层、弹窗面板层和鼠标交互层。为了方便记忆，直接设定APP层为四位数上万。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">也就是10000~~19999,20000~~29999,30000~39999。</span><br></pre></td></tr></table></figure><p><strong>值得注意的是，该模型中不仅有向上的考虑，还有0以下的考虑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可以设定一个页面背景层，让z-index：-1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">然后再设计一个APP通用背景层，z-index：-2。</span><br></pre></td></tr></table></figure><p><strong>总结</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1000以内都是正常页面，上千级别是页面级别的东西，上万级别是APP级别的东西。</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1xxx+是弹窗背景，2xxx+是弹窗，3xxx+是鼠标交互层。</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8BEChart%E5%90%AB%E5%9B%BE%E8%A1%A8%E6%A8%A1%E6%9D%BF_vue%E9%A1%B9%E7%9B%AE%E5%86%99%E6%B3%95/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8BEChart%E5%90%AB%E5%9B%BE%E8%A1%A8%E6%A8%A1%E6%9D%BF_vue%E9%A1%B9%E7%9B%AE%E5%86%99%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>本文是基于EChart官方文档进行的简化</p><p><a href="https://echarts.apache.org/handbook/zh/get-started/" title="快速上手 - 使用手册 - Apache ECharts">快速上手 - 使用手册 - Apache ECharts</a></p><h2 id="ECharts"><a href="#ECharts" class="headerlink" title="ECharts"></a>ECharts</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install echarts --save</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h3 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h3><h4 id="全局导入"><a href="#全局导入" class="headerlink" title="全局导入"></a>全局导入</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 引入 ECharts 核心模块</span><br><span class="line">import * as echarts from &#x27;echarts/core&#x27;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h4 id="按需导入"><a href="#按需导入" class="headerlink" title="按需导入"></a>按需导入</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于不同图表类型需要导入的东西非常杂乱，以下为导入分类总结</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>渲染器（必）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 引入 Canvas 渲染器</span><br><span class="line">import &#123; CanvasRenderer &#125; from &#x27;echarts/renderers&#x27;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>图表类型</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 引入柱状图图表</span><br><span class="line">import &#123; BarChart &#125; from &#x27;echarts/charts&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入折线图图表</span><br><span class="line">import &#123; LineChart &#125; from &#x27;echarts/charts&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入饼图图表</span><br><span class="line">import &#123; PieChart &#125; from &#x27;echarts/charts&#x27;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 引入标题组件</span><br><span class="line">import &#123; TitleComponent &#125; from &#x27;echarts/components&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入提示框组件</span><br><span class="line">import &#123; TooltipComponent &#125; from &#x27;echarts/components&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入直角坐标系组件（用于柱状图、折线图等）</span><br><span class="line">import &#123; GridComponent &#125; from &#x27;echarts/components&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入数据集组件</span><br><span class="line">import &#123; DatasetComponent &#125; from &#x27;echarts/components&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入内置数据转换器组件</span><br><span class="line">import &#123; TransformComponent &#125; from &#x27;echarts/components&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入图例组件（用于饼图等）</span><br><span class="line">import &#123; LegendComponent &#125; from &#x27;echarts/components&#x27;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>特性</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 引入标签自动布局特性</span><br><span class="line">import &#123; LabelLayout &#125; from &#x27;echarts/features&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入全局过渡动画特性</span><br><span class="line">import &#123; UniversalTransition &#125; from &#x27;echarts/features&#x27;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>注册组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 注册必须的组件和特性</span><br><span class="line">echarts.use([</span><br><span class="line">  TitleComponent,      // 标题组件</span><br><span class="line">  TooltipComponent,    // 提示框组件</span><br><span class="line">  GridComponent,       // 直角坐标系组件</span><br><span class="line">  DatasetComponent,    // 数据集组件</span><br><span class="line">  TransformComponent,  // 内置数据转换器组件</span><br><span class="line">  BarChart,            // 柱状图</span><br><span class="line">  LineChart,           // 折线图</span><br><span class="line">  PieChart,            // 饼图</span><br><span class="line">  LabelLayout,         // 标签自动布局特性</span><br><span class="line">  UniversalTransition, // 全局过渡动画特性</span><br><span class="line">  CanvasRenderer,      // Canvas 渲染器</span><br><span class="line">  LegendComponent,     // 图例组件</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h5 id="完整示例模板"><a href="#完整示例模板" class="headerlink" title="完整示例模板"></a>完整示例模板</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import &#123; onMounted &#125; from &#x27;vue&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入 ECharts 核心模块</span><br><span class="line">import * as echarts from &#x27;echarts/core&#x27;;</span><br><span class="line"></span><br><span class="line">// 引入图表类型</span><br><span class="line">import &#123; BarChart &#125; from &#x27;echarts/charts&#x27;;        // 柱状图</span><br><span class="line">import &#123; LineChart &#125; from &#x27;echarts/charts&#x27;;       // 折线图</span><br><span class="line">import &#123; PieChart &#125; from &#x27;echarts/charts&#x27;;        // 饼图</span><br><span class="line"></span><br><span class="line">// 引入组件</span><br><span class="line">import &#123; TitleComponent &#125; from &#x27;echarts/components&#x27;;      // 标题组件</span><br><span class="line">import &#123; TooltipComponent &#125; from &#x27;echarts/components&#x27;;    // 提示框组件</span><br><span class="line">import &#123; GridComponent &#125; from &#x27;echarts/components&#x27;;       // 直角坐标系组件</span><br><span class="line">import &#123; DatasetComponent &#125; from &#x27;echarts/components&#x27;;    // 数据集组件</span><br><span class="line">import &#123; TransformComponent &#125; from &#x27;echarts/components&#x27;;  // 内置数据转换器组件</span><br><span class="line">import &#123; LegendComponent &#125; from &#x27;echarts/components&#x27;;     // 图例组件</span><br><span class="line"></span><br><span class="line">// 引入特性</span><br><span class="line">import &#123; LabelLayout &#125; from &#x27;echarts/features&#x27;;           // 标签自动布局特性</span><br><span class="line">import &#123; UniversalTransition &#125; from &#x27;echarts/features&#x27;;   // 全局过渡动画特性</span><br><span class="line"></span><br><span class="line">// 引入渲染器</span><br><span class="line">import &#123; CanvasRenderer &#125; from &#x27;echarts/renderers&#x27;;       // Canvas 渲染器</span><br><span class="line"></span><br><span class="line">// 注册必须的组件和特性</span><br><span class="line">echarts.use([</span><br><span class="line">  TitleComponent,      // 标题组件</span><br><span class="line">  TooltipComponent,    // 提示框组件</span><br><span class="line">  GridComponent,       // 直角坐标系组件</span><br><span class="line">  DatasetComponent,    // 数据集组件</span><br><span class="line">  TransformComponent,  // 内置数据转换器组件</span><br><span class="line">  BarChart,            // 柱状图</span><br><span class="line">  LineChart,           // 折线图</span><br><span class="line">  PieChart,            // 饼图</span><br><span class="line">  LabelLayout,         // 标签自动布局特性</span><br><span class="line">  UniversalTransition, // 全局过渡动画特性</span><br><span class="line">  CanvasRenderer,      // Canvas 渲染器</span><br><span class="line">  LegendComponent,     // 图例组件</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>容器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">        &lt;div id=&quot;main&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>样式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#main &#123;</span><br><span class="line">    width: 600px;</span><br><span class="line">    height: 400px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>引入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import &#123; onMounted &#125; from &#x27;vue&#x27;</span><br><span class="line">// 引入 echarts 核心模块，核心模块提供了 echarts 使用必须要的接口。</span><br><span class="line">import * as echarts from &#x27;echarts/core&#x27;</span><br><span class="line">// 引入柱状图图表，图表后缀都为 Chart</span><br><span class="line">import &#123; BarChart &#125; from &#x27;echarts/charts&#x27;</span><br><span class="line">// 引入标题，提示框，直角坐标系，数据集，内置数据转换器组件，组件后缀都为 Component</span><br><span class="line">import &#123;</span><br><span class="line">TitleComponent,</span><br><span class="line">TooltipComponent,</span><br><span class="line">GridComponent,</span><br><span class="line">DatasetComponent,</span><br><span class="line">TransformComponent,</span><br><span class="line">&#125; from &#x27;echarts/components&#x27;</span><br><span class="line">// 标签自动布局、全局过渡动画等特性</span><br><span class="line">import &#123; LabelLayout, UniversalTransition &#125; from &#x27;echarts/features&#x27;</span><br><span class="line">// 引入 Canvas 渲染器，注意引入 CanvasRenderer 或者 SVGRenderer 是必须的一步</span><br><span class="line">import &#123; CanvasRenderer &#125; from &#x27;echarts/renderers&#x27;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>注册组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">echarts.use([</span><br><span class="line">    TitleComponent,</span><br><span class="line">    TooltipComponent,</span><br><span class="line">    GridComponent,</span><br><span class="line">    DatasetComponent,</span><br><span class="line">    TransformComponent,</span><br><span class="line">    BarChart,</span><br><span class="line">    LabelLayout,</span><br><span class="line">    UniversalTransition,</span><br><span class="line">    CanvasRenderer,</span><br><span class="line">])</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h3 id="图表配置"><a href="#图表配置" class="headerlink" title="图表配置"></a>图表配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">    // 基于准备好的dom，初始化echarts实例</span><br><span class="line">    const myChart = echarts.init(document.getElementById(&#x27;main&#x27;))</span><br><span class="line"></span><br><span class="line">    // 颜色数组</span><br><span class="line">    let colors = [</span><br><span class="line">        &#x27;#5470c6&#x27;,</span><br><span class="line">        &#x27;#91cc75&#x27;,</span><br><span class="line">        &#x27;#fac858&#x27;,</span><br><span class="line">        &#x27;#ee6666&#x27;,</span><br><span class="line">        &#x27;#73c0de&#x27;,</span><br><span class="line">        &#x27;#3ba272&#x27;,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    const option = &#123;</span><br><span class="line">        // 标题</span><br><span class="line">        title: &#123;</span><br><span class="line">            text: &#x27;ECharts 入门示例&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">        // 提示框</span><br><span class="line">        tooltip: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">        // x轴</span><br><span class="line">        xAxis: &#123;</span><br><span class="line">            data: [&#x27;衬衫&#x27;, &#x27;羊毛衫&#x27;, &#x27;雪纺衫&#x27;, &#x27;裤子&#x27;, &#x27;高跟鞋&#x27;, &#x27;袜子&#x27;],</span><br><span class="line">        &#125;,</span><br><span class="line">        // y轴</span><br><span class="line">        yAxis: &#123;</span><br><span class="line">            data: [&#x27;0&#x27;, &#x27;50&#x27;, &#x27;100&#x27;, &#x27;150&#x27;, &#x27;200&#x27;, &#x27;250&#x27;],</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        // 数据系列</span><br><span class="line">        series: [</span><br><span class="line">            &#123;</span><br><span class="line">                name: &#x27;销量&#x27;,</span><br><span class="line">                type: &#x27;bar&#x27;,</span><br><span class="line">                data: [5, 20, 36, 10, 10, 20],</span><br><span class="line">                itemStyle: &#123;</span><br><span class="line">                    color: (params) =&gt; colors[params.dataIndex] || &#x27;#fac858&#x27;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //loding预加载</span><br><span class="line">    myChart.showLoading()</span><br><span class="line">    $.get(&#x27;data.json&#x27;).done(function () &#123;</span><br><span class="line">        myChart.hideLoading()</span><br><span class="line">        myChart.setOption(option)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    myChart.setOption(option)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h3 id="拆分组件"><a href="#拆分组件" class="headerlink" title="拆分组件"></a>拆分组件</h3><h4 id="series-图表"><a href="#series-图表" class="headerlink" title="series &#x2F; 图表"></a>series &#x2F; 图表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">series: [</span><br><span class="line">    &#123;</span><br><span class="line">        name: &#x27;销量&#x27;,//单位量</span><br><span class="line">        type: &#x27;bar&#x27;,//图表类型</span><br><span class="line">        data: [5, 20, 36, 10, 10, 20],//图表数据</span><br><span class="line">        itemStyle: &#123;//样式配置</span><br><span class="line">            color: (params) =&gt; option.color[params.dataIndex] || &#x27;#fac858&#x27;, // 使用全局颜色</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h5 id="type-类型"><a href="#type-类型" class="headerlink" title="type &#x2F; 类型"></a>type &#x2F; 类型</h5><h6 id="柱状图（bar）"><a href="#柱状图（bar）" class="headerlink" title="柱状图（bar）"></a>柱状图（<code>bar</code>）</h6><p>需求</p><ul><li><strong>坐标轴</strong>：需要 <code>xAxis</code> 和 <code>yAxis</code> 配置。</li><li><strong>数据格式</strong>：数据通常是简单的数值数组或对象数组。</li><li><strong>其他配置</strong>：可以添加 <code>tooltip</code>、<code>title</code>、<code>legend</code> 等组件来增强图表的可读性和交互性。</li></ul><p>配置示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">const option = &#123;</span><br><span class="line">  title: &#123;</span><br><span class="line">    text: &#x27;ECharts 销量统计&#x27;,</span><br><span class="line">    subtext: &#x27;示例数据&#x27;,</span><br><span class="line">    left: &#x27;center&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  tooltip: &#123;</span><br><span class="line">    trigger: &#x27;axis&#x27;, // 触发类型为坐标轴触发</span><br><span class="line">  &#125;,</span><br><span class="line">  xAxis: &#123;</span><br><span class="line">    type: &#x27;category&#x27;, // 类目轴</span><br><span class="line">    data: [&#x27;衬衫&#x27;, &#x27;羊毛衫&#x27;, &#x27;雪纺衫&#x27;, &#x27;裤子&#x27;, &#x27;高跟鞋&#x27;, &#x27;袜子&#x27;], // x轴数据</span><br><span class="line">    axisLabel: &#123;</span><br><span class="line">      color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">      fontSize: 14,  // 标签字体大小</span><br><span class="line">    &#125;,</span><br><span class="line">    axisLine: &#123;</span><br><span class="line">      lineStyle: &#123;</span><br><span class="line">        color: &#x27;#ccc&#x27;, // 轴线颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    axisTick: &#123;</span><br><span class="line">      show: false, // 是否显示刻度线</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  yAxis: &#123;</span><br><span class="line">    type: &#x27;value&#x27;, // 数值轴</span><br><span class="line">    axisLabel: &#123;</span><br><span class="line">      color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">      formatter: &#x27;&#123;value&#125; 件&#x27;, // 标签格式化</span><br><span class="line">    &#125;,</span><br><span class="line">    axisLine: &#123;</span><br><span class="line">      show: false, // 是否显示轴线</span><br><span class="line">    &#125;,</span><br><span class="line">    splitLine: &#123;</span><br><span class="line">      lineStyle: &#123;</span><br><span class="line">        type: &#x27;dashed&#x27;, // 分割线样式</span><br><span class="line">        color: &#x27;#eee&#x27;,  // 分割线颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  series: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#x27;销量&#x27;,</span><br><span class="line">      type: &#x27;bar&#x27;, // 柱状图</span><br><span class="line">      data: [5, 20, 36, 10, 10, 20], // 数据</span><br><span class="line">      itemStyle: &#123;</span><br><span class="line">        color: (params) =&gt; [&#x27;#5470c6&#x27;, &#x27;#91cc75&#x27;, &#x27;#fac858&#x27;, &#x27;#ee6666&#x27;, &#x27;#73c0de&#x27;, &#x27;#3ba272&#x27;][params.dataIndex] || &#x27;#fac858&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h6 id="折线图（line）"><a href="#折线图（line）" class="headerlink" title="折线图（line）"></a>折线图（<code>line</code>）</h6><p>需求</p><ul><li><strong>坐标轴</strong>：需要 <code>xAxis</code> 和 <code>yAxis</code> 配置。</li><li><strong>数据格式</strong>：数据通常是简单的数值数组或对象数组。</li><li><strong>其他配置</strong>：可以添加 <code>tooltip</code>、<code>title</code>、<code>legend</code> 等组件来增强图表的可读性和交互性。</li></ul><p>配置示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">const option = &#123;</span><br><span class="line">  title: &#123;</span><br><span class="line">    text: &#x27;ECharts 销量趋势&#x27;,</span><br><span class="line">    subtext: &#x27;示例数据&#x27;,</span><br><span class="line">    left: &#x27;center&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  tooltip: &#123;</span><br><span class="line">    trigger: &#x27;axis&#x27;, // 触发类型为坐标轴触发</span><br><span class="line">  &#125;,</span><br><span class="line">  xAxis: &#123;</span><br><span class="line">    type: &#x27;category&#x27;, // 类目轴</span><br><span class="line">    data: [&#x27;衬衫&#x27;, &#x27;羊毛衫&#x27;, &#x27;雪纺衫&#x27;, &#x27;裤子&#x27;, &#x27;高跟鞋&#x27;, &#x27;袜子&#x27;], // x轴数据</span><br><span class="line">    axisLabel: &#123;</span><br><span class="line">      color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">      fontSize: 14,  // 标签字体大小</span><br><span class="line">    &#125;,</span><br><span class="line">    axisLine: &#123;</span><br><span class="line">      lineStyle: &#123;</span><br><span class="line">        color: &#x27;#ccc&#x27;, // 轴线颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    axisTick: &#123;</span><br><span class="line">      show: false, // 是否显示刻度线</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  yAxis: &#123;</span><br><span class="line">    type: &#x27;value&#x27;, // 数值轴</span><br><span class="line">    axisLabel: &#123;</span><br><span class="line">      color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">      formatter: &#x27;&#123;value&#125; 件&#x27;, // 标签格式化</span><br><span class="line">    &#125;,</span><br><span class="line">    axisLine: &#123;</span><br><span class="line">      show: false, // 是否显示轴线</span><br><span class="line">    &#125;,</span><br><span class="line">    splitLine: &#123;</span><br><span class="line">      lineStyle: &#123;</span><br><span class="line">        type: &#x27;dashed&#x27;, // 分割线样式</span><br><span class="line">        color: &#x27;#eee&#x27;,  // 分割线颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  series: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#x27;销量&#x27;,</span><br><span class="line">      type: &#x27;line&#x27;, // 折线图</span><br><span class="line">      data: [5, 20, 36, 10, 10, 20], // 数据</span><br><span class="line">      smooth: true, // 平滑曲线</span><br><span class="line">      itemStyle: &#123;</span><br><span class="line">        color: &#x27;#5470c6&#x27;, // 线条颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h6 id="饼图（pie）"><a href="#饼图（pie）" class="headerlink" title="饼图（pie）"></a>饼图（<code>pie</code>）</h6><p>需求</p><ul><li><strong>坐标轴</strong>：不需要 <code>xAxis</code> 和 <code>yAxis</code>，因为饼图是基于圆形的。</li><li><strong>数据格式</strong>：数据通常是包含 <code>value</code> 和 <code>name</code> 的对象数组。</li><li><strong>其他配置</strong>：可以添加 <code>tooltip</code>、<code>title</code>、<code>legend</code> 等组件来增强图表的可读性和交互性。</li></ul><p>配置示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">const option = &#123;</span><br><span class="line">  title: &#123;</span><br><span class="line">    text: &#x27;ECharts 销量分布&#x27;,</span><br><span class="line">    subtext: &#x27;示例数据&#x27;,</span><br><span class="line">    left: &#x27;center&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  tooltip: &#123;</span><br><span class="line">    trigger: &#x27;item&#x27;, // 触发类型为单个数据点触发</span><br><span class="line">  &#125;,</span><br><span class="line">  legend: &#123;</span><br><span class="line">    orient: &#x27;vertical&#x27;, // 图例方向</span><br><span class="line">    left: &#x27;left&#x27;,       // 图例位置</span><br><span class="line">  &#125;,</span><br><span class="line">  series: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#x27;销量&#x27;,</span><br><span class="line">      type: &#x27;pie&#x27;, // 饼图</span><br><span class="line">      radius: &#x27;50%&#x27;, // 饼图的半径</span><br><span class="line">      data: [</span><br><span class="line">        &#123; value: 5, name: &#x27;衬衫&#x27; &#125;,</span><br><span class="line">        &#123; value: 20, name: &#x27;羊毛衫&#x27; &#125;,</span><br><span class="line">        &#123; value: 36, name: &#x27;雪纺衫&#x27; &#125;,</span><br><span class="line">        &#123; value: 10, name: &#x27;裤子&#x27; &#125;,</span><br><span class="line">        &#123; value: 10, name: &#x27;高跟鞋&#x27; &#125;,</span><br><span class="line">        &#123; value: 20, name: &#x27;袜子&#x27; &#125;,</span><br><span class="line">      ], // 数据</span><br><span class="line">      itemStyle: &#123;</span><br><span class="line">        color: (params) =&gt; [&#x27;#5470c6&#x27;, &#x27;#91cc75&#x27;, &#x27;#fac858&#x27;, &#x27;#ee6666&#x27;, &#x27;#73c0de&#x27;, &#x27;#3ba272&#x27;][params.dataIndex] || &#x27;#fac858&#x27;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h6 id="散点图（scatter）"><a href="#散点图（scatter）" class="headerlink" title="散点图（scatter）"></a>散点图（<code>scatter</code>）</h6><p>需求</p><ul><li><strong>坐标轴</strong>：需要 <code>xAxis</code> 和 <code>yAxis</code> 配置。</li><li><strong>数据格式</strong>：数据通常是二维数组，每个数据点包含两个值 <code>[x, y]</code>。</li><li><strong>其他配置</strong>：可以添加 <code>tooltip</code>、<code>title</code>、<code>legend</code> 等组件来增强图表的可读性和交互性。</li></ul><p>配置示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">const option = &#123;</span><br><span class="line">  title: &#123;</span><br><span class="line">    text: &#x27;ECharts 散点图示例&#x27;,</span><br><span class="line">    subtext: &#x27;随机生成的数据&#x27;,</span><br><span class="line">    left: &#x27;center&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  tooltip: &#123;</span><br><span class="line">    trigger: &#x27;item&#x27;, // 触发类型为单个数据点触发</span><br><span class="line">  &#125;,</span><br><span class="line">  xAxis: &#123;</span><br><span class="line">    type: &#x27;value&#x27;, // 数值轴</span><br><span class="line">    name: &#x27;X轴&#x27;,</span><br><span class="line">    axisLabel: &#123;</span><br><span class="line">      color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">      fontSize: 14,  // 标签字体大小</span><br><span class="line">    &#125;,</span><br><span class="line">    axisLine: &#123;</span><br><span class="line">      lineStyle: &#123;</span><br><span class="line">        color: &#x27;#ccc&#x27;, // 轴线颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  yAxis: &#123;</span><br><span class="line">    type: &#x27;value&#x27;, // 数值轴</span><br><span class="line">    name: &#x27;Y轴&#x27;,</span><br><span class="line">    axisLabel: &#123;</span><br><span class="line">      color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">      fontSize: 14,  // 标签字体大小</span><br><span class="line">    &#125;,</span><br><span class="line">    axisLine: &#123;</span><br><span class="line">      lineStyle: &#123;</span><br><span class="line">        color: &#x27;#ccc&#x27;, // 轴线颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  series: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#x27;散点&#x27;,</span><br><span class="line">      type: &#x27;scatter&#x27;, // 散点图</span><br><span class="line">      data: [</span><br><span class="line">        [10, 20],</span><br><span class="line">        [20, 30],</span><br><span class="line">        [30, 40],</span><br><span class="line">        [40, 50],</span><br><span class="line">        [50, 60],</span><br><span class="line">        [60, 70],</span><br><span class="line">      ], // 数据</span><br><span class="line">      symbolSize: 20, // 散点大小</span><br><span class="line">      itemStyle: &#123;</span><br><span class="line">        color: &#x27;#5470c6&#x27;, // 散点颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h5 id="itemStyle-样式"><a href="#itemStyle-样式" class="headerlink" title="itemStyle &#x2F; 样式"></a>itemStyle &#x2F; 样式</h5><p>！注意：颜色的配置只能在</p><p><strong>1.series外（全局）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const option = &#123;</span><br><span class="line">  // ... 其他配置</span><br><span class="line">  color: [&#x27;#5470c6&#x27;, &#x27;#91cc75&#x27;, &#x27;#fac858&#x27;, &#x27;#ee6666&#x27;, &#x27;#73c0de&#x27;, &#x27;#3ba272&#x27;], // 全局颜色</span><br><span class="line">  series: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#x27;销量&#x27;,</span><br><span class="line">      type: &#x27;bar&#x27;,</span><br><span class="line">      data: [5, 20, 36, 10, 10, 20],</span><br><span class="line">      itemStyle: &#123;</span><br><span class="line">        color: (params) =&gt; option.color[params.dataIndex] || &#x27;#fac858&#x27;, // 使用全局颜色</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  // ... 其他配置</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p><strong>2.<code>itemStyle</code> 内部（局部）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">series: [</span><br><span class="line">  &#123;</span><br><span class="line">    name: &#x27;销量&#x27;,</span><br><span class="line">    type: &#x27;bar&#x27;,</span><br><span class="line">    data: [5, 20, 36, 10, 10, 20],</span><br><span class="line">    itemStyle: &#123;</span><br><span class="line">      color: (params) =&gt; &#123;</span><br><span class="line">        const colors = [&#x27;#5470c6&#x27;, &#x27;#91cc75&#x27;, &#x27;#fac858&#x27;, &#x27;#ee6666&#x27;, &#x27;#73c0de&#x27;, &#x27;#3ba272&#x27;];</span><br><span class="line">        return colors[params.dataIndex] || &#x27;#fac858&#x27;; // 直接使用本地定义的 colors 数组</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p><em><strong>不能在series中配置颜色数组</strong></em></p><p>渐变色（内部配置）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">itemStyle: &#123;</span><br><span class="line">    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [</span><br><span class="line">        &#123; offset: 0, color: &#x27;#5470c6&#x27; &#125;,</span><br><span class="line">        &#123; offset: 0.2, color: &#x27;#91cc75&#x27; &#125;,</span><br><span class="line">        &#123; offset: 0.5, color: &#x27;#91cc75&#x27; &#125;,</span><br><span class="line">        &#123; offset: 0.7, color: &#x27;#fac858&#x27; &#125;,</span><br><span class="line">        &#123; offset: 1, color: &#x27;#91cc75&#x27; &#125;,</span><br><span class="line">    ]),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h4 id="title-标题"><a href="#title-标题" class="headerlink" title="title | 标题"></a>title | 标题</h4><p>自定义标题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">title: &#123;</span><br><span class="line">    text: &#x27;ECharts 销量统计&#x27;,</span><br><span class="line">    subtext: &#x27;示例数据&#x27;,</span><br><span class="line">    left: &#x27;center&#x27;,</span><br><span class="line">    textStyle: &#123;</span><br><span class="line">       fontSize: 20,</span><br><span class="line">       color: &#x27;#333&#x27;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h4 id="color-颜色"><a href="#color-颜色" class="headerlink" title="color | 颜色"></a>color | 颜色</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">color: [&#x27;#5470c6&#x27;, &#x27;#91cc75&#x27;, &#x27;#fac858&#x27;, &#x27;#ee6666&#x27;, &#x27;#73c0de&#x27;, &#x27;#3ba272&#x27;], // 全局颜色</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h4 id="tooltip-提示框"><a href="#tooltip-提示框" class="headerlink" title="tooltip | 提示框"></a>tooltip | 提示框</h4><p>自定义提示框</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tooltip: &#123;</span><br><span class="line">  trigger: &#x27;axis&#x27;, // 触发类型，可以是 &#x27;item&#x27; 或 &#x27;axis&#x27;</span><br><span class="line">  axisPointer: &#123;</span><br><span class="line">    type: &#x27;shadow&#x27;, // 默认为 &#x27;line&#x27;，也可以是 &#x27;shadow&#x27; 或 &#x27;cross&#x27;</span><br><span class="line">  &#125;,</span><br><span class="line">  formatter: function (params) &#123;</span><br><span class="line">    return `$&#123;params[0].name&#125;: $&#123;params[0].value&#125;`;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h4 id="x-yAxis-坐标轴"><a href="#x-yAxis-坐标轴" class="headerlink" title="x&#x2F;yAxis | 坐标轴"></a>x&#x2F;yAxis | 坐标轴</h4><p>适用于</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">柱状图 bar</span><br><span class="line">折线图 line</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>坐标轴样式</p><p>自定义x轴</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">xAxis: &#123;</span><br><span class="line">  type: &#x27;category&#x27;,</span><br><span class="line">  data: [&#x27;衬衫&#x27;, &#x27;羊毛衫&#x27;, &#x27;雪纺衫&#x27;, &#x27;裤子&#x27;, &#x27;高跟鞋&#x27;, &#x27;袜子&#x27;],</span><br><span class="line">  axisLabel: &#123;</span><br><span class="line">    color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">    fontSize: 14,  // 标签字体大小</span><br><span class="line">  &#125;,</span><br><span class="line">  axisLine: &#123;</span><br><span class="line">    lineStyle: &#123;</span><br><span class="line">      color: &#x27;#ccc&#x27;, // 轴线颜色</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  axisTick: &#123;</span><br><span class="line">    show: false, // 是否显示刻度线</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><p>自定义y轴</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yAxis: &#123;</span><br><span class="line">  type: &#x27;value&#x27;,</span><br><span class="line">  axisLabel: &#123;</span><br><span class="line">    color: &#x27;#333&#x27;, // 标签颜色</span><br><span class="line">    formatter: &#x27;&#123;value&#125; 件&#x27;, // 标签格式化</span><br><span class="line">  &#125;,</span><br><span class="line">  axisLine: &#123;</span><br><span class="line">    show: false, // 是否显示轴线</span><br><span class="line">  &#125;,</span><br><span class="line">  splitLine: &#123;</span><br><span class="line">    lineStyle: &#123;</span><br><span class="line">      type: &#x27;dashed&#x27;, // 分割线样式</span><br><span class="line">      color: &#x27;#eee&#x27;,  // 分割线颜色</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h4 id="animation-动画"><a href="#animation-动画" class="headerlink" title="animation | 动画"></a>animation | 动画</h4><p>动画样式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">animation: true, // 是否开启动画</span><br><span class="line">animationDuration: 1000, // 动画持续时间</span><br><span class="line">animationEasing: &#x27;elasticOut&#x27;, // 动画缓动效果</span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><h4 id="loding-预加载"><a href="#loding-预加载" class="headerlink" title="loding | 预加载"></a>loding | 预加载</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm i --save-dev @types/jquery </span><br></pre></td></tr></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" title="点击并拖拽以移动"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myChart.showLoading()</span><br><span class="line">$.get(&#x27;data.json&#x27;).done(function (data) &#123;</span><br><span class="line">    myChart.hideLoading()</span><br><span class="line">    myChart.setOption(option)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E9%94%AE%E7%9B%98%E4%B9%B1%E9%94%AE%E9%97%AE%E9%A2%98/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E9%94%AE%E7%9B%98%E4%B9%B1%E9%94%AE%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="键盘乱键问题"><a href="#键盘乱键问题" class="headerlink" title="键盘乱键问题"></a>键盘乱键问题</h1><p><strong>真的很崩溃，机械键盘的乱键问题居然还能连带到本机的键盘上😅</strong></p><p><strong>最后发现步骤其实很简单，然后我乱修了两个小时🙃</strong></p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p><strong>机械+本机键盘出厂设置</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fn + esc 长按五秒以上</span><br></pre></td></tr></table></figure><p><strong>重启电脑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">还有我电脑开机是有一个键盘驱动选项的，直接给拒了</span><br></pre></td></tr></table></figure><p><strong>重新配置机械键盘（蓝牙啊啥的）</strong></p>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87--BFC%E4%B8%8EIFC/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87--BFC%E4%B8%8EIFC/</url>
      
        <content type="html"><![CDATA[<h3 id="盒子"><a href="#盒子" class="headerlink" title="盒子"></a>盒子</h3><h5 id="格式化上下文"><a href="#格式化上下文" class="headerlink" title="格式化上下文"></a>格式化上下文</h5><p><strong>外部显示类型（display-outside）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">规定盒子如何与统一格式上下文中的其他元素一起显示</span><br></pre></td></tr></table></figure><p><strong>内部显示类型（ display-inside  ）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">规定盒子内部布局方式，比如</span><br><span class="line">display:    flex    (外部显示为block ) 参与BFC（块级格式化上下文）</span><br><span class="line">display:inline-flex (外部显示为inline) 参与IFC（内联级格式化上下文）</span><br></pre></td></tr></table></figure><h5 id="BFC"><a href="#BFC" class="headerlink" title="BFC"></a>BFC</h5><p><strong>块级格式化上下文</strong></p><p><em><strong>FC</strong></em>（Formatting Context）（<em><strong>格式化上下文</strong></em>）</p><p><strong>所有的盒子都属于FC</strong></p><p><strong>可能属于一个BFC（block）(div&#x2F;p&#x2F;h1)、也可能是IFC（inline）(a&#x2F;span&#x2F;i&#x2F;img)</strong></p><h6 id="会生成BFC的情况"><a href="#会生成BFC的情况" class="headerlink" title="会生成BFC的情况"></a><strong>会生成BFC的情况</strong></h6><p><img src="/upload/image-20241104160610394.png" alt="image-20241104160610394.png"></p><h6 id="BFC的作用"><a href="#BFC的作用" class="headerlink" title="BFC的作用"></a><strong>BFC的作用</strong></h6><p><strong>帮助盒子一个挨着一个沿着垂直方向排布</strong></p><p><strong>margin就是由BFC来解析的</strong></p><p><strong>两个盒子都设置margin时候会折叠，就是BFC在起作用</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在同一个BFC里，两个盒子的margin才会折叠</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTML可以形成标准流，因为本身就是一个独立的BFC环境</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在BFC中，每个元素的左边缘是紧挨着包含块的左边缘的</span><br></pre></td></tr></table></figure><p><strong>BFC可以解决</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">margin的折叠问题</span><br><span class="line">浮动的高度塌陷问题</span><br></pre></td></tr></table></figure><h6 id="形成新的BFC"><a href="#形成新的BFC" class="headerlink" title="形成新的BFC"></a>形成新的BFC</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//只要overflow: !!不是!! visible</span><br><span class="line">可以是 auto/hidden/scroll</span><br></pre></td></tr></table></figure><p><strong>解决折叠问题</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//父级包裹两个元素</span><br><span class="line">div content</span><br><span class="line">    div item</span><br><span class="line">    div item</span><br><span class="line">div</span><br><span class="line">//css创建BFC</span><br><span class="line">.content&#123;</span><br><span class="line">    overflow: auto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>解决浮动高度塌陷</strong></p><p><strong>条件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//父元素触发BFC，形成独立块级格式化上下文</span><br><span class="line">//父元素高度为auto</span><br></pre></td></tr></table></figure><p><em>BFC的计算方式</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.如果只有inline-level，是行高的顶部和底部的距离</span><br><span class="line">2.如果有block-level，是由最底层的块上边缘和最底层块盒子的下边缘之间的距离</span><br><span class="line">3.如果有绝对定位元素，将被忽略;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4.如果有浮动元素，那么会增加高度以包括这些浮动元素的下边缘</span><br></pre></td></tr></table></figure><h6 id="overflow"><a href="#overflow" class="headerlink" title="overflow"></a>overflow</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">overflow: visible;  //可见</span><br><span class="line">overflow: hidden;   //隐藏(可滚动的容器)</span><br><span class="line">overflow: clip;     //剪辑(禁止滚动)</span><br><span class="line">overflow: scroll;   //滚动(浏览器总是显示滚动条)</span><br><span class="line">overflow: auto;     //自动(如果内容溢出，则浏览器提供滚动条)</span><br><span class="line">overflow: hidden;   //覆盖(滚动条绘制在内容之上，而不是占据空间)</span><br></pre></td></tr></table></figure><h5 id="IFC"><a href="#IFC" class="headerlink" title="IFC"></a>IFC</h5><p><strong>内联级格式化上下文</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">盒子会从包含块的顶部开始，按水平排列</span><br><span class="line">这些盒子可以以不同的方式对齐</span><br><span class="line">包含一串盒子的矩形区域就是一个 “线条框(line box)”</span><br></pre></td></tr></table></figure><h6 id="对齐方式"><a href="#对齐方式" class="headerlink" title="对齐方式"></a>对齐方式</h6><p><img src="/upload/image-20241110155405765.png" alt="image-20241110155405765.png"></p><p><img src="/upload/image-20241110155807497.png" alt="image-20241110155807497.png"></p><p><img src="/upload/image-20241110160000770.png" alt="image-20241110160000770.png"></p><h5 id="层叠上下文"><a href="#层叠上下文" class="headerlink" title="层叠上下文"></a>层叠上下文</h5><p><strong>对HTML元素的三维构想，基于用户界面z轴的上下排布</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于浏览器渲染过程的“渲染层(render layer)”</span><br></pre></td></tr></table></figure><h6 id="层叠水平"><a href="#层叠水平" class="headerlink" title="层叠水平"></a>层叠水平</h6><p><strong>也就是层叠顺序</strong></p><p><img src="/upload/image-20241110164351519.png" alt="image-20241110164351519.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">z-index只能在同一个层叠上下文比较</span><br><span class="line">子元素的z-index无法超过父元素的z-index顺序</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E5%B0%9D%E8%AF%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%A1%8C%E9%9D%A2%E7%AB%AF%E8%AE%A1%E6%97%B6%E5%99%A8%EF%BC%88%E5%8D%8A%E6%88%90%E5%93%81%E7%89%88%EF%BC%89/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E5%B0%9D%E8%AF%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%A1%8C%E9%9D%A2%E7%AB%AF%E8%AE%A1%E6%97%B6%E5%99%A8%EF%BC%88%E5%8D%8A%E6%88%90%E5%93%81%E7%89%88%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h2 id="吐槽"><a href="#吐槽" class="headerlink" title="吐槽"></a>吐槽</h2><p><strong>最初技术栈为Vue+Electron+TS，太甜美的难了。。。配置报错问题一大堆，一路报错问AI一路改，长达三个小时把文件改的乱七八糟无法收尾忍痛放弃新开项目</strong></p><p>**最后技术栈选择为 **<strong>Vue+Electron+Vite+JS</strong> ，包管理工具选择为 <strong>pnpm</strong></p><p><del>完整代码见github仓库</del> <code>......</code>(还没推，因为dist文件太大的原因没办法传，目前还在寻找更合理的推送方案)</p><h2 id="主步骤"><a href="#主步骤" class="headerlink" title="主步骤"></a>主步骤</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><strong>创建</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm create vite Tclick --template vue</span><br></pre></td></tr></table></figure><p><strong>依赖</strong></p><p><strong>package.json 直享版</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;clock&quot;,</span><br><span class="line">    &quot;private&quot;: true,</span><br><span class="line">    &quot;version&quot;: &quot;0.0.0&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;An Timer application.&quot;,//描述</span><br><span class="line">    &quot;author&quot;: &quot;none &lt;你的邮箱&gt;&quot;,//作者</span><br><span class="line">    &quot;homepage&quot;: &quot;./&quot;,</span><br><span class="line">    &quot;main&quot;: &quot;main.js&quot;,</span><br><span class="line">    &quot;scripts&quot;: &#123;</span><br><span class="line">        &quot;dev&quot;: &quot;vite&quot;,</span><br><span class="line">        &quot;build&quot;: &quot;vite build&quot;,</span><br><span class="line">        &quot;serve&quot;: &quot;vite preview&quot;,</span><br><span class="line">        &quot;electron:dev&quot;: &quot;concurrently \&quot;cross-env NODE_ENV=development wait-on http://localhost:5173 &amp;&amp; electron .\&quot; \&quot;npm run dev\&quot;&quot;,</span><br><span class="line">        &quot;electron:build&quot;: &quot;npm run build &amp;&amp; electron-builder &amp;&amp; node post-build.js&quot;,</span><br><span class="line">        &quot;start&quot;: &quot;npm run electron:dev&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;dependencies&quot;: &#123;</span><br><span class="line">        &quot;vue&quot;: &quot;^3.5.13&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;devDependencies&quot;: &#123;</span><br><span class="line">        &quot;@vitejs/plugin-vue&quot;: &quot;^5.2.1&quot;,</span><br><span class="line">        &quot;concurrently&quot;: &quot;^9.1.2&quot;,</span><br><span class="line">        &quot;cross-env&quot;: &quot;^7.0.3&quot;,</span><br><span class="line">        &quot;electron&quot;: &quot;^33.3.1&quot;,</span><br><span class="line">        &quot;electron-builder&quot;: &quot;^25.1.8&quot;,</span><br><span class="line">        &quot;vite&quot;: &quot;^6.0.5&quot;,</span><br><span class="line">        &quot;vite-plugin-html&quot;: &quot;^3.2.2&quot;,</span><br><span class="line">        &quot;wait-on&quot;: &quot;^8.0.2&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;build&quot;: &#123;</span><br><span class="line">        &quot;productName&quot;: &quot;Clock&quot;,</span><br><span class="line">        &quot;appId&quot;: &quot;com.example.clock&quot;,</span><br><span class="line">        &quot;directories&quot;: &#123;</span><br><span class="line">            &quot;output&quot;: &quot;release&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;files&quot;: [</span><br><span class="line">            &quot;dist/**/*&quot;,</span><br><span class="line">            &quot;node_modules/**/*&quot;,</span><br><span class="line">            &quot;main.js&quot;,</span><br><span class="line">            &quot;preload.js&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;mac&quot;: &#123;</span><br><span class="line">            &quot;target&quot;: &quot;dmg&quot;,</span><br><span class="line">            &quot;icon&quot;: &quot;dist/installer-icon-256.ico&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;win&quot;: &#123;</span><br><span class="line">            &quot;target&quot;: &quot;nsis&quot;,</span><br><span class="line">            &quot;icon&quot;: &quot;dist/installer-icon-256.ico&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;linux&quot;: &#123;</span><br><span class="line">            &quot;target&quot;: &quot;AppImage&quot;,</span><br><span class="line">            &quot;icon&quot;: &quot;dist/installer-icon-256.ico&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;nsis&quot;: &#123;</span><br><span class="line">            &quot;installerIcon&quot;: &quot;./public/installer-icon.ico&quot;,//这里的ico是我下的时钟图标，替换软件图标</span><br><span class="line">            &quot;oneClick&quot;: false,</span><br><span class="line">            &quot;allowToChangeInstallationDirectory&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install</span><br></pre></td></tr></table></figure><h3 id="补充项目结构"><a href="#补充项目结构" class="headerlink" title="补充项目结构"></a>补充项目结构</h3><p><code>public/icon</code>（图标）</p><p><code>main.js</code>（Electron主进程）</p><p><code>preload.js</code>（Electron预加载脚本）</p><p><code>post-build.js</code>（文件操作，生成dist）</p><h3 id="核心配置"><a href="#核心配置" class="headerlink" title="核心配置"></a>核心配置</h3><p><code>index.html</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;UTF-8&quot; /&gt;</span><br><span class="line">        &lt;link rel=&quot;icon&quot; type=&quot;image/svg+xml&quot; href=&quot;./dist/installer-icon.ico&quot; /&gt;</span><br><span class="line">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;</span><br><span class="line">        &lt;title&gt;Clock&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</span><br><span class="line">        &lt;script type=&quot;module&quot; src=&quot;/src/main.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><code>main.js</code>（Electron主进程）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">const &#123; app, BrowserWindow &#125; = require(&#x27;electron&#x27;)</span><br><span class="line">const path = require(&#x27;path&#x27;)</span><br><span class="line"></span><br><span class="line">function createWindow() &#123;</span><br><span class="line">    const win = new BrowserWindow(&#123;</span><br><span class="line">        width: 500,</span><br><span class="line">        height: 210,</span><br><span class="line">        x: 800, // 指定初始 x 坐标</span><br><span class="line">        y: 20, // 指定初始 y 坐标</span><br><span class="line">        webPreferences: &#123;</span><br><span class="line">            preload: path.join(__dirname, &#x27;preload.js&#x27;),</span><br><span class="line">            nodeIntegration: false,</span><br><span class="line">            contextIsolation: true,</span><br><span class="line">            // 设置 CSP</span><br><span class="line">            additionalArguments: [&#x27;--disable-features=ElectronSandbox&#x27;], // 根据需要调整</span><br><span class="line">            webviewTag: false, // 禁止使用 &lt;webview&gt; 标签</span><br><span class="line">            webSecurity: true,</span><br><span class="line">            sandbox: true,</span><br><span class="line">            contentSecurityPolicy: `</span><br><span class="line">        default-src &#x27;self&#x27;;</span><br><span class="line">        script-src &#x27;self&#x27;;</span><br><span class="line">        connect-src &#x27;self&#x27;;</span><br><span class="line">        style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;; /* 如果需要内联样式 */</span><br><span class="line">        img-src &#x27;self&#x27; data:;</span><br><span class="line">        font-src &#x27;self&#x27;;</span><br><span class="line">      `,</span><br><span class="line">        &#125;,</span><br><span class="line">        title: &#x27;Clock&#x27;, // 设置窗口标题</span><br><span class="line">        icon: path.join(__dirname, &#x27;dist&#x27;, &#x27;installer-icon.ico&#x27;), // 设置窗口图标</span><br><span class="line">        autoHideMenuBar: true, //自动隐藏菜单栏</span><br><span class="line">        alwaysOnTop: true, // 确保窗口始终在顶部</span><br><span class="line">        // frame: false, // 隐藏窗口边框</span><br><span class="line">        // resizable: false, // 禁止调整窗口大小</span><br><span class="line">        transparent: true, // 使窗口透明</span><br><span class="line">        // skipTaskbar: true, // 跳过任务栏显示</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    if (process.env.NODE_ENV === &#x27;development&#x27;) &#123;</span><br><span class="line">        win.loadURL(&#x27;http://localhost:5173&#x27;)</span><br><span class="line">        // win.loadFile(&#x27;dist/index.html&#x27;)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        win.loadFile(path.resolve(__dirname, &#x27;dist&#x27;, &#x27;index.html&#x27;))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.whenReady().then(() =&gt; &#123;</span><br><span class="line">    createWindow()</span><br><span class="line"></span><br><span class="line">    app.on(&#x27;activate&#x27;, function () &#123;</span><br><span class="line">        if (BrowserWindow.getAllWindows().length === 0) createWindow()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 其他事件监听器...</span><br><span class="line"></span><br><span class="line">app.on(&#x27;window-all-closed&#x27;, () =&gt; &#123;</span><br><span class="line">    if (process.platform !== &#x27;darwin&#x27;) &#123;</span><br><span class="line">        app.quit()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.on(&#x27;activate&#x27;, () =&gt; &#123;</span><br><span class="line">    if (BrowserWindow.getAllWindows().length === 0) &#123;</span><br><span class="line">        createWindow()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>preload.js</code>（Electron预加载脚本）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// preload.js</span><br><span class="line">window.addEventListener(&#x27;DOMContentLoaded&#x27;, () =&gt; &#123;</span><br><span class="line">    // 这里可以添加与DOM交互的代码</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>post-build.js</code>（文件操作，生成dist）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;)</span><br><span class="line">const path = require(&#x27;path&#x27;)</span><br><span class="line"></span><br><span class="line">const htmlFilePath = path.resolve(__dirname, &#x27;dist&#x27;, &#x27;index.html&#x27;)</span><br><span class="line"></span><br><span class="line">fs.readFile(htmlFilePath, &#x27;utf8&#x27;, (err, data) =&gt; &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        return console.log(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const result = data.replace(/&lt;title&gt;.*?&lt;\/title&gt;/, &#x27;&lt;title&gt;Clock&lt;/title&gt;&#x27;)</span><br><span class="line"></span><br><span class="line">    fs.writeFile(htmlFilePath, result, &#x27;utf8&#x27;, (err) =&gt; &#123;</span><br><span class="line">        if (err) return console.log(err)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="简陋的组件"><a href="#简陋的组件" class="headerlink" title="简陋的组件"></a>简陋的组件</h3><p><code>App.vue</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div id=&quot;app&quot; class=&quot;hide-scrollbar&quot;&gt;</span><br><span class="line">        &lt;Main /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">    import Main from &#x27;./components/index.vue&#x27;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .hide-scrollbar &#123;</span><br><span class="line">        scrollbar-width: none; /* Firefox */</span><br><span class="line">        -ms-overflow-style: none; /* IE 和 Edge */</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .hide-scrollbar::-webkit-scrollbar &#123;</span><br><span class="line">        display: none;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style</span><br></pre></td></tr></table></figure><p><code>utils/timeUtils.js</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">export const getFormattedTime = () =&gt; &#123;</span><br><span class="line">    const now = new Date();</span><br><span class="line">    </span><br><span class="line">    // 获取当前时间的小时、分钟和秒数，并确保它们都是两位数</span><br><span class="line">    const padZero = (num) =&gt; num.toString().padStart(2, &#x27;0&#x27;);</span><br><span class="line">    const hours = padZero(now.getHours());</span><br><span class="line">    const minutes = padZero(now.getMinutes());</span><br><span class="line">    const seconds = padZero(now.getSeconds());</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">        hoursFirstChar: hours[0],</span><br><span class="line">        hoursSecondChar: hours[1],</span><br><span class="line">        minutesFirstChar: minutes[0],</span><br><span class="line">        minutesSecondChar: minutes[1],</span><br><span class="line">        secondsFirstChar: seconds[0],</span><br><span class="line">        secondsSecondChar: seconds[1],</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>components / index.vue</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;layouts&quot;&gt;</span><br><span class="line">        &lt;div v-for=&quot;(title, index) in titles&quot; :key=&quot;index&quot; class=&quot;layout&quot;&gt;</span><br><span class="line">            &lt;div&gt;&lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;top&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;title&quot;&gt;&#123;&#123; title &#125;&#125;&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;btn&quot; @click=&quot;start(index)&quot; :disabled=&quot;timers[index].isRunning&quot;&gt;开始&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;btn&quot; @click=&quot;stop(index)&quot; :disabled=&quot;!timers[index].isRunning&quot;&gt;停止&lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;btn&quot; @click=&quot;reset(index)&quot; :disabled=&quot;timers[index].elapsedTime === 0&quot;&gt;重置&lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;!-- &lt;Flip</span><br><span class="line">                :hours=&quot;timers[index].formattedTime.hours&quot;</span><br><span class="line">                :minutes=&quot;timers[index].formattedTime.minutes&quot;</span><br><span class="line">                :seconds=&quot;timers[index].formattedTime.seconds&quot; /&gt; --&gt;</span><br><span class="line">            &lt;Timer /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">    import &#123; ref, computed &#125; from &#x27;vue&#x27;</span><br><span class="line">    import Flip from &#x27;./Flip/index.vue&#x27;</span><br><span class="line">    import Timer from &#x27;./Timer/index.vue&#x27;</span><br><span class="line"></span><br><span class="line">    const titles = [&#x27;学习时长&#x27;, &#x27;英语时长&#x27;, &#x27;看书时长&#x27;, &#x27;博客时长&#x27;]</span><br><span class="line">    const timers = ref([])</span><br><span class="line"></span><br><span class="line">    for (let i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">        timers.value.push(&#123;</span><br><span class="line">            startTime: null,</span><br><span class="line">            elapsedTime: 0,</span><br><span class="line">            isRunning: false,</span><br><span class="line">            formattedTime: &#123; hours: &#x27;00&#x27;, minutes: &#x27;00&#x27;, seconds: &#x27;00&#x27; &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const start = (index) =&gt; &#123;</span><br><span class="line">        if (!timers.value[index].isRunning) &#123;</span><br><span class="line">            timers.value[index].startTime = Date.now() - (timers.value[index].startTime ? timers.value[index].startTime : 0)</span><br><span class="line">            timers.value[index].isRunning = true</span><br><span class="line">            updateElapsedTime(index)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const stop = (index) =&gt; &#123;</span><br><span class="line">        timers.value[index].isRunning = false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const reset = (index) =&gt; &#123;</span><br><span class="line">        timers.value[index].startTime = null</span><br><span class="line">        timers.value[index].elapsedTime = 0</span><br><span class="line">        timers.value[index].isRunning = false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const updateElapsedTime = (index) =&gt; &#123;</span><br><span class="line">        if (timers.value[index].isRunning) &#123;</span><br><span class="line">            timers.value[index].elapsedTime = Math.floor((Date.now() - timers.value[index].startTime) / 1000)</span><br><span class="line">            updateFormattedTime(index)</span><br><span class="line">            setTimeout(() =&gt; updateElapsedTime(index), 1000)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const updateFormattedTime = (index) =&gt; &#123;</span><br><span class="line">        const hours = Math.floor(timers.value[index].elapsedTime / 3600).toString().padStart(2, &#x27;0&#x27;)</span><br><span class="line">        const minutes = Math.floor((timers.value[index].elapsedTime % 3600) / 60).toString().padStart(2, &#x27;0&#x27;)</span><br><span class="line">        const seconds = (timers.value[index].elapsedTime % 60).toString().padStart(2, &#x27;0&#x27;)</span><br><span class="line">        timers.value[index].formattedTime = &#123; hours, minutes, seconds &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .layouts &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        flex-direction: row;</span><br><span class="line">        gap: 20px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .layout &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        flex-direction: column;</span><br><span class="line">        align-items: center;</span><br><span class="line">        width: 25%;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .layout .top &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: space-between;</span><br><span class="line">        align-items: center;</span><br><span class="line">        width: 100%;</span><br><span class="line">        background: #fff;</span><br><span class="line">        border-radius: 20px;</span><br><span class="line">        padding: 10px;</span><br><span class="line">        box-sizing: border-box;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .layout .top .title &#123;</span><br><span class="line">        font-size: 20px;</span><br><span class="line">        font-weight: 700;</span><br><span class="line">        color: #333;</span><br><span class="line">        margin-right: auto;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .layout .top .btn &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: center;</span><br><span class="line">        align-items: center;</span><br><span class="line">        width: 50px;</span><br><span class="line">        height: 24px;</span><br><span class="line">        border-radius: 10px;</span><br><span class="line">        border: 1px solid #333;</span><br><span class="line">        font-size: 14px;</span><br><span class="line">        font-weight: 700;</span><br><span class="line">        color: #333;</span><br><span class="line">        padding: 0px 3px;</span><br><span class="line">        cursor: pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .layout .top .btn:hover &#123;</span><br><span class="line">        background: #333;</span><br><span class="line">        color: #fff;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p><code>components / Flip / index.vue</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;clock&quot;&gt;</span><br><span class="line">        &lt;!-- 小时 --&gt;</span><br><span class="line">        &lt;div class=&quot;flip&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;digital&quot; :data-number=&quot;hoursFirstChar&quot;&gt;&#123;&#123; hoursFirstChar &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;flip&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;digital&quot; :data-number=&quot;hoursSecondChar&quot;&gt;&#123;&#123; hoursSecondChar &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;em class=&quot;divider&quot;&gt;:&lt;/em&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 分钟 --&gt;</span><br><span class="line">        &lt;div class=&quot;flip&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;digital&quot; :data-number=&quot;minutesFirstChar&quot;&gt;&#123;&#123; minutesFirstChar &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;flip&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;digital&quot; :data-number=&quot;minutesSecondChar&quot;&gt;&#123;&#123; minutesSecondChar &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;em class=&quot;divider&quot;&gt;:&lt;/em&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 秒 --&gt;</span><br><span class="line">        &lt;div class=&quot;flip&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;digital&quot; :data-number=&quot;secondsFirstChar&quot;&gt;&#123;&#123; secondsFirstChar &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;flip&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;digital&quot; :data-number=&quot;secondsSecondChar&quot;&gt;&#123;&#123; secondsSecondChar &#125;&#125;&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">    import &#123; ref, onMounted, watch &#125; from &#x27;vue&#x27;;</span><br><span class="line">    import &#123; getFormattedTime &#125; from &#x27;../../utils/timeUtils&#x27;; // 确保路径正确</span><br><span class="line"></span><br><span class="line">    const hoursFirstChar = ref(&#x27;&#x27;);</span><br><span class="line">    const hoursSecondChar = ref(&#x27;&#x27;);</span><br><span class="line">    const minutesFirstChar = ref(&#x27;&#x27;);</span><br><span class="line">    const minutesSecondChar = ref(&#x27;&#x27;);</span><br><span class="line">    const secondsFirstChar = ref(&#x27;&#x27;);</span><br><span class="line">    const secondsSecondChar = ref(&#x27;&#x27;);</span><br><span class="line"></span><br><span class="line">    const updateTime = () =&gt; &#123;</span><br><span class="line">        const time = getFormattedTime();</span><br><span class="line">        hoursFirstChar.value = time.hoursFirstChar;</span><br><span class="line">        hoursSecondChar.value = time.hoursSecondChar;</span><br><span class="line">        minutesFirstChar.value = time.minutesFirstChar;</span><br><span class="line">        minutesSecondChar.value = time.minutesSecondChar;</span><br><span class="line">        secondsFirstChar.value = time.secondsFirstChar;</span><br><span class="line">        secondsSecondChar.value = time.secondsSecondChar;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">        updateTime(); // 初始化时更新时间</span><br><span class="line">        setInterval(updateTime, 1000); // 每秒更新一次时间</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        justify-content: center;</span><br><span class="line">        align-items: center;</span><br><span class="line">        height: 100vh;</span><br><span class="line">        width: 100vw;</span><br><span class="line">        background-color: #2c3e50; /* 添加背景色以便于查看 */</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .clock &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 时钟的分隔 */</span><br><span class="line">    .clock .divider &#123;</span><br><span class="line">        font-size: 30px;</span><br><span class="line">        line-height: 60px;</span><br><span class="line">        font-style: normal;</span><br><span class="line">        color: rgb(255, 255, 255); /* 更改为白色以便于查看 */</span><br><span class="line">        margin: 0 5px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 时钟的卡片 */</span><br><span class="line">    .clock .flip &#123;</span><br><span class="line">        position: relative;</span><br><span class="line">        width: 40px; /* 稍微增加宽度以确保数字完全显示 */</span><br><span class="line">        height: 60px; /* 增加高度以确保数字完全显示 */</span><br><span class="line">        margin: 2px;</span><br><span class="line">        font-size: 48px; /* 增加字体大小以便于查看 */</span><br><span class="line">        font-weight: 700;</span><br><span class="line">        line-height: 60px; /* 确保文本垂直居中 */</span><br><span class="line">        text-align: center;</span><br><span class="line">        background: rgb(46, 45, 45);</span><br><span class="line">        border: 1px solid rgb(34, 33, 33);</span><br><span class="line">        border-radius: 10px;</span><br><span class="line">        box-shadow: 0 0 6px rgba(54, 54, 54, 0.5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* 时钟上的数字 */</span><br><span class="line">    .clock .flip .digital &#123;</span><br><span class="line">        position: absolute;</span><br><span class="line">        top: 0;</span><br><span class="line">        left: 0;</span><br><span class="line">        right: 0;</span><br><span class="line">        bottom: 0;</span><br><span class="line">        color: white; /* 数字颜色为白色 */</span><br><span class="line">        background: transparent; /* 背景透明 */</span><br><span class="line">        border-radius: 10px;</span><br><span class="line">        display: flex;</span><br><span class="line">        align-items: center;</span><br><span class="line">        justify-content: center;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p><code>components / Timer / index.vue</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;&#123;&#123; formattedTime &#125;&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;button @click=&quot;start&quot; :disabled=&quot;isRunning&quot;&gt;开始&lt;/button&gt;</span><br><span class="line">        &lt;button @click=&quot;stop&quot; :disabled=&quot;!isRunning&quot;&gt;停止&lt;/button&gt;</span><br><span class="line">        &lt;button @click=&quot;reset&quot; :disabled=&quot;elapsedTime === 0&quot;&gt;重置&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">    import &#123; ref, computed, onMounted, onUnmounted &#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">    const startTime = ref(null)</span><br><span class="line">    const elapsedTime = ref(0)</span><br><span class="line">    const isRunning = ref(false)</span><br><span class="line"></span><br><span class="line">    const formattedTime = computed(() =&gt; &#123;</span><br><span class="line">        const hours = Math.floor(elapsedTime.value / 3600).toString().padStart(2, &#x27;0&#x27;)</span><br><span class="line">        const minutes = Math.floor((elapsedTime.value % 3600) / 60).toString().padStart(2, &#x27;0&#x27;)</span><br><span class="line">        const seconds = (elapsedTime.value % 60).toString().padStart(2, &#x27;0&#x27;)</span><br><span class="line">        return `$&#123;hours&#125;:$&#123;minutes&#125;:$&#123;seconds&#125;`</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    let intervalId = null</span><br><span class="line"></span><br><span class="line">    function start() &#123;</span><br><span class="line">        if (!isRunning.value) &#123;</span><br><span class="line">            startTime.value = Date.now() - (startTime.value ? startTime.value : 0)</span><br><span class="line">            isRunning.value = true</span><br><span class="line">            intervalId = setInterval(updateElapsedTime, 1000)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function stop() &#123;</span><br><span class="line">        clearInterval(intervalId)</span><br><span class="line">        isRunning.value = false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function reset() &#123;</span><br><span class="line">        clearInterval(intervalId)</span><br><span class="line">        startTime.value = null</span><br><span class="line">        elapsedTime.value = 0</span><br><span class="line">        isRunning.value = false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function updateElapsedTime() &#123;</span><br><span class="line">        elapsedTime.value = Math.floor((Date.now() - startTime.value) / 1000)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">        document.addEventListener(&#x27;visibilitychange&#x27;, handleVisibilityChange)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    onUnmounted(() =&gt; &#123;</span><br><span class="line">        document.removeEventListener(&#x27;visibilitychange&#x27;, handleVisibilityChange)</span><br><span class="line">        clearInterval(intervalId)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    function handleVisibilityChange() &#123;</span><br><span class="line">        if (document.visibilityState === &#x27;hidden&#x27;) &#123;</span><br><span class="line">            if (isRunning.value) &#123;</span><br><span class="line">                stop()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (document.visibilityState === &#x27;visible&#x27;) &#123;</span><br><span class="line">            if (isRunning.value) &#123;</span><br><span class="line">                start()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm run build</span><br></pre></td></tr></table></figure><p><strong>网页端开发环境</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm run dev</span><br></pre></td></tr></table></figure><p><strong>桌面端开发环境</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm run start</span><br></pre></td></tr></table></figure><h3 id="exe文件生成位置"><a href="#exe文件生成位置" class="headerlink" title=".exe文件生成位置"></a>.exe文件生成位置</h3><p><code>release</code>文件夹中的 Setup.exe（文件有70多m!!!不理解）</p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a><em>TODO</em></h3><p><strong>1.桌面软件图标还是Electron的，需要修改为下好的ico</strong></p><p><strong>2.git大文件提交问题（可能是需要改动gitignore？没有接触过）</strong></p><p><strong>3.第一版Vue+Electron+TS项目提到过自动发布版本工作流，还有检测标签啥的，还没弄懂这周探索一下，没记错的话github主页的贪吃蛇好像也和这个有关系</strong></p><p><strong>4.简单UI排布</strong></p><p><strong>5.交互功能：用户可自行添加多个计时器，且独立计时</strong></p><p><strong>6.考虑到挂后台会有计时误差，添加新的计时逻辑（begin记录时间戳，从后台调出时通过时间戳相减更新时间）</strong></p>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/WebSocket/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/WebSocket/</url>
      
        <content type="html"><![CDATA[<h1 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h1><blockquote><p><strong>低延迟，双向实时通信(双全工)，长期运行</strong></p></blockquote><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><strong>相比HTTP协议，WebSocket是一种****实时通信</strong>协议</p><p><strong>在实时通讯前，HTTP通过****轮询</strong>解决实时问题</p><blockquote><p><strong>轮询：客户端定期向服务器发送请求</strong></p><blockquote><p><strong>长轮询：客户端发出请求后，保持连接打开，等待新数据响应后再关闭连接</strong></p></blockquote><blockquote><p><strong>Comet：保持长连接，返回请求后继续保持连接打开</strong></p></blockquote></blockquote><p><strong>WebSocket的连接只需要建立一次</strong></p><h2 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h2><h3 id="理论须知"><a href="#理论须知" class="headerlink" title="理论须知"></a>理论须知</h3><p><strong>需要HTTP向服务器发起一次常规Get请求，并在这个请求头上携带</strong><em><strong>Upgrade</strong></em></p><blockquote><p><strong>Upgrade作为升级请求将传递给服务器，协议从HTTP升级为WebSocket</strong></p></blockquote><p><strong>在此之后客户端和服务器即可随时向彼此发送消息</strong></p><h3 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h3><p><strong>前端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const socket = new WebSocket(&quot;ws://localhost:8080&quot;);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">socket.onopen =function(event)&#123;</span><br><span class="line">    console.log(&quot;Websocket连接已打开&quot;)</span><br><span class="line">&#125;</span><br><span class="line">socket.onmessage =function(event)&#123;</span><br><span class="line">    console.log(&quot;收到了回复:&quot;event.data)</span><br><span class="line">&#125;</span><br><span class="line">socket.onclose = function(event)&#123;</span><br><span class="line">    console.log(&quot;Websocket连接已关闭&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function click()&#123;//发送消息</span><br><span class="line">    socket.send(&quot;Hello World!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>后端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&#x27;http&#x27;);//引入模块</span><br><span class="line">const WebSocket = require(&#x27;ws&#x27;);</span><br><span class="line"></span><br><span class="line">const server = http.createServer();//HTTP服务器实例</span><br><span class="line">const wss = new WebSocket.Server(&#123; server &#125;);//根据服务器实例创建WebSocket实例</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wss.on(&#x27;connection&#x27;,(socket) =&gt; &#123;//客户端连入Websocket服务器</span><br><span class="line">    socket.on(&#x27;message&#x27;,(message)=&gt;&#123;</span><br><span class="line">        console.log(&#x27;收到消息:&#x27;+ message)</span><br><span class="line">        socket.send(&#x27;Hello FireUG&#x27;);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    socket.on(&#x27;close&#x27;,() =&gt; &#123;</span><br><span class="line">        console.log(&#x27;Websocket连接已关闭&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server.on(&#x27;request&#x27;,(request,response)=&gt;&#123;</span><br><span class="line">    response.writeHead(200,&#123;&#x27;Content-Type&#x27;:&#x27;text/plain&#x27;&#125;)</span><br><span class="line">    response.end(&#x27;Hello, World!&#x27;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.listen(8080，() =&gt; &#123;</span><br><span class="line">    console.log(&#x27;服务器已启动，端口号为 8080&#x27;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="心跳机制"><a href="#心跳机制" class="headerlink" title="心跳机制"></a>心跳机制</h2><blockquote><p><strong>为了保持长连接，服务端和客户端之间通过</strong> <code>心跳包</code>保持连接状态，防止长时间没有数据传输而被切断</p></blockquote><p><code>心跳包</code></p><blockquote><p><strong>一种数据包，不包含任何实际数据</strong></p><p><strong>客户端和服务端定期发送一个空的数据包，确保链接仍然有效</strong></p><p><strong>如果一段时间没有收到对方的心跳包，就可认为连接已经断开</strong></p></blockquote><h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p><strong>安全</strong></p><blockquote><p><strong>不提供加密功能，需采用其他方式来确保安全性</strong></p><blockquote><p><strong>SSL协议：可对WebSocket连接进行加密防止敏感信息被窃听和篡改</strong></p></blockquote><blockquote><p><strong>设置黑白名单：在服务端设置，只允许特定IP地址或域名的客户端进行连接</strong></p></blockquote></blockquote><p><strong>支持</strong></p><blockquote><p><strong>小于IE10的浏览器不支持</strong></p></blockquote><p><strong>优化</strong></p><blockquote><p><strong>保持长连接需要服务器不断地维护和处理连接状态，需要优化性能，不然会过度地消耗服务器资源</strong></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/WebRTC%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%20%20%E5%85%A8%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/WebRTC%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%20%20%E5%85%A8%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="WebRTC实现本地视频通话-全流程详解"><a href="#WebRTC实现本地视频通话-全流程详解" class="headerlink" title="WebRTC实现本地视频通话 | 全流程详解"></a>WebRTC实现本地视频通话 | 全流程详解</h1><p>**源码见仓库 **<a href="https://github.com/Breezli/WebRTC_Demo">Breezli&#x2F;WebRTC_Demo: 基于WebRTC技术实现的本地网页端视频通话</a></p><p><strong>分为前后端两个文件夹</strong></p><blockquote><p><strong>webrtc-client  (客户端)</strong></p><p><strong>webrtc-server (服务端)</strong></p></blockquote><h2 id="预先准备"><a href="#预先准备" class="headerlink" title="预先准备"></a>预先准备</h2><h3 id="webrtc-client"><a href="#webrtc-client" class="headerlink" title="webrtc-client"></a>webrtc-client</h3><p><strong>前端页面绘制</strong></p><p><code>依赖下载</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pnpm create vite@latest webrtc-client -- --template vue-ts</span><br><span class="line">pnpm install -D tailwindcss postcss autoprefixer</span><br><span class="line">npx tailwindcss init -p</span><br></pre></td></tr></table></figure><p><code>package.json</code>直通</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;webrtc-client&quot;,</span><br><span class="line">  &quot;private&quot;: true,</span><br><span class="line">  &quot;version&quot;: &quot;0.0.0&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;module&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;dev&quot;: &quot;vite&quot;,</span><br><span class="line">    &quot;build&quot;: &quot;vue-tsc -b &amp;&amp; vite build&quot;,</span><br><span class="line">    &quot;preview&quot;: &quot;vite preview&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;socket.io-client&quot;: &quot;^4.8.1&quot;,//重要依赖</span><br><span class="line">    &quot;vue&quot;: &quot;^3.5.13&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;devDependencies&quot;: &#123;</span><br><span class="line">    &quot;@vitejs/plugin-vue&quot;: &quot;^5.2.1&quot;,</span><br><span class="line">    &quot;@vue/tsconfig&quot;: &quot;^0.7.0&quot;,</span><br><span class="line">    &quot;autoprefixer&quot;: &quot;^10.4.20&quot;,//自动添加css前缀</span><br><span class="line">    &quot;postcss&quot;: &quot;^8.4.49&quot;,</span><br><span class="line">    &quot;tailwindcss&quot;: &quot;^3.4.17&quot;,//tailwindcss样式库</span><br><span class="line">    &quot;typescript&quot;: &quot;~5.6.2&quot;,</span><br><span class="line">    &quot;vite&quot;: &quot;^6.0.5&quot;,</span><br><span class="line">    &quot;vue-tsc&quot;: &quot;^2.2.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>App.vue</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;flex items-center flex-col text-center p-12 h-screen&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;relative h-full mb-4&quot;&gt;</span><br><span class="line">            &lt;video</span><br><span class="line">                ref=&quot;localVideo&quot;</span><br><span class="line">                class=&quot;w-96 h-full bg-gray-200 mb-4 object-cover&quot;&gt;&lt;/video&gt;</span><br><span class="line">            &lt;video</span><br><span class="line">                ref=&quot;remoteVideo&quot;</span><br><span class="line">                class=&quot;w-32 h-48 absolute bottom-0 right-0 object-cover&quot;&gt;&lt;/video&gt;</span><br><span class="line">            &lt;div</span><br><span class="line">                v-if=&quot;caller &amp;&amp; calling&quot;</span><br><span class="line">                class=&quot;absolute top-2/3 left-36 flex flex-col items-center&quot;&gt;</span><br><span class="line">                &lt;p class=&quot;mb-4 text-white&quot;&gt;等待对方接听...&lt;/p&gt;</span><br><span class="line">                &lt;img</span><br><span class="line">                    @click=&quot;hangUp&quot;</span><br><span class="line">                    src=&quot;/refuse.svg&quot;</span><br><span class="line">                    class=&quot;w-16 cursor-pointer&quot;</span><br><span class="line">                    alt=&quot;&quot; /&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div</span><br><span class="line">                v-if=&quot;called &amp;&amp; calling&quot;</span><br><span class="line">                class=&quot;absolute top-2/3 left-32 flex flex-col items-center&quot;&gt;</span><br><span class="line">                &lt;p class=&quot;mb-4 text-white&quot;&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line">                &lt;div class=&quot;flex&quot;&gt;</span><br><span class="line">                    &lt;img</span><br><span class="line">                        @click=&quot;hangUp&quot;</span><br><span class="line">                        src=&quot;/refuse.svg&quot;</span><br><span class="line">                        class=&quot;w-16 cursor-pointer mr-4&quot;</span><br><span class="line">                        alt=&quot;&quot; /&gt;</span><br><span class="line">                    &lt;img</span><br><span class="line">                        @click=&quot;acceptCall&quot;</span><br><span class="line">                        src=&quot;/accept.svg&quot;</span><br><span class="line">                        class=&quot;w-16 cursor-pointer&quot;</span><br><span class="line">                        alt=&quot;&quot; /&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;flex gap-2 mb-4&quot;&gt;</span><br><span class="line">            &lt;button</span><br><span class="line">                class=&quot;rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white&quot;</span><br><span class="line">                @click=&quot;callRemote&quot;&gt;</span><br><span class="line">                发起视频</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;button</span><br><span class="line">                class=&quot;rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white&quot;</span><br><span class="line">                @click=&quot;hangUp&quot;&gt;</span><br><span class="line">                挂断视频</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p><code>main.ts</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createApp &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#x27;./style.css&#x27;</span><br><span class="line">import App from &#x27;./App.vue&#x27;</span><br><span class="line"></span><br><span class="line">createApp(App).mount(&#x27;#app&#x27;)</span><br></pre></td></tr></table></figure><p><code>style.css</code> 这里使用了tailwind的样式库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@tailwind base;</span><br><span class="line">@tailwind components;</span><br><span class="line">@tailwind utilities;</span><br></pre></td></tr></table></figure><p><code>tailwind.config.js</code> 此配置文件中添加所有模板文件的路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/** @type &#123;import(&#x27;tailwindcss&#x27;).Config&#125; */</span><br><span class="line">export default &#123;</span><br><span class="line">    content: [</span><br><span class="line">    &quot;./index.html&quot;,</span><br><span class="line">    &quot;./src/**/*.&#123;vue,js,ts,jsx,tsx&#125;&quot;,</span><br><span class="line">  ],</span><br><span class="line">    theme: &#123;</span><br><span class="line">        extend: &#123;&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>到此前端页面绘制完成，可在3000端口可启动node服务</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm run start</span><br></pre></td></tr></table></figure><h3 id="webrtc-server"><a href="#webrtc-server" class="headerlink" title="webrtc-server"></a>webrtc-server</h3><p><strong>初始化服务端项目</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm init</span><br></pre></td></tr></table></figure><p><code>socket.io</code> 封装了websocket应用创建服务</p><p><code>nodemon</code> 代码改变会自动重启(不用重复地开关)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install socket.io nodemon</span><br></pre></td></tr></table></figure><p><code>package.json</code> 添加 <code>start</code>命令，使用 <code>nodemon</code>启动项目</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;,</span><br><span class="line">  &quot;start&quot;: &quot;nodemon index.js&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><strong>创建</strong> <code>index.js</code>（最初版，之后后端的所有操作都在这个文件上进行）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const socket = require(&#x27;socket.io&#x27;);//封装了websocket应用创建服务</span><br><span class="line">const http = require(&#x27;http&#x27;);//引入http模块 </span><br><span class="line"></span><br><span class="line">const server = http.createServer()//创建服务器</span><br><span class="line"></span><br><span class="line">const io = socket(server, &#123;</span><br><span class="line">    cors: &#123;</span><br><span class="line">        origin: &#x27;*&#x27; // 配置跨域</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">/////接下来的主体部分/////</span><br><span class="line">io.on(&#x27;connection&#x27;, sock =&gt; &#123;</span><br><span class="line">    console.log(&#x27;连接成功...&#x27;)</span><br><span class="line">    sock.emit(&#x27;connectionSuccess&#x27;);// 向客户端发送连接成功的消息</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//...</span><br><span class="line"></span><br><span class="line">io.on(&#x27;disconnect&#x27;, () =&gt; &#123;</span><br><span class="line">    console.log(&#x27;连接断开&#x27;);</span><br><span class="line">    sock.emit(&#x27;connectionFalse&#x27;);// 向客户端发送连接断开的消息</span><br><span class="line">&#125;);</span><br><span class="line">/////接下来的主体部分/////</span><br><span class="line"></span><br><span class="line">server.listen(3000, () =&gt; &#123;</span><br><span class="line">    console.log(&#x27;服务器启动成功&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="插播socket重要概念"><a href="#插播socket重要概念" class="headerlink" title="!!!插播socket重要概念!!!"></a>!!!插播socket重要概念!!!</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.emit   发送事件</span><br><span class="line">.on     监听事件</span><br></pre></td></tr></table></figure><p><strong>常见内置事件说明</strong></p><table><thead><tr><th><strong>事件名称</strong></th><th><strong>触发场景</strong></th><th><strong>使用位置</strong></th></tr></thead><tbody><tr><td><strong>connect</strong></td><td><strong>客户端成功连接到服务端时</strong></td><td><strong>客户端</strong></td></tr><tr><td><strong>connection</strong></td><td><strong>服务端接收到新客户端连接时</strong></td><td><strong>服务端</strong></td></tr><tr><td><strong>disconnect</strong></td><td><strong>连接断开时</strong></td><td><strong>客户端&#x2F;服务端</strong></td></tr><tr><td><strong>error</strong></td><td><strong>连接发生错误时</strong></td><td><strong>客户端&#x2F;服务端</strong></td></tr></tbody></table><p><strong>后端至此搭建完成，可在3000端口可启动node服务</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm run start</span><br></pre></td></tr></table></figure><h2 id="前端连接信令服务器"><a href="#前端连接信令服务器" class="headerlink" title="前端连接信令服务器"></a>前端连接信令服务器</h2><p><strong>依靠的就是</strong> <code>socket.io-client</code></p><p><strong>接下来我们将在</strong> <code>App.vue</code>中开始编写脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">    import &#123; ref, onMounted, onUnmounted &#125; from &#x27;vue&#x27;</span><br><span class="line">    import &#123; io, Socket &#125; from &quot;socket.io-client&quot;;</span><br><span class="line"></span><br><span class="line">    const socket = ref&lt;Socket&gt;() // 前端Socket实例</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">        const sock = io(&#x27;localhost:3000&#x27;); // 通过 io(&#x27;localhost:3000&#x27;) 创建的 Socket.IO 客户端实例</span><br><span class="line"></span><br><span class="line">        // 连接成功</span><br><span class="line">        sock.on(&#x27;connectionSuccess&#x27;, () =&gt; &#123;</span><br><span class="line">            console.log(&#x27;连接成功&#x27;)</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        socket.value = sock;// 存储Socket实例</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><strong>还记得吗，就在前两步，后端在连接成功后向前端.emit(发送)了connectionSuccess事件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">io.on(&#x27;connection&#x27;, sock =&gt; &#123;</span><br><span class="line">  console.log(&#x27;连接成功...&#x27;)</span><br><span class="line">  sock.emit(&#x27;connectionSuccess&#x27;);// 向客户端发送连接成功的消息</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>而在此时的前端加入的</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;connectionSuccess&#x27;, () =&gt; &#123;// 接收到服务端发来的connectionSuccess(连接成功)事件</span><br><span class="line">    console.log(&#x27;连接成功&#x27;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>前后端交互正式开始</strong></p><h2 id="发起视频请求"><a href="#发起视频请求" class="headerlink" title="发起视频请求"></a>发起视频请求</h2><h3 id="获取本地音视频流"><a href="#获取本地音视频流" class="headerlink" title="获取本地音视频流"></a>获取本地音视频流</h3><p><strong>前端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const getLocalStream = async () =&gt; &#123;</span><br><span class="line">    const stream = await navigator.mediaDevices.getUserMedia(&#123;// 获取音视频流</span><br><span class="line">        video: true,</span><br><span class="line">        audio: true,</span><br><span class="line">    &#125;)</span><br><span class="line">    localVideo.value!.srcObject = stream // 将媒体流设置到 video 标签上播放</span><br><span class="line">    localVideo.value!.play() // 播放音视频流</span><br><span class="line">    localStream.value = stream // 存储本地流</span><br><span class="line"></span><br><span class="line">    return stream</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="“房间”的概念"><a href="#“房间”的概念" class="headerlink" title="“房间”的概念"></a>“房间”的概念</h3><blockquote><p><strong>不妨先停下来思考一下，为什么在同一个网页，不同的客户端可以看见不同的页面，和实时共享的内容</strong></p></blockquote><p><img src="/upload/image-20250205190246032.png" alt="image-20250205190246032.png"></p><p><strong>我们先来看一看之前给前端写的组件（layout省略版）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;video ref=&quot;localVideo&quot;&gt;&lt;/video&gt;    //本地视频</span><br><span class="line">&lt;video ref=&quot;remoteVideo&quot;&gt;&lt;/video&gt;   //接收方视频（位于右下角）</span><br><span class="line"></span><br><span class="line">&lt;div v-if=&quot;caller &amp;&amp; calling&quot;&gt;  //状态参数---caller:发送方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;等待对方接听...&lt;/p&gt;</span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;    //挂断</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div v-if=&quot;called &amp;&amp; calling&quot;&gt;  //状态参数---called:接收方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;    //挂断</span><br><span class="line">    &lt;img @click=&quot;acceptCall&quot; src=&quot;/accept.svg&quot;/&gt;//接听</span><br><span class="line"></span><br><span class="line">    &lt;button @click=&quot;callRemote&quot;&gt;发起视频&lt;/button&gt;</span><br><span class="line">    &lt;button @click=&quot;hangUp&quot;&gt;挂断视频&lt;/button&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><blockquote><p><strong>不难发现我们是依靠状态参数来控制页面显示的</strong></p></blockquote><p><strong>本项目参数表如下</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const called = ref&lt;boolean&gt;(false) // 是否是接收方</span><br><span class="line">const caller = ref&lt;boolean&gt;(false) // 是否是发起方</span><br><span class="line">const calling = ref&lt;boolean&gt;(false) // 呼叫中</span><br><span class="line">const communicating = ref&lt;boolean&gt;(false) // 视频通话中</span><br><span class="line">const localVideo = ref&lt;HTMLVideoElement&gt;() // video标签实例，播放本人的视频</span><br><span class="line">const remoteVideo = ref&lt;HTMLVideoElement&gt;() // video标签实例，播放对方的视频</span><br><span class="line">const localStream = ref&lt;MediaStream&gt;() // 本地流</span><br><span class="line"></span><br><span class="line">const roomId = &#x27;001&#x27; // 房间ID</span><br></pre></td></tr></table></figure><p><strong>顺便带上实例创建</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const socket = ref&lt;Socket&gt;() // Socket实例</span><br><span class="line">const peer = ref&lt;any&gt;() // RTCPeerConnection实例</span><br></pre></td></tr></table></figure><p><strong>而对于我们这个项目，</strong><code>房间</code>的概念就很简单</p><blockquote><p><strong>A (左) 向B (右) 发起接通请求，在B接收请求后，双方都将加入这个视频通话的”房间”</strong></p><p><strong>房间 可以通过自主分配id划分，每个房间也可以加入很多用户 (如直播系统)</strong></p><p><strong>服务端含有加入房间的操纵代码 sock.join(Id)</strong></p></blockquote><h3 id="加入房间请求"><a href="#加入房间请求" class="headerlink" title="加入房间请求"></a>加入房间请求</h3><p><strong>前端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;connectionSuccess&#x27;, () =&gt; &#123;</span><br><span class="line">  console.log(&#x27;连接服务器成功...&#x27;);</span><br><span class="line">  sock.emit(&#x27;joinRoom&#x27;, roomId) // 前端发送加入房间事件</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>后端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;joinRoom&#x27;, (roomId) =&gt; &#123;</span><br><span class="line">  sock.join(roomId) // 加入房间</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="发起视频请求-1"><a href="#发起视频请求-1" class="headerlink" title="发起视频请求"></a>发起视频请求</h3><p><strong>A方按钮触发函数</strong></p><p><strong>前端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const callRemote = async () =&gt; &#123;</span><br><span class="line">    console.log(&#x27;发起视频&#x27;);// 状态更新</span><br><span class="line">    caller.value = true;// 发送方标记</span><br><span class="line">    calling.value = true;// 呼叫中</span><br><span class="line">    await getLocalStream()// 获取本地音视频流函数</span><br><span class="line">    socket.value?.emit(&#x27;callRemote&#x27;, roomId)// 发送视频请求事件</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>后端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;callRemote&#x27;, (roomId) =&gt; &#123;// 收到发送方的视频请求事件</span><br><span class="line">    io.to(roomId).emit(&#x27;receiveCall&#x27;)// 向这个房间中的所有人广播事件receiveCall</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>前端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;receiveCall&#x27;, () =&gt; &#123;// 房间内所有接收方监听到视频请求事件</span><br><span class="line">    if (!caller.value) &#123;// 非发起方</span><br><span class="line">        calling.value = true// 呼叫中</span><br><span class="line">        called.value = true// 接收方标记</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p><strong>此时A(发起)方启动摄像头和麦克风，并等待对方接听</strong></p><p><strong>B(接收)方出现 接听&#x2F;挂断 按钮</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div v-if=&quot;caller &amp;&amp; calling&quot;&gt;  //状态参数---caller:发送方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;等待对方接听...&lt;/p&gt;</span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;    //挂断</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div v-if=&quot;called &amp;&amp; calling&quot;&gt;  //状态参数---called:接收方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;    //挂断</span><br><span class="line">    &lt;img @click=&quot;acceptCall&quot; src=&quot;/accept.svg&quot;/&gt;//接听</span><br><span class="line"></span><br><span class="line">    &lt;button @click=&quot;callRemote&quot;&gt;发起视频&lt;/button&gt;//发起</span><br><span class="line">    &lt;button @click=&quot;hangUp&quot;&gt;挂断视频&lt;/button&gt;   //挂断</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><h3 id="接收-挂断-视频"><a href="#接收-挂断-视频" class="headerlink" title="接收 &#x2F; 挂断 视频"></a>接收 &#x2F; 挂断 视频</h3><p><em><strong>趁着现在，我们添上其他按钮绑定的函数</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 挂断视频</span><br><span class="line">const hangUp = () =&gt; &#123;</span><br><span class="line">    socket.value.emit(&#x27;hangUp&#x27;, roomId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 接收视频请求（接收方）</span><br><span class="line">const acceptCall = () =&gt; &#123;</span><br><span class="line">    socket.value.emit(&#x27;acceptCall&#x27;, roomId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em><strong>接着来看后端怎么处理</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 挂断视频</span><br><span class="line">sock.on(&#x27;hangUp&#x27;, (roomId) =&gt; &#123;</span><br><span class="line">    io.to(roomId).emit(&#x27;hangUp&#x27;)// 向Id房间内所有人广播这个事件</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 接收视频请求</span><br><span class="line">sock.on(&#x27;acceptCall&#x27;, (roomId) =&gt; &#123;</span><br><span class="line">    io.to(roomId).emit(&#x27;acceptCall&#x27;)// 向Id房间内所有人广播这个事件</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><em><strong>返回前端，处理我们接收到的 hangUp || acceptCall</strong></em></p><p><strong>挂断视频</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;hangUp&#x27;, () =&gt; &#123;</span><br><span class="line">    reset()// 重置状态</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>重置状态函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const reset = () =&gt; &#123;</span><br><span class="line">    called.value = false</span><br><span class="line">    caller.value = false</span><br><span class="line">    calling.value = false</span><br><span class="line">    communicating.value = false</span><br><span class="line">    peer.value = null</span><br><span class="line">    localVideo.value!.srcObject = null // 关闭本地视频</span><br><span class="line">    remoteVideo.value!.srcObject = null // 关闭远程视频</span><br><span class="line">    localStream.value?.getTracks()[0].stop() // 关闭本地流</span><br><span class="line">    // localStream.value = undefined // 关闭本地流（相同效果）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>接受视频请求</strong></p><p><strong>而这个就变复杂了</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;acceptCall&#x27;, async () =&gt; &#123;</span><br><span class="line">    if (caller.value) &#123;// 发送方</span><br><span class="line">        peer.value = new RTCPeerConnection()// 创建RTCPeerConnection对象</span><br><span class="line">        peer.value.addStream(localStream.value)// 添加本地音视频流</span><br><span class="line"></span><br><span class="line">        peer.value.onicecandidate = (event: any) =&gt; &#123;// 获取candidate信息</span><br><span class="line">            if (event.candidate) &#123;</span><br><span class="line">                sock.emit(&#x27;sendCandidate&#x27;, &#123; roomId, candidate: event.candidate &#125;)// 向服务器发送candidate信息</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取对方的音视频流</span><br><span class="line">        peer.value.onaddstream = (event: any) =&gt; &#123;</span><br><span class="line">            calling.value = false</span><br><span class="line">            communicating.value = true</span><br><span class="line">            // 拿到对方的视频流</span><br><span class="line">            remoteVideo.value!.srcObject = event.stream</span><br><span class="line">            remoteVideo.value!.play()</span><br><span class="line">        &#125;</span><br><span class="line">        // 生成offer</span><br><span class="line">        const offer = await peer.value.createOffer(&#123;</span><br><span class="line">            offerToReceiveAudio: true, // 是否接收对方的音频</span><br><span class="line">            offerToReceiveVideo: true, // 是否接收对方的视频</span><br><span class="line">        &#125;)</span><br><span class="line">        await peer.value.setLocalDescription(offer)// 设置本地描述的offer</span><br><span class="line">        sock.emit(&#x27;sendOffer&#x27;, &#123; roomId, offer &#125;)// 发送offer</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="交换-SDP-信息和-candidate-信息"><a href="#交换-SDP-信息和-candidate-信息" class="headerlink" title="交换 SDP 信息和 candidate 信息"></a>交换 SDP 信息和 candidate 信息</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><em><strong>SDP</strong></em> ：WebRTC的一种协议，用于描述<strong>设备支持的媒体格式</strong></p><p><em><strong>candidate</strong></em> ：网络信息</p><p><strong>媒体协商</strong> ：交换SDP</p><p><strong>ICE</strong> ：WebRTC的通信机制</p><p><img src="/upload/image-20250113161100817.png" alt="image-20250113161100817.png"></p><p><strong>工作原理</strong></p><blockquote><p><strong>1.双方收集本地网络地址（分 共有 | 私有）+ STUN 和 TURN 服务器获取候选地址</strong></p><p><strong>2.双方通过信令服务器交换这些候选地址</strong></p><p><strong>3.双方使用候选地址进行连接测试，确定最佳的可用地址，开始实时音视频通话</strong></p></blockquote><h3 id="媒体协商"><a href="#媒体协商" class="headerlink" title="媒体协商"></a>媒体协商</h3><p><strong>接下来是最重要的信令交换步骤（WebRTC核心）</strong></p><p><strong>主要用到以下方法</strong></p><p><strong>媒体协商</strong></p><blockquote><p><strong>createOffer</strong></p><p><strong>createAnswer</strong></p><p><strong>setLocalDesccription</strong></p><p><strong>setRemoteDesccription</strong></p></blockquote><p><strong>重要事件</strong></p><blockquote><p><strong>onicecandidate</strong></p><p><strong>onaddstream</strong></p></blockquote><p><img src="/upload/image-20250113163924170.png" alt="image-20250113163924170.png"></p><p><strong>步骤流程重绘（可以对标号有个印象）</strong></p><blockquote><p><strong>预告：所有函数均在前端实现，后端起到向前端广播作用</strong></p></blockquote><p><img src="/upload/IMG_20250205_220254.jpg" alt="IMG_20250205_220254.jpg"></p><p><strong>紧接着接收方接收到对方同意的消息</strong></p><h3 id="信息交换全程"><a href="#信息交换全程" class="headerlink" title="信息交换全程"></a>信息交换全程</h3><p><strong>前端（发送方）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;acceptCall&#x27;, async () =&gt; &#123;</span><br><span class="line">    if (caller.value) &#123;// 发送方</span><br><span class="line">        peer.value = new RTCPeerConnection()// 创建RTCPeerConnection对象</span><br><span class="line">        peer.value.addStream(localStream.value)// 添加本地音视频流</span><br><span class="line"></span><br><span class="line">        // 获取candidate信息</span><br><span class="line">        peer.value.onicecandidate = (event: any) =&gt; &#123;</span><br><span class="line">            if (event.candidate) &#123;</span><br><span class="line">                // 向服务器发送candidate信息</span><br><span class="line">                sock.emit(&#x27;sendCandidate&#x27;, &#123; roomId, candidate: event.candidate &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取对方的音视频流</span><br><span class="line">        peer.value.onaddstream = (event: any) =&gt; &#123;</span><br><span class="line">            calling.value = false</span><br><span class="line">            communicating.value = true</span><br><span class="line">            // 拿到对方的视频流</span><br><span class="line">            remoteVideo.value!.srcObject = event.stream</span><br><span class="line">            remoteVideo.value!.play()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ---①---</span><br><span class="line">        const offer = await peer.value.createOffer(&#123;// 生成offer</span><br><span class="line">            offerToReceiveAudio: true, // 是否接收对方的音频</span><br><span class="line">            offerToReceiveVideo: true, // 是否接收对方的视频</span><br><span class="line">        &#125;)</span><br><span class="line">        ---②---</span><br><span class="line">        await peer.value.setLocalDescription(offer)// 设置本地描述的offer</span><br><span class="line">        ---③---</span><br><span class="line">        sock.emit(&#x27;sendOffer&#x27;, &#123; roomId, offer &#125;)// 发送offer !!!注意,这里offer已经当参数传过去了!!!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>后端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;sendCandidate&#x27;, (&#123; roomId, candidate &#125;) =&gt; &#123;</span><br><span class="line">    io.to(roomId).emit(&#x27;receiveCandidate&#x27;, candidate)// 向这个房间里所有人广播candidate信息</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;sendOffer&#x27;, (&#123; roomId, offer &#125;) =&gt; &#123;// !!!offer在这里!!!</span><br><span class="line">    io.to(roomId).emit(&#x27;sendOffer&#x27;, offer)// 向这个房间里所有人广播offer信息 &amp;&amp; 向接收方发送这个offer</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>前端（接收方）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;sendOffer&#x27;, async (offer: any) =&gt; &#123;// !!!offer传回前端(判断被标注的接收方)!!!</span><br><span class="line">    if (called.value) &#123;// 接收方</span><br><span class="line">        const stream = await getLocalStream()// 获取本地音视频流</span><br><span class="line">        peer.value = new RTCPeerConnection()// 接收方创建自己的RTCPeerConnection对象</span><br><span class="line">        peer.value.addStream(stream)// 添加本地音视频流</span><br><span class="line"></span><br><span class="line">        peer.value.onicecandidate = (event: any) =&gt; &#123;// 获取candidate信息</span><br><span class="line">            if (event.candidate) &#123;</span><br><span class="line">                // 向服务器发送candidate信息</span><br><span class="line">                sock.emit(&#x27;sendCandidate&#x27;, &#123; roomId, candidate: event.candidate &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取对方的音视频流</span><br><span class="line">        peer.value.onaddstream = (event: any) =&gt; &#123;</span><br><span class="line">            calling.value = false</span><br><span class="line">            communicating.value = true</span><br><span class="line">            // 拿到对方的视频流</span><br><span class="line">            remoteVideo.value!.srcObject = event.stream</span><br><span class="line">            remoteVideo.value!.play()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ---④---</span><br><span class="line">        await peer.value.setRemoteDescription(offer)// 设置远端描述信息</span><br><span class="line"></span><br><span class="line">        ---⑤---</span><br><span class="line">        const answer = await peer.value.createAnswer()// 生成answer</span><br><span class="line">        ---⑥---</span><br><span class="line">        await peer.value.setLocalDescription(answer)// 设置本地描述信息</span><br><span class="line">        ---⑦---</span><br><span class="line">        sock.emit(&#x27;sendAnswer&#x27;, &#123; roomId, answer &#125;)// 发送answer !!!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>后端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;sendCandidate&#x27;, (&#123; roomId, candidate &#125;) =&gt; &#123;// !!!</span><br><span class="line">    io.to(roomId).emit(&#x27;receiveCandidate&#x27;, candidate)// 向这个房间里所有人广播candidate信息</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;sendAnswer&#x27;, (&#123; roomId, answer &#125;) =&gt; &#123;</span><br><span class="line">    io.to(roomId).emit(&#x27;receiveAnswer&#x27;, answer)// 向这个房间里所有人广播answer信息 &amp;&amp; 向接收方发送这个answer</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>前端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;receiveAnswer&#x27;, (answer: any) =&gt; &#123;</span><br><span class="line">    if (caller.value) &#123;// 发送方</span><br><span class="line">        ---⑧---</span><br><span class="line">        peer.value.setRemoteDescription(answer)// 设置远端描述信息</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>为了让文章不那么乱，最后再补一下</strong><em>candidate</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.on(&#x27;receiveCandidate&#x27;, async (candidate: any) =&gt; &#123;</span><br><span class="line">    await peer.value.addIceCandidate(candidate) // 添加candidate信息</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p><strong>一路下来是不是逻辑非常清晰明了😁 (bushi)</strong></p></blockquote><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p><strong>前端 (App.vue)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">import &#123; ref, onMounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; io, Socket &#125; from &#x27;socket.io-client&#x27;</span><br><span class="line"></span><br><span class="line">const roomId = &#x27;001&#x27; // 房间ID</span><br><span class="line"></span><br><span class="line">const called = ref&lt;boolean&gt;(false) // 是否是接收方</span><br><span class="line">const caller = ref&lt;boolean&gt;(false) // 是否是发起方</span><br><span class="line">const calling = ref&lt;boolean&gt;(false) // 呼叫中</span><br><span class="line">const communicating = ref&lt;boolean&gt;(false) // 视频通话中</span><br><span class="line">const localVideo = ref&lt;HTMLVideoElement&gt;() // video标签实例，播放本人的视频</span><br><span class="line">const remoteVideo = ref&lt;HTMLVideoElement&gt;() // video标签实例，播放对方的视频</span><br><span class="line">const localStream = ref&lt;MediaStream&gt;() // 本地流</span><br><span class="line">const socket = ref&lt;Socket&gt;() // Socket实例</span><br><span class="line">const peer = ref&lt;any&gt;() // RTCPeerConnection实例</span><br><span class="line"></span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">    const sock = io(&#x27;localhost:3001&#x27;) // 连接服务器</span><br><span class="line"></span><br><span class="line">    // 连接成功</span><br><span class="line">    sock.on(&#x27;connectionSuccess&#x27;, () =&gt; &#123;</span><br><span class="line">        // 进入房间</span><br><span class="line">        sock.emit(&#x27;joinRoom&#x27;, roomId)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 接收方监听收到视频请求事件</span><br><span class="line">    sock.on(&#x27;receiveCall&#x27;, () =&gt; &#123;</span><br><span class="line">        if (!caller.value) &#123;</span><br><span class="line">            calling.value = true</span><br><span class="line">            called.value = true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 发送方收到同意视频事件</span><br><span class="line">    sock.on(&#x27;acceptCall&#x27;, async () =&gt; &#123;</span><br><span class="line">        if (caller.value) &#123;</span><br><span class="line">            // 发送方</span><br><span class="line">            // 创建RTCPeerConnection对象</span><br><span class="line">            peer.value = new RTCPeerConnection()</span><br><span class="line">            // 添加本地音视频流</span><br><span class="line">            peer.value.addStream(localStream.value)</span><br><span class="line"></span><br><span class="line">            // 获取candidate信息</span><br><span class="line">            peer.value.onicecandidate = (event: any) =&gt; &#123;</span><br><span class="line">                if (event.candidate) &#123;</span><br><span class="line">                    // 向服务器发送candidate信息</span><br><span class="line">                    sock.emit(&#x27;sendCandidate&#x27;, &#123; roomId, candidate: event.candidate &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 获取对方的音视频流</span><br><span class="line">            peer.value.onaddstream = (event: any) =&gt; &#123;</span><br><span class="line">                calling.value = false</span><br><span class="line">                communicating.value = true</span><br><span class="line">                // 拿到对方的视频流</span><br><span class="line">                remoteVideo.value!.srcObject = event.stream</span><br><span class="line">                remoteVideo.value!.play()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 生成offer</span><br><span class="line">            const offer = await peer.value.createOffer(&#123;</span><br><span class="line">                offerToReceiveAudio: true, // 是否接收对方的音频</span><br><span class="line">                offerToReceiveVideo: true, // 是否接收对方的视频</span><br><span class="line">            &#125;)</span><br><span class="line">            // 设置本地描述的offer</span><br><span class="line">            await peer.value.setLocalDescription(offer)</span><br><span class="line">            // 发送offer</span><br><span class="line">            sock.emit(&#x27;sendOffer&#x27;, &#123; roomId, offer &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 接收方收到offer</span><br><span class="line">    sock.on(&#x27;sendOffer&#x27;, async (offer: any) =&gt; &#123;</span><br><span class="line">        if (called.value) &#123;</span><br><span class="line">            const stream = await getLocalStream()</span><br><span class="line"></span><br><span class="line">            // 接收方创建自己的RTCPeerConnection对象</span><br><span class="line">            peer.value = new RTCPeerConnection()</span><br><span class="line"></span><br><span class="line">            // 添加本地音视频流</span><br><span class="line">            peer.value.addStream(stream)</span><br><span class="line"></span><br><span class="line">            // 获取candidate信息</span><br><span class="line">            peer.value.onicecandidate = (event: any) =&gt; &#123;</span><br><span class="line">                if (event.candidate) &#123;</span><br><span class="line">                    // 向服务器发送candidate信息</span><br><span class="line">                    sock.emit(&#x27;sendCandidate&#x27;, &#123; roomId, candidate: event.candidate &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 获取对方的音视频流</span><br><span class="line">            peer.value.onaddstream = (event: any) =&gt; &#123;</span><br><span class="line">                // 拿到对方的视频流</span><br><span class="line">                calling.value = false</span><br><span class="line">                communicating.value = true</span><br><span class="line">                remoteVideo.value!.srcObject = event.stream</span><br><span class="line">                remoteVideo.value!.play()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 设置远端描述信息</span><br><span class="line">            await peer.value.setRemoteDescription(offer)</span><br><span class="line"></span><br><span class="line">            // 生成answer</span><br><span class="line">            const answer = await peer.value.createAnswer()</span><br><span class="line">            // 设置本地描述信息</span><br><span class="line">            await peer.value.setLocalDescription(answer)</span><br><span class="line">            // 发送answer</span><br><span class="line">            sock.emit(&#x27;sendAnswer&#x27;, &#123; roomId, answer &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 发送方收到接收方的answer</span><br><span class="line">    sock.on(&#x27;receiveAnswer&#x27;, (answer: any) =&gt; &#123;</span><br><span class="line">        if (caller.value) &#123;</span><br><span class="line">            // 设置远端描述信息</span><br><span class="line">            peer.value.setRemoteDescription(answer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 接收candidate信息</span><br><span class="line">    sock.on(&#x27;receiveCandidate&#x27;, async (candidate: any) =&gt; &#123;</span><br><span class="line">        await peer.value.addIceCandidate(candidate) // 添加candidate信息</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 收到挂断视频请求</span><br><span class="line">    sock.on(&#x27;hangUp&#x27;, () =&gt; &#123;</span><br><span class="line">        reset()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    socket.value = sock</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 获取本地音视频流</span><br><span class="line">const getLocalStream = async () =&gt; &#123;</span><br><span class="line">    // 获取音视频流</span><br><span class="line">    const stream = await navigator.mediaDevices.getUserMedia(&#123;</span><br><span class="line">        video: true,</span><br><span class="line">        audio: true,</span><br><span class="line">    &#125;)</span><br><span class="line">    // 将媒体流设置到 video 标签上播放</span><br><span class="line">    localVideo.value!.srcObject = stream</span><br><span class="line">    // 播放音视频流</span><br><span class="line">    localVideo.value!.play()</span><br><span class="line">    // 存储本地流</span><br><span class="line">    localStream.value = stream</span><br><span class="line"></span><br><span class="line">    return stream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 发起视频请求（发起方）</span><br><span class="line">const callRemote = async () =&gt; &#123;</span><br><span class="line">    if (calling.value || communicating.value) &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    calling.value = true</span><br><span class="line">    // 获取本地音视频流</span><br><span class="line">    await getLocalStream()</span><br><span class="line"></span><br><span class="line">    // 向服务器发送发起视频请求的事件</span><br><span class="line">    caller.value = true</span><br><span class="line">    socket.value.emit(&#x27;callRemote&#x27;, roomId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 接收视频请求（接受方）</span><br><span class="line">const acceptCall = () =&gt; &#123;</span><br><span class="line">    // 向服务器发送接受视频请求的事件</span><br><span class="line">    socket.value.emit(&#x27;acceptCall&#x27;, roomId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 挂断视频</span><br><span class="line">const hangUp = () =&gt; &#123;</span><br><span class="line">    socket.value.emit(&#x27;hangUp&#x27;, roomId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 状态重置</span><br><span class="line">const reset = () =&gt; &#123;</span><br><span class="line">    called.value = false</span><br><span class="line">    caller.value = false</span><br><span class="line">    calling.value = false</span><br><span class="line">    communicating.value = false</span><br><span class="line">    peer.value = null</span><br><span class="line">    localVideo.value!.srcObject = null // 关闭本地视频</span><br><span class="line">    remoteVideo.value!.srcObject = null // 关闭远程视频</span><br><span class="line">    localStream.value?.getTracks()[0].stop() // 关闭本地流</span><br><span class="line">    // localStream.value = undefined // 关闭本地流</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>后端 (index.js)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">const socket = require(&#x27;socket.io&#x27;)</span><br><span class="line">const http = require(&#x27;http&#x27;)</span><br><span class="line"></span><br><span class="line">const server = http.createServer()</span><br><span class="line"></span><br><span class="line">const io = socket(server, &#123;</span><br><span class="line">    cors: &#123;</span><br><span class="line">        origin: &#x27;*&#x27;, // 配置跨域</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">io.on(&#x27;connection&#x27;, (sock) =&gt; &#123;</span><br><span class="line">    console.log(&#x27;连接成功...&#x27;)</span><br><span class="line"></span><br><span class="line">    // 向客户端发送连接成功的消息</span><br><span class="line">    sock.emit(&#x27;connectionSuccess&#x27;)</span><br><span class="line"></span><br><span class="line">    // 监听客户端进入房间的事件</span><br><span class="line">    sock.on(&#x27;joinRoom&#x27;, (roomId) =&gt; &#123;</span><br><span class="line">        // 加入房间</span><br><span class="line">        sock.join(roomId)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 收到发送方的视频请求事件</span><br><span class="line">    sock.on(&#x27;callRemote&#x27;, (roomId) =&gt; &#123;</span><br><span class="line">        // 向这个房间中的人广播这个事件</span><br><span class="line">        io.to(roomId).emit(&#x27;receiveCall&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 收到接收方的同意视频事件</span><br><span class="line">    sock.on(&#x27;acceptCall&#x27;, (roomId) =&gt; &#123;</span><br><span class="line">        // 向这个房间中的人广播这个事件</span><br><span class="line">        io.to(roomId).emit(&#x27;acceptCall&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 收到发送方的offer</span><br><span class="line">    sock.on(&#x27;sendOffer&#x27;, (&#123; roomId, offer &#125;) =&gt; &#123;</span><br><span class="line">        // 向接收方发送这个offer</span><br><span class="line">        io.to(roomId).emit(&#x27;sendOffer&#x27;, offer)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 收到接收方的answer</span><br><span class="line">    sock.on(&#x27;sendAnswer&#x27;, (&#123; roomId, answer &#125;) =&gt; &#123;</span><br><span class="line">        // 向这个房间中的人广播这个事件</span><br><span class="line">        io.to(roomId).emit(&#x27;receiveAnswer&#x27;, answer)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 收到发送方的candidate信息</span><br><span class="line">    sock.on(&#x27;sendCandidate&#x27;, (&#123; roomId, candidate &#125;) =&gt; &#123;</span><br><span class="line">        // 向这个房间中的人广播candidate信息</span><br><span class="line">        io.to(roomId).emit(&#x27;receiveCandidate&#x27;, candidate)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 收到挂断视频请求</span><br><span class="line">    sock.on(&#x27;hangUp&#x27;, (roomId) =&gt; &#123;</span><br><span class="line">        // 向这个房间中的人广播这个事件</span><br><span class="line">        io.to(roomId).emit(&#x27;hangUp&#x27;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(3001, () =&gt; &#123;</span><br><span class="line">    console.log(&#x27;服务器启动成功&#x27;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="项目启动方式"><a href="#项目启动方式" class="headerlink" title="项目启动方式"></a>项目启动方式</h2><p><strong>后端启动服务</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm start</span><br></pre></td></tr></table></figure><p><strong>前端</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pnpm install</span><br><span class="line">pnpm run dev</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/TS%20+%20NodeJS%E5%AE%9E%E7%8E%B0axios/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/TS%20+%20NodeJS%E5%AE%9E%E7%8E%B0axios/</url>
      
        <content type="html"><![CDATA[<h1 id="TS-NodeJS实现axios"><a href="#TS-NodeJS实现axios" class="headerlink" title="TS + NodeJS实现axios"></a>TS + NodeJS实现axios</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/alexjoverm/typescript-library-starter.git ts-axios</span><br></pre></td></tr></table></figure><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><blockquote><p><strong>在浏览器端使用XMLHttpRequest对象通讯</strong></p><p><strong>Promise API</strong></p><p><strong>请求响应拦截器</strong></p><p><strong>请求数据和响应数据转换</strong></p><p><strong>请求的取消</strong></p><p><strong>JSON数据的自动转换</strong></p><p><strong>客户端防止XSRF</strong></p></blockquote><p><strong>框架工具</strong></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250129205459495.png?lastModify=1739868293" alt="image-20250129205459495"></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250129205721267.png?lastModify=1739868293" alt="image-20250129205721267"></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250129205345604.png?lastModify=1739868293" alt="image-20250129205345604"></p><h3 id="请求代码"><a href="#请求代码" class="headerlink" title="请求代码"></a>请求代码</h3><p><strong>axios最基本的操作</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line">    method: &#x27;get&#x27;,</span><br><span class="line">    url: &#x27;/simple/get&#x27;,</span><br><span class="line">    params: &#123;</span><br><span class="line">        a:1,</span><br><span class="line">        b:2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>创建入口文件</strong></p><p><code>index.ts</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function axios(config) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default axios</span><br></pre></td></tr></table></figure><p><code>xhr.ts</code></p><blockquote><p><code>xhr</code> 函数用于发送 HTTP 请求的工具函数，基于 XMLHttpRequest API 实现，并提供了一个简单的接口来配置和发送请求。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig &#125; from &#x27;./types&#x27;</span><br><span class="line"></span><br><span class="line">export default function xhr(config: AxiosRequestConfig) &#123;</span><br><span class="line">  const &#123; data = null, url, method = &#x27;get&#x27; &#125; = config// 解构设置默认值</span><br><span class="line">  const request = new XMLHttpRequest()// 实例化一个 XMLHttpRequest 对象 并赋值给 request 变量</span><br><span class="line">  request.open(method.toUpperCase(), url, true)// 调用 open 方法 并传入 method url true 三个参数 并将 method 转换为大写并赋值给 method,url. async:true</span><br><span class="line">  request.send(data)// 调用 send 方法 并传入 data 参数 并赋值给 request 变量</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250130164413743.png?lastModify=1739868293" alt="image-20250130164413743"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h2 id="webpack配置"><a href="#webpack配置" class="headerlink" title="webpack配置"></a>webpack配置</h2><blockquote><p><strong>webpack.config.js</strong></p><p><strong>整体导出一个对象，包含mode（开发模式），entry，output，module，resolve，plugins几个关键属性</strong></p></blockquote><h3 id="entry"><a href="#entry" class="headerlink" title="entry"></a><em>entry</em></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">entry: fs.readdirSync(__dirname).reduce((entries, dir) =&gt; &#123;</span><br><span class="line">    const fullDir = path.join(__dirname, dir)</span><br><span class="line">    const entry = path.join(fullDir, &#x27;app.ts&#x27;)</span><br><span class="line">    if (fs.statSync(fullDir).isDirectory() &amp;&amp; fs.existsSync(entry)) &#123;</span><br><span class="line">        entries[dir] = [&#x27;webpack-hot-middleware/client&#x27;, entry]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return entries</span><br><span class="line">&#125;, &#123;&#125;),</span><br></pre></td></tr></table></figure><blockquote><p><strong>entries收集了多个目录的入口文件 (app.ts) ，并将每个入口引入一个用于热更新的文件</strong></p><p><strong>entries是一个对象，key为目录名</strong></p></blockquote><h3 id="output"><a href="#output" class="headerlink" title="output"></a><em>output</em></h3><blockquote><p><strong>将entries的key打包成filename</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">    path: path.join(__dirname, &#x27;__build__&#x27;),</span><br><span class="line">    filename: &#x27;[name].js&#x27;,</span><br><span class="line">    publicPath: &#x27;/__build__/&#x27;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="module"><a href="#module" class="headerlink" title="module"></a><em>module</em></h3><blockquote><p><strong>rules定义一系列处理不同类型文件的规则</strong></p><p><strong>.ts :</strong><code>tslint-loader</code> 进行预处理 (包括类型检查)</p><p><strong>.tsx :</strong><code>transpileOnly: true</code> 只进行编译而不进行类型检查</p><p><strong>.css :</strong><code>style-loader</code> 将 CSS 注入到 DOM 中，<code>css-loader</code> 处理 CSS 文件中的 <code>@import</code> 和 <code>url()</code></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">module: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;</span><br><span class="line">            test: /\.ts$/,</span><br><span class="line">            enforce: &#x27;pre&#x27;,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &#x27;tslint-loader&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            test: /\.tsx?$/,</span><br><span class="line">            use: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: &#x27;ts-loader&#x27;,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        transpileOnly: true</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            test: /\.css$/,</span><br><span class="line">            use: [&#x27;style-loader&#x27;, &#x27;css-loader&#x27;]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a><em>resolve</em></h3><blockquote><p><strong>指定在导入模块时可以省略的文件扩展名，Webpack 会自动尝试这些扩展名。</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolve: &#123;</span><br><span class="line">    extensions: [&#x27;.ts&#x27;, &#x27;.tsx&#x27;, &#x27;.js&#x27;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a><em>plugins</em></h3><blockquote><p><strong>热更新 | 发生错误不打包文件</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugins: [new webpack.HotModuleReplacementPlugin(), new webpack.NoEmitOnErrorsPlugin()]</span><br></pre></td></tr></table></figure><h2 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h2><h3 id="处理url参数-params"><a href="#处理url参数-params" class="headerlink" title="处理url参数(params)"></a>处理url参数(params)</h3><blockquote><p>**核心思想：把 params 的 key&amp;value **<strong>解构拼接</strong>到 URL 上</p></blockquote><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210214938544.png?lastModify=1739868293" alt="image-20250210214938544"></p><p><code>helpers/url.ts</code></p><h4 id="解构URL-params"><a href="#解构URL-params" class="headerlink" title="解构URL -&gt; params"></a>解构URL -&gt; params</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export function bulidURL(url: string, params?: any): string &#123;//解构</span><br><span class="line">    ...</span><br><span class="line">    return url</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>需处理逻辑</strong></p><p><em>没有参数</em></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210215202014.png?lastModify=1739868293" alt="image-20250210215202014"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (!params) &#123;</span><br><span class="line">    // 没有参数 直接返回 url</span><br><span class="line">    return url</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解构params-key-value"><a href="#解构params-key-value" class="headerlink" title="解构params -&gt; key&#x2F;value"></a>解构params -&gt; key&#x2F;value</h4><p><strong>params是一个包含请求参数的对象</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//例</span><br><span class="line">const params = &#123;</span><br><span class="line">  name: &#x27;John&#x27;,</span><br><span class="line">  age: 30,</span><br><span class="line">  hobbies: [&#x27;reading&#x27;, &#x27;coding&#x27;]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>具体代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const parts: string[] = [] // 存放参数的数组</span><br><span class="line"></span><br><span class="line">Object.keys(params).forEach(key =&gt; &#123; // key 依次取到 &#x27;name&#x27;, &#x27;age&#x27;, &#x27;hobbies&#x27; 等值</span><br><span class="line">    const val = params[key] // 对象key值所对应的value</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><em>value 为 null 或 undefined</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (val === null || typeof val === &#x27;undefined&#x27;) &#123;</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>value</em> 为 <em>数组</em></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210214959177.png?lastModify=1739868293" alt="image-20250210214959177"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let values = [] // 定义 values 变量</span><br><span class="line"></span><br><span class="line">if (Array.isArray(val)) &#123;// 如果 value 为数组 直接赋值给 values</span><br><span class="line">    values = val</span><br><span class="line">    key += &#x27;[]&#x27; // 键名后面添加一个 []</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    values = [val] // 赋值给 values</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>value</em> 为 <em>Data</em> | <em>字符串</em> | <em>对象</em></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210215112025.png?lastModify=1739868293" alt="image-20250210215112025"></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210215135428.png?lastModify=1739868293" alt="image-20250210215135428"></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210215027145.png?lastModify=1739868293" alt="image-20250210215027145"></p><p><strong>helpers&#x2F;util.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const toString = Object.prototype.toString</span><br><span class="line">export function isDate(val: any): val is Date &#123;</span><br><span class="line">    return toString.call(val) === &#x27;[object Date]&#x27;</span><br><span class="line">&#125;</span><br><span class="line">export function isObject(val: any): val is Object &#123;</span><br><span class="line">    return val !== null &amp;&amp; typeof val === &#x27;object&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>再回来</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import &#123; isDate, isObject &#125; from &#x27;./util&#x27;</span><br><span class="line">function encode(val: string): string &#123;</span><br><span class="line">  return encodeURIComponent(val)</span><br><span class="line">    .replace(/%40/g, &#x27;@&#x27;)</span><br><span class="line">    .replace(/%3A/gi, &#x27;:&#x27;)</span><br><span class="line">    .replace(/%24/g, &#x27;$&#x27;)</span><br><span class="line">    .replace(/%2C/gi, &#x27;,&#x27;)</span><br><span class="line">    .replace(/%20/g, &#x27;+&#x27;)</span><br><span class="line">    .replace(/%5B/gi, &#x27;[&#x27;)</span><br><span class="line">    .replace(/%5D/gi, &#x27;]&#x27;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">values.forEach(val =&gt; &#123; // 遍历 values</span><br><span class="line">    if (isDate(val)) &#123; // value 为日期</span><br><span class="line">        val = val.toISOString() // 转换为 ISO 格式赋值给 val</span><br><span class="line">    &#125; else if (isObject(val)) &#123; // value 为对象</span><br><span class="line">        val = JSON.stringify(val) // 转换为字符串赋值给 val</span><br><span class="line">    &#125;</span><br><span class="line">    parts.push(`$&#123;encode(key)&#125;=$&#123;encode(val)&#125;`) // 特殊字符转码赋值给 parts</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>拼装成URL</strong></p><blockquote><p><strong>parts.join(‘&amp;’) 效果</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;name=John&#x27;, &#x27;age=30&#x27;, &#x27;hobbies[]=reading&#x27;, &#x27;hobbies[]=coding&#x27;]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;name=John&amp;age=30&amp;hobbies[]=reading&amp;hobbies[]=coding&#x27;</span><br></pre></td></tr></table></figure></blockquote><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210215213939.png?lastModify=1739868293" alt="image-20250210215213939"></p><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250210215227134.png?lastModify=1739868293" alt="image-20250210215227134"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">let serializedParams = parts.join(&#x27;&amp;&#x27;) // 将 parts 数组中的所有元素连接成一个字符串，并使用 &amp; 作为分隔符</span><br><span class="line">if (serializedParams) &#123; // 如果 serializedParams 不为空 则拼接 url</span><br><span class="line">    const markIndex = url.indexOf(&#x27;#&#x27;) // 查找 URL 中是否存在 # 符号 返回 # 符号在 URL 中的位置索引</span><br><span class="line">    if (markIndex !== -1) &#123;</span><br><span class="line">        url = url.slice(0, markIndex) // 使用slice方法将URL截取到哈希部分之前，从而去除哈希部分</span><br><span class="line">    &#125;</span><br><span class="line">    url += (url.indexOf(&#x27;?&#x27;) === -1 ? &#x27;?&#x27; : &#x27;&amp;&#x27;) + serializedParams // 确保URL中的查询参数?存在</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理body数据"><a href="#处理body数据" class="headerlink" title="处理body数据"></a>处理body数据</h3><p><strong>helpers&#x2F;util.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const toString = Object.prototype.toString</span><br><span class="line">export function isDate(val: any): val is Date &#123; // 判断是否为日期</span><br><span class="line">  return toString.call(val) === &#x27;[object Date]&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// export function isObject(val: any): val is Object &#123;  // 判断是否为对象</span><br><span class="line">//   return val !== null &amp;&amp; typeof val === &#x27;object&#x27;</span><br><span class="line">// &#125;</span><br><span class="line"></span><br><span class="line">export function isPlainObject(val: any): val is Object &#123; // 判断是否为普通对象</span><br><span class="line">  return toString.call(val) === &#x27;[object Object]&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>helpers&#x2F;data.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import &#123; isPlainObject &#125; from &#x27;./util&#x27;</span><br><span class="line"></span><br><span class="line">export function transformRequest(data: any): any &#123;</span><br><span class="line">  if (isPlainObject(data)) &#123;</span><br><span class="line">    return JSON.stringify(data)</span><br><span class="line">  &#125;</span><br><span class="line">  return data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function processConfig(config: AxiosRequestConfig): void &#123; // 处理 config</span><br><span class="line">  config.url = transformURL(config)</span><br><span class="line">  config.data = transformRequestData(config)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformURL(config: AxiosRequestConfig): string &#123; // 处理 url 返回拼接后的 url</span><br><span class="line">  const &#123; url, params &#125; = config</span><br><span class="line">  return bulidURL(url, params)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformRequestData(config: AxiosRequestConfig): void &#123; // 处理 data</span><br><span class="line">  config.data = transformRequest(config.data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理header"><a href="#处理header" class="headerlink" title="处理header"></a>处理header</h3><blockquote><p><strong>headers一般传递诸如认证信息、内容类型等元数据给服务器</strong></p></blockquote><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250212030911535.png?lastModify=1739868293" alt="image-20250212030911535"></p><p><strong>helpers&#x2F;header.ts</strong></p><blockquote><p><strong>处理headers</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export function processHeaders(headers: any, data: any): any &#123;// processHeaders 函数接收 headers 和 data 两个参数</span><br><span class="line">    normalizeHeaderName(headers, &#x27;Content-Type&#x27;)// 调用 normalizeHeaderName 函数将 headers 的 Content-Type 属性名规范化</span><br><span class="line">    if (isPlainObject(data)) &#123;// 如果 data 是一个普通对象</span><br><span class="line">        if (headers &amp;&amp; !headers[&#x27;Content-Type&#x27;]) &#123;// 如果 headers 不存在 Content-Type 属性</span><br><span class="line">            headers[&#x27;Content-Type&#x27;] = &#x27;application/json;charset=utf-8&#x27;// 设置 Content-Type 属性为 application/json;charset=utf-8</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>Content-Type</code> 是HTTP请求头的一部分，用于指示实体主体（即请求或响应的正文部分）的数据类型。它告诉接收方如何解析接收到的数据。例如，当发送JSON格式的数据时，通常会将 <code>Content-Type</code> 设置为 <code>application/json</code>，这样接收方就知道应该以JSON的形式来解析数据</p></blockquote><p><strong>辅助函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function normalizeHeaderName(headers: any, normalizedName: string): void &#123;// normalizeHeaderName 函数接收 headers 和 normalizedName 两个参数</span><br><span class="line">    if (!headers) &#123;// 如果 headers 不存在</span><br><span class="line">        return// 直接返回</span><br><span class="line">    &#125; </span><br><span class="line">    Object.keys(headers).forEach(name =&gt; &#123;// 遍历 headers 的所有属性</span><br><span class="line">        if (name !== normalizedName &amp;&amp; name.toUpperCase() === normalizedName.toUpperCase()) &#123;// 如果属性名不等于 normalizedName 并且属性名的大写形式等于 normalizedName 的大写形式</span><br><span class="line">            headers[normalizedName] = headers[name]// 将 headers 的属性名设置为 normalizedName (content-type -&gt; Content-Type)</span><br><span class="line">            delete headers[name]// 删除 headers 的属性名</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    return headers// 返回 headers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>types&#x2F;index.ts 加入 headers</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosRequestConfig &#123;</span><br><span class="line">  url: string</span><br><span class="line">  method?: Method</span><br><span class="line">  data?: any</span><br><span class="line">  params?: any</span><br><span class="line">  headers?: any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>index.ts 增添处理逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function processConfig(config: AxiosRequestConfig): void &#123;// 处理 config</span><br><span class="line">  config.url = transformURL(config)</span><br><span class="line">  config.headers = transformHeaders(config)// 先处理 headers</span><br><span class="line">  config.data = transformRequestData(config)// 再处理 data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformHeaders(config: AxiosRequestConfig): any &#123;</span><br><span class="line">  // 处理 headers 调用 processHeaders 方法</span><br><span class="line">  const &#123; headers = &#123;&#125;, data &#125; = config</span><br><span class="line">  return processHeaders(headers, data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>xhr.ts 添加header处理逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export default function xhr(config: AxiosRequestConfig): void &#123;</span><br><span class="line">  const &#123; data = null, url, method = &#x27;get&#x27;, headers &#125; = config // 添加header解构</span><br><span class="line">  const request = new XMLHttpRequest() // 实例化一个 XMLHttpRequest 对象 并赋值给 request 变量</span><br><span class="line">  request.open(method.toUpperCase(), url, true) </span><br><span class="line">  </span><br><span class="line">  Object.keys(headers).forEach(name =&gt; &#123; // 遍历 headers 的所有属性</span><br><span class="line">    if (data=== null &amp;&amp; name.toLowerCase() === &#x27;content-type&#x27;) &#123;// 如果 data 为 null 并且属性名为 content-type</span><br><span class="line">      delete headers[name]// 删除 headers 的属性名</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">      request.setRequestHeader(name, headers[name])// 调用 setRequestHeader 方法 并传入 name headers[name] 两个参数 并赋值给 request 变量</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  request.send(data) // 调用 send 方法 并传入 data 参数 并赋值给 request 变量</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><blockquote><p><strong>这部分处理实现了</strong></p><p><strong>为Content-Type自动添加application&#x2F;json;charset&#x3D;UTF-8（告知服务端解析的是JSON数据）</strong></p></blockquote><h3 id="获取处理response"><a href="#获取处理response" class="headerlink" title="获取处理response"></a>获取处理response</h3><p><strong>types &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosRequestConfig &#123;//config接口</span><br><span class="line">  url: string</span><br><span class="line">  method?: Method</span><br><span class="line">  data?: any</span><br><span class="line">  params?: any</span><br><span class="line">  headers?: any</span><br><span class="line">  responseType?: XMLHttpRequestResponseType //新增</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface AxiosResponse &#123;//response接口</span><br><span class="line">  data: any</span><br><span class="line">  status: number</span><br><span class="line">  statusText: string</span><br><span class="line">  headers: any</span><br><span class="line">  config: AxiosRequestConfig</span><br><span class="line">  request: any</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface AxiosPromise extends Promise&lt;AxiosResponse&gt; &#123;//promise接口</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>xhr.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosPromise, AxiosResponse &#125; from &#x27;./types&#x27;</span><br><span class="line"></span><br><span class="line">export default function xhr(config: AxiosRequestConfig): AxiosPromise &#123;// xhr 函数接收一个 config 参数</span><br><span class="line">  return new Promise((resolve, reject) =&gt; // 返回一个 Promise 对象 并传入 resolve reject 两个参数</span><br><span class="line">    const &#123; data = null, url, method = &#x27;get&#x27;, headers, responseType &#125; = config // 解构赋值拿到变量</span><br><span class="line">    const request = new XMLHttpRequest() // 实例化一个 XMLHttpRequest 对象 并赋值给 request 变量</span><br><span class="line"></span><br><span class="line">    if (responseType) &#123;</span><br><span class="line">      request.responseType = responseType</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    request.open(method.toUpperCase(), url, true) // 调用 open 方法 并传入 method url true 三个参数 并将 method 转换为大写并赋值给 method,url. async:true异步</span><br><span class="line"></span><br><span class="line">    request.onreadystatechange = function handleLoad() &#123;// 调用 onreadystatechange 方法 并传入 handleLoad 函数 并赋值给 request 变量</span><br><span class="line">      if (request.readyState !== 4) &#123;// 4状态为正确接收到数据 (// 没有收到正确的响应)</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      const responseHeaders = request.getAllResponseHeaders() // 调用 getAllResponseHeaders 方法 并赋值给 responseHeaders 变量（后面要处理这个字符串）</span><br><span class="line">      const responseData = responseType &amp;&amp; responseType !== &#x27;text&#x27; ? request.response : request.responseText // 调用 responseText 方法 并赋值给 responseData 变量</span><br><span class="line">      const response: AxiosResponse = &#123;</span><br><span class="line">        data: responseData,</span><br><span class="line">        status: request.status,</span><br><span class="line">        statusText: request.statusText,</span><br><span class="line">        headers: responseHeaders,</span><br><span class="line">        config,</span><br><span class="line">        request</span><br><span class="line">      &#125;</span><br><span class="line">      resolve(response) // 调用 resolve 方法 并传入 response 参数</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object.keys(headers).forEach(name =&gt; &#123;// 遍历 headers 的所有属性</span><br><span class="line">      if (data === null &amp;&amp; name.toLowerCase() === &#x27;content-type&#x27;) &#123;// 如果 data 为 null 并且属性名为 content-type</span><br><span class="line">        delete headers[name] // 删除 headers 的属性名</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        request.setRequestHeader(name, headers[name]) // 调用 setRequestHeader 方法 并传入 name headers[name] 两个参数 并赋值给 request 变量</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    request.send(data) // 调用 send 方法 并传入 data 参数 并赋值给 request 变量</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosPromise &#125; from &#x27;./types&#x27;</span><br><span class="line"></span><br><span class="line">function axios(config: AxiosRequestConfig): AxiosPromise &#123;</span><br><span class="line">  // axios 函数接收一个 config 参数</span><br><span class="line">  processConfig(config)</span><br><span class="line">  return xhr(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getAllResponseHeaders</code>方法处理</p><p><strong>XMLHttpRequest 对象的 getAllResponseHeaders 方法获取到的值是如下字符串</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">date:Fri,05 Apr 2019 12:40:49 GMT</span><br><span class="line">etag: W/&quot;d-Ssxx4FRxEutDLwo2+xkkxKc4y0k&#x27;&#x27;</span><br><span class="line">connection: keep-alive</span><br><span class="line">x-powered-by: Express</span><br><span class="line">content-length:13</span><br><span class="line">content-type:application/json;charset=utf-8</span><br></pre></td></tr></table></figure><blockquote><p><strong>每一行都是以回车和换行符</strong> <code>\r\n</code>结束，是每个 header 属性的分隔符</p></blockquote><p><strong>而我们希望解析成的对象结构</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    date:Fri,05 Apr 2019 12:40:49 GMT</span><br><span class="line">etag: W/&quot;d-Ssxx4FRxEutDLwo2+xkkxKc4y0k&#x27;&#x27;,</span><br><span class="line">connection: keep-alive,</span><br><span class="line">x-powered-by: Express,</span><br><span class="line">content-length:13</span><br><span class="line">content-type:application/json;charset=utf-8</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>headers.ts 新增parseHeaders方法</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">export function parseHeaders(headers: string): any &#123;// parseHeaders 函数接收 headers 参数</span><br><span class="line">  let parsed = Object.create(null)// 创建一个空对象</span><br><span class="line">  if (!headers) &#123;// 如果 headers 不存在</span><br><span class="line">    return parsed// 返回 parsed</span><br><span class="line">  &#125;</span><br><span class="line">  headers.split(&#x27;\r\n&#x27;).forEach(line =&gt; &#123;// 遍历 headers 的每一行</span><br><span class="line">    let [key, val] = line.split(&#x27;:&#x27;)// 分割每一行的 key 和 val</span><br><span class="line">    key = key.trim().toLowerCase()// 去掉 key 的空格并将 key 转换为小写</span><br><span class="line">    if (!key) &#123;// 如果 key 不存在</span><br><span class="line">      return// 直接返回</span><br><span class="line">    &#125;</span><br><span class="line">    if (val) &#123;// 如果 val 存在</span><br><span class="line">      val = val.trim()// 去掉 val 的空格</span><br><span class="line">    &#125;</span><br><span class="line">    parsed[key] = val// 将 key 和 val 赋值给 parsed</span><br><span class="line">  &#125;)</span><br><span class="line">  return parsed// 返回 parsed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理响应data"><a href="#处理响应data" class="headerlink" title="处理响应data"></a>处理响应data</h3><p><strong>不设置responseType情况下，服务端返回数据是字符串类型</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data: &quot;&#123;&quot;a&quot;:1,&quot;b&quot;:2&#125;&quot;</span><br></pre></td></tr></table></figure><p><strong>我们要转成对象</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data:&#123;</span><br><span class="line">    a: 1,</span><br><span class="line">    b: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>data.ts 新增transformResponse转化函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export function transformResponse(data: any): any &#123;</span><br><span class="line">  if (typeof data === &#x27;string&#x27;) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      data = JSON.parse(data)</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">      // do nothing</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  return data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>index.ts 处理axios</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import &#123; transformRequest,transformResponse &#125; from &#x27;./helpers/data&#x27;// 新增引入转化函数</span><br><span class="line"></span><br><span class="line">function axios(config: AxiosRequestConfig): AxiosPromise &#123;</span><br><span class="line">  processConfig(config)</span><br><span class="line">  return xhr(config).then(res =&gt; &#123; //请求结束后对 response data 进行处理</span><br><span class="line">    return transformResponseData(res)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformResponseData(res: AxiosResponse): AxiosResponse &#123;// 处理 response data</span><br><span class="line">  res.data = transformResponse(res.data)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/// 基础核心功能至此已全部实现 ///</span><br></pre></td></tr></table></figure><h2 id="错误处理-reject拒回"><a href="#错误处理-reject拒回" class="headerlink" title="错误处理(reject拒回)"></a>错误处理(reject拒回)</h2><h3 id="处理网络错误"><a href="#处理网络错误" class="headerlink" title="处理网络错误"></a>处理网络错误</h3><p><strong>网络不通时发送请求会触发 XMLHttpRequest 对象实例的error事件，所以我们可以在onerror事件回调函数中捕获此类错误</strong></p><p><strong>xhr.ts 中添加</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.onerror = function handleError() &#123; // 调用 onerror 方法 并传入 handleError 函数 并赋值给 request 变量</span><br><span class="line">    reject(new Error(&#x27;Network Error&#x27;)) // 调用 reject 方法 并传入 Network Error 参数 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理超时错误"><a href="#处理超时错误" class="headerlink" title="处理超时错误"></a>处理超时错误</h3><p><strong>设置一个timeout，当请求超过某个时间后没收到响应则终止，并触发 timeout 事件</strong></p><blockquote><p><strong>默认超时时间为0（永不超时，我们首先需要允许程序可配置超时时间</strong></p></blockquote><p><strong>type &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosRequestConfig &#123;//config接口</span><br><span class="line">  url: string</span><br><span class="line">  method?: Method</span><br><span class="line">  data?: any</span><br><span class="line">  params?: any</span><br><span class="line">  headers?: any</span><br><span class="line">  responseType?: XMLHttpRequestResponseType</span><br><span class="line">  timeout?: number // 新增timeout</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>xhr.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const &#123; data = null, url, method = &#x27;get&#x27;, headers, responseType , timeout&#125; = config // 新增解构</span><br><span class="line"></span><br><span class="line">// 新增逻辑</span><br><span class="line">if (timeout) &#123; // 如果 timeout 存在</span><br><span class="line">    request.timeout = timeout</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request.ontimeout = function handleTimeout() &#123;</span><br><span class="line">    reject(new Error(`Timeout of $&#123;timeout&#125; ms exceeded`)) // 超过 $&#123;timeout&#125; 毫秒 超时 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="状态码处理-200错误"><a href="#状态码处理-200错误" class="headerlink" title="状态码处理(!200错误)"></a>状态码处理(!200错误)</h3><blockquote><p><strong>处理时机：接收到响应的时候</strong></p></blockquote><p><strong>xhr.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">request.onreadystatechange = function handleLoad() &#123;</span><br><span class="line">    if (request.readyState !== 4) &#123; // 没有收到正确的响应</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //也就是在这里//</span><br><span class="line">    if (request.status === 0) &#123; // 如果发送网络错误 || 超时错误</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resolve(response) // </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function handleResponse(response: AxiosResponse): void &#123; // 传入处理 response 参数</span><br><span class="line">    if (response.status &gt;= 200 &amp;&amp; response.status &lt; 300) &#123; // 状态码 大于等于 200 并且小于 300</span><br><span class="line">        resolve(response) // 调用 resolve 方法 并传入 response 参数</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        reject(new Error(`Request failed with status code $&#123;response.status&#125;`)) // 报错状态码</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="错误信息增强"><a href="#错误信息增强" class="headerlink" title="错误信息增强"></a>错误信息增强</h3><blockquote><p><strong>按照之前的操作，我们实现了对基础错误信息的处理，但我们对外提供的错误信息是十分有限的</strong></p><p><strong>我们希望对外提供的错误信息包括</strong></p><p><strong>错误文本信息（报错显示）</strong></p><p><strong>请求对象配置 config</strong></p><p><strong>错误代码 code</strong></p><p><strong>XMLHttpRequest 对象实例 request</strong></p><p><strong>自定义响应对象 response</strong></p></blockquote><h4 id="创建AxiosError类"><a href="#创建AxiosError类" class="headerlink" title="创建AxiosError类"></a>创建AxiosError类</h4><p><strong>types &#x2F; index.ts 定义接口</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosError extends Error &#123;//error接口</span><br><span class="line">    isAxiosError: boolean</span><br><span class="line">    config: AxiosRequestConfig</span><br><span class="line">    code?: string</span><br><span class="line">    request?: any</span><br><span class="line">    response?: AxiosResponse</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>新建 helpers &#x2F; error.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosResponse &#125; from &#x27;../types&#x27;</span><br><span class="line"></span><br><span class="line">export class AxiosError extends Error &#123; // 定义一个AxiosError类继承Error类 实现AxiosError接口 并设置 isAxiosError为true</span><br><span class="line">  isAxiosError: boolean</span><br><span class="line">  config: AxiosRequestConfig</span><br><span class="line">  code?: string | null</span><br><span class="line">  request?: any</span><br><span class="line">  response?: AxiosResponse</span><br><span class="line"></span><br><span class="line">  constructor( //构造函数 接收五个参数赋值给对应的属性 并设置 isAxiosError为true</span><br><span class="line">    message: string,</span><br><span class="line">    config: AxiosRequestConfig,</span><br><span class="line">    code?: string | null,</span><br><span class="line">    request?: any,</span><br><span class="line">    response?: AxiosResponse</span><br><span class="line">  ) &#123;</span><br><span class="line">    super(message) //调用父类的构造函数 传入message参数赋值给message属性</span><br><span class="line"></span><br><span class="line">    this.config = config</span><br><span class="line">    this.code = code</span><br><span class="line">    this.request = request</span><br><span class="line">    this.response = response</span><br><span class="line">    this.isAxiosError = true</span><br><span class="line"></span><br><span class="line">    Object.setPrototypeOf(this, AxiosError.prototype) // 修复原型链问题</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function createError( //定义一个createError函数 接收五个参数 并返回一个AxiosError对象</span><br><span class="line">  message: string,</span><br><span class="line">  config: AxiosRequestConfig,</span><br><span class="line">  code?: string | null,</span><br><span class="line">  request?: any,</span><br><span class="line">  response?: AxiosResponse</span><br><span class="line">) &#123;</span><br><span class="line">  const error = new AxiosError(message, config, code, request, response)</span><br><span class="line"></span><br><span class="line">  return error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="createError-方法应用"><a href="#createError-方法应用" class="headerlink" title="createError 方法应用"></a>createError 方法应用</h4><blockquote><p><strong>对错误对象创建的逻辑进行修改</strong></p></blockquote><p><strong>xhr.ts</strong></p><p><em><strong>onerror修改</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.onerror = function handleError() &#123;</span><br><span class="line">    reject(new Error(&#x27;Network Error&#x27;)) // 调用 reject 方法 并传入 Network Error 参数 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>替换为</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.onerror = function handleError() &#123;</span><br><span class="line">    reject(createError(&#x27;Network Error&#x27;,config,null,request)) // 传入 &#x27;Network Error&#x27;,config,null,request 参数（事件触发时拿不到response就不传了） 调用 createError 方法并传入参数</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em><strong>ontimeout修改</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request.ontimeout = function handleTimeout() &#123;</span><br><span class="line">   // 调用 ontimeout 方法 并传入 handleTimeout 函数 并赋值给 request 变量</span><br><span class="line">   reject(new Error(`Timeout of $&#123;timeout&#125; ms exceeded`)) // 调用 reject 方法 并传入 Timeout of $&#123;timeout&#125; ms exceeded 参数</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>替换为</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request.ontimeout = function handleTimeout() &#123;</span><br><span class="line">    // 调用 ontimeout 方法 并传入 handleTimeout 函数 并赋值给 request 变量</span><br><span class="line">    reject(createError(`Timeout of $&#123;timeout&#125; ms exceeded`,config,&#x27;ECONNABORTED&#x27;,request)) // 传入 `Timeout of $&#123;timeout&#125; ms exceeded`,config,&#x27;ECONNABORTED&#x27;,request 参数 调用 createError 方法 并传入参数</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em><strong>handleResponse修改</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function handleResponse(response: AxiosResponse): void &#123; // 传入处理 response 参数</span><br><span class="line">    if (response.status &gt;= 200 &amp;&amp; response.status &lt; 300) &#123; // 状态码 大于等于 200 并且小于 300</span><br><span class="line">        resolve(response) // 调用 resolve 方法 并传入 response 参数</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        reject(new Error(`Request failed with status code $&#123;response.status&#125;`)) // 调用 reject 方法 并传入 Request failed with status code $&#123;response.status&#125; 参数</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>替换为</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function handleResponse(response: AxiosResponse): void &#123; // 传入处理 response 参数</span><br><span class="line">    if (response.status &gt;= 200 &amp;&amp; response.status &lt; 300) &#123; // 状态码 大于等于 200 并且小于 300</span><br><span class="line">        resolve(response) // 调用 resolve 方法 并传入 response 参数</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        reject(createError(`Request failed with status code $&#123;response.status&#125;`,config,null,request,response)) // 传入 `Request failed with status code $&#123;response.status&#125;`,config,null,request,response 参数 调用 createError 方法 并传入参数</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="接口扩展"><a href="#接口扩展" class="headerlink" title="接口扩展"></a>接口扩展</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><blockquote><p><strong>为了用户更加方便地使用axios发送请求，我们可以为所有支持的请求方法扩展一些接口</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//[可选项]</span><br><span class="line">axios.request(config)</span><br><span class="line">axios.get(url[,config])</span><br><span class="line">axios.delete(url[,config])</span><br><span class="line">axios.head(url[,config])</span><br><span class="line">axios.options(url[,config])</span><br><span class="line">axios.post(url[,datal,config])</span><br><span class="line">axios.put(url[,datal,config])</span><br><span class="line">axios.patch(url[,datal,config])</span><br></pre></td></tr></table></figure><p><strong>types &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export interface Axios &#123;//axios接口</span><br><span class="line">  request(config: AxiosRequestConfig): AxiosPromise</span><br><span class="line">  get(url: string, config?: AxiosRequestConfig): AxiosPromise</span><br><span class="line">  delete(url: string, config?: AxiosRequestConfig): AxiosPromise</span><br><span class="line">  head(url: string, config?: AxiosRequestConfig): AxiosPromise</span><br><span class="line">  options(url: string, config?: AxiosRequestConfig): AxiosPromise</span><br><span class="line">  post(url: string, data?: any, config?: AxiosRequestConfig): AxiosPromise</span><br><span class="line">  put(url: string, data?: any, config?: AxiosRequestConfig): AxiosPromise</span><br><span class="line">  patch(url: string, data?: any, config?: AxiosRequestConfig): AxiosPromise</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface AxiosInstance extends Axios &#123;//axios实例接口 既有函数类型又有属性接口</span><br><span class="line">  (config: AxiosRequestConfig): AxiosPromise</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建Axios-ts"><a href="#创建Axios-ts" class="headerlink" title="创建Axios.ts"></a>创建Axios.ts</h3><blockquote><p><strong>存放一些发送请求核心代码</strong></p></blockquote><p><strong>core &#x2F; Axios.ts &#x2F;&#x2F;大写表示是一个类</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosPromise &#125; from &#x27;../types&#x27;</span><br><span class="line"></span><br><span class="line">export default class Axios &#123;</span><br><span class="line">  request(config: AxiosRequestConfig): AxiosPromise &#123;// 实现request方法</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>core &#x2F; dispatchRequest.ts</strong></p><blockquote><p><strong>封装axios.ts核心代码</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosPromise, AxiosResponse &#125; from &#x27;../types&#x27;</span><br><span class="line">import xhr from &#x27;../xhr&#x27;</span><br><span class="line">import &#123; bulidURL &#125; from &#x27;../helpers/url&#x27;</span><br><span class="line">import &#123; transformRequest, transformResponse &#125; from &#x27;../helpers/data&#x27;</span><br><span class="line">import &#123; processHeaders &#125; from &#x27;../helpers/header&#x27;</span><br><span class="line"></span><br><span class="line">export default function dispatchRequest(config: AxiosRequestConfig): AxiosPromise &#123;// dispatchRequest 函数接收一个 config 参数</span><br><span class="line">  processConfig(config)</span><br><span class="line">  return xhr(config).then(res =&gt; &#123;//请求结束后对 response data 进行处理</span><br><span class="line">    return transformResponseData(res)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function processConfig(config: AxiosRequestConfig): void &#123;// 处理 config</span><br><span class="line">  config.url = transformURL(config)</span><br><span class="line">  config.headers = transformHeaders(config) // 先处理 headers</span><br><span class="line">  config.data = transformRequestData(config) // 再处理 data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformURL(config: AxiosRequestConfig): string &#123;// 处理 url 返回拼接后的 url</span><br><span class="line">  const &#123; url, params &#125; = config</span><br><span class="line">  return bulidURL(url, params)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformRequestData(config: AxiosRequestConfig): void &#123;// 处理 data 调用 transformRequest 方法</span><br><span class="line">  config.data = transformRequest(config.data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformHeaders(config: AxiosRequestConfig): any &#123;// 处理 headers 调用 processHeaders 方法</span><br><span class="line">  const &#123; headers = &#123;&#125;, data &#125; = config</span><br><span class="line">  return processHeaders(headers, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformResponseData(res: AxiosResponse): AxiosResponse &#123;// 处理 response data</span><br><span class="line">  res.data = transformResponse(res.data)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>然后将xhr.ts移入core文件夹（xhr也作为核心模块）</strong></p></blockquote><p><strong>部分报错修改</strong> (严格模式)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//dispatchRequest.ts</span><br><span class="line">return bulidURL(url!, params)</span><br><span class="line"></span><br><span class="line">//xht.ts</span><br><span class="line">request.open(method.toUpperCase(), url!, true) // 调用 open 方法传入 method url true 三个参数 并将 method 转换为大写并赋值给 method,url. async:true异步</span><br></pre></td></tr></table></figure><blockquote><p><strong>Tips： 断言（ ! ）</strong></p><blockquote><p>**TS中，当你保证某个变量不会为 **<code>null</code> 或者 <code>undefined</code>，但编译器却无法推断出来的时候，就可以使用非空断言操作符 ( ! )，不会在运行时进行检查，但要是你做出了错误的保证，在运行时就可能会出现错误。</p></blockquote></blockquote><h3 id="实现Axios类中接口"><a href="#实现Axios类中接口" class="headerlink" title="实现Axios类中接口"></a>实现Axios类中接口</h3><p><code>Axios.ts</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosPromise &#125; from &#x27;../types&#x27;</span><br><span class="line">import dispatchRequest from &#x27;./dispatchRequest&#x27;</span><br><span class="line"></span><br><span class="line">export default class Axios &#123;</span><br><span class="line">  request(...)</span><br><span class="line">  get(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**实现 **<em><strong>request</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request(config: AxiosRequestConfig): AxiosPromise &#123;// 传入config参数 并返回AxiosPromise</span><br><span class="line">    return dispatchRequest(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><em><strong>逻辑封装</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_requestMethodWithoutData(</span><br><span class="line">method: Method,</span><br><span class="line">url: string,</span><br><span class="line">config?: AxiosRequestConfig</span><br><span class="line">): AxiosPromise &#123;</span><br><span class="line">// 封装_requestMethodWithoutData方法传入method,url和config参数 并返回AxiosPromise</span><br><span class="line">return this.request(Object.assign(config || &#123;&#125;, &#123; method, url &#125;)) // 调用request方法 并传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>**实现 **<em><strong>get</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">get(url: string, config?: AxiosRequestConfig): AxiosPromise &#123;// 传入url和config参数</span><br><span class="line">    return this._requestMethodWithoutData(&#x27;get&#x27;, url, config) // 调用方法 传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**实现 **<em><strong>delete</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete(url: string, config?: AxiosRequestConfig): AxiosPromise &#123;// 传入url和config参数</span><br><span class="line">    return this._requestMethodWithoutData(&#x27;delete&#x27;, url, config) // 调用方法 传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**实现 **<em><strong>head</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">head(url: string, config?: AxiosRequestConfig): AxiosPromise &#123;// 传入url和config参数</span><br><span class="line">    return this._requestMethodWithoutData(&#x27;head&#x27;, url, config) // 调用方法 并传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**实现 **<em><strong>options</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">options(url: string, config?: AxiosRequestConfig): AxiosPromise &#123;// 传入url和config参数</span><br><span class="line">    return this._requestMethodWithoutData(&#x27;options&#x27;, url, config) // 调用方法 并传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><em><strong>逻辑封装</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_requestMethodWithData(</span><br><span class="line">method: Method,</span><br><span class="line">url: string,</span><br><span class="line">data?: any,</span><br><span class="line">config?: AxiosRequestConfig</span><br><span class="line">): AxiosPromise &#123;</span><br><span class="line">// 封装_requestMethodWithData方法传入method,url,data和config参数 并返回AxiosPromise</span><br><span class="line">return this.request(Object.assign(config || &#123;&#125;, &#123; method, url, data &#125;)) // 调用request方法 并传入一个对象</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></blockquote><p>**实现 **<em><strong>post</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">head(url: string, config?: AxiosRequestConfig): AxiosPromise &#123;// 传入url,data和config参数</span><br><span class="line">    return this._requestMethodWithData(&#x27;post&#x27;, url, data, config) // 调用方法 并传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**实现 **<em><strong>put</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">put(url: string, config?: AxiosRequestConfig): AxiosPromise &#123;// 传入url,data和config参数</span><br><span class="line">    return this._requestMethodWithData(&#x27;put&#x27;, url, data, config) // 调用方法 并传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**实现 **<em><strong>patch</strong></em> 接口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">patch(url: string, config?: AxiosRequestConfig): AxiosPromise &#123;// 传入url,data和config参数</span><br><span class="line">    return this._requestMethodWithData(&#x27;patch&#x27;, url, data, config) // 调用方法 并传入一个对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="混合对象实现"><a href="#混合对象实现" class="headerlink" title="混合对象实现"></a>混合对象实现</h3><blockquote><p><strong>首先这个对象是函数，其次这个对象包括Axios类内所有原型属性和实例属性</strong></p></blockquote><p><strong>helpers &#x2F; utils</strong></p><blockquote><p><code>extend</code> 合成函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 示例</span><br><span class="line">const target = &#123; a: 1 &#125;;</span><br><span class="line">const source = &#123; b: 2 &#125;;</span><br><span class="line">const result = extend(target, source);</span><br><span class="line">console.log(result); // 输出: &#123; a: 1, b: 2 &#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>这里我们使用</strong><em><strong>泛型</strong></em> <code>T</code> 和 <code>U</code></p></blockquote><blockquote><p><code>T</code> 代表目标对象 <code>to</code> 的类型，<code>U</code> 代表源对象 <code>from</code> 的类型</p></blockquote><blockquote><p>**函数的返回值类型是 **<code>T &amp; U</code>，也就是 <code>to</code> 和 <code>from</code> 两个对象类型的交集。</p></blockquote></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export function extend&lt;T, U&gt;(to: T, from: U): T &amp; U &#123; // 合并对象</span><br><span class="line">  for (const key in from) &#123;</span><br><span class="line">    ;(to as T &amp; U)[key] = from[key] as any //把 from 对象的属性值赋值给 to 对象对应的属性。这里运用了类型断言 as T &amp; U 和 as any，让 TypeScript 编译器认可这种赋值操作。</span><br><span class="line">  &#125;</span><br><span class="line">  return to as T &amp; U //也用了类型断言 as T &amp; U</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工厂函数实现"><a href="#工厂函数实现" class="headerlink" title="工厂函数实现"></a>工厂函数实现</h3><p><strong>处理axios.ts</strong></p><blockquote><p><strong>删掉内容，只保留 export default axios</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosInstance &#125; from &quot;./types&quot;</span><br><span class="line">import Axios from &quot;./core/Axios&quot;</span><br><span class="line">import &#123; extend &#125; from &quot;./helpers/util&quot;</span><br><span class="line"></span><br><span class="line">function createInstance(): AxiosInstance &#123;</span><br><span class="line">  const context = new Axios()//实例化一个 Axios 对象 并赋值给 context 变量</span><br><span class="line">  const instance = Axios.prototype.request.bind(context)//调用 request 方法 并传入 context 参数 并赋值给 instance 变量 绑定 this 指向 context</span><br><span class="line"></span><br><span class="line">  extend(instance, context) //调用 extend 方法 并传入 instance 和 context 参数 实现 instance 对象继承 context 对象</span><br><span class="line">  return instance as AxiosInstance //返回 instance 对象 并断言为 AxiosInstance 类型</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const axios = createInstance() //调用 createInstance 方法 并赋值给 axios 变量</span><br><span class="line"></span><br><span class="line">export default axios</span><br></pre></td></tr></table></figure><h3 id="axios函数重载"><a href="#axios函数重载" class="headerlink" title="axios函数重载"></a>axios函数重载</h3><blockquote><p><strong>目前我们函数只能存放一个对象</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line">url: &#x27;/extend/post&#x27;,</span><br><span class="line">method: &#x27;post&#x27;,</span><br><span class="line">data:&#123;</span><br><span class="line">msg:&#x27;hi&#x27;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>那么如果axios同时含有两个参数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">axios(&#x27;/extend/post&#x27;,&#123;</span><br><span class="line">method: &#x27;post&#x27;,</span><br><span class="line">data:&#123;</span><br><span class="line">msg:&#x27;hi&#x27;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></blockquote><p><strong>type &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosInstance extends Axios &#123;//axios实例接口 既有函数类型又有属性接口</span><br><span class="line">  (config: AxiosRequestConfig): AxiosPromis) //(config单参)</span><br><span class="line">  (url: string, config?: AxiosRequestConfig): AxiosPromise //添加：函数重载(url+config双参)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>core &#x2F; Axios.ts</strong></p><blockquote><p><strong>修改request方法</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request(config: AxiosRequestConfig): AxiosPromise &#123;// 实现request方法传入config参数</span><br><span class="line">    return dispatchRequest(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>改为👇</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">request(url: any, config: any): AxiosPromise &#123;// 实现request方法传入url？config？参数</span><br><span class="line">    if (typeof url === &#x27;string&#x27;) &#123; //url+config双参</span><br><span class="line">        if (!config) &#123;</span><br><span class="line">            config = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        config.url = url</span><br><span class="line">    &#125; else &#123; //config单参</span><br><span class="line">        config = url //此时的url就是config</span><br><span class="line">    &#125;</span><br><span class="line">    return dispatchRequest(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="响应数据支持泛型"><a href="#响应数据支持泛型" class="headerlink" title="响应数据支持泛型"></a>响应数据支持泛型</h3><blockquote><p><strong>通常情况，我们会将后端返回数据格式单独放入一个接口中</strong></p></blockquote><p><strong>设置泛型，提高类型灵活性</strong></p><p><strong>type &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosResponse&lt;T = any&gt; &#123; //response接口</span><br><span class="line">    data: T</span><br><span class="line">    status: number</span><br><span class="line">    statusText: string</span><br><span class="line">    headers: any</span><br><span class="line">    config: AxiosRequestConfig</span><br><span class="line">    request: any</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface AxiosPromise&lt;T = any&gt; extends Promise&lt;AxiosResponse&lt;T&gt;&gt; &#123; //promise接口</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface Axios &#123; //axios接口</span><br><span class="line">    request&lt;T = any&gt;(config: AxiosRequestConfig): AxiosPromise&lt;T&gt;</span><br><span class="line">    get&lt;T = any&gt;(url: string, config?: AxiosRequestConfig): AxiosPromise&lt;T&gt;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface AxiosInstance extends Axios &#123; //axios实例接口 既有函数类型又有属性接口</span><br><span class="line">    &lt;T = any&gt;(config: AxiosRequestConfig): AxiosPromise&lt;T&gt;</span><br><span class="line">    &lt;T = any&gt;(url: string, config?: AxiosRequestConfig): AxiosPromise&lt;T&gt; //函数重载</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="拦截器实现"><a href="#拦截器实现" class="headerlink" title="拦截器实现"></a>拦截器实现</h2><blockquote><p><strong>也就是axios二次封装中常见的请求拦截器 &amp; 响应拦截器</strong></p><p><strong>我们先回顾一下用户asios拦截器是怎么写的</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import axios from &#x27;axios&#x27;</span><br><span class="line"></span><br><span class="line">const instance = axios.create(&#123;</span><br><span class="line"> baseURL:&#x27;/api</span><br><span class="line">&#125;)</span><br><span class="line">instance.interceptors.request.use(res =&gt;&#123;//请求拦截器</span><br><span class="line"> console.log(&#x27;res&#x27;,res)</span><br><span class="line">&#125;)</span><br><span class="line">instance.interceptors.response.use(res =&gt;&#123;//响应拦截器</span><br><span class="line"> console.log(&#x27;res&#x27;,res)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">export default instance</span><br></pre></td></tr></table></figure><p><strong>Tip：request是后添加的先执行，response是先添加的先执行</strong></p></blockquote><h3 id="拦截器管理类"><a href="#拦截器管理类" class="headerlink" title="拦截器管理类"></a>拦截器管理类</h3><p><strong>types &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosInterceptorManager&lt;T&gt; &#123; //拦截器接口</span><br><span class="line">  use(resolved: ResolvedFn&lt;T&gt;, rejected?: RejectedFn): number //添加拦截器 返回拦截器id</span><br><span class="line">  eject(id: number): void //删除拦截器 返回拦截器id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface ResolvedFn&lt;T = any&gt; &#123; //成功拦截器接口</span><br><span class="line">  (val: T): T | Promise&lt;T&gt; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface RejectedFn &#123; //失败拦截器接口</span><br><span class="line">  (error: any): any </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>core &#x2F; interceptorManager.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import &#123; ResolvedFn, RejectedFn &#125; from &#x27;../types&#x27;</span><br><span class="line"></span><br><span class="line">interface Interceptor&lt;T&gt; &#123;// 拦截器接口</span><br><span class="line">  resolved: ResolvedFn&lt;T&gt;</span><br><span class="line">  rejected?: RejectedFn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default class InterceptorManager&lt;T&gt; &#123;// 拦截器管理类</span><br><span class="line">  private interceptors: Array&lt;Interceptor&lt;T&gt;&gt;// 拦截器数组存放的是拦截器对象 每个对象有两个属性 resolved rejected</span><br><span class="line">  constructor() &#123; // 构造函数 初始化拦截器数组 </span><br><span class="line">    this.interceptors = [] // 拦截器数组中存放的是拦截器对象</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  use(resolved: ResolvedFn&lt;T&gt;, rejected?: RejectedFn): number &#123;// 添加拦截器</span><br><span class="line">    this.interceptors.push(&#123;// 将拦截器对象添加到拦截器数组中</span><br><span class="line">      resolved,</span><br><span class="line">      rejected</span><br><span class="line">    &#125;)</span><br><span class="line">    return this.interceptors.length - 1 // 返回拦截器的id 用于删除拦截器</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  forEach(fn: (interceptor: Interceptor&lt;T&gt;) =&gt; void): void &#123;// 遍历拦截器</span><br><span class="line">    this.interceptors.forEach(interceptor =&gt; &#123;// 遍历拦截器数组</span><br><span class="line">      if (interceptor !== null) &#123;// 判断拦截器是否存在</span><br><span class="line">        fn(interceptor) // 存在则调用fn函数</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  eject(id: number): void &#123;// 删除拦截器 通过id删除拦截器</span><br><span class="line">    if (this.interceptors[id]) &#123;// 判断拦截器是否存在</span><br><span class="line">      this.interceptors[id] = null // 存在则将拦截器置为null</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="链式调用实现"><a href="#链式调用实现" class="headerlink" title="链式调用实现"></a>链式调用实现</h3><p><strong>core &#x2F; Axios.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosPromise,AxiosResponse, Method &#125; from &#x27;../types&#x27;</span><br><span class="line">import InterceptorManager from &#x27;./interceptorManager&#x27;</span><br><span class="line"></span><br><span class="line">interface Interceptors &#123;</span><br><span class="line">    request: InterceptorManager&lt;AxiosRequestConfig&gt;</span><br><span class="line">    response: InterceptorManager&lt;AxiosResponse&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default class Axios &#123;</span><br><span class="line">    interceptors: Interceptors</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        this.interceptors = &#123; //用户可以通过axios.interceptors.request.use()添加拦截器</span><br><span class="line">            request: new InterceptorManager&lt;AxiosRequestConfig&gt;(),</span><br><span class="line">            response: new InterceptorManager&lt;AxiosResponse&gt;()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request(...)...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>完善request (实现调用链)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosPromise, AxiosResponse, Method,ResolvedFn,RejectedFn &#125; from &#x27;../types&#x27;</span><br><span class="line"></span><br><span class="line">interface PromiseChain&lt;T&gt; &#123;</span><br><span class="line">    resolved: ResolvedFn&lt;T&gt; | ((config: AxiosRequestConfig) =&gt; AxiosPromise)//resolved是一个函数类型 接收一个AxiosRequestConfig类型的参数 返回一个AxiosPromise类型的参数</span><br><span class="line">    rejected?: RejectedFn //rejected是一个函数类型 接收一个AxiosRequestConfig类型的参数 返回一个AxiosPromise类型的参数</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">request(url: any, config: any): AxiosPromise &#123;// 实现request方法传入参数</span><br><span class="line">    if (typeof url === &#x27;string&#x27;) &#123;</span><br><span class="line">        if (!config) &#123;</span><br><span class="line">            config = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        config.url = url</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        config = url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const chain:PromiseChain&lt;any&gt;[] = [</span><br><span class="line">        &#123;// 创建一个数组chain</span><br><span class="line">            resolved: dispatchRequest,</span><br><span class="line">            rejected: undefined</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">    this.interceptors.request.forEach(interceptor =&gt; &#123;// 遍历request拦截器</span><br><span class="line">        chain.unshift(interceptor) // 将拦截器添加到chain数组的开头 </span><br><span class="line">    &#125;)</span><br><span class="line">    this.interceptors.response.forEach(interceptor =&gt; &#123;// 遍历response拦截器</span><br><span class="line">        chain.push(interceptor) // 将拦截器添加到chain数组的末尾</span><br><span class="line">    &#125;)</span><br><span class="line">    let promise = Promise.resolve(config) // 创建一个promise对象 并传入config参数</span><br><span class="line">    while (chain.length) &#123;</span><br><span class="line">        // 遍历chain数组</span><br><span class="line">        const &#123; resolved, rejected &#125; = chain.shift()! // 取出chain数组的第一个元素</span><br><span class="line">              promise = promise.then(resolved, rejected) // 将promise对象的then方法传入resolved和rejected参数</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return dispatchRequest(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="合并用户配置"><a href="#合并用户配置" class="headerlink" title="合并用户配置"></a>合并用户配置</h2><blockquote><p><strong>用户在发送请求时可以传入一个配置来决定请求的不同行为</strong></p><p><strong>甚至可以直接修改一些默认配置 (defaults)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">axios.defaults.headers.common[&#x27;test&#x27;]= 123 //默认对任何类型的请求的header都添加test属性</span><br><span class="line">axios.defaults.headers.post[&#x27;Content-Type&#x27;] = &#x27;application/x-www-form-urlencoded&#x27; //默认对post请求的header都添加Content-Type属性</span><br><span class="line">axios.defaults.timeout = 2000</span><br></pre></td></tr></table></figure></blockquote><h3 id="默认配置设置"><a href="#默认配置设置" class="headerlink" title="默认配置设置"></a>默认配置设置</h3><p><strong>defaults.ts 配置默认请求</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig &#125; from &quot;./types&quot;;</span><br><span class="line"></span><br><span class="line">const defaults: AxiosRequestConfig = &#123;</span><br><span class="line">  url: &quot;&quot;,</span><br><span class="line">  method: &quot;get&quot;,</span><br><span class="line">  timeout: 0,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    common: &#123;</span><br><span class="line">      Accept: &quot;application/json, text/plain, */*&quot;,//通用的请求头 接受的响应类型为json/plain文本*/*表示任意类型 优先级最低</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const methodsNoData = [&quot;delete&quot;, &quot;get&quot;, &quot;head&quot;, &quot;options&quot;];</span><br><span class="line"></span><br><span class="line">methodsNoData.forEach((method) =&gt; &#123;</span><br><span class="line">  defaults.headers[method] = &#123;&#125;;//没有数据的请求头 优先级高于通用的请求头</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const methodsWithData = [&quot;post&quot;, &quot;put&quot;, &quot;patch&quot;];</span><br><span class="line"></span><br><span class="line">methodsWithData.forEach((method) =&gt; &#123;</span><br><span class="line">  defaults.headers[method] = &#123;</span><br><span class="line">    &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,//表单提交的请求头 优先级高于通用的请求头</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">export default defaults;</span><br></pre></td></tr></table></figure><p><strong>core &#x2F; Axios.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export default class Axios &#123;</span><br><span class="line">    defaults: AxiosRequestConfig</span><br><span class="line">    interceptors: Interceptors</span><br><span class="line"></span><br><span class="line">    constructor(initConfig?: AxiosRequestConfig) &#123;</span><br><span class="line">        this.defaults = initConfig // 初始化defaults属性</span><br><span class="line">        this.interceptors = &#123;</span><br><span class="line">            //用户可以通过axios.interceptors.request.use()添加拦截器</span><br><span class="line">            request: new InterceptorManager&lt;AxiosRequestConfig&gt;(),</span><br><span class="line">            response: new InterceptorManager&lt;AxiosResponse&gt;()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>types &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export interface Axios &#123;</span><br><span class="line">    defaults: AxiosRequestConfig //默认配置</span><br><span class="line">    interceptors: &#123; //拦截器</span><br><span class="line">        request: AxiosInterceptorManager&lt;AxiosRequestConfig&gt;</span><br><span class="line">        response: AxiosInterceptorManager&lt;AxiosResponse&gt;  </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>重写 axios.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosInstance, AxiosRequestConfig &#125; from &quot;./types&quot;</span><br><span class="line">import Axios from &quot;./core/Axios&quot;</span><br><span class="line">import &#123; extend &#125; from &quot;./helpers/util&quot;</span><br><span class="line">import defaults from &quot;./defaults&quot;</span><br><span class="line"></span><br><span class="line">function createInstance(config:AxiosRequestConfig): AxiosInstance &#123;</span><br><span class="line">  const context = new Axios(config)//创建一个 Axios 实例 并传入 config 参数 并赋值给 context 变量</span><br><span class="line">  const instance = Axios.prototype.request.bind(context)//调用 request 方法 并传入 context 参数 并赋值给 instance 变量 绑定 this 指向 context</span><br><span class="line"></span><br><span class="line">  extend(instance, context) //调用 extend 方法 并传入 instance 和 context 参数 实现 instance 对象继承 context 对象</span><br><span class="line">  return instance as AxiosInstance //返回 instance 对象 并断言为 AxiosInstance 类型</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const axios = createInstance(defaults) //调用 createInstance 方法 并传入 defaults 参数 并赋值给 axios 变量</span><br><span class="line"></span><br><span class="line">export default axios</span><br></pre></td></tr></table></figure><h3 id="合并策略实现"><a href="#合并策略实现" class="headerlink" title="合并策略实现"></a>合并策略实现</h3><p><strong>创建core &#x2F; mergeConfig.ts</strong></p><blockquote><p><code>config1</code> 为默认配置</p><p><code>config2</code> 代表用户传入的自定义配置</p><blockquote><p>**实现示例 (假设 **<code>config1</code> 和 <code>config2</code> 如下：)</p></blockquote><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const config1 = &#123;</span><br><span class="line">timeout: 1000,</span><br><span class="line">headers: &#123;</span><br><span class="line"> &#x27;Content-Type&#x27;: &#x27;application/json&#x27;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const config2 = &#123;</span><br><span class="line">timeout: 2000,</span><br><span class="line">headers: &#123;</span><br><span class="line"> &#x27;Authorization&#x27;: &#x27;Bearer token&#x27;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>**合并 **<code>timeout</code> 属性时，<code>val1</code> 就是 <code>config1.timeout</code> 的值 <code>1000</code>，<code>val2</code> 就是 <code>config2.timeout</code> 的值 <code>2000</code>。</p></blockquote></blockquote><h4 id="timeout逻辑"><a href="#timeout逻辑" class="headerlink" title="timeout逻辑"></a>timeout逻辑</h4><p><strong>mergeConfig.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig &#125; from &#x27;../types&#x27;</span><br><span class="line"></span><br><span class="line">const strats = Object.create(null)//合并策略 key为属性名 value为合并策略函数</span><br><span class="line"></span><br><span class="line">function defaultStrat(val1: any, val2: any): any &#123;//默认合并策略</span><br><span class="line">  return typeof val2 !== &#x27;undefined&#x27; ? val2 : val1//优先取val2 如果val2不存在则取val1</span><br><span class="line">&#125;</span><br><span class="line">function fromVal2Strat(val1: any, val2: any): any &#123;</span><br><span class="line">  if (typeof val2 !== &#x27;undefined&#x27;) &#123;//忽略val1 只取val2</span><br><span class="line">    return val2</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const stratKeysFromVal2 = [&#x27;url&#x27;, &#x27;params&#x27;, &#x27;data&#x27;]</span><br><span class="line"></span><br><span class="line">stratKeysFromVal2.forEach(key =&gt; &#123;//对于url params data属性 只取val2</span><br><span class="line">  strats[key] = fromVal2Strat</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">export default function mergeConfig(</span><br><span class="line">  config1: AxiosRequestConfig,</span><br><span class="line">  config2?: AxiosRequestConfig</span><br><span class="line">): AxiosRequestConfig &#123;</span><br><span class="line">  if (!config2) &#123;</span><br><span class="line">    config2 = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  const config = Object.create(null)//合并后的配置结果</span><br><span class="line"></span><br><span class="line">  for (let key in config2) &#123;</span><br><span class="line">    mergeField(key)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  for (let key in config1) &#123;</span><br><span class="line">    if (!config2[key]) &#123;</span><br><span class="line">      mergeField(key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function mergeField(key: string): void &#123;</span><br><span class="line">    const strat = strats[key] || defaultStrat//合并策略</span><br><span class="line">    config[key] = strat(config1[key], config2![key])</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>types &#x2F; index.ts 添加自动索引</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosRequestConfig &#123;</span><br><span class="line">    ...</span><br><span class="line">    [propName: string]: any //字符串自动索引</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="headers逻辑"><a href="#headers逻辑" class="headerlink" title="headers逻辑"></a>headers逻辑</h4><h5 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function deepMergeStrat(val1: any, val2: any): any &#123;</span><br><span class="line">  if (isPlainObject(val2)) &#123;//如果val2是对象</span><br><span class="line">    return deepMerge(val1, val2)//递归合并</span><br><span class="line">  &#125; else if (typeof val2!== &#x27;undefined&#x27;) &#123;//如果val2不是对象 且val2存在</span><br><span class="line">    return val2</span><br><span class="line">  &#125; else if (isPlainObject(val1)) &#123;//如果val2不是对象 且val2不存在 且val1是对象</span><br><span class="line">    return deepMerge(val1)//递归合并</span><br><span class="line">  &#125; else if (typeof val1!== &#x27;undefined&#x27;) &#123;//如果val2不是对象 且val2不存在 且val1不是对象 且val1存在</span><br><span class="line">    return val1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>deepMerge工具函数实现</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">export function deepMerge(...objs: any[]): any &#123;</span><br><span class="line">  // 深度合并对象</span><br><span class="line">  const result = Object.create(null)</span><br><span class="line"></span><br><span class="line">  objs.forEach(obj =&gt; &#123;</span><br><span class="line">    if (obj) &#123;</span><br><span class="line">      Object.keys(obj).forEach(key =&gt; &#123;</span><br><span class="line">        const val = obj[key]</span><br><span class="line">        if (isPlainObject(val)) &#123;</span><br><span class="line">          if (isPlainObject(result[key])) &#123;</span><br><span class="line">            result[key] = deepMerge(result[key], val)</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            result[key] = deepMerge(val)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          result[key] = val</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>在请求中应用函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">request(url: any, config: any): AxiosPromise &#123; // 实现request方法传入参数</span><br><span class="line">    。。。</span><br><span class="line">    if (typeof url === &#x27;string&#x27;) &#123;</span><br><span class="line">        if (!config) &#123;</span><br><span class="line">            config = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        config.url = url</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        config = url</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //发送请求之前应用</span><br><span class="line">    config = this.mergeConfig(this.defaults,config) // 合并config</span><br><span class="line"></span><br><span class="line">    const chain:PromiseChain&lt;any&gt;[] = [</span><br><span class="line">        &#123;// 创建一个数组chain</span><br><span class="line">            resolved: dispatchRequest,</span><br><span class="line">            rejected: undefined</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">    。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h5><blockquote><p><strong>合并后的headers是一个复杂对象，多了common、post、get等属性</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">headers:&#123;</span><br><span class="line"> common:&#123;</span><br><span class="line">     Accept:&#x27;application/json,text/plain,*/*&#x27;</span><br><span class="line"> &#125;,</span><br><span class="line"> post: &#123;</span><br><span class="line">     &#x27;Content-Type&#x27;:&#x27;application/x-www-form-urlencoded&#x27;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>我们需要压缩成一级</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">headers:&#123;</span><br><span class="line"> Accept:&#x27;application/json,text/plain,*/*&#x27;,</span><br><span class="line"> &#x27;Content-Type&#x27;:&#x27;application/x-www-form-urlencoded&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Tip：对于comman 中定义的header字段，我们都要提取，而对于post、get 这类提取，需要和该次请求的方法对应。</strong></p></blockquote><p><strong>headers.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">export function flattenHeaders(headers: any, method: Method): any &#123;// flattenHeaders 函数接收 headers 和 method 参数 将 headers 中的属性名规范化 并删除不必要的属性 并返回一个新的 headers 对象</span><br><span class="line">  if (!headers) &#123;// 如果 headers 不存在</span><br><span class="line">    return headers// 返回 headers</span><br><span class="line">  &#125;</span><br><span class="line">  headers = deepMerge(headers, null)// 调用 deepMerge 函数将 headers 深度合并</span><br><span class="line">  const methodsToDelete = [// 定义一个数组 methodsToDelete 存储需要删除的 headers 属性名</span><br><span class="line">    &#x27;delete&#x27;,</span><br><span class="line">    &#x27;get&#x27;,</span><br><span class="line">    &#x27;head&#x27;,</span><br><span class="line">    &#x27;options&#x27;,</span><br><span class="line">    &#x27;post&#x27;,</span><br><span class="line">    &#x27;put&#x27;,</span><br><span class="line">    &#x27;patch&#x27;,</span><br><span class="line">    &#x27;common&#x27;,</span><br><span class="line">  ]</span><br><span class="line">  methodsToDelete.forEach(method =&gt; &#123;// 遍历 methodsToDelete 数组</span><br><span class="line">    delete headers[method]// 删除 headers 的属性名</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return headers// 返回 headers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>dispatchRequest.ts 应用函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function processConfig(config: AxiosRequestConfig): void &#123;// 处理 config</span><br><span class="line">  config.url = transformURL(config)</span><br><span class="line">  config.headers = transformHeaders(config) // 先处理 headers</span><br><span class="line">  config.data = transformRequestData(config) // 再处理 data</span><br><span class="line">  config.headers = flattenHeaders(config.headers, config.method!) //处理 headers 扁平化</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="更多配置"><a href="#更多配置" class="headerlink" title="更多配置"></a>更多配置</h3><h4 id="transfromRequest-transfromResponse"><a href="#transfromRequest-transfromResponse" class="headerlink" title="transfromRequest &amp; transfromResponse"></a>transfromRequest &amp; transfromResponse</h4><blockquote><p><strong>官方axios中提供</strong> <code>transfromRequest</code>&amp;<code>transfromResponse</code>，值为<em><strong>一个数组或一个函数</strong></em></p><p>**这两个属性允许用户在 **<strong>数据发送到服务器之前</strong>(只适用于put、post、patch，而且可以修改headers对象) &#x2F; <strong>把响应数据传递给then或catch之前</strong> 对其修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line"> transformRequest: [</span><br><span class="line">     (function(data) &#123;</span><br><span class="line">         return qs.stringify(data); // 自定义的 transformRequest</span><br><span class="line">     &#125;),</span><br><span class="line">     ...axios.defaults.transformRequest // 保留默认的 transformRequest</span><br><span class="line"> ],</span><br><span class="line"> transformResponse: [</span><br><span class="line">     ...axios.defaults.transformResponse, // 展开默认的 transformResponse</span><br><span class="line">     function(data) &#123;</span><br><span class="line">         if (typeof data === &#x27;object&#x27;) &#123; // 自定义的 transformResponse</span><br><span class="line">             data.b = 2; // 修改响应数据</span><br><span class="line">         &#125;</span><br><span class="line">         return data;</span><br><span class="line">     &#125;</span><br><span class="line"> ],</span><br><span class="line"> url: &#x27;/config/post&#x27;, // 请求的 URL</span><br><span class="line"> method: &#x27;post&#x27;, // 请求方法</span><br><span class="line"> data: &#123;</span><br><span class="line">     a: 1 // 请求的数据</span><br><span class="line"> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></blockquote><h5 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a>定义接口</h5><p><strong>types &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosRequestConfig &#123; //config接口</span><br><span class="line">  url: string</span><br><span class="line">  method?: Method</span><br><span class="line">  data?: any</span><br><span class="line">  params?: any</span><br><span class="line">  headers?: any</span><br><span class="line">  responseType?: XMLHttpRequestResponseType</span><br><span class="line">  timeout?: number</span><br><span class="line">  transformRequest?: AxiosTransformer | AxiosTransformer[]//请求数据转换函数</span><br><span class="line">  transformResponse?: AxiosTransformer | AxiosTransformer[]//响应数据转换函数</span><br><span class="line"></span><br><span class="line">  [propName: string]: any //字符串自动索引</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export interface AxiosTransformer &#123; //转换接口</span><br><span class="line">  (data: any, headers?: any): any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>defaults.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import &#123; processHeaders &#125; from &#x27;./helpers/header&#x27;</span><br><span class="line">import &#123; transformRequest, transformResponse &#125; from &#x27;./helpers/data&#x27;</span><br><span class="line"></span><br><span class="line">const defaults: AxiosRequestConfig = &#123;</span><br><span class="line">  url: &#x27;&#x27;,</span><br><span class="line">  method: &#x27;get&#x27;,</span><br><span class="line">  timeout: 0,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    common: &#123;</span><br><span class="line">      Accept: &#x27;application/json, text/plain, */*&#x27; //通用的请求头 接受的响应类型为json/plain文本*/*表示任意类型 优先级最低</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  transformRequest: [</span><br><span class="line">    function(data: any, headers: any): any &#123;</span><br><span class="line">      processHeaders(headers, data) //处理请求头</span><br><span class="line">      return transformRequest(data) //处理请求数据</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  transformResponse: [</span><br><span class="line">    function(data: any): any &#123;</span><br><span class="line">      return transformResponse(data) //处理响应数据</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="重构transform逻辑"><a href="#重构transform逻辑" class="headerlink" title="重构transform逻辑"></a>重构transform逻辑</h5><p><strong>core &#x2F; transform.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosTransformer &#125; from &#x27;../types&#x27;</span><br><span class="line"></span><br><span class="line">export default function transform(//transform函数接收data headers fns三个参数</span><br><span class="line">  data: any,</span><br><span class="line">  headers: any,</span><br><span class="line">  fns?: AxiosTransformer | AxiosTransformer[]</span><br><span class="line">): any &#123;</span><br><span class="line">  if (!fns) &#123;//如果没有传入fns 直接返回data</span><br><span class="line">    return data</span><br><span class="line">  &#125;</span><br><span class="line">  if (!Array.isArray(fns)) &#123;//如果fns不是数组 将其转为数组</span><br><span class="line">    fns = [fns]</span><br><span class="line">  &#125;</span><br><span class="line">  fns.forEach(fn =&gt; &#123;//遍历fns数组 依次调用fn函数</span><br><span class="line">    data = fn(data, headers)</span><br><span class="line">  &#125;)</span><br><span class="line">  return data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>core &#x2F; dispatchRequest.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import transform from &#x27;./transform&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function processConfig(config: AxiosRequestConfig): void &#123;</span><br><span class="line">  // 处理 config</span><br><span class="line">  config.url = transformURL(config)</span><br><span class="line">  config.headers = transformHeaders(config) // 先处理 headers</span><br><span class="line">  config.data = transformRequestData(config) // 再处理 data</span><br><span class="line">  config.headers = flattenHeaders(config.headers, config.method!) //处理 headers 扁平化</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>更改为👇</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function processConfig(config: AxiosRequestConfig): void &#123;</span><br><span class="line">  // 处理 config</span><br><span class="line">  config.url = transformURL(config)</span><br><span class="line">  config.data = transform(config.data, config.headers, config.transformRequest) //处理 data</span><br><span class="line">  config.headers = flattenHeaders(config.headers, config.method!) //处理 headers 扁平化</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>删掉不用的东西</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import &#123; transformRequest, transformResponse &#125; from &#x27;../helpers/data&#x27;</span><br><span class="line"></span><br><span class="line">function transformRequestData(config: AxiosRequestConfig): void &#123;</span><br><span class="line">  // 处理 data 调用 transformRequest 方法</span><br><span class="line">  config.data = transformRequest(config.data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function transformHeaders(config: AxiosRequestConfig): any &#123;</span><br><span class="line">  // 处理 headers 调用 processHeaders 方法</span><br><span class="line">  const &#123; headers = &#123;&#125;, data &#125; = config</span><br><span class="line">  return processHeaders(headers, data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>更改逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function transformResponseData(res: AxiosResponse): AxiosResponse &#123; // 处理 response data</span><br><span class="line">  res.data = transform(res.data, res.headers, res.config.transformResponse)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="create"><a href="#create" class="headerlink" title="create"></a>create</h4><blockquote><p><strong>目前为止，我们的 axios 都是一个单例，一旦我们修改了 axios 的默认配置，会影响所有的请求。我们希望提供了一个</strong> <code>axios.create</code>的静态接口允许我们创建一个新的 axios 实例，同时允许我们传入新的配置和默认配置合并，并做为新的默认配置。</p></blockquote><h5 id="扩展新的接口"><a href="#扩展新的接口" class="headerlink" title="扩展新的接口"></a>扩展新的接口</h5><p><strong>types &#x2F; index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export interface AxiosStatic extends AxiosInstance &#123; //axios静态接口</span><br><span class="line">  create(config?: AxiosRequestConfig): AxiosInstance //创建axios实例</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>axios.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import &#123; AxiosRequestConfig, AxiosStatic &#125; from &#x27;./types&#x27;</span><br><span class="line">import Axios from &#x27;./core/Axios&#x27;</span><br><span class="line">import &#123; extend &#125; from &#x27;./helpers/util&#x27;</span><br><span class="line">import defaults from &#x27;./defaults&#x27;</span><br><span class="line">import mergeConfig from &#x27;./core/mergeConfig&#x27;</span><br><span class="line"></span><br><span class="line">function createInstance(config: AxiosRequestConfig): AxiosStatic &#123;</span><br><span class="line">  const context = new Axios(config) //创建一个 Axios 实例 并传入 config 参数 并赋值给 context 变量</span><br><span class="line">  const instance = Axios.prototype.request.bind(context) //调用 request 方法 并传入 context 参数 并赋值给 instance 变量 绑定 this 指向 context</span><br><span class="line"></span><br><span class="line">  extend(instance, context) //调用 extend 方法 并传入 instance 和 context 参数 实现 instance 对象继承 context 对象</span><br><span class="line">  return instance as AxiosStatic //返回 instance 对象 并断言为 AxiosStatic 类型</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const axios = createInstance(defaults) //调用 createInstance 方法 并传入 defaults 参数 并赋值给 axios 变量</span><br><span class="line"></span><br><span class="line">axios.create = function create(config) &#123; //axios.create 方法接收一个 config 参数 并返回一个 createInstance 方法的调用结果 并传入 mergeConfig 方法的调用结果 并传入 defaults 和 config 参数</span><br><span class="line">  return createInstance(mergeConfig(defaults, config))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default axios</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/Node.js%E5%9F%BA%E7%A1%80/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/Node.js%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="Node-js基础"><a href="#Node-js基础" class="headerlink" title="Node.js基础"></a>Node.js基础</h1><h2 id="模块系统"><a href="#模块系统" class="headerlink" title="模块系统"></a>模块系统</h2><h3 id="require-module"><a href="#require-module" class="headerlink" title="require &amp; module"></a>require &amp; module</h3><blockquote><p><strong>CommonJS规范</strong></p><p><strong>模块化:把代码按功能分开(可复用性强)</strong></p></blockquote><p><strong>举例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function sayHello(name) &#123;</span><br><span class="line">    return `Hello, $&#123;name&#125;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&#x27;express&#x27;);//引入express模块</span><br><span class="line">const sayHello = require(&#x27;./myModule&#x27;);//引入自定义模块</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.get(&#x27;/&#x27;, (req, res) =&gt; &#123;</span><br><span class="line">    res.send(sayHello(&#x27;World&#x27;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="npm包管理"><a href="#npm包管理" class="headerlink" title="npm包管理"></a>npm包管理</h3><blockquote><p><strong>就是前端常见的 npm install 下包</strong></p></blockquote><h2 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h2><h3 id="回调函数Promise"><a href="#回调函数Promise" class="headerlink" title="回调函数Promise"></a>回调函数Promise</h3><blockquote><p><strong>可以通过</strong> <code>util.promisify</code>将基于回调的API转换为返回Promise的形式</p><p><code>async</code>关键字定义一个返回Promise的函数，<code>await</code>等待一个Promise对象的结果</p></blockquote><h3 id="fs-readFile"><a href="#fs-readFile" class="headerlink" title="fs.readFile"></a>fs.readFile</h3><blockquote><p><strong>Node.js的文件系统模块（fs）提供了同步和异步两种版本的API，如</strong> <code>fs.readFile</code>和 <code>fs.readFileSync</code>。</p></blockquote><p><strong>四种写法</strong></p><p><img src="/upload/image-20250207162038459.png" alt="image-20250207162038459.png"></p><h2 id="HTTP服务器"><a href="#HTTP服务器" class="headerlink" title="HTTP服务器"></a>HTTP服务器</h2><h3 id="引入nodejs内置模块"><a href="#引入nodejs内置模块" class="headerlink" title="引入nodejs内置模块"></a>引入nodejs内置模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&#x27;http&#x27;);</span><br><span class="line">const url = require(&#x27;url&#x27;);</span><br></pre></td></tr></table></figure><h3 id="创建服务器"><a href="#创建服务器" class="headerlink" title="创建服务器"></a>创建服务器</h3><blockquote><p><code>http.createServer()</code>函数创建一个新的HTTP服务器实例</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">  // 处理请求和响应</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p><strong>当有请求到达服务器时，回调函数会被触发</strong></p><p><code>req</code>是请求对象，<code>res</code>是响应对象</p></blockquote><h3 id="解析URL"><a href="#解析URL" class="headerlink" title="解析URL"></a>解析URL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const parsedUrl = url.parse(req.url, true);</span><br></pre></td></tr></table></figure><blockquote><p><strong><code>req.url</code></strong>：获取请求的URL（比如 <code>/hello?name=Qwen</code>）</p><p><strong><code>url.parse()</code></strong>：将URL拆解成对象，第二个参数 <code>true</code>表示将查询参数（如 <code>?name=Qwen</code>）解析为对象（<code>parsedUrl.query</code>）</p></blockquote><h3 id="设置响应头"><a href="#设置响应头" class="headerlink" title="设置响应头"></a>设置响应头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.writeHead(200, &#123;&#x27;Content-Type&#x27;: &#x27;text/plain&#x27;&#125;);</span><br></pre></td></tr></table></figure><blockquote><p><strong>状态码200</strong>：表示请求成功</p><p><strong><code>Content-Type: text/plain</code></strong>：告诉浏览器返回的内容是纯文本</p></blockquote><h3 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h3><p><strong>req.url</strong></p><p><strong>req.method</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (req.method === &#x27;GET&#x27;) &#123;</span><br><span class="line">  if (parsedUrl.pathname === &#x27;/hello&#x27;) &#123;//http://localhost:3000/hello?...=...</span><br><span class="line">    // 处理/hello路径</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 处理其他路径</span><br><span class="line">  &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  // 处理非GET请求</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>路径是</strong> <code>/hello</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let name = parsedUrl.query.name || &quot;World&quot;;</span><br><span class="line">res.end(`Hello $&#123;name&#125;!\n`);</span><br></pre></td></tr></table></figure><blockquote><p><strong>获取查询参数</strong>：从 <code>parsedUrl.query</code>中读取 <code>name</code>参数（如 <code>?name=Qwen</code>）</p><p><strong>如果未提供</strong> <code>name</code>，默认值为 <code>World</code></p><p><strong>示例</strong>：访问 <code>http://localhost:3000/hello?name=Qwen</code>会返回 <code>Hello Qwen!</code></p></blockquote><p><strong>其他路径</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.end(&#x27;Welcome to the simple HTTP server!\n&#x27;);</span><br></pre></td></tr></table></figure><blockquote><p><strong>根路径示例</strong>：访问 <code>http://localhost:3000/</code>会返回欢迎消息</p></blockquote><h3 id="非get请求"><a href="#非get请求" class="headerlink" title="非get请求"></a>非get请求</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.writeHead(405, &#123;&#x27;Content-Type&#x27;: &#x27;text/plain&#x27;&#125;);</span><br><span class="line">res.end(&#x27;Method Not Allowed\n&#x27;);</span><br></pre></td></tr></table></figure><blockquote><p><strong>状态码405</strong>：表示服务器不支持该请求方法（如POST、PUT等）</p><p><strong>会返回错误信息</strong> <code>Method Not Allowed</code></p></blockquote><h3 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.listen(3000, () =&gt; &#123;</span><br><span class="line">  console.log(&#x27;Server is listening on port 3000&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><blockquote><p><strong>服务器监听本地的3000端口，启动后打印日志。</strong></p></blockquote><h2 id="调试与部署"><a href="#调试与部署" class="headerlink" title="调试与部署"></a>调试与部署</h2><h3 id="nodemon热重载"><a href="#nodemon热重载" class="headerlink" title="nodemon热重载"></a>nodemon热重载</h3><blockquote><p><code>nodemon</code>是一个用于Node.js应用的工具，它可以监听文件变化并在文件被修改时自动重启服务，这大大提高了开发效率</p></blockquote><h3 id="PM2进程管理"><a href="#PM2进程管理" class="headerlink" title="PM2进程管理"></a>PM2进程管理</h3><blockquote><p><strong>它可以保证你的应用程序始终在线，即使遇到崩溃也能自动重启</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm2 start app.js --name &quot;MyApi&quot;</span><br></pre></td></tr></table></figure><blockquote><p><code>app.js</code>就是你Node.js应用的入口文件</p></blockquote><p><strong>安装</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express nodemon pm2 --save</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/mini-vue%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/mini-vue%E6%90%AD%E5%BB%BA%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="mini-vue搭建笔记"><a href="#mini-vue搭建笔记" class="headerlink" title="mini-vue搭建笔记"></a>mini-vue搭建笔记</h1><h1 id="原理概况"><a href="#原理概况" class="headerlink" title="原理概况"></a>原理概况</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/cuixiaorui/mini-vue</span><br></pre></td></tr></table></figure><h2 id="Vue3模块组织方式"><a href="#Vue3模块组织方式" class="headerlink" title="Vue3模块组织方式"></a>Vue3模块组织方式</h2><h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250219223855962.png?lastModify=1740547033" alt="image-20250219223855962"></p><h3 id="简单来说"><a href="#简单来说" class="headerlink" title="简单来说"></a>简单来说</h3><h4 id="处理编译"><a href="#处理编译" class="headerlink" title="处理编译"></a>处理编译</h4><blockquote><p><code>compiler-sfc</code>专门解析sfc (使用rollup-vue<em><strong>把App.vue单文件组件编译成JS</strong></em>)</p><p><code>compiler-dom</code>依赖core，处理template标签，<em><strong>把template编译转化成一个render函数</strong></em></p><p><code>compiler-core</code>给dom提供依赖</p></blockquote><h4 id="处理运行时"><a href="#处理运行时" class="headerlink" title="处理运行时"></a>处理运行时</h4><blockquote><p><code>runtime-dom</code>依赖core</p><p><code>runtime-core</code><em><strong>最重点的核心代码</strong></em></p><p><code>runtime-reactivity</code>实现vue的<em><strong>响应式</strong></em></p></blockquote><h3 id="更为详细的"><a href="#更为详细的" class="headerlink" title="更为详细的"></a>更为详细的</h3><h4 id="runtime-reactivity-响应式系统"><a href="#runtime-reactivity-响应式系统" class="headerlink" title="runtime-reactivity 响应式系统"></a>runtime-reactivity 响应式系统</h4><blockquote><p><strong>提供了诸如 reactive、ref 等 API 来创建响应式对象或变量。</strong> <strong>使用 WeakMap 数据结构来跟踪依赖关系，确保当数据变化时能够通知相关的观察者进行更新。</strong> <strong>实现了 effect 函数机制，用于自动追踪和触发副作用函数的执行。</strong></p></blockquote><h4 id="runtime-core-跨平台渲染"><a href="#runtime-core-跨平台渲染" class="headerlink" title="runtime-core 跨平台渲染"></a>runtime-core 跨平台渲染</h4><blockquote><p><strong>Vue3 的运行时核心模块，提供了跨平台的渲染能力。它的主要职责包括：</strong> <strong>定义了通用的渲染器接口 createRenderer，允许开发者自定义渲染逻辑。</strong> <strong>实现了组件生命周期管理、插槽机制以及其他运行时所需的基础功能。</strong> <strong>提供了诸如 h 函数这样的工具，用于创建虚拟 DOM 节点。</strong> <strong>包含了与平台无关的运行时核心实现（如虚拟 DOM 的渲染器、组件实现和一些全局的 JS API）。</strong></p></blockquote><h4 id="runtime-dom-DOM方法"><a href="#runtime-dom-DOM方法" class="headerlink" title="runtime-dom DOM方法"></a>runtime-dom DOM方法</h4><blockquote><p><strong>runtime-dom 模块针对浏览器环境实现了具体的运行时逻辑。其主要任务是：</strong> <strong>封装了一系列与 DOM 操作相关的实用方法，如创建元素、插入节点等。</strong> <strong>提供了一个基于 runtime-core 的默认渲染器实例，用于将虚拟 DOM 节点渲染到真实的 DOM 容器中。</strong> <strong>处理特定于浏览器的行为，比如属性绑定、事件监听器添加等。</strong> <strong>对原生 DOM API、属性、样式、事件等进行管理。</strong></p></blockquote><h4 id="compiler-sfc-解析-vue组件"><a href="#compiler-sfc-解析-vue组件" class="headerlink" title="compiler-sfc 解析.vue组件"></a>compiler-sfc 解析.vue组件</h4><blockquote><p><strong>compiler-sfc 模块负责解析单文件组件（.vue 文件），它将 .vue 文件中的 <strong><template></strong>、</strong><script>** 和 <strong><style></strong> 部分分别提取出来，并对它们进行相应的处理。具体而言：** <strong>对于 <strong><template></strong> 部分，会调用 compiler-dom 来将其编译为渲染函数。</strong> <strong>对于 <strong><script></strong> 部分，可能会做一些额外的处理，比如注入上下文或处理 TypeScript 类型声明。</strong> <strong>对于 <strong><style></strong> 部分，则可能涉及 CSS 模块化处理或者其他样式相关的转换。</strong></p></blockquote><h4 id="compiler-core-编译逻辑和算法"><a href="#compiler-core-编译逻辑和算法" class="headerlink" title="compiler-core 编译逻辑和算法"></a>compiler-core 编译逻辑和算法</h4><blockquote><p><strong>作为 Vue 编译的核心模块，compiler-core 是平台无关的，提供了基础的编译逻辑和算法。它的职责是定义了编译的基本流程，包括但不限于：</strong> <strong>提供 baseParse 函数用于解析模板字符串到 AST。</strong> <strong>定义了 transform 方法来对 AST 进行转换。</strong> <strong>实现了 generate 函数用来从 AST 生成最终的渲染函数代码。</strong> <strong>提供了与平台无关的代码转换插件，适用于不同类型的编译需求。</strong></p></blockquote><h4 id="compiler-dom-浏览器模板编译"><a href="#compiler-dom-浏览器模板编译" class="headerlink" title="compiler-dom 浏览器模板编译"></a>compiler-dom 浏览器模板编译</h4><blockquote><p><strong>该模块专注于浏览器端的模板编译工作。它的主要功能包括：</strong> <strong>接收 Vue 的模板字符串作为输入，通过调用 baseCompile 函数来执行实际的编译过程。</strong> <strong>将模板字符串解析为抽象语法树（AST）。</strong> <strong>对 AST 进行必要的转换和优化。</strong> <strong>最终生成可执行的 JavaScript 渲染函数代码，以便在浏览器环境中运行。</strong></p></blockquote><h1 id="runtime-reactivity-响应式系统-1"><a href="#runtime-reactivity-响应式系统-1" class="headerlink" title="runtime-reactivity 响应式系统"></a>runtime-reactivity 响应式系统</h1><h2 id="主流程-脑图"><a href="#主流程-脑图" class="headerlink" title="主流程 | 脑图"></a>主流程 | 脑图</h2><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250220163321605.png?lastModify=1740547033" alt="image-20250220163321605"></p><h3 id="reactive-响应式设置"><a href="#reactive-响应式设置" class="headerlink" title="reactive 响应式设置"></a>reactive 响应式设置</h3><blockquote><p><em><strong>reactivity核心API</strong></em></p><p><strong><code>reactive()</code><strong>创建</strong>对象类型</strong>的响应式数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reactive &#125; from &#x27;vue&#x27;;</span><br><span class="line">const state = reactive(&#123; count: 0 &#125;);</span><br><span class="line">state.count++; // 修改后视图自动更新</span><br></pre></td></tr></table></figure><p><strong><code>ref()</code><strong>创建</strong>任意类型</strong>的响应式数据（通过 <code>.value</code> 访问）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">const num = ref(0);</span><br><span class="line">num.value = 10; // 修改需使用 .value</span><br></pre></td></tr></table></figure><p>**<code>computed()</code>**创建依赖其他数据的计算属性：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const doubleCount = computed(() =&gt; state.count * 2);</span><br></pre></td></tr></table></figure><p>**<code>watch()</code> 和 <code>watchEffect()</code>**监听数据变化执行副作用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">watch(num, (newVal) =&gt; console.log(&#x27;num变化:&#x27;, newVal));</span><br><span class="line">watchEffect(() =&gt; console.log(&#x27;count变化:&#x27;, state.count));</span><br></pre></td></tr></table></figure></blockquote><h4 id="reactive-单测"><a href="#reactive-单测" class="headerlink" title="reactive 单测"></a>reactive 单测</h4><p><strong>reactivity / tests / reactive.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reactive, isReactive, toRaw, reactiveMap &#125; from &quot;../src/reactive&quot;;</span><br></pre></td></tr></table></figure><blockquote><p><code>reactive</code>: 将普通对象转换为响应式对象。** <strong><code>isReactive</code>: 检查一个对象是否是响应式对象。</strong> <strong><code>toRaw</code>: 获取响应式对象对应的原始对象。</strong> **<code>reactiveMap</code>: 内部使用的 Map 数据结构，用于存储原始对象和响应式对象之间的映射关系。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">describe(&quot;reactive&quot;, () =&gt; &#123;</span><br><span class="line">  test(&quot;Object&quot;, () =&gt; &#123;//测试用例1 | 基本功能：确保 reactive 方法能够正确地将普通对象转换为响应式对象。</span><br><span class="line">    const original = &#123; foo: 1 &#125;;</span><br><span class="line">    const observed = reactive(original);//将普通对象转换为响应式对象</span><br><span class="line">    expect(observed).not.toBe(original);//确保 reactive 返回的对象与原始对象不是同一个引用</span><br><span class="line">    expect(isReactive(observed)).toBe(true);//验证 observed 是响应式对象</span><br><span class="line">    expect(isReactive(original)).toBe(false);//而 original 不是</span><br><span class="line">    expect(observed.foo).toBe(1);//可读取</span><br><span class="line">    expect(&quot;foo&quot; in observed).toBe(true);//存在</span><br><span class="line">    expect(Object.keys(observed)).toEqual([&quot;foo&quot;]);//自有属性键名</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  test(&quot;nested reactives&quot;, () =&gt; &#123;//测试用例2 | 嵌套对象支持：确保嵌套对象和数组也能被正确转换为响应式对象。</span><br><span class="line">    const original = &#123;//定义一个复杂对象</span><br><span class="line">      nested: &#123;//嵌套对象</span><br><span class="line">        foo: 1,</span><br><span class="line">      &#125;,</span><br><span class="line">      array: [&#123; bar: 2 &#125;],//数组</span><br><span class="line">    &#125;;</span><br><span class="line">    const observed = reactive(original);//将复杂对象转换为响应式对象</span><br><span class="line">    expect(isReactive(observed.nested)).toBe(true);</span><br><span class="line">    expect(isReactive(observed.array)).toBe(true);</span><br><span class="line">    expect(isReactive(observed.array[0])).toBe(true);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  test(&quot;toRaw&quot;, () =&gt; &#123;//测试用例3 | toRaw 方法：确保可以正确地从响应式对象中获取原始对象。</span><br><span class="line">    const original = &#123; foo: 1 &#125;;</span><br><span class="line">    const observed = reactive(original);</span><br><span class="line">    expect(toRaw(observed)).toBe(original);//确保通过 toRaw 方法可以从响应式对象 observed 中获取原始对象 original</span><br><span class="line">    expect(toRaw(original)).toBe(original);//如果直接对原始对象调用 toRaw，应该返回原始对象本身</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="reactive-源码实现（Proxy）"><a href="#reactive-源码实现（Proxy）" class="headerlink" title="reactive 源码实现（Proxy）"></a>reactive 源码实现（<em>Proxy</em>）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function reactive(target) &#123;</span><br><span class="line">  return createReactiveObject(target, reactiveMap, mutableHandlers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>👇</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function createReactiveObject(target, proxyMap, baseHandlers) &#123;//原理是JS创建的Proxy对象，目的是可以侦听到用户 get 或者 set 的动作</span><br><span class="line">    </span><br><span class="line">  const existingProxy = proxyMap.get(target);//先检查 proxyMap 中是否已经存在与当前 target 对应的代理对象。</span><br><span class="line">  if (existingProxy) &#123;//存在则直接返回缓存中的代理对象，避免重复创建。</span><br><span class="line">    return existingProxy;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //target 被代理的目标对象</span><br><span class="line">  //baseHandlers 一个拦截器对象，定义了代理的行为（例如如何处理 get 和 set 操作）</span><br><span class="line">  const proxy = new Proxy(target, baseHandlers);</span><br><span class="line"></span><br><span class="line">  proxyMap.set(target, proxy);//把创建好的 proxy 给存起来</span><br><span class="line">  return proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>另：回顾Proxy功能 | 可在用户对目标对象的</strong>***访问(get)<em><strong>和</strong></em>修改(set)***操作中，自定义逻辑（如触发依赖更新）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 定义一个目标对象</span><br><span class="line">const target = &#123; count: 0 &#125;;</span><br><span class="line"></span><br><span class="line">// 创建一个 Proxy 对象</span><br><span class="line">const reactiveObj = new Proxy(target, &#123;</span><br><span class="line">get(target, key, receiver) &#123;</span><br><span class="line">console.log(`Getting $&#123;key&#125;`);</span><br><span class="line">return Reflect.get(target, key, receiver);</span><br><span class="line">&#125;,</span><br><span class="line">set(target, key, value, receiver) &#123;</span><br><span class="line">console.log(`Setting $&#123;key&#125; to $&#123;value&#125;`);</span><br><span class="line">const result = Reflect.set(target, key, value, receiver);</span><br><span class="line">if (result) &#123;</span><br><span class="line">console.log(&quot;Trigger updates...&quot;);</span><br><span class="line">&#125;</span><br><span class="line">return result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 测试</span><br><span class="line">console.log(reactiveObj.count); // 输出: Getting count</span><br><span class="line">reactiveObj.count++; // 输出: Setting count to 1 和 Trigger updates...</span><br></pre></td></tr></table></figure></blockquote><h3 id="init-初始化"><a href="#init-初始化" class="headerlink" title="init 初始化"></a>init 初始化</h3><h4 id="effect-单测"><a href="#effect-单测" class="headerlink" title="effect 单测"></a>effect 单测</h4><blockquote><p><em><strong>effect 函数功能</strong></em></p><p><strong>当依赖的数据发生变化时，自动重新执行指定的函数。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reactive, effect &#125; from &#x27;@vue/reactivity&#x27;;</span><br><span class="line"></span><br><span class="line">const state = reactive(&#123; count: 0 &#125;);</span><br><span class="line"></span><br><span class="line">// effect函数</span><br><span class="line">effect(() =&gt; &#123;</span><br><span class="line">console.log(`Count is $&#123;state.count&#125;`);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 修改状态</span><br><span class="line">state.count++; // 输出: Count is 1</span><br><span class="line">state.count++; // 输出: Count is 2</span><br></pre></td></tr></table></figure><p>**手动停止 **<code>effect</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 创建一个 effect 并获取停止函数</span><br><span class="line">const stop = effect(() =&gt; &#123;</span><br><span class="line">console.log(`Count is $&#123;state.count&#125;`);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 修改状态</span><br><span class="line">state.count++; // 输出: Count is 1</span><br><span class="line">// 停止 effect</span><br><span class="line">stop();</span><br><span class="line">// 再次修改状态，但 effect 不再触发</span><br><span class="line">state.count++; // 无输出</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reactive &#125; from &quot;../src/reactive&quot;;</span><br><span class="line">import &#123; effect, stop &#125; from &quot;../src/effect&quot;;</span><br><span class="line">import &#123; vi &#125; from &quot;vitest&quot;;</span><br><span class="line"></span><br><span class="line">describe(&quot;effect&quot;, () =&gt; &#123;</span><br><span class="line">  it(&quot;should run the passed function once (wrapped by a effect)&quot;, () =&gt; &#123; //验证 effect 函数是否会立即执行传入的函数一次</span><br><span class="line">    const fnSpy = vi.fn(() =&gt; &#123;&#125;);//创建一个间谍函数fnSpy</span><br><span class="line">    effect(fnSpy);//fnSpy作为参数传递给effect函数</span><br><span class="line">    expect(fnSpy).toHaveBeenCalledTimes(1);//验证fnSpy是否被调用了一次</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;should observe basic properties&quot;, () =&gt; &#123;//验证 effect 函数是否能够观察到响应式对象的基本属性的变化</span><br><span class="line">    let dummy;</span><br><span class="line">    const counter = reactive(&#123; num: 0 &#125;);</span><br><span class="line">    effect(() =&gt; (dummy = counter.num));//使用 effect 函数包裹一个箭头函数，该函数将 counter.num 的值赋给 dummy。</span><br><span class="line">    </span><br><span class="line">    expect(dummy).toBe(0);</span><br><span class="line">    counter.num = 7;</span><br><span class="line">    expect(dummy).toBe(7);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;should observe multiple properties&quot;, () =&gt; &#123;//验证 effect 函数是否能够观察到响应式对象的多个属性的变化</span><br><span class="line">    let dummy;</span><br><span class="line">    const counter = reactive(&#123; num1: 0, num2: 0 &#125;);</span><br><span class="line">    effect(() =&gt; (dummy = counter.num1 + counter.num1 + counter.num2));</span><br><span class="line">    </span><br><span class="line">    expect(dummy).toBe(0);</span><br><span class="line">    counter.num1 = counter.num2 = 7;</span><br><span class="line">    expect(dummy).toBe(21);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;should handle multiple effects&quot;, () =&gt; &#123;//验证 effect 函数是否能够处理多个响应式依赖</span><br><span class="line">    let dummy1, dummy2;</span><br><span class="line">    const counter = reactive(&#123; num: 0 &#125;);</span><br><span class="line">    effect(() =&gt; (dummy1 = counter.num));</span><br><span class="line">    effect(() =&gt; (dummy2 = counter.num));</span><br><span class="line"></span><br><span class="line">    expect(dummy1).toBe(0);</span><br><span class="line">    expect(dummy2).toBe(0);</span><br><span class="line">    counter.num++;</span><br><span class="line">    expect(dummy1).toBe(1);</span><br><span class="line">    expect(dummy2).toBe(1);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;should observe nested properties&quot;, () =&gt; &#123;//验证 effect 函数是否能够观察到嵌套属性的变化</span><br><span class="line">    let dummy;</span><br><span class="line">    const counter = reactive(&#123; nested: &#123; num: 0 &#125; &#125;);</span><br><span class="line">    effect(() =&gt; (dummy = counter.nested.num));</span><br><span class="line"></span><br><span class="line">    expect(dummy).toBe(0);</span><br><span class="line">    counter.nested.num = 8;</span><br><span class="line">    expect(dummy).toBe(8);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;should observe function call chains&quot;, () =&gt; &#123;//验证 effect 函数是否能够观察到函数调用链的变化</span><br><span class="line">    let dummy;</span><br><span class="line">    const counter = reactive(&#123; num: 0 &#125;);</span><br><span class="line">    effect(() =&gt; (dummy = getNum()));</span><br><span class="line"></span><br><span class="line">    function getNum() &#123;</span><br><span class="line">      return counter.num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    expect(dummy).toBe(0);</span><br><span class="line">    counter.num = 2;</span><br><span class="line">    expect(dummy).toBe(2);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;scheduler&quot;, () =&gt; &#123;//验证 effect 函数是否能够正确地调用 scheduler 函数</span><br><span class="line">    let dummy;</span><br><span class="line">    let run: any;</span><br><span class="line">    const scheduler = vi.fn(() =&gt; &#123;</span><br><span class="line">      run = runner;</span><br><span class="line">    &#125;);</span><br><span class="line">    const obj = reactive(&#123; foo: 1 &#125;);</span><br><span class="line">    const runner = effect(</span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        dummy = obj.foo;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; scheduler &#125;</span><br><span class="line">    );</span><br><span class="line">    expect(scheduler).not.toHaveBeenCalled();</span><br><span class="line">    expect(dummy).toBe(1);</span><br><span class="line">    // should be called on first trigger</span><br><span class="line">    obj.foo++;</span><br><span class="line">    expect(scheduler).toHaveBeenCalledTimes(1);</span><br><span class="line">    // // should not run yet</span><br><span class="line">    expect(dummy).toBe(1);</span><br><span class="line">    // // manually run</span><br><span class="line">    run();</span><br><span class="line">    // // should have run</span><br><span class="line">    expect(dummy).toBe(2);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;stop&quot;, () =&gt; &#123;//验证 effect 函数是否能够正确地停止观察</span><br><span class="line">    let dummy;</span><br><span class="line">    const obj = reactive(&#123; prop: 1 &#125;);</span><br><span class="line">    const runner = effect(() =&gt; &#123;</span><br><span class="line">      dummy = obj.prop;</span><br><span class="line">    &#125;);</span><br><span class="line">    obj.prop = 2;</span><br><span class="line">    expect(dummy).toBe(2);</span><br><span class="line">    stop(runner);</span><br><span class="line">    // obj.prop = 3</span><br><span class="line">    obj.prop++;</span><br><span class="line">    expect(dummy).toBe(2);</span><br><span class="line"></span><br><span class="line">    // stopped effect should still be manually callable</span><br><span class="line">    runner();</span><br><span class="line">    expect(dummy).toBe(3);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(&quot;events: onStop&quot;, () =&gt; &#123;//验证 effect 函数是否能够正确地触发 onStop 事件</span><br><span class="line">    const onStop = vi.fn();</span><br><span class="line">    const runner = effect(() =&gt; &#123;&#125;, &#123;</span><br><span class="line">      onStop,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    stop(runner);</span><br><span class="line">    expect(onStop).toHaveBeenCalled();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="effect-源码实现"><a href="#effect-源码实现" class="headerlink" title="effect 源码实现"></a>effect 源码实现</h4><p><strong>effect函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export function effect(fn, options = &#123;&#125;) &#123;</span><br><span class="line">    //fn：用户传入的副作用函数，该函数内部通常会访问响应式数据，当这些响应式数据发生变化时，fn 会被重新执行。</span><br><span class="line">    //options：一个可选的配置对象，默认值为空对象 &#123;&#125;。</span><br><span class="line">    const _effect = new ReactiveEffect(fn);</span><br><span class="line"></span><br><span class="line">    extend(_effect, options);//将用户传入的 options 配置对象合并到_effect 实例上，但不容易直接看出 _effect 实例上有哪些额外的属性</span><br><span class="line">    _effect.run();//调用内部run方法</span><br><span class="line"></span><br><span class="line">    // 将 _effect.run 方法绑定到 _effect 实例上，创建一个新的函数 runner</span><br><span class="line">    // 当调用 runner 函数时，实际上是调用 _effect.run 方法</span><br><span class="line">    const runner: any = _effect.run.bind(_effect);</span><br><span class="line">    //在 runner 函数上添加一个 effect 属性，指向 _effect 实例</span><br><span class="line">    runner.effect = _effect;</span><br><span class="line">    return runner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="执行fn"><a href="#执行fn" class="headerlink" title="执行fn"></a>执行fn</h5><p><strong>ReactiveEffect类</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">export class ReactiveEffect &#123;</span><br><span class="line">  active = true; //标记该副作用函数是否处于活跃状态</span><br><span class="line">  deps = []; //存储该副作用函数的所有依赖项</span><br><span class="line">  public onStop?: () =&gt; void; //副作用函数停止时的回调</span><br><span class="line">  constructor(public fn, public scheduler?) &#123;</span><br><span class="line">    console.log(&quot;创建 ReactiveEffect 对象&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run() &#123;</span><br><span class="line">    console.log(&quot;run&quot;);</span><br><span class="line">      </span><br><span class="line">    //如果 this.active 为 false，表示该副作用函数已经被停止（调用了 stop 方法），此时直接执行 this.fn() 并返回结果，不进行依赖收集。</span><br><span class="line">    if (!this.active) &#123;</span><br><span class="line">      return this.fn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shouldTrack = true;//全局变量，控制是否进行依赖收集。true表示开始收集依赖。</span><br><span class="line">    activeEffect = this as any;//全局变量，存储当前正在执行的副作用函数。this表示当前正在执行的副作用函数是 ReactiveEffect 的实例。</span><br><span class="line">      </span><br><span class="line">    console.log(&quot;执行用户传入的 fn&quot;);</span><br><span class="line">    const result = this.fn();</span><br><span class="line"></span><br><span class="line">    shouldTrack = false;//停止依赖收集。</span><br><span class="line">    activeEffect = undefined;//当前没有正在执行的副作用函数。</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    if (this.active) &#123;//该副作用函数已经被停止</span><br><span class="line">      // 如果第一次执行 stop 后 active 就 false 了，这是为了防止重复的调用，执行 stop 逻辑</span><br><span class="line">      cleanupEffect(this);//从所有依赖该副作用函数的响应式对象中移除该副作用函数，从而停止响应式追踪</span><br><span class="line">      if (this.onStop) &#123;//this.onStop 存在，则调用该回调函数，允许用户在副作用函数停止时执行自定义逻辑</span><br><span class="line">        this.onStop();</span><br><span class="line">      &#125;</span><br><span class="line">      this.active = false;//副作用函数已经停止</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="触发get-访问"><a href="#触发get-访问" class="headerlink" title="触发get(访问)"></a>触发get(访问)</h5><h5 id="执行track-收集依赖"><a href="#执行track-收集依赖" class="headerlink" title="执行track(收集依赖)"></a>执行track(收集依赖)</h5><h5 id="把effect收集起来作为依赖"><a href="#把effect收集起来作为依赖" class="headerlink" title="把effect收集起来作为依赖"></a>把effect收集起来作为依赖</h5><h3 id="update-更新"><a href="#update-更新" class="headerlink" title="update 更新"></a>update 更新</h3><h4 id="例：effect-单测"><a href="#例：effect-单测" class="headerlink" title="例：effect 单测"></a>例：effect 单测</h4><h5 id="触发set-修改"><a href="#触发set-修改" class="headerlink" title="触发set(修改)"></a>触发set(修改)</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">it(&quot;should observe basic properties&quot;, () =&gt; &#123;//验证 effect 函数是否能够观察到响应式对象的基本属性的变化</span><br><span class="line">    let dummy;</span><br><span class="line">    const counter = reactive(&#123; num: 0 &#125;);</span><br><span class="line">    effect(() =&gt; (dummy = counter.num));</span><br><span class="line"></span><br><span class="line">    expect(dummy).toBe(0);</span><br><span class="line">    counter.num = 7;// 更新时触发set操作</span><br><span class="line">    expect(dummy).toBe(7);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="执行trigger-触发依赖"><a href="#执行trigger-触发依赖" class="headerlink" title="执行trigger(触发依赖)"></a>执行trigger(触发依赖)</h5><p><strong>baseHandlers.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function createSetter() &#123;</span><br><span class="line">    return function set(target, key, value, receiver) &#123;</span><br><span class="line">        const result = Reflect.set(target, key, value, receiver)</span><br><span class="line"></span><br><span class="line">        trigger(target, &#x27;set&#x27;, key)// 触发trigger后重新运行effect函数</span><br><span class="line"></span><br><span class="line">        return result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="effect重新运行"><a href="#effect重新运行" class="headerlink" title="effect重新运行"></a>effect重新运行</h5><blockquote><p><strong>执行fn-&gt;触发get(访问)-&gt;执行track(收集依赖)-&gt;把effect收集起来作为依赖</strong></p></blockquote><h2 id="baseHandlers-脑图"><a href="#baseHandlers-脑图" class="headerlink" title="baseHandlers | 脑图"></a>baseHandlers | 脑图</h2><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250220164149032.png?lastModify=1740547033" alt="image-20250220164149032"></p><p><strong>直达src / baseHandlers.ts</strong></p><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">function createGetter(isReadonly = false, shallow = false) &#123;</span><br><span class="line">  return function get(target, key, receiver) &#123;</span><br><span class="line">    //这些辅助函数用于检查 key 是否为 ReactiveFlags.RAW，并且 receiver 是否与相应的映射表（reactiveMap、readonlyMap 或 shallowReadonlyMap）中的目标对象匹配。</span><br><span class="line">    const isExistInReactiveMap = () =&gt;</span><br><span class="line">      key === ReactiveFlags.RAW &amp;&amp; receiver === reactiveMap.get(target);</span><br><span class="line"></span><br><span class="line">    const isExistInReadonlyMap = () =&gt;</span><br><span class="line">      key === ReactiveFlags.RAW &amp;&amp; receiver === readonlyMap.get(target);</span><br><span class="line"></span><br><span class="line">    const isExistInShallowReadonlyMap = () =&gt;</span><br><span class="line">      key === ReactiveFlags.RAW &amp;&amp; receiver === shallowReadonlyMap.get(target);</span><br><span class="line"></span><br><span class="line">    if (key === ReactiveFlags.IS_REACTIVE) &#123;//表示对象是否为响应式对象。</span><br><span class="line">      return !isReadonly;</span><br><span class="line">    &#125; else if (key === ReactiveFlags.IS_READONLY) &#123;</span><br><span class="line">      return isReadonly;</span><br><span class="line">    &#125; else if (//表示对象是否为只读对象。</span><br><span class="line">      isExistInReactiveMap() ||</span><br><span class="line">      isExistInReadonlyMap() ||</span><br><span class="line">      isExistInShallowReadonlyMap()</span><br><span class="line">    ) &#123;</span><br><span class="line">      return target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //假设obj=&#123;foo:1&#125; key:foo -&gt; res = 1 res就是目标对象的属性值//</span><br><span class="line">    const res = Reflect.get(target, key, receiver);</span><br><span class="line"></span><br><span class="line">    if (!isReadonly) &#123;//如果对象不是只读的，调用 track 函数进行依赖收集。只读对象不会被修改，也就不会触发 trigger 函数，所以不需要收集依赖。</span><br><span class="line">      // 在触发 get 的时候进行依赖收集</span><br><span class="line">      track(target, &quot;get&quot;, key);//触发track</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (shallow) &#123;//如果是浅响应式模式，直接返回属性值，不进行递归处理</span><br><span class="line">      return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isObject(res)) &#123;//如果属性值是一个对象，根据 isReadonly 的值，将其转换为只读响应式对象或普通响应式对象</span><br><span class="line">      // res 等于 target[key]</span><br><span class="line">      return isReadonly ? readonly(res) : reactive(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return res;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function createSetter() &#123;</span><br><span class="line">    return function set(target, key, value, receiver) &#123;</span><br><span class="line">         //假设obj=&#123;foo:1&#125; key:foo -&gt; value可变2//</span><br><span class="line">         //obj=&#123;foo:2&#125;//</span><br><span class="line">        const result = Reflect.set(target, key, value, receiver)//设置对象的属性值</span><br><span class="line"></span><br><span class="line">        trigger(target, &#x27;set&#x27;, key)//trigger函数会通知所有依赖该属性的副作用函数重新执行，以确保响应式系统能够正确更新相关的视图或数据。</span><br><span class="line"></span><br><span class="line">        return result//设置完成，返回结果</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="deleteProperty"><a href="#deleteProperty" class="headerlink" title="deleteProperty"></a>deleteProperty</h3><h3 id="has"><a href="#has" class="headerlink" title="has"></a>has</h3><h3 id="ownKeys"><a href="#ownKeys" class="headerlink" title="ownKeys"></a>ownKeys</h3><h2 id="track-收集依赖-脑图"><a href="#track-收集依赖-脑图" class="headerlink" title="track(收集依赖) | 脑图"></a>track(收集依赖) | 脑图</h2><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250220212111915.png?lastModify=1740547033" alt="image-20250220212111915"></p><h3 id="初始化dep"><a href="#初始化dep" class="headerlink" title="初始化dep"></a>初始化dep</h3><p><strong>src / effect.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">export function track(target, type, key) &#123;</span><br><span class="line">    //target：响应式对象，即被代理的原始对象。</span><br><span class="line">    //type：操作类型，例如 GET、SET 等，不过在当前代码中，type 参数未被使用。</span><br><span class="line">    //key：响应式对象的属性名。</span><br><span class="line">    if (!isTracking()) &#123;//当前是否允许进行依赖收集</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(`触发 track -&gt; target: $&#123;target&#125; type:$&#123;type&#125; key:$&#123;key&#125;`);</span><br><span class="line">    </span><br><span class="line">    let depsMap = targetMap.get(target);//targetMap 是一个 WeakMap，用于存储每个响应式对象对应的 depsMap</span><br><span class="line">    if (!depsMap) &#123;// 如果是第一次的话，初始化 depsMap 的逻辑</span><br><span class="line">        depsMap = new Map();// 创建一个新的 Map 实例</span><br><span class="line">        targetMap.set(target, depsMap);//存储到 targetMap 中</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let dep = depsMap.get(key);//depsMap 是一个 Map，存储每个属性对应的 dep</span><br><span class="line">    if (!dep) &#123;</span><br><span class="line">        dep = createDep();//创建一个新的 dep 实例</span><br><span class="line">        depsMap.set(key, dep);//存储到 depsMap 中</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    trackEffects(dep);//将当前的副作用函数（activeEffect）添加到 dep 中，并将 dep 添加到 activeEffect 的 deps 数组中</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="基于activeEffect获取当前依赖-dep-push-activeEffect"><a href="#基于activeEffect获取当前依赖-dep-push-activeEffect" class="headerlink" title="基于activeEffect获取当前依赖 &amp; dep.push(activeEffect)"></a>基于activeEffect获取当前依赖 &amp; dep.push(activeEffect)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export function trackEffects(dep) &#123;</span><br><span class="line">    // 将当前活跃的副作用函数（activeEffect）添加到对应的依赖集合（dep）中，同时将该依赖集合添加到副作用函数的依赖列表（deps）里。</span><br><span class="line">    if (!dep.has(activeEffect)) &#123;//检查是否已收集副函数</span><br><span class="line">        dep.add(activeEffect);//添加</span><br><span class="line">        (activeEffect as any).deps.push(dep);//添加依赖集合到副作用函数的依赖列表</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="trigger-触发依赖-脑图"><a href="#trigger-触发依赖-脑图" class="headerlink" title="trigger(触发依赖) | 脑图"></a>trigger(触发依赖) | 脑图</h2><p><strong>src / effect.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">export function trigger(target, type, key) &#123;</span><br><span class="line">    // target：响应式对象，即被代理的原始对象。</span><br><span class="line">    // type：操作类型，例如 GET、SET 等。不过在当前代码中，暂时只处理了 GET 类型。</span><br><span class="line">    // key：响应式对象的属性名。</span><br><span class="line">    let deps: Array&lt;any&gt; = [];//存储所有依赖该属性的依赖集合（dep）</span><br><span class="line"></span><br><span class="line">    const depsMap = targetMap.get(target);//从 targetMap 中获取 target 对应的 depsMap</span><br><span class="line"></span><br><span class="line">    if (!depsMap) return;</span><br><span class="line"></span><br><span class="line">    // 暂时只实现了 GET 类型</span><br><span class="line">    // get 类型只需要取出来就可以</span><br><span class="line">    const dep = depsMap.get(key);</span><br><span class="line"></span><br><span class="line">    deps.push(dep);// 最后收集到 deps 内</span><br><span class="line"></span><br><span class="line">    const effects: Array&lt;any&gt; = [];</span><br><span class="line">    deps.forEach((dep) =&gt; &#123; // 这里解构 dep 得到的是 dep 内部存储的 effect</span><br><span class="line">        effects.push(...dep);</span><br><span class="line">    &#125;);</span><br><span class="line">    // 这里的目的是只有一个 dep ，这个dep 里面包含所有的 effect</span><br><span class="line">    // 这里的目前应该是为了 triggerEffects 这个函数的复用</span><br><span class="line">    triggerEffects(createDep(effects));// 触发该依赖集合中的所有副作用函数重新执行</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>src / dep.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export function createDep(effects?) &#123;</span><br><span class="line">    // Set 是 JavaScript 中的一种数据结构，类似于数组，但成员的值都是唯一的，没有重复的值。</span><br><span class="line">    const dep = new Set(effects);// 将传入的 effects 作为初始值填充到这个 Set 中</span><br><span class="line">    return dep;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>src / effect.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export function triggerEffects(dep) &#123; // dep 是一个存储副作用函数的集合，通常是一个 Set 类型，用于记录依赖于某个响应式对象属性的所有副作用函数。</span><br><span class="line">    for (const effect of dep) &#123;// 遍历 dep 集合中的每个副作用函数 effect</span><br><span class="line">        if (effect.scheduler) &#123;// effect.scheduler存在</span><br><span class="line">            // scheduler 可以让用户自己选择调用的时机，这样就可以灵活的控制调用了</span><br><span class="line">            // 在 runtime-core 中，就是使用了 scheduler 实现了在 next ticker 中调用的逻辑</span><br><span class="line">            effect.scheduler();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            effect.run();// 直接调用 effect.run() 方法，执行副作用函数。</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="runtime-core-初始化核心"><a href="#runtime-core-初始化核心" class="headerlink" title="runtime-core 初始化核心"></a>runtime-core 初始化核心</h1><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p><strong>example / helloWorld</strong></p><p><strong>index.html</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=&quot;main.js&quot; type=&quot;module&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><strong>main.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createApp &#125; from &quot;../../dist/mini-vue.esm-bundler.js&quot;;</span><br><span class="line">import App from &quot;./App.js&quot;;</span><br><span class="line"></span><br><span class="line">const rootContainer = document.querySelector(&quot;#root&quot;);//获取根标签节点</span><br><span class="line">createApp(App).mount(rootContainer); //createApp(传入根组件).mount(传入根容器)</span><br></pre></td></tr></table></figure><p><strong>App.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;//一个对象</span><br><span class="line">    name: &quot;App&quot;,//标记当前组件的名字</span><br><span class="line">    setup(props,context) &#123;&#125;,//一个在组件创建之前执行的函数，可使用响应式数据、生命周期钩子、计算属性等</span><br><span class="line"></span><br><span class="line">    render() &#123;//把template转化成render函数，代表这个组件想要渲染出来的视图</span><br><span class="line">        //tag标签名(div)  props属性对象  children数据包含了(div 元素的子节点)</span><br><span class="line">        return h(&quot;div&quot;, &#123; tId: 1 &#125;, [h(&quot;p&quot;, &#123;&#125;, &quot;主页&quot;), h(HelloWorld)]);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="渲染流程详解"><a href="#渲染流程详解" class="headerlink" title="渲染流程详解"></a>渲染流程详解</h2><h3 id="mount-初始化流程"><a href="#mount-初始化流程" class="headerlink" title="mount 初始化流程"></a>mount 初始化流程</h3><blockquote><p><strong>先进入main.js---获取到根容器---触发createApp函数---调用createApp内部App对象的mount函数---mount内部基于传来的根容器生成虚拟节点vnode(一个普通对象但有几个关键的key，最关键的是有type对象[和传入的对象是一样的name|setup|render])</strong></p><p><strong>调用mount内部的render---调用内部patch方法---解构出type对象---switch判断type的类型从而用不同的方法处理</strong></p><blockquote><p><strong>component</strong> 组件类型---调用processComponent---根据!n1分成初始化or更新</p></blockquote><blockquote><blockquote><p><strong>mountComponent</strong> 初始化---模板初始化对象+把vnode虚拟节点挂在到该对象上---<em><strong>setupComponent</strong></em>---initProps+initSlots+setupStatefulComponent初始化props/slots/setup&amp;处理组件---在setupStatefulComponent创建一个代理对象[还是那个传来的type对象]将其绑定到instance对象上---传入instance触发setcurrentinstance---handlesetupResult基于setup中的props和context做出一定的处理---1.setup返回一个函数[会把它当成render函数去写] 2.setup返回一个对象[赋值,调用finishComponentSetup,如果没有render会将Component的render赋值给它]</p></blockquote></blockquote><blockquote><blockquote><p><strong>往回走走到</strong><em><strong>setupComponent</strong></em>，instance.update使用effect调用componentUpdateFn---该函数中要调用传来对象里的render函数获取vnode子组件生成好的虚拟节点---在componentUpdateFn触发<em><strong>patch</strong></em>(递归回去了)【!此时已经变成<strong>element</strong>元素类型了!】</p></blockquote></blockquote><blockquote><blockquote><p><strong>updateComponent</strong> 更新</p></blockquote></blockquote><blockquote><p><strong>element</strong> 元素类型---调用processElement---根据!n1分成初始化or更新</p></blockquote><blockquote><blockquote><p><strong>mountElement</strong> 初始化(把虚拟节点转化成一个真实的dom元素)---创建el(真实的element)---[文本类型调用hostcreateElement]---[数组类型调用mountChildren]传入childer节点,el---遍历数组触发<em><strong>patch</strong></em>(递归)【!此时数组元素就是<strong>element</strong>类型!】</p></blockquote></blockquote><blockquote><blockquote><p><strong>仍然位于mountElement函数中,如果元素props存在,遍历调用****hostPatchProp</strong>(传入el,key,null,val)---分类,内部处理还是调用了dom内部的API</p></blockquote></blockquote><blockquote><blockquote><p><strong>返回mountElement函数,下一步调用****hostInsert</strong>(el,container[根组件])[将所有的一切插回#root根元素组件]到此所有元素就都在页面上展示出来了，也就是初始化的全过程</p></blockquote></blockquote><blockquote><blockquote><p><strong>patchElement</strong></p></blockquote></blockquote></blockquote><blockquote><p>**通俗来说：**<em><strong>调用render就是“拆箱”的过程</strong></em>直到把内部所有的组件渲染到浏览器上</p></blockquote><h3 id="update-更新流程"><a href="#update-更新流程" class="headerlink" title="update 更新流程"></a>update 更新流程</h3><p><strong>App.js 样例变动</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">export default &#123;//一个对象</span><br><span class="line">    name: &quot;App&quot;,//标记当前组件的名字</span><br><span class="line">    setup(props,context) &#123;//一个在组件创建之前执行的函数，可使用响应式数据、生命周期钩子、计算属性等</span><br><span class="line">        const count = ref(10)</span><br><span class="line">        window.count = count</span><br><span class="line">        </span><br><span class="line">        return&#123;</span><br><span class="line">            count,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    render() &#123;//把template转化成render函数，代表这个组件想要渲染出来的视图</span><br><span class="line">        //tag标签名(div)  props属性对象  children数据包含了(div 元素的子节点)</span><br><span class="line">        return h(&quot;div&quot;, &#123; tId: 1 &#125;, [h(&quot;p&quot;, &#123;&#125;, &quot;主页&quot; + this.count)]);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><strong>响应式的值发生改变(响应式对象都在render函数内)---执行用户传入的fn---判断是否初始化---触发当前组件的effect函数执行(instance,update)---调用render函数(获取前后虚拟节点树节点)---触发</strong><em><strong>patch</strong></em>(前后虚拟节点树节点)---根据!n2分成<strong>component</strong>组件类型or<strong>element</strong>元素类型</p><p><em><em>更新逻辑：<strong><em><strong>processXXX</strong></em>中n1存在---进入</strong></em>updateXXX</em>**(n1,n2)---取出新(n1&amp;n2)老(n2&amp;{})props---n2.el=n1.el---对比props(patchProps)---对比children(patchChild)双端对比算法实现</p></blockquote><h1 id="逐步搭建"><a href="#逐步搭建" class="headerlink" title="逐步搭建"></a>逐步搭建</h1><h2 id="初始化项目-搭建环境"><a href="#初始化项目-搭建环境" class="headerlink" title="初始化项目+搭建环境"></a>初始化项目+搭建环境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line">npm install --save-dev jest</span><br><span class="line">pnpm add typescript --save-dev</span><br><span class="line">npx tsc --init</span><br><span class="line">pnpm add --save-dev jest</span><br><span class="line">pnpm i --save-dev @types/node</span><br></pre></td></tr></table></figure><p><strong>替换 package.json &amp; tsconfig.json</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;jest&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;types&quot;: [&quot;jest&quot;],</span><br><span class="line">&quot;noImplicitAny&quot;: false,//把any报错忽略掉</span><br></pre></td></tr></table></figure><p><strong>配置bable环境</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add --save-dev babel-jest @babel/core @babel/preset-env @babel/preset-typescript</span><br></pre></td></tr></table></figure><p><strong>根目录下创建一个</strong> <code>babel.config.js</code>文件</p><blockquote><p><strong>以当前node版本做一个转换 | 支持TS</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    [&#x27;@babel/preset-env&#x27;, &#123;targets: &#123;node: &#x27;current&#x27;&#125;&#125;],</span><br><span class="line">    &#x27;@babel/preset-typescript&#x27;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>编写测试文件</strong></p><p><strong>reactivity / index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function sum(a, b) &#123;</span><br><span class="line">    return a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>reactivity / tests / index.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;index&#x27;, () =&gt; &#123;</span><br><span class="line">    expect(1).toBe(1)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>单测运行</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm test</span><br></pre></td></tr></table></figure><h2 id="runtime-reactivity-响应式系统实现"><a href="#runtime-reactivity-响应式系统实现" class="headerlink" title="runtime-reactivity 响应式系统实现"></a>runtime-reactivity 响应式系统实现</h2><h3 id="编写单测"><a href="#编写单测" class="headerlink" title="编写单测"></a>编写单测</h3><h4 id="effect"><a href="#effect" class="headerlink" title="effect"></a>effect</h4><p><strong>reactivity / texts / effect.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import &#123; effect &#125; from &#x27;../effect&#x27;</span><br><span class="line">import &#123; reactive &#125; from &#x27;../reactive&#x27;</span><br><span class="line"></span><br><span class="line">describe(&#x27;effect&#x27;, () =&gt; &#123;</span><br><span class="line">    it.skip(&#x27;effect&#x27;, () =&gt; &#123;</span><br><span class="line">        const user = reactive(&#123;// 响应式对象</span><br><span class="line">            age: 10,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        let nextAge</span><br><span class="line">        effect(() =&gt; &#123;//收集依赖 接收fn 触发get操作</span><br><span class="line">            nextAge = user.age + 1</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        expect(nextAge).toBe(11)</span><br><span class="line"></span><br><span class="line">        // update 触发set操作</span><br><span class="line">        user.age++</span><br><span class="line">        expect(nextAge).toBe(12)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="reactive"><a href="#reactive" class="headerlink" title="reactive"></a>reactive</h4><p><strong>reactivity / texts / reactive.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reactive &#125; from &#x27;../reactive&#x27;</span><br><span class="line"></span><br><span class="line">describe(&#x27;reactive&#x27;, () =&gt; &#123;</span><br><span class="line">    it(&#x27;reactive&#x27;, () =&gt; &#123;</span><br><span class="line">        const original = &#123; age: 1 &#125;</span><br><span class="line">        const observed = reactive(original)</span><br><span class="line">        expect(observed).not.toBe(original)</span><br><span class="line">        expect(observed.age).toBe(1)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="实现reactive"><a href="#实现reactive" class="headerlink" title="实现reactive"></a>实现reactive</h3><p><strong>tsconfig.json</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;lib&quot;: [&quot;DOM&quot;,&quot;ES6&quot;], </span><br></pre></td></tr></table></figure><p><strong>reactivity / reactive.ts</strong></p><blockquote><p><strong>传入一个对象，返回一个Proxy对象，实现 get &amp; set 函数</strong></p><blockquote><p><strong>详解 假设对象为 { foo : 1 }</strong></p></blockquote><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">target: &#123; foo : 1 &#125;</span><br><span class="line">key: foo</span><br><span class="line">value: 1</span><br></pre></td></tr></table></figure></blockquote></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">export function reactive(raw) &#123;</span><br><span class="line">    return new Proxy(raw, &#123;</span><br><span class="line">        get(target, key) &#123;</span><br><span class="line">            const res = Reflect.get(target, key)</span><br><span class="line"></span><br><span class="line">            // TODO:收集依赖</span><br><span class="line"></span><br><span class="line">            return res</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        set(target, key, value) &#123;</span><br><span class="line">            const res = Reflect.set(target, key, value)</span><br><span class="line">            </span><br><span class="line">            // TODO:触发依赖</span><br><span class="line"></span><br><span class="line">            return res</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>测试 pnpm test reactive</strong></p></blockquote><h3 id="实现effect"><a href="#实现effect" class="headerlink" title="实现effect"></a>实现effect</h3><p><strong>reactivity / effect.ts</strong></p><blockquote><p><strong>传入一个副作用函数fn，响应式数据发生变化时，重新执行fn</strong></p><blockquote><p>**封装类，将 **<code>_fn</code> 私有属性和 <code>run</code> 方法封装在一起，外部代码只能通过 <code>run</code> 方法来执行 <code>_fn</code>，隐藏内部实现细节，提高代码的安全性和可维护性</p></blockquote><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class ReactiveEffect &#123;</span><br><span class="line">private _fn: any</span><br><span class="line"> constructor(fn) &#123;</span><br><span class="line">     this._fn = fn</span><br><span class="line"> &#125;</span><br><span class="line"> run() &#123;</span><br><span class="line">     this._fn()</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export function effect(fn) &#123;</span><br><span class="line">    const _effect = new ReactiveEffect(fn)</span><br><span class="line"></span><br><span class="line">    _effect.run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>测试 pnpm test effect</strong></p></blockquote><h3 id="实现reactive-get"><a href="#实现reactive-get" class="headerlink" title="实现reactive-get"></a>实现reactive-get</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get(target, key) &#123;</span><br><span class="line">    const res = Reflect.get(target, key)</span><br><span class="line"></span><br><span class="line">    track(target, key) //传入对象和key</span><br><span class="line"></span><br><span class="line">    return res</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h4 id="track-依赖收集"><a href="#track-依赖收集" class="headerlink" title="track 依赖收集"></a>track 依赖收集</h4><p><strong>reactivity / effect.ts</strong></p><blockquote><p><strong>构建一个容器，存储依赖</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const targetMap = new Map() // 存储依赖关系</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const targetMap = new Map() // 存所有依赖</span><br><span class="line">export function track(target, key) &#123;</span><br><span class="line">    let depsMap = targetMap.get(target)</span><br><span class="line">    if (!depsMap) &#123;</span><br><span class="line">        depsMap = new Map()</span><br><span class="line">        targetMap.set(target, depsMap)//targetMap结构[target&lt;obj&gt;, depsMap&lt;map&gt;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let dep = depsMap.get(key)</span><br><span class="line">    if (!dep) &#123;</span><br><span class="line">        dep = new Set()</span><br><span class="line">        depsMap.set(key, dep)//depsMap结构[key&lt;key&gt;, dep&lt;ReactiveEffect&gt;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dep.add(？)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>如何拿到fn</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//全局对象</span><br><span class="line">let activeEffect</span><br><span class="line"></span><br><span class="line">//ReactiveEffect类内</span><br><span class="line">run() &#123;</span><br><span class="line">    activeEffect = this</span><br><span class="line">    this._fn()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//传入effect</span><br><span class="line">dep.add(activeEffect)</span><br></pre></td></tr></table></figure><h3 id="实现reactive-set"><a href="#实现reactive-set" class="headerlink" title="实现reactive-set"></a>实现reactive-set</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set(target, key, value) &#123;</span><br><span class="line">    const res = Reflect.set(target, key, value)</span><br><span class="line"></span><br><span class="line">    trigger(target, key) //传入对象和key</span><br><span class="line">    </span><br><span class="line">    return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="trigger-依赖触发"><a href="#trigger-依赖触发" class="headerlink" title="trigger 依赖触发"></a>trigger 依赖触发</h4><p><strong>reactivity / effect.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">export function trigger(target, key) &#123;</span><br><span class="line">    let depsMap = targetMap.get(target)</span><br><span class="line">    if (!depsMap) &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let dep = depsMap.get(key)</span><br><span class="line">    if (!dep) &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dep.forEach((effect) =&gt; &#123;</span><br><span class="line">        effect.run()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>测试 pnpm test effect</strong></p></blockquote><h3 id="完善effect功能"><a href="#完善effect功能" class="headerlink" title="完善effect功能"></a>完善effect功能</h3><h4 id="功能单测1"><a href="#功能单测1" class="headerlink" title="功能单测1"></a>功能单测1</h4><p><strong>reactivity / texts / effect.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;返回runner可以触发effect&#x27;, () =&gt; &#123;</span><br><span class="line">    let foo = 10</span><br><span class="line">    const runner = effect(() =&gt; &#123;</span><br><span class="line">        foo++</span><br><span class="line">        return foo</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    expect(foo).toBe(11)//创建effect - foo++</span><br><span class="line">    const r = runner()//调用runner - foo++</span><br><span class="line">    expect(foo).toBe(12)</span><br><span class="line">    expect(r).toBe(foo)//调用runner - foo++</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>修改effect逻辑</strong></p><p><em>实现创建实例时run一次</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export function effect(fn) &#123;</span><br><span class="line">const _effect = new ReactiveEffect(fn)</span><br><span class="line"></span><br><span class="line">_effect.run() //先执行一次</span><br><span class="line"></span><br><span class="line">    return _effect.run.bind(_effect)//返回run函数并绑定this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">run() &#123;</span><br><span class="line">    activeEffect = this</span><br><span class="line">    return this._fn()//返回值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>**Tips：有关 *****.bind(...)***</p><p>**直接返回 **<code>_effect.run</code> 会让 <code>run</code> 方法在调用时 <code>this</code> 指向出现问题，可能导致 <code>this._fn()</code> 无法正常执行。</p><p><em>例子</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class ReactiveEffect &#123;</span><br><span class="line">private _fn: any;</span><br><span class="line">constructor(fn) &#123;</span><br><span class="line">this._fn = fn;</span><br><span class="line">&#125;</span><br><span class="line">run() &#123;</span><br><span class="line">console.log(&#x27;this:&#x27;, this);</span><br><span class="line">this._fn();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function effectWithBind(fn) &#123;// 返回 _effect.run.bind(_effect)</span><br><span class="line">const _effect = new ReactiveEffect(fn);</span><br><span class="line">_effect.run();</span><br><span class="line">return _effect.run.bind(_effect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function effectWithoutBind(fn) &#123;// 返回 _effect.run</span><br><span class="line">const _effect = new ReactiveEffect(fn);</span><br><span class="line">_effect.run();</span><br><span class="line">return _effect.run;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const boundRun = effectWithBind(f);// 使用 effectWithBind</span><br><span class="line">boundRun(); // this 指向 _effect 实例</span><br><span class="line"></span><br><span class="line">const unboundRun = effectWithoutBind(f);// 使用 effectWithoutBind</span><br><span class="line">unboundRun(); // this 指向全局对象（在浏览器中是 window）</span><br></pre></td></tr></table></figure></blockquote><blockquote><p><strong>测试 pnpm test effect</strong></p></blockquote><h4 id="功能单测2"><a href="#功能单测2" class="headerlink" title="功能单测2"></a>功能单测2</h4><p><strong>reactivity / texts / effect.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">it.skip(&quot;scheduler&quot;, () =&gt; &#123;</span><br><span class="line">    // 1. 通过 effect 的第二个参数给定一个 scheduler 的 fn</span><br><span class="line">    // 2. effect 第一次执行的时候 还会执行 fn</span><br><span class="line">    // 3. 当 响应式对象 set update 不会执行 fn 而是执行 scheduler</span><br><span class="line">    // 4. 如果说当执行 runner 的时候 会再次执行 fn</span><br><span class="line">    let dummy</span><br><span class="line">    let run: any</span><br><span class="line">    const scheduler = jest.fn(() =&gt; &#123;</span><br><span class="line">        run = runner</span><br><span class="line">    &#125;)</span><br><span class="line">    const obj = reactive(&#123; foo: 1 &#125;)</span><br><span class="line">    const runner = effect(() =&gt; </span><br><span class="line">&#123; dummy = obj.foo &#125;,</span><br><span class="line">&#123; scheduler &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    expect(scheduler).not.toHaveBeenCalled()//scheduler不会被调用</span><br><span class="line">    expect(dummy).toBe(1)</span><br><span class="line"></span><br><span class="line">    //当响应式对象set时调用scheduler,但不会执行fn</span><br><span class="line">    obj.foo++</span><br><span class="line">    expect(scheduler).toHaveBeenCalledTimes(1)</span><br><span class="line">    expect(dummy).toBe(1)</span><br><span class="line"></span><br><span class="line">    //调用runner时执行fn</span><br><span class="line">    run()</span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>更新effect函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">constructor(fn, public scheduler?) &#123;//拿到可选参数scheduler</span><br><span class="line">    this._fn = fn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function effect(fn, options: any = &#123;&#125;) &#123;</span><br><span class="line">    const scheduler = options.scheduler//拿到scheduler</span><br><span class="line">    const _effect = new ReactiveEffect(fn, scheduler)//给类传入scheduler</span><br><span class="line"></span><br><span class="line">    _effect.run()</span><br><span class="line">    return _effect.run.bind(_effect)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>修改更新函数trigger逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dep.forEach((effect) =&gt; &#123;</span><br><span class="line">    if (effect.scheduler) &#123;</span><br><span class="line">        effect.scheduler()</span><br><span class="line">        return</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        effect.run()</span><br><span class="line">    &#125;</span><br><span class="line">    effect.run()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p><strong>pnpm test effect</strong></p></blockquote><h4 id="功能单测3"><a href="#功能单测3" class="headerlink" title="功能单测3"></a>功能单测3</h4><p><strong>reactivity / texts / effect.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">it(&quot;stop的执行逻辑&quot;, () =&gt; &#123;</span><br><span class="line">    let dummy</span><br><span class="line">    const obj = reactive(&#123; prop: 1 &#125;)</span><br><span class="line">    const runner = effect(() =&gt; &#123;</span><br><span class="line">        dummy = obj.prop</span><br><span class="line">    &#125;)</span><br><span class="line">    obj.prop = 2</span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line"></span><br><span class="line">    stop(runner)//停止执行runner</span><br><span class="line"></span><br><span class="line">    obj.prop = 3</span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line"></span><br><span class="line">    runner()</span><br><span class="line">    expect(dummy).toBe(3)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>reactivity / effect.ts</strong></p><p><strong>实现stop代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function stop(runner) &#123;</span><br><span class="line">    runner.effect.stop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>修改effect函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export function effect(fn, options: any = &#123;&#125;) &#123;</span><br><span class="line">    const scheduler = options.scheduler</span><br><span class="line">    const _effect = new ReactiveEffect(fn, scheduler)</span><br><span class="line"></span><br><span class="line">    _effect.run()</span><br><span class="line"></span><br><span class="line">    const runner: any = _effect.run.bind(_effect) //定义runner函数并绑定this</span><br><span class="line">    runner.effect = _effect //将effect挂载到runner上</span><br><span class="line"></span><br><span class="line">    return runner</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>track（依赖收集）函数添加逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dep.add(activeEffect)</span><br><span class="line">activeEffect.deps.push(dep)</span><br></pre></td></tr></table></figure><p><strong>修改effect类 | 添加stop函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public deps = []</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">    this.deps.forEach((dep:any) =&gt; &#123;</span><br><span class="line">        dep.delete(this)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>pnpm test effect --watch</strong></p></blockquote><p><strong>代码优化（抽离清除逻辑 &amp; 防抖）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">active = true</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">    if (this.active) &#123;</span><br><span class="line">        cleanupEffect(this)</span><br><span class="line">        this.active = false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function cleanupEffect(effect) &#123;</span><br><span class="line">    effect.deps.forEach((dep: any) =&gt; &#123;</span><br><span class="line">        dep.delete(effect)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="功能单测4"><a href="#功能单测4" class="headerlink" title="功能单测4"></a>功能单测4</h4><p><strong>reactivity / texts / effect.spec.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;onStop的执行逻辑&#x27;, () =&gt; &#123;</span><br><span class="line">    const obj = reactive(&#123;</span><br><span class="line">        foo: 1,</span><br><span class="line">    &#125;)</span><br><span class="line">    const onStop = jest.fn()//jest.fn() 创建一个模拟函数 onStop，用于记录其调用次数和参数</span><br><span class="line">    let dummy</span><br><span class="line">    const runner = effect(</span><br><span class="line">        () =&gt; &#123;</span><br><span class="line">            dummy = obj.foo//响应式对象</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            onStop,//选项对象</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    stop(runner)</span><br><span class="line">    expect(onStop).toBeCalledTimes(1)//验证 onStop 函数是否被调用了一次</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>reactivity / effect.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//_effect.onStop = options.onStop//调用类方法</span><br><span class="line">//Object.assign(_effect, options)//调用类方法(优化)</span><br><span class="line">extend(_effect, options)//调用类方法(抽离封装)</span><br></pre></td></tr></table></figure><blockquote><p><strong>Tip：二者区别</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 假设 options 对象如下</span><br><span class="line">const options = &#123;</span><br><span class="line">onStop: () =&gt; console.log(&#x27;Effect stopped&#x27;),</span><br><span class="line">someOtherOption: &#x27;value&#x27;</span><br><span class="line">&#125;;</span><br><span class="line">const _effect = new ReactiveEffect(() =&gt; &#123;&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 仅赋值 onStop 属性</span><br><span class="line">_effect.onStop = options.onStop;</span><br><span class="line"></span><br><span class="line">console.log(_effect.onStop); // 输出: () =&gt; console.log(&#x27;Effect stopped&#x27;)</span><br><span class="line">console.log(_effect.someOtherOption); // 输出: undefined</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 复制 options 对象的所有属性到 _effect</span><br><span class="line">Object.assign(_effect, options);</span><br><span class="line"></span><br><span class="line">console.log(_effect.onStop); // 输出: () =&gt; console.log(&#x27;Effect stopped&#x27;)</span><br><span class="line">console.log(_effect.someOtherOption); // 输出: &#x27;value&#x27;</span><br></pre></td></tr></table></figure></blockquote><p><strong>继续抽离函数</strong></p><p><strong>src / shared (放置通用的工具函数) / index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export const extend = Object.assign</span><br></pre></td></tr></table></figure><p><strong>修改类</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">onStop?: () =&gt; void</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">    if (this.active) &#123;</span><br><span class="line">        cleanupEffect(this)</span><br><span class="line">        if (this.onStop) &#123;</span><br><span class="line">            this.onStop()</span><br><span class="line">        &#125;</span><br><span class="line">        this.active = false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现readonly功能"><a href="#实现readonly功能" class="headerlink" title="实现readonly功能"></a>实现readonly功能</h3><h4 id="编写单测-1"><a href="#编写单测-1" class="headerlink" title="编写单测"></a>编写单测</h4><p><strong>readonly.spec.ts</strong></p><blockquote><p><strong>只读属性只能读取set不能被改写set</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import &#123; readonly &#125; from &#x27;../reactive&#x27;</span><br><span class="line"></span><br><span class="line">describe(&#x27;readonly&#x27;, () =&gt; &#123;</span><br><span class="line">it(&#x27;readonly&#x27;, () =&gt; &#123;</span><br><span class="line">const original = &#123; foo: 1 &#125;</span><br><span class="line">const wrapped = readonly(original)</span><br><span class="line">expect(wrapped).not.toBe(original) //返回一个新对象，而非返回原对象</span><br><span class="line">expect(wrapped.foo).toBe(1)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">it(&#x27;warning when call set&#x27;, () =&gt; &#123;</span><br><span class="line">console.warn = jest.fn()</span><br><span class="line">const user = readonly(&#123;</span><br><span class="line">age: 10,</span><br><span class="line">&#125;)</span><br><span class="line">user.age = 11</span><br><span class="line">expect(console.warn).toBeCalled()//调用了console.warn</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>reactive</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export function readonly(raw) &#123;</span><br><span class="line">    return new Proxy(raw, &#123;</span><br><span class="line">        get(target, key) &#123;</span><br><span class="line">            return Reflect.get(target, key)</span><br><span class="line">        &#125;,</span><br><span class="line">        set(target, key, value) &#123;</span><br><span class="line">            console.warn(`key: $&#123;key&#125; set 失败，因为 target 是 readonly 的`, target)</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>抽离 get &amp; set 函数</strong></p><p><strong>createGetter</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function createGetter(isReadonly = false, shallow = false) &#123;</span><br><span class="line">    return function get(target, key) &#123;//返回一个get函数</span><br><span class="line">        const res = Reflect.get(target, key)</span><br><span class="line">        if (!isReadonly) &#123;</span><br><span class="line">            track(target, key)</span><br><span class="line">        &#125;</span><br><span class="line">        if (shallow) &#123;</span><br><span class="line">            return res</span><br><span class="line">        &#125;</span><br><span class="line">        if (typeof res === &#x27;object&#x27;) &#123;</span><br><span class="line">            return isReadonly ? readonly(res) : reactive(res)</span><br><span class="line">        &#125;</span><br><span class="line">        return res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>createSetter</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function createSetter(shallow = false) &#123;</span><br><span class="line">    return function set(target, key, value) &#123;</span><br><span class="line">        const res = Reflect.set(target, key, value)</span><br><span class="line">        trigger(target, key)</span><br><span class="line">        return res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>改写函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">export function reactive(raw) &#123;</span><br><span class="line">    return new Proxy(raw, &#123;</span><br><span class="line">        get: createGetter(),</span><br><span class="line">        set: createSetter(),</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function readonly(raw) &#123;</span><br><span class="line">    return new Proxy(raw, &#123;</span><br><span class="line">        get: createGetter(true),</span><br><span class="line">        set(target, key, value) &#123;</span><br><span class="line">            console.warn(`key: $&#123;key&#125; set 失败，因为 target 是 readonly 的`, target)</span><br><span class="line">            return true</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>继续优化抽离组件</strong></p><p><strong>创建 baseHanders.ts | 封装get逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import &#123; track, trigger &#125; from &#x27;./effect&#x27;</span><br><span class="line"></span><br><span class="line">function createGetter(isReadonly = false) &#123;</span><br><span class="line">return function get(target, key) &#123;</span><br><span class="line">const res = Reflect.get(target, key)</span><br><span class="line">if (!isReadonly) &#123;</span><br><span class="line">track(target, key)</span><br><span class="line">&#125;</span><br><span class="line">return res</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function createSetter() &#123;</span><br><span class="line">return function set(target, key, value) &#123;</span><br><span class="line">const res = Reflect.set(target, key, value)</span><br><span class="line">trigger(target, key)</span><br><span class="line">return res</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const reactiveHandlers = &#123;</span><br><span class="line">get: createGetter(),</span><br><span class="line">set: createSetter(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const readonlyHandlers = &#123;</span><br><span class="line">get: createGetter(true),</span><br><span class="line">set(target, key, value) &#123;</span><br><span class="line">console.warn(`key: $&#123;key&#125; set 失败，因为 target 是 readonly 的`, target)</span><br><span class="line">return true</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>重构 reactive &amp; readonly</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import &#123; reactiveHandlers, readonlyHandlers &#125; from &#x27;./baseHanders&#x27;</span><br><span class="line"></span><br><span class="line">function createActiveEffect(raw: any, baseHanders) &#123;</span><br><span class="line">return new Proxy(raw, baseHanders)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function reactive(raw) &#123;</span><br><span class="line">return createActiveEffect(raw, reactiveHandlers)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function readonly(raw) &#123;</span><br><span class="line">return createActiveEffect(raw, readonlyHandlers)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>为 createGetter 添加缓存机制</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const get = createGetter()</span><br><span class="line">const set = createSetter()</span><br><span class="line">const readonlyGet = createGetter(true)</span><br></pre></td></tr></table></figure><blockquote><p><strong>pnpm test readonly --watch</strong></p></blockquote><h3 id="实现-isReactive-isReadonly-功能"><a href="#实现-isReactive-isReadonly-功能" class="headerlink" title="实现 isReactive &amp; isReadonly 功能"></a>实现 isReactive &amp; isReadonly 功能</h3><h4 id="编写单测-2"><a href="#编写单测-2" class="headerlink" title="编写单测"></a>编写单测</h4><p><strong>reactive.spec.ts</strong></p><blockquote><p>**判断传入的 **<code>value</code> 是否为响应式对象</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;reactive&#x27;, () =&gt; &#123;</span><br><span class="line">    const original = &#123; age: 1 &#125;</span><br><span class="line">    const observed = reactive(original)</span><br><span class="line">    expect(observed).not.toBe(original)</span><br><span class="line">    expect(observed.age).toBe(1)</span><br><span class="line"></span><br><span class="line">    //判断是否是响应式对象</span><br><span class="line">    expect(isReactive(observed)).toBe(true)</span><br><span class="line">    expect(isReactive(original)).toBe(false)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>readonly.spec.ts</strong></p><blockquote><p><strong>判断是否是只读对象</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;readonly&#x27;, () =&gt; &#123;</span><br><span class="line">    const original = &#123; foo: 1 &#125;</span><br><span class="line">    const wrapped = readonly(original)</span><br><span class="line">    expect(wrapped).not.toBe(original) //返回一个新对象，而非返回原对象</span><br><span class="line">    expect(wrapped.foo).toBe(1)</span><br><span class="line"></span><br><span class="line">    expect(isReadonly(wrapped)).toBe(true)//判断是否是只读对象</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h4><p><strong>createGetter拦截判断</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function createGetter(isReadonly = false) &#123;</span><br><span class="line">return function get(target, key) &#123;</span><br><span class="line"></span><br><span class="line">if (key === ReactiveFlags.IS_REACTIVE) &#123;//判断是否是响应式对象</span><br><span class="line">return !isReadonly</span><br><span class="line">&#125;else if (key === ReactiveFlags.IS_READONLY) &#123;//判断是否是只读对象</span><br><span class="line">return isReadonly</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const res = Reflect.get(target, key)</span><br><span class="line">if (!isReadonly) &#123;</span><br><span class="line">track(target, key)</span><br><span class="line">&#125;</span><br><span class="line">return res</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>reactive.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">export const enum ReactiveFlags &#123;</span><br><span class="line">IS_REACTIVE = &#x27;__v_isReactive&#x27;,</span><br><span class="line">IS_READONLY = &#x27;__v_isReadonly&#x27;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function isReactive(value) &#123;//判断是否是响应式对象</span><br><span class="line">    return !!value[ReactiveFlags.IS_REACTIVE]</span><br><span class="line">&#125;</span><br><span class="line">export function isReadonly(value) &#123;//判断是否是只读对象</span><br><span class="line">    return !!value[ReactiveFlags.IS_READONLY]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>pnpm test readonly --watch</strong></p><p><strong>pnpm test reactive --watch</strong></p></blockquote><h3 id="stop功能优化"><a href="#stop功能优化" class="headerlink" title="stop功能优化"></a>stop功能优化</h3><h4 id="当前bug"><a href="#当前bug" class="headerlink" title="当前bug"></a>当前bug</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it(&quot;stop的执行逻辑&quot;, () =&gt; &#123;</span><br><span class="line">    let dummy</span><br><span class="line">    const obj = reactive(&#123; prop: 1 &#125;)</span><br><span class="line">    const runner = effect(() =&gt; &#123;</span><br><span class="line">        dummy = obj.prop</span><br><span class="line">    &#125;)</span><br><span class="line">    obj.prop = 2</span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line"></span><br><span class="line">    stop(runner)//停止执行runner</span><br><span class="line"></span><br><span class="line">    // obj.prop = 3 只涉及set操作</span><br><span class="line">    obj.prop++ //触发 get+set</span><br><span class="line">    </span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line"></span><br><span class="line">    runner()</span><br><span class="line">    expect(dummy).toBe(3)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p><strong>stop(runner)会根据该响应式对象中active的状态清除它的已经收集的所有依赖</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">effect.deps.forEach((dep: any) =&gt; &#123;</span><br><span class="line">dep.delete(effect)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>**+1触发get操作一定会触发track操作重新收集依赖 **</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dep.add(activeEffect)//之前的依赖都白清了</span><br></pre></td></tr></table></figure><p><strong>所以stop函数之后的操作不应该收集依赖（不能触发track操作）</strong></p></blockquote><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p><strong>track添加逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if(!activeEffect || !shouldTrack)&#123;//如果没有激活的effect或者shouldTrack为false，直接返回</span><br><span class="line">    return  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//...收集依赖</span><br><span class="line"></span><br><span class="line">if (dep.has(activeEffect)) &#123;</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br><span class="line">dep.add(activeEffect)</span><br><span class="line">activeEffect.deps.push(dep)</span><br></pre></td></tr></table></figure><p><strong>修改run函数（stop根据active状态区分）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">run() &#123;</span><br><span class="line">    if (!this.active) &#123; // stop状态直接返回fn</span><br><span class="line">        return this._fn()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shouldTrack = true // 允许进行依赖收集</span><br><span class="line">    activeEffect = this</span><br><span class="line"></span><br><span class="line">    const res = this._fn() // this._fn() 执行，期间访问响应式对象的属性，触发track依赖收集</span><br><span class="line"></span><br><span class="line">    shouldTrack = false // 依赖收集结束，后续操作不会再触发依赖收集。</span><br><span class="line"></span><br><span class="line">    return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>cleanupEffect添加逻辑</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">effect.deps.length = 0</span><br></pre></td></tr></table></figure><blockquote><p><strong>pnpm test reactive --watch</strong></p></blockquote><h3 id="嵌套响应式转换"><a href="#嵌套响应式转换" class="headerlink" title="嵌套响应式转换"></a>嵌套响应式转换</h3><h4 id="编写单测-3"><a href="#编写单测-3" class="headerlink" title="编写单测"></a>编写单测</h4><p><strong>reactive</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;嵌套响应式对象转换&#x27;, () =&gt; &#123;</span><br><span class="line">    const original = &#123;</span><br><span class="line">        nested: &#123;</span><br><span class="line">            foo: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        array: [&#123; bar: 2 &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">    const observed = reactive(original)</span><br><span class="line">    expect(isReactive(observed.nested)).toBe(true)</span><br><span class="line">    expect(isReactive(observed.array)).toBe(true)</span><br><span class="line">    expect(isReactive(observed.array[0])).toBe(true) </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>readonly</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;readonly&#x27;, () =&gt; &#123;</span><br><span class="line">    const original = &#123; foo: 1, bar: &#123; baz: 2 &#125; &#125;</span><br><span class="line">    const wrapped = readonly(original)</span><br><span class="line"></span><br><span class="line">    expect(wrapped).not.toBe(original) //返回一个新对象，而非返回原对象</span><br><span class="line">    expect(wrapped.foo).toBe(1)</span><br><span class="line"></span><br><span class="line">    expect(isReadonly(original)).toBe(false)</span><br><span class="line">    expect(isReadonly(original.bar)).toBe(false)</span><br><span class="line">    expect(isReadonly(wrapped)).toBe(true)//只读</span><br><span class="line">    expect(isReadonly(wrapped.bar)).toBe(true)//只读</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>baseHanders.ts 递归拦截</strong></p><blockquote><p><strong>createGetter函数</strong></p><p>**const res = Reflect.get(**<em>target</em>, <em>key</em>)后添加判断</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (isObject(res)) &#123;//判断是否是对象</span><br><span class="line">    return isReadonly ? readonly(res) : reactive(res)//返回只读对象或者响应式对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>shared / index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export const isObject = (val) =&gt; &#123;</span><br><span class="line">    return val !== null &amp;&amp; typeof val === &#x27;object&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="shallowReadonly工具函数"><a href="#shallowReadonly工具函数" class="headerlink" title="shallowReadonly工具函数"></a>shallowReadonly工具函数</h3><h4 id="编写单测-4"><a href="#编写单测-4" class="headerlink" title="编写单测"></a>编写单测</h4><p><strong>shallowReadonly.spec.ts</strong></p><blockquote><p><strong>数据展示:确保外层数据不会被意外修改，同时允许在必要时修改嵌套对象</strong></p><p><strong>性能优化:避免对所有嵌套对象进行只读处理</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#123; isReadonly, shallowReadonly &#125; from &#x27;../reactive&#x27;</span><br><span class="line"></span><br><span class="line">describe(&#x27;shallowReadonly&#x27;, () =&gt; &#123;</span><br><span class="line">    it(&#x27;shallowReadonly&#x27;, () =&gt; &#123;</span><br><span class="line">        const props = shallowReadonly(&#123; n: &#123; foo: 1 &#125; &#125;)</span><br><span class="line">        expect(isReadonly(props)).toBe(true)//表层只读</span><br><span class="line">        expect(isReadonly(props.n)).toBe(false)//内部正常</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="功能实现-1"><a href="#功能实现-1" class="headerlink" title="功能实现"></a>功能实现</h4><p><strong>reactive.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function shallowReadonly(raw) &#123;</span><br><span class="line">    return createActiveEffect(raw, shallowReadonlyHandlers)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>baseHanders.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const readonlyGet = createGetter(true)</span><br><span class="line">const shallowReadonlyGet = createGetter(true, true)</span><br></pre></td></tr></table></figure><p><strong>createGetter改写</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function createGetter(isReadonly = false, shallow = false)</span><br><span class="line"></span><br><span class="line">if (shallow) &#123;</span><br><span class="line">    return res</span><br><span class="line">&#125;</span><br><span class="line">//👇判断isObject前拦截👆//</span><br><span class="line">if (isObject(res)) &#123;//判断是否是对象</span><br><span class="line">    return isReadonly ? readonly(res) : reactive(res) //返回只读对象或者响应式对象</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>继承改写自readonlyHandlers</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export const shallowReadonlyHandlers = extend(&#123;&#125;, readonlyHandlers, &#123;</span><br><span class="line">    get: shallowReadonlyGet,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="实现isProxy功能"><a href="#实现isProxy功能" class="headerlink" title="实现isProxy功能"></a>实现isProxy功能</h3><h4 id="编写单测-5"><a href="#编写单测-5" class="headerlink" title="编写单测"></a>编写单测</h4><blockquote><p><strong>判断是否是代理对象</strong></p></blockquote><p><strong>reactive &amp; readonly 分别添加</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expect(isProxy(observed)).toBe(true)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expect(isProxy(wrapped)).toBe(true)</span><br></pre></td></tr></table></figure><h4 id="功能实现-2"><a href="#功能实现-2" class="headerlink" title="功能实现"></a>功能实现</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function isProxy(value) &#123; //判断是否是代理对象</span><br><span class="line">    return isReactive(value) || isReadonly(value)   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现ref"><a href="#实现ref" class="headerlink" title="实现ref"></a>实现ref</h3><h4 id="必看：ref与-reactive区别"><a href="#必看：ref与-reactive区别" class="headerlink" title="必看：ref与 reactive区别"></a>必看：<code>ref</code>与 <code>reactive</code>区别</h4><table><thead><tr><th><strong>reactive</strong></th><th><strong>ref</strong></th></tr></thead><tbody><tr><td><strong>❌只支持****对象</strong>和<strong>数组</strong>(引用数据类型)</td><td><strong>✅支持基本数据类型+引用数据类型</strong></td></tr><tr><td><strong>❌重新分配一个新对象会丢失响应性</strong></td><td><strong>✅重新分配一个新对象****不会</strong>失去响应</td></tr><tr><td><strong>❌将对象传入函数时,失去响应</strong></td><td><strong>✅传入函数时,不会失去响应</strong></td></tr><tr><td><strong>能直接访问属性</strong></td><td><strong>需要使用</strong> <code>.value</code>访问属性</td></tr><tr><td><strong>✅在</strong> <code>&lt;script&gt;</code>和 <code>&lt;template&gt;</code>中无差别使用</td><td><strong>❌在</strong> <code>&lt;script&gt;</code>和 <code>&lt;template&gt;</code>使用方式不同(script中要 <code>.value</code>)</td></tr><tr><td><strong>❌解构时会丢失响应性,需使用toRefs</strong></td><td><strong>❌解构对象时会丢失响应性,需使用toRefs</strong></td></tr></tbody></table><blockquote><p><strong>ref只传单值，不能使用Proxy(Proxy对对象起作用)</strong></p><p><strong>ref中的任何一个点key都要对应一个dep，get&amp;set进行依赖收集和触发</strong></p></blockquote><h4 id="功能单测1-1"><a href="#功能单测1-1" class="headerlink" title="功能单测1"></a>功能单测1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#123; effect &#125; from &#x27;../effect&#x27;</span><br><span class="line">import &#123; ref &#125; from &#x27;../ref&#x27;</span><br><span class="line"></span><br><span class="line">describe(&#x27;ref&#x27;, () =&gt; &#123;</span><br><span class="line">    it.only(&#x27;value&#x27;, () =&gt; &#123;</span><br><span class="line">        const a = ref(1)</span><br><span class="line">        expect(a.value).toBe(1)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>ref.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class RefImpl &#123;</span><br><span class="line">    private _value: any;</span><br><span class="line">    constructor(value) &#123;//构造函数</span><br><span class="line">        this._value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get value() &#123;//获取value</span><br><span class="line">        return this._value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // set value() &#123;</span><br><span class="line"></span><br><span class="line">    // &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function ref(value) &#123;</span><br><span class="line">    return new RefImpl(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="功能单测2-1"><a href="#功能单测2-1" class="headerlink" title="功能单测2"></a>功能单测2</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;should be reactive&#x27;, () =&gt; &#123;</span><br><span class="line">    const a = ref(1)</span><br><span class="line">    let dummy</span><br><span class="line">    let calls = 0</span><br><span class="line">    effect(() =&gt; &#123;</span><br><span class="line">        calls++</span><br><span class="line">        dummy = a.value</span><br><span class="line">    &#125;)</span><br><span class="line">    expect(calls).toBe(1)//effect执行了一次</span><br><span class="line">    expect(dummy).toBe(1)</span><br><span class="line">    a.value = 2</span><br><span class="line">    expect(calls).toBe(2)</span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line">    // 值相同不会触发</span><br><span class="line">    a.value = 2</span><br><span class="line">    expect(calls).toBe(2)</span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>ref.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class RefImpl &#123;</span><br><span class="line">    private _value: any //值</span><br><span class="line">    public dep //依赖就是唯一的value</span><br><span class="line">    constructor(value) &#123;</span><br><span class="line">        //构造函数</span><br><span class="line">        this._value = value //存储值</span><br><span class="line">        this.dep = new Set() //存储依赖</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get value() &#123;</span><br><span class="line">        //获取value</span><br><span class="line">        return this._value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set value(newValue) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function ref(value) &#123;</span><br><span class="line">    return new RefImpl(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>回到effect抽离 get &amp; set 逻辑代码复用</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">trackEffects(dep)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function trackEffects(dep) &#123;</span><br><span class="line">    if (dep.has(activeEffect)) &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    dep.add(activeEffect)</span><br><span class="line">    activeEffect.deps.push(dep)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">triggerEffects(dep)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function triggerEffects(dep) &#123; </span><br><span class="line">dep.forEach((effect) =&gt; &#123;</span><br><span class="line">if (effect.scheduler) &#123;</span><br><span class="line">effect.scheduler()</span><br><span class="line">return</span><br><span class="line">&#125; else &#123;</span><br><span class="line">effect.run()</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ref.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">get value() &#123;</span><br><span class="line">    trackEffects(this.dep) //收集依赖</span><br><span class="line">    return this._value //获取value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set value(newValue) &#123;</span><br><span class="line">    this._value = newValue //设置value</span><br><span class="line">    triggerEffects(this.dep) //触发依赖</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>实现赋值相同不触发effect功能</strong></p><p><strong>set value添加</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(Object.is(newValue,this._value)) return //如果新值和旧值相等，直接返回</span><br></pre></td></tr></table></figure><p><strong>抽离封装成工具函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function trackRefValue(ref) &#123;</span><br><span class="line">    if (isTracking()) &#123;</span><br><span class="line">        trackEffects(ref.dep)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export const hasChange = (val, newValue) =&gt; &#123;</span><br><span class="line">    return !Object.is(val, newValue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>get &amp; set value改写</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">get value() &#123;</span><br><span class="line">    trackRefValue(this) //收集依赖</span><br><span class="line">    return this._value //获取value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set value(newValue) &#123;</span><br><span class="line">    if (hasChange(newValue, this._value)) &#123;//判断是否有变化</span><br><span class="line">        this._value = newValue //设置value</span><br><span class="line">        triggerEffects(this.dep) //触发依赖</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="功能单测3-1"><a href="#功能单测3-1" class="headerlink" title="功能单测3"></a>功能单测3</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;嵌套响应&#x27;, () =&gt; &#123;</span><br><span class="line">    const a = ref(&#123;</span><br><span class="line">        count: 1,</span><br><span class="line">    &#125;)</span><br><span class="line">    let dummy</span><br><span class="line">    effect(() =&gt; &#123;</span><br><span class="line">        dummy = a.value.count</span><br><span class="line">    &#125;)</span><br><span class="line">    expect(dummy).toBe(1)</span><br><span class="line">    a.value.count = 2</span><br><span class="line">    expect(dummy).toBe(2)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p><strong>要实现嵌套就设计递归嘛</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private _value: any //值</span><br><span class="line">public dep //依赖就是唯一的value</span><br><span class="line">private _rawValue: any //原始值</span><br><span class="line">constructor(value) &#123;</span><br><span class="line">    this._rawValue = value</span><br><span class="line">    this._value = isObject(value) ? reactive(value) : value //如果是对象，就递归</span><br><span class="line">    this.dep = new Set() //存储依赖</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set value(newValue) &#123;</span><br><span class="line">    if (hasChange(newValue, this._rawValue)) &#123;</span><br><span class="line">        //判断是否有变化</span><br><span class="line">        this._rawValue = newValue</span><br><span class="line">        this._value = isObject(newValue) ? reactive(newValue) : newValue</span><br><span class="line">        triggerEffects(this.dep) //触发依赖</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>继续优化</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private _rawValue: any //原始值</span><br><span class="line"></span><br><span class="line">set value(newValue) &#123;</span><br><span class="line">    if (hasChange(newValue, this._rawValue)) &#123;</span><br><span class="line">        //判断是否有变化</span><br><span class="line">        this._rawValue = newValue</span><br><span class="line">        this._value = convert(newValue) //如果是对象，就递归</span><br><span class="line">        triggerEffects(this.dep) //触发依赖</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function convert(value) &#123;</span><br><span class="line">    return isObject(value) ? reactive(value) : value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现isRef"><a href="#实现isRef" class="headerlink" title="实现isRef"></a>实现isRef</h3><h4 id="编写单测-6"><a href="#编写单测-6" class="headerlink" title="编写单测"></a>编写单测</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;isRef&#x27;, () =&gt; &#123;</span><br><span class="line">    const a = ref(1)</span><br><span class="line">    const user = &#123;</span><br><span class="line">        age: a,</span><br><span class="line">    &#125;</span><br><span class="line">    expect(isRef(a)).toBe(true)</span><br><span class="line">    expect(isRef(1)).toBe(false)</span><br><span class="line">    expect(isRef(user)).toBe(false)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="功能实现-3"><a href="#功能实现-3" class="headerlink" title="功能实现"></a>功能实现</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public __v_isRef = true //标识是否是ref</span><br><span class="line"></span><br><span class="line">export function isRef(ref) &#123;</span><br><span class="line">    return !!ref.__v_isRef//转换为布尔值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现unRef"><a href="#实现unRef" class="headerlink" title="实现unRef"></a>实现unRef</h3><blockquote><p><strong>如果参数是 ref，则返回内部值，否则返回参数本身</strong></p></blockquote><h4 id="编写单测-7"><a href="#编写单测-7" class="headerlink" title="编写单测"></a>编写单测</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;unRef&#x27;, () =&gt; &#123;//</span><br><span class="line">    const a = ref(1)</span><br><span class="line">    expect(unRef(a)).toBe(1)</span><br><span class="line">    expect(unRef(1)).toBe(1)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="功能实现-4"><a href="#功能实现-4" class="headerlink" title="功能实现"></a>功能实现</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function unRef(ref) &#123;</span><br><span class="line">    return isRef(ref) ? ref.value : ref //如果是ref，就返回value，否则返回原对象   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现proxyRefs"><a href="#实现proxyRefs" class="headerlink" title="实现proxyRefs (?)"></a>实现proxyRefs (?)</h3><h4 id="编写单测-8"><a href="#编写单测-8" class="headerlink" title="编写单测"></a>编写单测</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;proxyRefs&#x27;, () =&gt; &#123;</span><br><span class="line">    const user = &#123;</span><br><span class="line">        age: ref(10),</span><br><span class="line">        name: &#x27;zf&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">    const proxyUser = proxyRefs(user)</span><br><span class="line">    expect(user.age.value).toBe(10)</span><br><span class="line">    expect(proxyUser.age).toBe(10)//可以省略.value</span><br><span class="line">    expect(proxyUser.name).toBe(&#x27;zf&#x27;)//可以省略.value</span><br><span class="line"></span><br><span class="line">    proxyUser.age = 20</span><br><span class="line">    expect(proxyUser.age).toBe(20)</span><br><span class="line">    expect(user.age.value).toBe(20)</span><br><span class="line"></span><br><span class="line">    proxyUser.age = ref(10)</span><br><span class="line">    expect(proxyUser.age).toBe(10)</span><br><span class="line">    expect(user.age.value).toBe(10)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="功能实现-5"><a href="#功能实现-5" class="headerlink" title="功能实现"></a>功能实现</h4><blockquote><p><strong>逻辑：</strong></p><p><strong>get到ref返回.value，否则直接返回原对象</strong></p><p><strong>实例对象触发set会连锁原对象值改变</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export function proxyRefs(objectWithRefs) &#123;</span><br><span class="line">    return new Proxy(objectWithRefs, &#123;</span><br><span class="line">        get(target, key) &#123;</span><br><span class="line">            return unRef(Reflect.get(target, key)) //如果是ref，就返回value，否则返回原对象</span><br><span class="line">        &#125;,</span><br><span class="line">        set(target, key, value) &#123;</span><br><span class="line">            if (isRef(target[key]) &amp;&amp; !isRef(value)) &#123;</span><br><span class="line">                return (target[key].value = value) //如果是ref，就返回value，否则返回原对象</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return Reflect.set(target, key, value) //如果是ref，就返回value，否则返回原对象</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现computed"><a href="#实现computed" class="headerlink" title="实现computed"></a>实现computed</h3><blockquote><p>**接受一个 **<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/get#description">getter 函数</a>，返回一个只读的响应式 <a href="https://cn.vuejs.org/api/reactivity-core.html#ref">ref</a> 对象。该 ref 通过 <code>.value</code> 暴露 getter 函数的返回值。它也可以接受一个带有 <code>get</code> 和 <code>set</code> 函数的对象来创建一个可写的 ref 对象。</p></blockquote><h4 id="功能单测1-2"><a href="#功能单测1-2" class="headerlink" title="功能单测1"></a>功能单测1</h4><p><strong>computed.spec.ts</strong></p><blockquote><p><code>computed</code> 函数会基于这个 getter 函数创建一个计算属性 <code>age</code>，该计算属性的值会根据 <code>user.age</code> 的变化而自动更新。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import &#123; computed &#125; from &#x27;../computed&#x27;</span><br><span class="line">import &#123; reactive &#125; from &#x27;../reactive&#x27;</span><br><span class="line"></span><br><span class="line">describe(&#x27;computed&#x27;, () =&gt; &#123;</span><br><span class="line">    it(&#x27;computed&#x27;, () =&gt; &#123;</span><br><span class="line">        const user = reactive(&#123;</span><br><span class="line">            age: 1,</span><br><span class="line">        &#125;)</span><br><span class="line">        const age = computed(() =&gt; &#123;</span><br><span class="line">            return user.age</span><br><span class="line">        &#125;)</span><br><span class="line">        expect(age.value).toBe(1)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>computed.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class ComputedRefImpl &#123;</span><br><span class="line">    private _getter: any</span><br><span class="line">    constructor(getter) &#123;</span><br><span class="line">        this._getter = getter</span><br><span class="line">    &#125;</span><br><span class="line">    get value() &#123;</span><br><span class="line">        return this._getter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function computed(getter) &#123;</span><br><span class="line">    return new ComputedRefImpl(getter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="功能单测2-2"><a href="#功能单测2-2" class="headerlink" title="功能单测2"></a>功能单测2</h4><p><strong>computed.spec.ts</strong></p><blockquote><p>**接受一个 **<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/get#description">getter 函数</a>，返回一个只读的响应式 <a href="https://cn.vuejs.org/api/reactivity-core.html#ref">ref</a> 对象。该 ref 通过 <code>.value</code> 暴露 getter 函数的返回值。它也可以接受一个带有 <code>get</code> 和 <code>set</code> 函数的对象来创建一个可写的 ref 对象。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;should compute lazily&#x27;, () =&gt; &#123;</span><br><span class="line">    const value = reactive(&#123;</span><br><span class="line">        foo: 1,</span><br><span class="line">    &#125;)</span><br><span class="line">    const getter = jest.fn(() =&gt; &#123;</span><br><span class="line">        return value.foo</span><br><span class="line">    &#125;)</span><br><span class="line">    const cValue = computed(getter)</span><br><span class="line">    expect(getter).not.toHaveBeenCalled()</span><br><span class="line">    expect(cValue.value).toBe(1)</span><br><span class="line">    expect(getter).toHaveBeenCalledTimes(1)</span><br><span class="line">    // 再次访问，不应该再调用</span><br><span class="line">    cValue.value</span><br><span class="line">    expect(getter).toHaveBeenCalledTimes(1)</span><br><span class="line">    // 不应该再调用</span><br><span class="line">    value.foo = 2</span><br><span class="line">    expect(getter).toHaveBeenCalledTimes(1)</span><br><span class="line">    // 触发getter</span><br><span class="line">    expect(cValue.value).toBe(2)</span><br><span class="line">    expect(getter).toHaveBeenCalledTimes(2)</span><br><span class="line">    // 不应该再调用</span><br><span class="line">    cValue.value</span><br><span class="line">    expect(getter).toHaveBeenCalledTimes(2)   </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>computed.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import &#123; ReactiveEffect &#125; from &#x27;./effect&#x27;</span><br><span class="line"></span><br><span class="line">class ComputedRefImpl &#123;</span><br><span class="line">    private _getter: any</span><br><span class="line">    private _value: any</span><br><span class="line">    private _dirty: boolean = true</span><br><span class="line">    private _effect: any</span><br><span class="line">    constructor(getter) &#123;</span><br><span class="line">        this._getter = getter</span><br><span class="line">        this._effect = new ReactiveEffect(getter, () =&gt; &#123;</span><br><span class="line">            if (!this._dirty) &#123;</span><br><span class="line">                this._dirty = true</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    get value() &#123;</span><br><span class="line">        if (this._dirty) &#123;</span><br><span class="line">            this._dirty = false</span><br><span class="line">            this._value = this._effect.run()</span><br><span class="line">        &#125;</span><br><span class="line">        return this._value</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function computed(getter) &#123;</span><br><span class="line">    return new ComputedRefImpl(getter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="runtime-core-初始化流程实现"><a href="#runtime-core-初始化流程实现" class="headerlink" title="runtime-core 初始化流程实现"></a>runtime-core 初始化流程实现</h2><h3 id="总览导图"><a href="#总览导图" class="headerlink" title="总览导图"></a>总览导图</h3><blockquote><p><strong>全程跟着这个流程图实现</strong></p></blockquote><p><img src="file:///C:/Users/DELL/Downloads/runtime-core.jpg?lastModify=1740547033" alt="runtime-core"></p><p><strong>创建src / runtime-core文件夹</strong></p><blockquote><p><strong>这次的测试样例放在根目录下的example / helloworld</strong></p></blockquote><h3 id="初始化-component-主流程"><a href="#初始化-component-主流程" class="headerlink" title="初始化 component 主流程"></a>初始化 component 主流程</h3><h4 id="测试文件"><a href="#测试文件" class="headerlink" title="测试文件"></a>测试文件</h4><p><strong>example / helloworld / index.html</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;UTF-8&quot; /&gt;</span><br><span class="line">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;</span><br><span class="line">        &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</span><br><span class="line">        &lt;script src=&quot;main.js&quot; type=&quot;module&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><strong>以下文件模拟Vue3</strong></p><p><strong>main.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">createApp(App).mount(&#x27;#app&#x27;)</span><br><span class="line">👇</span><br><span class="line">createApp(App) + app.mount(&#x27;#app&#x27;)</span><br><span class="line">//创建一个根组件App(Vue应用实例)，然后将其挂载到&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;中，从此这个 &lt;div&gt; 里的内容由 Vue 接管，Vue 会根据 App 的图纸，在&lt;div&gt;中渲染出你写的组件</span><br></pre></td></tr></table></figure><p><strong>App.js</strong></p><blockquote><p><strong>!!! 有关虚拟节点 先去看看这篇文章</strong><a href="https://juejin.cn/post/7323031996864446505">vue3虚拟dom详解(含源码) - 掘金</a> !!!</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export const App = &#123;</span><br><span class="line">    render() &#123;//UI逻辑</span><br><span class="line">        return h( //Vue 中的创建虚拟 DOM 的辅助函数,用于创建虚拟 DOM 节点,接收三个参数：</span><br><span class="line">            &#x27;div&#x27;, //要创建的 HTML 标签名或组件选项对象.</span><br><span class="line">            &#x27;hi, &#x27; + this.msg //子节点,可以是字符串、数字、数组或其他虚拟 DOM 节点.</span><br><span class="line">        )</span><br><span class="line">    &#125;,</span><br><span class="line">    setup() &#123;//组合式 API 的入口点,用于组合组件的逻辑，例如响应式数据、生命周期钩子、计算属性等</span><br><span class="line">        return &#123;</span><br><span class="line">            msg: &#x27;mini-vue&#x27;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="基础实现"><a href="#基础实现" class="headerlink" title="基础实现"></a>基础实现</h4><p><strong>createApp.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">export function createApp(rootComponent: any) &#123; // 传入根组件</span><br><span class="line">    return &#123;</span><br><span class="line">        mount(rootContainer: any) &#123; // 挂载回根容器</span><br><span class="line">            // 先把根组件转换成虚拟节点vnode</span><br><span class="line">            // 之后所有的操作都会基于vnode做处理</span><br><span class="line">            const vnode = createVNode(rootComponent)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>vnode.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export function createVNode(type: any, props?: any, children?: any) &#123;</span><br><span class="line">    const vnode = &#123;</span><br><span class="line">        type,// 类型</span><br><span class="line">        props,// 属性</span><br><span class="line">        children,// 孩子</span><br><span class="line">        el: null,// 对应的真实dom</span><br><span class="line">        component: null,// 组件实例</span><br><span class="line">        key: props?.key,// 唯一标识</span><br><span class="line">        // shapeFlag: getShapeFlag(type), // 类型标识</span><br><span class="line">    &#125;</span><br><span class="line">    return vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>添加render函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mount(rootContainer: any) &#123;</span><br><span class="line">    const vnode = createVNode(rootComponent)</span><br><span class="line"></span><br><span class="line">    render(vnode, rootContainer)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><strong>renderer.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createComponentInstance &#125; from &quot;./component&quot;</span><br><span class="line"></span><br><span class="line">export function render(vnode: any, container: any) &#123;</span><br><span class="line">    // 调用patch函数</span><br><span class="line">    patch(vnode, container)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function patch(vnode: any, container: any) &#123;</span><br><span class="line">    if (vnode.shapeFlag === 1) &#123;</span><br><span class="line">        // 处理element</span><br><span class="line">        processElement(vnode, container)  </span><br><span class="line">    &#125;else if (vnode.shapeFlag === 8) &#123;</span><br><span class="line">        // 处理component</span><br><span class="line">        processComponent(vnode, container)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function processElement(vnode: any, container: any) &#123;</span><br><span class="line">    mountElement(vnode, container)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mountElement(vnode: any, container: any) &#123;</span><br><span class="line">    // 创建组件实例对象</span><br><span class="line">    const instance = createComponentInstance(vnode)</span><br><span class="line"></span><br><span class="line">    // 处理组件的setup</span><br><span class="line">    setupComponent(instance)</span><br><span class="line"></span><br><span class="line">    // 处理组件的render</span><br><span class="line">    setupRenderEffect(instance, vnode, container)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>component.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">export function createComponentInstance(vnode: any) &#123;</span><br><span class="line">    const instance = &#123;</span><br><span class="line">        vnode,          // 组件的虚拟节点（设计图）</span><br><span class="line">        type: vnode.type, // 组件定义（比如你写的 .vue 文件中的对象）</span><br><span class="line">        props: vnode.props, // 外部传入的属性</span><br><span class="line">        slots: vnode.slots, // 插槽内容（类似 `&lt;template #header&gt;`）</span><br><span class="line">        proxy: null,     // 代理对象（用于访问数据和属性）</span><br><span class="line">    &#125;;</span><br><span class="line">    return instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function setupComponent(instance: any) &#123;</span><br><span class="line">    // 初始化组件</span><br><span class="line">    initProps(instance)</span><br><span class="line">    initSlots(instance)</span><br><span class="line"></span><br><span class="line">    // 处理组件的setup</span><br><span class="line">    setupStatefulComponent(instance)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function setupStatefulComponent(instance: any) &#123;</span><br><span class="line">    // 先拿到组件</span><br><span class="line">    const Component = instance.type // 组件定义（比如你写的 setup 函数）</span><br><span class="line"></span><br><span class="line">    // 代理对象（用于访问数据和属性）</span><br><span class="line">    instance.proxy = new Proxy(instance, &#123;</span><br><span class="line">        get(target, key) &#123;</span><br><span class="line">            const &#123; setup, props &#125; = target</span><br><span class="line"></span><br><span class="line">            if (key in setup) &#123;// 优先从 setup 返回值中找</span><br><span class="line">                return setup[key]       </span><br><span class="line">            &#125;   else if (key in props) &#123;// 其次从 props 中找</span><br><span class="line">                return props[key]</span><br><span class="line">            &#125;</span><br><span class="line">            return Reflect.get(target, key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)  </span><br><span class="line"></span><br><span class="line">    const &#123; setup &#125; = Component //解构出setup</span><br><span class="line"></span><br><span class="line">    if (setup) &#123;</span><br><span class="line">        setCurrentInstance(instance) // 标记“当前对象是谁”</span><br><span class="line">        const setupResult = setup() // 执行你的 setup 函数</span><br><span class="line">        setCurrentInstance(null) // 清除标记</span><br><span class="line"></span><br><span class="line">        handleSetupResult(instance, setupResult) // 保存 setup 返回值</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        finishComponentSetup(instance) // 没有 setup 直接完成初始化</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function handleSetupResult(instance: any, setupResult: any) &#123;</span><br><span class="line">    if (typeof setupResult === &#x27;object&#x27;) &#123;</span><br><span class="line">        instance.setupState = setupResult; // 保存 setup 返回的对象</span><br><span class="line">    &#125;</span><br><span class="line">    finishComponentSetup(instance); // 完成组装</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function finishComponentSetup(instance: any) &#123;</span><br><span class="line">    const Component = instance.type;</span><br><span class="line">    // 确定 render 函数（你写的 template 会被编译成 render 函数）</span><br><span class="line">    instance.render = Component.render || instance.vnode.render;</span><br><span class="line">    // 准备渲染（虚拟 DOM 生成真实 DOM）</span><br><span class="line">    setupRenderEffect(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>renderer.ts 继续完善逻辑</strong></p><blockquote><p>**回调render，实现 “拆箱” **</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function setupRenderEffect(instance: any, vnode: any, container: any) &#123;</span><br><span class="line">    const &#123; proxy &#125; = instance</span><br><span class="line">    const subTree = instance.render.call(proxy) //拿到虚拟节点树</span><br><span class="line"></span><br><span class="line">    // vnode -&gt; patch</span><br><span class="line">    // vnode -&gt; element -&gt; mountElement</span><br><span class="line">    patch(subTree, container)</span><br><span class="line"></span><br><span class="line">    vnode.el = subTree.el</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用-rollup-打包库"><a href="#使用-rollup-打包库" class="headerlink" title="使用 rollup 打包库"></a>使用 rollup 打包库</h3><blockquote><p><strong>rollup一般用于库的打包，而webpack更多用于应用的打包</strong></p><blockquote><p><strong>构建输出的作用👇</strong></p></blockquote><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">提供对不同模块格式的支持，增强库的兼容性</span><br><span class="line">优化代码体积与性能</span><br><span class="line">简化库的分发与使用流程，促进组件复用</span><br><span class="line">实现按需加载</span><br></pre></td></tr></table></figure></blockquote><blockquote><p><strong>在以下案例中就构建了两种格式 CommonJS &amp; ES Module 的文件</strong></p></blockquote></blockquote><h4 id="配置rollup"><a href="#配置rollup" class="headerlink" title="配置rollup"></a>配置rollup</h4><p><strong>安装</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install --global rollup</span><br></pre></td></tr></table></figure><p><strong>安装官方依赖</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pnpm install @rollup/plugin-typescript --save-dev</span><br><span class="line">pnpm install tslib</span><br></pre></td></tr></table></figure><blockquote><p><strong>创建 src / index.ts 作为 mini-vue 的出入口</strong></p></blockquote><p><strong>rollup.config.js 编写脚本文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import typescript from &#x27;@rollup/plugin-typescript&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    input: &#x27;src/index.ts&#x27;, // 入口文件</span><br><span class="line">    output: [</span><br><span class="line">        &#123;</span><br><span class="line">            file: &#x27;lib/guide-mini-vue.cjs.js&#x27;, // 输出的 CommonJS 格式文件</span><br><span class="line">            format: &#x27;cjs&#x27;, // 指定输出格式为 CommonJS</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            file: &#x27;lib/guide-mini-vue.esm.js&#x27;, // 输出的 ES Module 格式文件</span><br><span class="line">            format: &#x27;es&#x27;, // 指定输出格式为 ES Module</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    plugins: [</span><br><span class="line">        // 插件列表</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><strong>构建的输出文件就是lib下的 guide-mini-vue.cjs.js &amp; guide-mini-vue.esm.js 这两个文件</strong></p></blockquote><p><strong>在package.json中打开依赖</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;jest&quot;,</span><br><span class="line">    &quot;build&quot;: &quot;rollup -c config.js&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><strong>更改tsconfig.json依赖项</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;module&quot;: &quot;esnext&quot;,</span><br></pre></td></tr></table></figure><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p><strong>处理src下的index文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// mini-vue 的入口</span><br><span class="line">export * from &#x27;./runtime-core&#x27;</span><br></pre></td></tr></table></figure><p><strong>再处理runtime-core下的index文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export &#123; createApp &#125; from &quot;./createApp&quot;;</span><br></pre></td></tr></table></figure><blockquote><p><strong>pnpm build 即可构建两种格式的文件</strong></p></blockquote><p><em><strong>补充h函数逻辑</strong></em></p><blockquote><p><strong>前情提要</strong></p><p><strong>example下的App.js文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export const App = &#123;</span><br><span class="line"> render() &#123; // UI逻辑</span><br><span class="line">     return h( // Vue 中的创建虚拟 DOM 的辅助函数,用于创建虚拟 DOM 节点,接收三个参数：</span><br><span class="line">         &#x27;div&#x27;, // 要创建的 HTML 标签名或组件选项对象.</span><br><span class="line">         &#123;&#125;, // 标签属性,可以是一个对象或数组.</span><br><span class="line">         &#x27;hi, &#x27; + this.msg // 子节点,可以是字符串、数字、数组或其他虚拟 DOM 节点.</span><br><span class="line">     )</span><br><span class="line"> &#125;,</span><br><span class="line"> setup() &#123; // 组合式 API 的入口点,用于组合组件的逻辑，例如响应式数据、生命周期钩子、计算属性等</span><br><span class="line">     return &#123;</span><br><span class="line">         msg: &#x27;mini-vue&#x27;,</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p><strong>runtime-core / h.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createVNode &#125; from &quot;./vnode&quot;;</span><br><span class="line"></span><br><span class="line">export function h(type: any, props?: any, children?: any) &#123;</span><br><span class="line">    return createVNode(type, props, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>runtime-core / index.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export &#123; createApp &#125; from &#x27;./createApp&#x27;</span><br><span class="line">import &#123; h &#125; from &#x27;./h&#x27;</span><br></pre></td></tr></table></figure><blockquote><p><strong>pnpm build 继续构建到 example 测试项目里</strong></p></blockquote><p><strong>然后就可以在example中直接引用构建下来的文件</strong></p><p><strong>main.js</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// vue3</span><br><span class="line">import &#123; createApp &#125; from &#x27;../../lib/guide-mini-vue.esm.js&#x27; // 导入自己构建的文件</span><br><span class="line">import &#123; App &#125; from &#x27;./App.js&#x27;</span><br><span class="line"></span><br><span class="line">createApp(App).mount(&#x27;#app&#x27;)</span><br></pre></td></tr></table></figure><p><strong>然后就可以打开HTML文件了</strong></p><h2 id="runtime-dom-封装DOM方法"><a href="#runtime-dom-封装DOM方法" class="headerlink" title="runtime-dom 封装DOM方法"></a>runtime-dom 封装DOM方法</h2><h2 id="compiler-core-编译逻辑和算法-1"><a href="#compiler-core-编译逻辑和算法-1" class="headerlink" title="compiler-core 编译逻辑和算法"></a>compiler-core 编译逻辑和算法</h2><h2 id="compiler-sfc-解析-vue组件-1"><a href="#compiler-sfc-解析-vue组件-1" class="headerlink" title="compiler-sfc 解析.vue组件"></a>compiler-sfc 解析.vue组件</h2><h2 id="compiler-dom-处理template标签"><a href="#compiler-dom-处理template标签" class="headerlink" title="compiler-dom 处理template标签"></a>compiler-dom 处理template标签</h2>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/GO%20%20VO%20%20AO%20/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/GO%20%20VO%20%20AO%20/</url>
      
        <content type="html"><![CDATA[<h1 id="GO-VO-AO"><a href="#GO-VO-AO" class="headerlink" title="GO ? VO ? AO ?"></a>GO ? VO ? AO ?</h1><p>我用 <strong>「剧场演出」</strong> 来比喻这些概念</p><h2 id="GO-（Global-Object）"><a href="#GO-（Global-Object）" class="headerlink" title="GO （Global Object）"></a>GO （Global Object）</h2><p><strong>全局上下文对象（就是全局变量）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var globalProp = &quot;剧场灯光&quot;;  // 🎯 放入GO</span><br><span class="line">function stageManager() &#123; /*...*/ &#125;  // 🎯 放入GO</span><br></pre></td></tr></table></figure><p><strong>预编译阶段</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GO = &#123;</span><br><span class="line">  globalProp: undefined,  // 先摆上道具标签</span><br><span class="line">  stageManager: function()&#123;...&#125;  // 导演剧本提前挂好</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>执行阶段</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GO = &#123;</span><br><span class="line">  globalProp: &quot;剧场灯光&quot;,  // 道具就位</span><br><span class="line">  stageManager: function()&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="VO-（Variable-Object）"><a href="#VO-（Variable-Object）" class="headerlink" title="VO （Variable Object）"></a>VO （Variable Object）</h2><p><strong>变量对象</strong></p><p><strong>每个执行上下文都有</strong></p><p><strong>上下文创建到销毁</strong></p><h2 id="AO-（Activation-Object）"><a href="#AO-（Activation-Object）" class="headerlink" title="AO （Activation Object）"></a>AO （Activation Object）</h2><p><strong>活动对象</strong></p><p><strong>函数调用时临时创建，调用结束销毁</strong></p><h2 id="用一个面试题例子来理解"><a href="#用一个面试题例子来理解" class="headerlink" title="用一个面试题例子来理解"></a>用一个面试题例子来理解</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var a = 1;</span><br><span class="line">function test() &#123;</span><br><span class="line">    console.log(a);  // 🤔 输出什么？</span><br><span class="line">    var a = 2;</span><br><span class="line">&#125;</span><br><span class="line">test();</span><br></pre></td></tr></table></figure><blockquote><p><strong>1.全局GO（初始）: { a: undefined, test: function }</strong></p><p><strong>2.</strong><code>var a = 1;</code>GO : { a: 1, test: function }</p><p><strong>3.</strong><code>test();</code>创建AO : { a: undefined }</p><p><strong>4.</strong><code>console.log(a)</code> : AO位于作用域最顶层，{ a: undefined } ，输出 <code>undefined</code></p><p><strong>5.</strong><code>var a = 2;</code>: AO : { a: 2 }</p><p><strong>6.调用函数结束，AO数据销毁，GO : { a: 1, test: function }</strong></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/ECharts%E5%AE%98%E6%96%B9%E5%9B%BE%E8%A1%A8%E5%BA%93CV%E6%95%99%E7%A8%8B/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/ECharts%E5%AE%98%E6%96%B9%E5%9B%BE%E8%A1%A8%E5%BA%93CV%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h3 id="本文项目主干结构"><a href="#本文项目主干结构" class="headerlink" title="本文项目主干结构"></a>本文项目主干结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">├── public</span><br><span class="line">│   └── data.json        # 数据文件（静态拆分数据时使用）</span><br><span class="line">│</span><br><span class="line">├── src</span><br><span class="line">│   ├── utils           # 工具</span><br><span class="line">│   │   └── request.ts  # axios二次封装</span><br><span class="line">│   │</span><br><span class="line">│   ├── store              # Pinia仓库</span><br><span class="line">│   │   └── chartStore.ts  # 管理图表相关的数据</span><br><span class="line">│   │</span><br><span class="line">│   ├── services         # API 服务</span><br><span class="line">│   │   └── api.ts       # 模拟后端 API 请求</span><br><span class="line">│   │</span><br><span class="line">│   ├── components       # 组件</span><br><span class="line">│   │   ├── chart        # 图表组件</span><br><span class="line">│   │   │   ├── category # 图表分类</span><br><span class="line">│   │   │   │   └── rose.vue  # 玫瑰图组件</span><br><span class="line">│   │   │   │   └── bar.vue   # 柱状图组件</span><br><span class="line">│   │   │   │   └── line.vue  # 折线图组件</span><br><span class="line">│   │   │   │   └── pie.vue   # 饼状图组件</span><br><span class="line">│   │   │   │   └── scaatter  # 散点图组件</span><br><span class="line">│   │   │   │</span><br><span class="line">│   │   │   ├── data     # 数据处理逻辑</span><br><span class="line">│   │   │   │   └── chartData.ts # 数据获取和处理</span><br><span class="line">│   │   │   │</span><br><span class="line">│   │   │   └── chart.vue # 所有图表汇总</span><br><span class="line">│   │   │</span><br><span class="line">│   │   └── other-components # 其他组件</span><br><span class="line">│   │</span><br><span class="line">│   ├── App.vue          # 根组件</span><br><span class="line">│   ├── main.ts          # 入口文件</span><br><span class="line">│   │</span><br><span class="line">│   └── types            # 类型定义</span><br><span class="line">│       └── chart.d.ts   # ECharts 数据类型定义</span><br><span class="line">│</span><br><span class="line">├── vite.config.ts       # Vite 配置文件</span><br><span class="line">└── package.json         # 项目依赖</span><br></pre></td></tr></table></figure><p><a href="https://echarts.apache.org/examples/zh/index.html">Examples - Apache ECharts</a></p><p><strong>Echarts官网→所有示例→选择需要导入的图表→完整代码</strong></p><p>本文以基础南丁格尔玫瑰图作示例</p><p><a href="https://echarts.apache.org/examples/zh/editor.html?c=pie-roseType-simple&lang=ts&version=5.5.0">Examples - Apache ECharts</a></p><h3 id="官网源码（原生JS）"><a href="#官网源码（原生JS）" class="headerlink" title="官网源码（原生JS）"></a>官网源码（原生JS）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> echarts <span class="keyword">from</span> <span class="string">&#x27;echarts&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> chartDom = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;main&#x27;</span>)!;</span><br><span class="line"><span class="keyword">var</span> myChart = echarts.<span class="title function_">init</span>(chartDom);</span><br><span class="line"><span class="keyword">var</span> option;</span><br><span class="line"></span><br><span class="line">option = &#123;</span><br><span class="line">  <span class="attr">legend</span>: &#123;</span><br><span class="line">    <span class="attr">top</span>: <span class="string">&#x27;bottom&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">toolbox</span>: &#123;</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">feature</span>: &#123;</span><br><span class="line">      <span class="attr">mark</span>: &#123; <span class="attr">show</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="attr">dataView</span>: &#123; <span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">readOnly</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      <span class="attr">restore</span>: &#123; <span class="attr">show</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="attr">saveAsImage</span>: &#123; <span class="attr">show</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">series</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Nightingale Chart&#x27;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;pie&#x27;</span>,</span><br><span class="line">      <span class="attr">radius</span>: [<span class="number">50</span>, <span class="number">250</span>],</span><br><span class="line">      <span class="attr">center</span>: [<span class="string">&#x27;50%&#x27;</span>, <span class="string">&#x27;50%&#x27;</span>],</span><br><span class="line">      <span class="attr">roseType</span>: <span class="string">&#x27;area&#x27;</span>,</span><br><span class="line">      <span class="attr">itemStyle</span>: &#123;</span><br><span class="line">        <span class="attr">borderRadius</span>: <span class="number">8</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">data</span>: [</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">40</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 1&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">38</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 2&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">32</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 3&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">30</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 4&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">28</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 5&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">26</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 6&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">22</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 7&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">value</span>: <span class="number">18</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 8&#x27;</span> &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">option &amp;&amp; myChart.<span class="title function_">setOption</span>(option);</span><br></pre></td></tr></table></figure><h3 id="转Vue组件（静态数据）"><a href="#转Vue组件（静态数据）" class="headerlink" title="转Vue组件（静态数据）"></a>转Vue组件（静态数据）</h3><p>rose.vue</p><h4 id="template"><a href="#template" class="headerlink" title="template"></a>template</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div ref=&quot;chartContainer&quot; class=&quot;chart-container&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><h4 id="script"><a href="#script" class="headerlink" title="script"></a>script</h4><h5 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> echarts <span class="keyword">from</span> <span class="string">&#x27;echarts&#x27;</span>;</span><br></pre></td></tr></table></figure><p>其他按需引入</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onMounted, ref, onUnmounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>; <span class="comment">//更多的看自己需求</span></span><br></pre></td></tr></table></figure><h5 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h5><p>JS源码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chartDom = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;main&#x27;</span>)!;</span><br></pre></td></tr></table></figure><p><strong>转vue组件</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取图表容器的引用</span></span><br><span class="line"><span class="keyword">const</span> chartContainer = ref&lt;<span class="title class_">HTMLElement</span> | <span class="literal">null</span>&gt;(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>JS源码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myChart = echarts.<span class="title function_">init</span>(chartDom);</span><br></pre></td></tr></table></figure><p><strong>转vue组件</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义图表实例</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">myChart</span>: echarts.<span class="property">ECharts</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><h5 id="option"><a href="#option" class="headerlink" title="option"></a>option</h5><p>JS源码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> option;</span><br><span class="line">option = &#123;</span><br><span class="line">    <span class="comment">//这段直接复制过来//</span></span><br><span class="line">    <span class="attr">legend</span>: &#123;</span><br><span class="line">        <span class="attr">top</span>: <span class="string">&#x27;bottom&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//这段直接复制过来//</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>转vue组件</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义图表选项</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">option</span>: echarts.<span class="property">EChartsOption</span> = &#123;</span><br><span class="line">    <span class="comment">//这段直接复制过来//</span></span><br><span class="line">    <span class="attr">legend</span>: &#123;</span><br><span class="line">        <span class="attr">top</span>: <span class="string">&#x27;bottom&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//这段直接复制过来//</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h5><p>JS源码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option &amp;&amp; myChart.<span class="title function_">setOption</span>(option);</span><br></pre></td></tr></table></figure><p><strong>转vue组件（优化版）</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在组件挂载时初始化图表</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!chartContainer.<span class="property">value</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 ECharts 实例</span></span><br><span class="line">  myChart = echarts.<span class="title function_">init</span>(chartContainer.<span class="property">value</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置图表选项</span></span><br><span class="line">  myChart.<span class="title function_">setOption</span>(option);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听窗口大小变化，自动调整图表大小</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, resizeChart);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在组件卸载时清理图表实例</span></span><br><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (myChart) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, resizeChart);</span><br><span class="line">    myChart.<span class="title function_">dispose</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义函数：调整图表大小</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resizeChart</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (myChart) &#123;</span><br><span class="line">    myChart.<span class="title function_">resize</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="style"><a href="#style" class="headerlink" title="style"></a>style</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.chart-container</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>; <span class="comment">/* 根据需要调整高度 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="抽离数据写法（静态数据）"><a href="#抽离数据写法（静态数据）" class="headerlink" title="抽离数据写法（静态数据）"></a>抽离数据写法（静态数据）</h3><p>【注：这里是从本地调用数据的写法，需要】</p><h4 id="public-data-json"><a href="#public-data-json" class="headerlink" title="public &#x2F; data.json"></a>public &#x2F; data.json</h4><p>(模拟后端传来的数据)</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 1&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 2&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 3&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 4&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">28</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 5&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 6&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 7&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rose 8&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="图表组件修改"><a href="#图表组件修改" class="headerlink" title="图表组件修改"></a>图表组件修改</h4><p>option &#x2F; series 部分</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data</span>: [</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">40</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 1&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">38</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 2&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">32</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 3&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">30</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 4&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">28</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 5&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">26</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 6&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">22</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 7&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">value</span>: <span class="number">18</span>, <span class="attr">name</span>: <span class="string">&#x27;rose 8&#x27;</span> &#125;,</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p>改为</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data</span>: [], <span class="comment">// 初始为空，稍后从 data.json 加载</span></span><br></pre></td></tr></table></figure><h5 id="添加异步加载函数"><a href="#添加异步加载函数" class="headerlink" title="添加异步加载函数"></a>添加异步加载函数</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步加载数据</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadData</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 使用 fetch 从 public/data.json 获取数据</span></span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/data.json&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加报错提示</span></span><br><span class="line">        <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Failed to fetch data&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提取数据</span></span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 JSON 数据转换为 ECharts 需要的格式（根据数据键值对自行修改）</span></span><br><span class="line">        <span class="keyword">const</span> chartData = data.<span class="property">data</span>.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">            <span class="attr">value</span>: item.<span class="property">value</span>,</span><br><span class="line">            <span class="attr">name</span>: item.<span class="property">name</span>,</span><br><span class="line">        &#125;))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换图表选项中‘data’项</span></span><br><span class="line">        option.<span class="property">series</span>[<span class="number">0</span>].<span class="property">data</span> = chartData;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果图表已经初始化，则重新设置选项</span></span><br><span class="line">        <span class="keyword">if</span> (myChart) &#123;</span><br><span class="line">            myChart.<span class="title function_">setOption</span>(option);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error loading data:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="调用函数-loadData"><a href="#调用函数-loadData" class="headerlink" title="调用函数 loadData"></a>调用函数 loadData</h5><p>在 onMounted 中的 setOption 后</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!chartContainer.<span class="property">value</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 ECharts 实例</span></span><br><span class="line">    myChart = echarts.<span class="title function_">init</span>(chartContainer.<span class="property">value</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置图表选项</span></span><br><span class="line">    myChart.<span class="title function_">setOption</span>(option)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载数据并更新图表</span></span><br><span class="line">    <span class="title function_">loadData</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听窗口大小变化，自动调整图表大小</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, resizeChart)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="真实前后端对接（动态请求）"><a href="#真实前后端对接（动态请求）" class="headerlink" title="真实前后端对接（动态请求）"></a>真实前后端对接（动态请求）</h3><h4 id="使用-axios"><a href="#使用-axios" class="headerlink" title="使用 axios"></a>使用 <code>axios</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install axios</span><br></pre></td></tr></table></figure><h5 id="axios二次封装"><a href="#axios二次封装" class="headerlink" title="axios二次封装"></a>axios二次封装</h5><p>模板</p><p><code>src/utils/request.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios, &#123; <span class="title class_">AxiosInstance</span>, <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ElMessage</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;element-plus&#x27;</span>; <span class="comment">// Element Plus 组件（主要是使用Message消息弹出框）</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span>; <span class="comment">// 引入 Pinia Store</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span>; <span class="comment">// 引入 Vue Router</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 axios 实例</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">service</span>: <span class="title class_">AxiosInstance</span> = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">baseURL</span>: <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">env</span>.<span class="property">VITE_API_BASE_URL</span> || <span class="string">&#x27;/&#x27;</span>, <span class="comment">// 从环境变量中获取 API 基础路径</span></span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">5000</span>, <span class="comment">// 请求超时时间</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在发送请求之前做些什么</span></span><br><span class="line">    <span class="comment">// 例如，添加身份验证 token</span></span><br><span class="line">    <span class="keyword">const</span> token = store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">token</span>; <span class="comment">// 假设你有用户信息存储在 Pinia 中</span></span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      config.<span class="property">headers</span>[<span class="string">&#x27;Authorization&#x27;</span>] = <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 对请求错误做些什么</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params"><span class="attr">response</span>: <span class="title class_">AxiosResponse</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 对响应数据做点什么</span></span><br><span class="line">    <span class="keyword">const</span> res = response.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果接口返回的状态码不是 200，说明请求失败</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">code</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(res.<span class="property">message</span> || <span class="string">&#x27;Error&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(res.<span class="property">message</span> || <span class="string">&#x27;Error&#x27;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 对响应错误做点什么</span></span><br><span class="line">    <span class="keyword">if</span> (error.<span class="property">response</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (error.<span class="property">response</span>.<span class="property">status</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">          <span class="comment">// 清除 Token 并跳转到登录页面</span></span><br><span class="line">          store.<span class="title function_">dispatch</span>(<span class="string">&#x27;user/logout&#x27;</span>);</span><br><span class="line">          router.<span class="title function_">push</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">403</span>:</span><br><span class="line">          <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;Forbidden&#x27;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">          <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;Not Found&#x27;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">500</span>:</span><br><span class="line">          <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;Server Error&#x27;</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">          <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(error.<span class="property">message</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;Network Error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service;</span><br></pre></td></tr></table></figure><p>现在可以在任何地方通过 <code>import request from &#39;@/utils/request&#39;</code> 来使用封装后的 axios 实例</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span>;</span><br></pre></td></tr></table></figure><h5 id="函数-loadData修改"><a href="#函数-loadData修改" class="headerlink" title="函数 loadData修改"></a>函数 loadData修改</h5><p>静态获取</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">loadData</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/////更改处////</span></span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/data.json&#x27;</span>) <span class="comment">// 使用 fetch 从 public/data.json 获取数据</span></span><br><span class="line">        <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Failed to fetch data&#x27;</span>) &#125;</span><br><span class="line">        <span class="comment">/////更改处////</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>()</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure><p>动态对接</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadData</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/////更改处////</span></span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;/api/data&#x27;</span>); <span class="comment">// 假设后端 API 地址为 /api/data</span></span><br><span class="line">        <span class="comment">/////更改处////</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">const</span> data = response.<span class="property">data</span>;</span><br><span class="line">        ......</span><br></pre></td></tr></table></figure><h4 id="Pinia状态管理"><a href="#Pinia状态管理" class="headerlink" title="Pinia状态管理"></a>Pinia状态管理</h4><p>如果你的应用中有多个组件需要共享数据（例如多个图表共享同一份数据），可以考虑使用 Vuex 或 Pinia 进行状态管理。这样可以避免重复的 API 请求，并且更容易管理数据流。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install pinia</span><br></pre></td></tr></table></figure><h5 id="在-main-ts-中注册Pinia"><a href="#在-main-ts-中注册Pinia" class="headerlink" title="在 main.ts 中注册Pinia"></a>在 <code>main.ts</code> 中注册Pinia</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementPlus</span> <span class="keyword">from</span> <span class="string">&#x27;element-plus&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-plus/dist/index.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 Pinia</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">createPinia</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 Vue Router 和 Element Plus</span></span><br><span class="line">app.<span class="title function_">use</span>(router);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">ElementPlus</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br></pre></td></tr></table></figure><h5 id="chartStore-ts"><a href="#chartStore-ts" class="headerlink" title="chartStore.ts"></a><code>chartStore.ts</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ChartState</span> &#123;</span><br><span class="line">    <span class="attr">chartData</span>: <span class="title class_">Array</span>&lt;&#123; <span class="attr">value</span>: <span class="built_in">number</span>; <span class="attr">name</span>: <span class="built_in">string</span> &#125;&gt;;</span><br><span class="line">    <span class="attr">isLoading</span>: <span class="built_in">boolean</span>;</span><br><span class="line">    <span class="attr">error</span>: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useChartStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;chart&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">state</span>: (): <span class="function"><span class="params">ChartState</span> =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">chartData</span>: [], <span class="comment">// 图表数据</span></span><br><span class="line">        <span class="attr">isLoading</span>: <span class="literal">false</span>, <span class="comment">// 加载状态</span></span><br><span class="line">        <span class="attr">error</span>: <span class="literal">null</span>, <span class="comment">// 错误信息</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">        <span class="keyword">async</span> <span class="title function_">fetchChartData</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">error</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> response = <span class="keyword">await</span> request.<span class="title function_">get</span>(<span class="string">&#x27;/api/data&#x27;</span>); <span class="comment">// 假设后端 API 地址为 /api/data</span></span><br><span class="line">                <span class="keyword">const</span> data = response.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将 JSON 数据转换为 ECharts 需要的格式</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">chartData</span> = data.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">                    <span class="attr">value</span>: item.<span class="property">sales</span>,</span><br><span class="line">                    <span class="attr">name</span>: item.<span class="property">category</span>,</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">error</span> = <span class="string">&#x27;Failed to load chart data&#x27;</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error loading data:&#x27;</span>, error);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这样就可以在组件中直接调用现成的数据逻辑了</p><h5 id="rose-vue"><a href="#rose-vue" class="headerlink" title="rose.vue"></a><code>rose.vue</code></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">    import &#123; onMounted, onUnmounted, ref, watch &#125; from &#x27;vue&#x27;;</span><br><span class="line">    import * as echarts from &#x27;echarts&#x27;;</span><br><span class="line">    import &#123; useChartStore &#125; from &#x27;@/store/chartStore&#x27;;// 调用自定义Store</span><br><span class="line"></span><br><span class="line">    const chartContainer = ref&lt;HTMLElement | null&gt;(null);</span><br><span class="line">    let myChart: echarts.ECharts | null = null;</span><br><span class="line"></span><br><span class="line">    // 获取 Pinia Store</span><br><span class="line">    const chartStore = useChartStore();</span><br><span class="line"></span><br><span class="line">    // 定义图表选项</span><br><span class="line">    const option: echarts.EChartsOption = &#123;</span><br><span class="line">        legend: &#123;</span><br><span class="line">            top: &#x27;bottom&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">        toolbox: &#123;</span><br><span class="line">            show: true,</span><br><span class="line">            feature: &#123;</span><br><span class="line">                mark: &#123; show: true &#125;,</span><br><span class="line">                dataView: &#123; show: true, readOnly: false &#125;,</span><br><span class="line">                restore: &#123; show: true &#125;,</span><br><span class="line">                saveAsImage: &#123; show: true &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        series: [</span><br><span class="line">            &#123;</span><br><span class="line">                name: &#x27;销量&#x27;,</span><br><span class="line">                type: &#x27;pie&#x27;,</span><br><span class="line">                radius: [50, 250],</span><br><span class="line">                center: [&#x27;50%&#x27;, &#x27;50%&#x27;],</span><br><span class="line">                roseType: &#x27;area&#x27;,</span><br><span class="line">                itemStyle: &#123;</span><br><span class="line">                    borderRadius: 8,</span><br><span class="line">                &#125;,</span><br><span class="line">                data: [], // 初始为空，稍后从 Pinia Store 获取</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // 监听 Pinia Store 中的数据变化</span><br><span class="line">    watch(</span><br><span class="line">        () =&gt; chartStore.chartData,</span><br><span class="line">        (newData) =&gt; &#123;</span><br><span class="line">            if (myChart &amp;&amp; newData.length &gt; 0) &#123;</span><br><span class="line">                option.series[0].data = newData;</span><br><span class="line">                myChart.setOption(option);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">        if (!chartContainer.value) return;</span><br><span class="line">        // 初始化 ECharts 实例</span><br><span class="line">        myChart = echarts.init(chartContainer.value);</span><br><span class="line">        // 设置初始图表选项（此时 series.data 为空）</span><br><span class="line">        myChart.setOption(option);</span><br><span class="line">        // 加载数据</span><br><span class="line">        chartStore.fetchChartData();</span><br><span class="line">        // 监听窗口大小变化，自动调整图表大小</span><br><span class="line">        window.addEventListener(&#x27;resize&#x27;, resizeChart);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // 在组件卸载时移除事件监听器</span><br><span class="line">    onUnmounted(() =&gt; &#123;</span><br><span class="line">        if (myChart) &#123;</span><br><span class="line">            window.removeEventListener(&#x27;resize&#x27;, resizeChart);</span><br><span class="line">            myChart.dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // 自定义函数：调整图表大小</span><br><span class="line">    const resizeChart = () =&gt; &#123;</span><br><span class="line">        if (myChart) &#123;</span><br><span class="line">            myChart.resize();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h5 id="更多组件"><a href="#更多组件" class="headerlink" title="更多组件"></a>更多组件</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据上述步骤实现官网源码转Vue组件，插入到category #图表分类 文件夹下即可</span><br></pre></td></tr></table></figure><h4 id="加载动画设置"><a href="#加载动画设置" class="headerlink" title="加载动画设置"></a>加载动画设置</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!chartContainer.<span class="property">value</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 ECharts 实例</span></span><br><span class="line">  myChart = echarts.<span class="title function_">init</span>(chartContainer.<span class="property">value</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 显示加载动画</span></span><br><span class="line">  myChart.<span class="title function_">showLoading</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载数据并更新图表</span></span><br><span class="line">  <span class="title function_">loadData</span>().<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 无论成功还是失败，都隐藏加载动画</span></span><br><span class="line">    myChart?.<span class="title function_">hideLoading</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听窗口大小变化，自动调整图表大小</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, resizeChart);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="缓存与性能优化"><a href="#缓存与性能优化" class="headerlink" title="缓存与性能优化"></a>缓存与性能优化</h4><h5 id="缓存数据"><a href="#缓存数据" class="headerlink" title="缓存数据"></a>缓存数据</h5><p>如果数据不会频繁变化，可以考虑使用浏览器的缓存机制（如 localStorage 或 sessionStorage）来缓存数据，减少不必要的 API 请求。</p><p><code>chartStore.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ChartState</span> &#123;</span><br><span class="line">  <span class="attr">chartData</span>: <span class="title class_">Array</span>&lt;&#123; <span class="attr">value</span>: <span class="built_in">number</span>; <span class="attr">name</span>: <span class="built_in">string</span> &#125;&gt;;</span><br><span class="line">  <span class="attr">isLoading</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">error</span>: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useChartStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;chart&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: (): <span class="function"><span class="params">ChartState</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">chartData</span>: [], <span class="comment">// 图表数据</span></span><br><span class="line">    <span class="attr">isLoading</span>: <span class="literal">false</span>, <span class="comment">// 加载状态</span></span><br><span class="line">    <span class="attr">error</span>: <span class="literal">null</span>, <span class="comment">// 错误信息</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">fetchChartData</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 检查是否有缓存数据</span></span><br><span class="line">      <span class="keyword">const</span> cachedData = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;chartData&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (cachedData) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chartData</span> = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(cachedData);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> request.<span class="title function_">get</span>(<span class="string">&#x27;/api/data&#x27;</span>); <span class="comment">// 假设后端 API 地址为 /api/data</span></span><br><span class="line">        <span class="keyword">const</span> data = response.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 JSON 数据转换为 ECharts 需要的格式</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chartData</span> = data.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">          <span class="attr">value</span>: item.<span class="property">sales</span>,</span><br><span class="line">          <span class="attr">name</span>: item.<span class="property">category</span>,</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 缓存数据</span></span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;chartData&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">chartData</span>));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">error</span> = <span class="string">&#x27;Failed to load chart data&#x27;</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error loading data:&#x27;</span>, error);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="按需加载"><a href="#按需加载" class="headerlink" title="按需加载"></a>按需加载</h5><p>大型图表或复杂的数据集，可以考虑分页加载数据或懒加载</p><p><code>chartStore.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useChartStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;chart&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: (): <span class="function"><span class="params">ChartState</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">chartData</span>: [],</span><br><span class="line">    <span class="attr">isLoading</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">error</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">fetchChartData</span>(<span class="params"><span class="attr">forceRefresh</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">error</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果不需要强制刷新且有缓存数据，则直接使用缓存</span></span><br><span class="line">      <span class="keyword">if</span> (!forceRefresh) &#123;</span><br><span class="line">        <span class="keyword">const</span> cachedData = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;chartData&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (cachedData) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">chartData</span> = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(cachedData);</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> request.<span class="title function_">get</span>(<span class="string">&#x27;/api/data&#x27;</span>); <span class="comment">// 假设后端 API 地址为 /api/data</span></span><br><span class="line">        <span class="keyword">const</span> data = response.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 JSON 数据转换为 ECharts 需要的格式</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chartData</span> = data.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">          <span class="attr">value</span>: item.<span class="property">sales</span>,</span><br><span class="line">          <span class="attr">name</span>: item.<span class="property">category</span>,</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 缓存数据</span></span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;chartData&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">chartData</span>));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">error</span> = <span class="string">&#x27;Failed to load chart data&#x27;</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error loading data:&#x27;</span>, error);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>rose.vue</code></p><p>调用 fetchChartData 时传递参数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认情况下使用缓存数据</span></span><br><span class="line">chartStore.<span class="title function_">fetchChartData</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果需要强制刷新数据（例如用户点击了“刷新”按钮），可以传递 true</span></span><br><span class="line"><span class="comment">// chartStore.fetchChartData(true);</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF%E6%96%B9%E5%90%91%E9%80%89%E5%9E%8B/"/>
      <url>/2025/03/08/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF%E6%96%B9%E5%90%91%E9%80%89%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="前端技术方向选型"><a href="#前端技术方向选型" class="headerlink" title="前端技术方向选型"></a>前端技术方向选型</h1><hr><h2 id="数据可视化"><a href="#数据可视化" class="headerlink" title="数据可视化"></a>数据可视化</h2><p><strong>简介：将数据以图表、图形等可视化形式展示</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数据可视化库，如D3.js、ECharts、AntV等</span><br><span class="line">JavaScript的数组操作、数据过滤</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">数据处理和分析能力要求高</span><br><span class="line">JavaScript的数组操作、数据过滤等方法</span><br><span class="line">不同图表类型的特点和配置选项复杂，需要深入了解</span><br><span class="line">可视化效果的设计和优化难度大，如色彩搭配、布局调整等。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：高</strong></p><p><strong>成熟性：比较成熟，已有许多成熟的数据可视化库，功能强大，基本能满足常见需求。</strong></p><p><strong>可延展性：较好，可与后端数据处理、前端交互等技术集成，拓展数据可视化的应用场景。</strong></p><hr><h2 id="跨端"><a href="#跨端" class="headerlink" title="跨端"></a>跨端</h2><p><strong>简介：一套代码在不同的平台上运行，如Web、Android、iOS、小程序等。</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">掌握跨端框架，如ReactNative、Flutter等；</span><br><span class="line">了解不同平台的原生开发技术，如Android的Java/Kotlin、iOS的Swift/Objective-C；</span><br><span class="line">熟悉前端的基础技术HTML、CSS、JavaScript；</span><br><span class="line">掌握相关的打包和发布工具，如Cordova、Capacitor等。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">不同平台的原生开发技术差异大，需要学习和掌握多种技术栈；</span><br><span class="line">跨端框架的原理和使用复杂，如ReactNative、Flutter等；</span><br><span class="line">适配不同平台的UI和交互规范困难。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：高</strong></p><p><strong>成熟性：比较成熟，主流的跨端框架已得到广泛应用，但在一些特殊需求和平台上仍存在兼容性问题。</strong></p><p><strong>可延展性：强，可与后端开发、云服务等技术集成，拓展跨端应用的功能和场景。</strong></p><hr><h2 id="工程化"><a href="#工程化" class="headerlink" title="工程化"></a>工程化</h2><p><strong>简介：使用软件工程的方法和工具来规范和优化前端开发流程，提高开发效率、代码质量和可维护性。</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">构建工具，如Webpack、Vite等；</span><br><span class="line">代码规范和检查工具，如ESLint、Prettier等；</span><br><span class="line">了解模块化和组件化开发的方法，如ES6模块、Vue组件、React组件等；</span><br><span class="line">版本控制工具，如Git</span><br><span class="line">自动化部署和持续集成工具，如Jenkins、GitLab CI等。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">构建工具的配置和使用复杂，如Webpack、Vite等</span><br><span class="line">代码规范和检查工具的定制和集成困难</span><br><span class="line">理解和掌握模块化和组件化开发的原理和方法需要一定时间。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：高</strong></p><p><strong>成熟性：比较成熟，相关的构建工具、代码规范和检查工具等已得到广泛应用。</strong></p><p><strong>可延展性：较好，可与其他技术集成，如测试框架、自动化部署工具等，拓展工程化的范围和功能。</strong></p><hr><h2 id="即时通讯"><a href="#即时通讯" class="headerlink" title="即时通讯"></a>即时通讯</h2><p><strong>简介：实现客户端与客户端之间的实时通信，如文字消息、语音消息、视频通话等</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">掌握WebSocket或WebRTC等实时通信技术；</span><br><span class="line">熟悉相关的即时通讯协议，如XMPP、MQTT等；</span><br><span class="line">了解音视频处理技术，如音频采集、视频编码等；</span><br><span class="line">掌握JavaScript的事件处理和异步编程，实现实时通信的交互功能。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实时通信协议和技术的理解和实现复杂，如WebSocket、WebRTC等；</span><br><span class="line">音视频处理技术难度大，包括音频采集、视频编码等；</span><br><span class="line">安全和隐私保护要求高，如数据加密、用户认证等。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：高</strong></p><p><strong>成熟性：比较成熟，已有许多成熟的即时通讯解决方案和库，但在一些特殊需求下仍需定制开发。</strong></p><p><strong>可延展性：较好，可与其他技术集成，如人工智能聊天机器人、客服系统等，拓展应用场景。</strong></p><hr><h2 id="协同"><a href="#协同" class="headerlink" title="协同"></a>协同</h2><p><strong>简介：多人对一个项目进行编译，开发，调试</strong></p><p><strong>技术平台：协同工具平台Git，SVN版本控制系统</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">了解常用的协同工具和平台，如Git、SVN等版本控制系统；</span><br><span class="line">掌握相关的代码合并、冲突解决等技术；</span><br><span class="line">熟悉实时通信技术，如WebSocket，用于实现多人实时协作的交互功能；</span><br><span class="line">了解团队协作和项目管理的流程和方法。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实时通信技术的实现和优化复杂，如WebSocket的连接管理、消息推送等；</span><br><span class="line">处理多人同时操作的并发控制和数据一致性困难；</span><br><span class="line">不同开发人员的代码合并和冲突解决繁琐。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：高</strong></p><p><strong>成熟性：技术在不断发展和完善中，已有一些成熟的协同工具和平台，但在一些复杂场景下仍存在挑战。</strong></p><p><strong>可延展性：强，可与各种开发工具和技术集成，拓展协同的范围和功能。</strong></p><hr><h2 id="富文本"><a href="#富文本" class="headerlink" title="富文本"></a>富文本</h2><p><strong>简介：支持用户输入和编辑丰富格式文本的功能，如加粗、斜体、图片、视频、链接等，应用于博客、内容管理系统、在线文档等场景。</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">可使用成熟的富文本编辑器库，如TinyMCE、CKEditor等；</span><br><span class="line">掌握JavaScript的事件处理和DOM操作，实现对富文本内容的动态编辑和交互；</span><br><span class="line">熟悉相关的图片上传、视频嵌入等技术，以及数据存储和传输的方式。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">富文本编辑器的功能复杂，需要深入掌握其API和配置选项；</span><br><span class="line">处理大量文本和复杂格式时的性能优化挑战大；</span><br><span class="line">实现多人协同编辑时的冲突处理和数据同步困难。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：较高</strong></p><p><strong>成熟性：比较成熟，已有许多成熟的富文本编辑器库，功能丰富，基本能满足常见需求。</strong></p><p><strong>可延展性：较好，可与其他前端技术集成，如文件上传、图片处理、数据存储等，拓展应用场景。</strong></p><hr><h2 id="3D渲染"><a href="#3D渲染" class="headerlink" title="3D渲染"></a>3D渲染</h2><p><strong>简介：在浏览器中创建和展示3D图形和场景</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">掌握WebGL或WebGPU的API</span><br><span class="line">了解3D图形的基本概念，如顶点、纹理、材质等；</span><br><span class="line">熟悉相关的3D渲染引擎，如Three.js、Babylon.js等；</span><br><span class="line">掌握JavaScript的性能优化技巧，以提高3D渲染的效率；</span><br><span class="line">了解图形设计和建模工具，如Blender、Maya等，用于创建3D模型和场景。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3D图形学知识要求高，如顶点、纹理、材质等概念复杂；</span><br><span class="line">WebGL或WebGPU的API学习曲线陡峭，需要掌握底层图形渲染原理；</span><br><span class="line">性能优化难度大，尤其是在处理复杂场景和大量数据时。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：中等偏高</strong></p><p><strong>成熟性：处于发展阶段，相关的3D渲染引擎和工具不断完善，但仍有一定的技术门槛。</strong></p><p><strong>可延展性：好，可与动画、物理引擎等技术结合，拓展3D应用的功能和场景。</strong></p><hr><h2 id="音视频"><a href="#音视频" class="headerlink" title="音视频"></a>音视频</h2><p><strong>简介：在前端实现音视频的播放、录制、编辑、直播、视频会议等功能</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">掌握HTML5的 &lt;video&gt; 和 &lt;audio&gt; 标签，以及相关的API；</span><br><span class="line">了解音视频编解码技术，如H.264、AAC等；</span><br><span class="line">熟悉音视频处理库，如FFmpeg、WebRTC等；</span><br><span class="line">掌握JavaScript的事件处理和异步编程，实现音视频的交互功能。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">音视频编解码技术复杂，需要掌握相关的标准和算法；</span><br><span class="line">浏览器兼容性问题多，不同浏览器对音视频的支持和表现不同；</span><br><span class="line">实时音视频流的传输和处理难度大，如网络延迟、丢包等问题。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：中等偏高，在线教育、视频会议、娱乐等领域对音视频功能的需求不断增长。</strong></p><p><strong>成熟性：比较成熟，HTML5的 <strong><video></strong> 和 <strong><audio></strong> 标签已得到广泛支持，相关的音视频处理库也较为完善。</strong></p><p><strong>可延展性：较好</strong></p><hr><h2 id="低代码"><a href="#低代码" class="headerlink" title="低代码"></a>低代码</h2><p><strong>简介：通过可视化界面和少量代码编写，快速构建应用程序的开发方式，旨在提高开发效率、降低技术门槛，使非专业开发人员也能参与开发。</strong></p><p><strong>技术平台：Jeecg-boot，宜搭</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">精通HTML、CSS、JavaScript基础技术；</span><br><span class="line">熟悉主流的低代码平台，如Jeecg-boot、宜搭等；</span><br><span class="line">相关的前端框架，如Vue、React等</span><br><span class="line">后端技术如Spring Boot、Node.js等</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">定制性受限，对于复杂业务逻辑和特殊需求难以满足；</span><br><span class="line">自动生成代码可能存在性能问题，如加载速度慢、响应不及时等；</span><br><span class="line">平台兼容性有待提高，不同低代码平台的组件和功能差异大。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：较高</strong></p><p><strong>成熟性：处于快速发展阶段，技术和功能不断完善，已有不少成熟的低代码平台，但仍存在一些局限性。</strong></p><p><strong>可延展性：较好，可与多种技术集成，如后端开发技术、数据分析工具等，拓展应用场景。</strong></p><hr><h2 id="Flow"><a href="#Flow" class="headerlink" title="Flow"></a>Flow</h2><p><strong>简介：通常用于处理前端页面中的布局和排版，实现元素的灵活排列和自适应，提高页面的布局效率和响应性。</strong></p><p><strong>技术平台：</strong></p><p><strong>技术栈</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">核心是CSS的Flex布局和Grid布局</span><br><span class="line">掌握Flex布局的属性如flex-direction、flex-wrap等，以及Grid布局的相关属性和概念。</span><br><span class="line">了解JavaScript的DOM操作，以便在需要动态调整布局时进行交互操作。</span><br></pre></td></tr></table></figure><p><strong>难点</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对CSS布局知识要求高，需深入理解Flex和Grid布局的原理和属性；</span><br><span class="line">在不同浏览器和设备上的兼容性处理复杂；</span><br><span class="line">动态布局调整时，JavaScript与CSS的交互逻辑较难把握。</span><br></pre></td></tr></table></figure><p><strong>市场需求度：中</strong></p><p><strong>成熟性：相对成熟，CSS的Flex和Grid布局已得到广泛支持，相关的布局库和框架也较为完善。</strong></p><p><strong>可延展性：一般，主要围绕页面布局和排版进行扩展，如与动画效果、交互组件等结合。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%B7%A5%E5%85%B7/%E7%BD%91%E9%A1%B5%E8%A7%86%E9%A2%91%E6%8D%95%E8%8E%B7%E5%B7%A5%E5%85%B7/"/>
      <url>/2025/03/08/%E5%B7%A5%E5%85%B7/%E7%BD%91%E9%A1%B5%E8%A7%86%E9%A2%91%E6%8D%95%E8%8E%B7%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<h1 id="网页视频捕获工具"><a href="#网页视频捕获工具" class="headerlink" title="网页视频捕获工具"></a>网页视频捕获工具</h1><h2 id="本地解析工具"><a href="#本地解析工具" class="headerlink" title="本地解析工具"></a>本地解析工具</h2><p><strong>基于Windows系统</strong></p><blockquote><p><a href="https://mkvtoolnix.download/downloads.html#windows">MKVToolNix Downloads – Matroska tools for Linux&#x2F;Unix and Windows</a></p></blockquote><p><strong>（当然网站里也有其他系统的工具，只是我没用用过）</strong></p><p>**下载后解压出来 **<code>MKVToolNix</code> 文件夹</p><p>**启动项是 **<code>mkvtoolnix-gui.exe</code></p><p><img src="/upload/image-20250128160924228.png" alt="image-20250128160924228.png"></p><h2 id="浏览器脚本"><a href="#浏览器脚本" class="headerlink" title="浏览器脚本"></a>浏览器脚本</h2><p><code>media-source-extract</code> 装到油猴里（文件放在最后了）</p><p><img src="/upload/image-20250128160910518.png" alt="image-20250128160910518.png"></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p><img src="/upload/image-20250128163554230.png" alt="image-20250128163554230.png"></p><h2 id="脚本文件"><a href="#脚本文件" class="headerlink" title="脚本文件"></a><em>脚本文件</em></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br></pre></td><td class="code"><pre><span class="line">// ==UserScript==</span><br><span class="line">// @name         media-source-extract</span><br><span class="line">// @namespace    https://github.com/Momo707577045/media-source-extract</span><br><span class="line">// @version      0.8.2</span><br><span class="line">// @description  https://github.com/Momo707577045/media-source-extract 配套插件</span><br><span class="line">// @author       Momo707577045</span><br><span class="line">// @include      *</span><br><span class="line">// @exclude      http://blog.luckly-mjw.cn/tool-show/media-source-extract/player/player.html</span><br><span class="line">// @downloadURL https://blog.luckly-mjw.cn/tool-show/media-source-extract/media-source-extract.user.js</span><br><span class="line">// @updateURL   https://blog.luckly-mjw.cn/tool-show/media-source-extract/media-source-extract.user.js</span><br><span class="line">// @grant        none</span><br><span class="line">// @run-at document-start</span><br><span class="line">// ==/UserScript==</span><br><span class="line"></span><br><span class="line">(function () &#123;</span><br><span class="line">  &#x27;use strict&#x27;;</span><br><span class="line">  (function () &#123;</span><br><span class="line">    if (document.getElementById(&#x27;media-source-extract&#x27;)) &#123;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 复写 call 函数，绕过劫持检查</span><br><span class="line">    Function.prototype.toString.call = function (caller) &#123;</span><br><span class="line">      return `&#x27;function $&#123;caller.name&#125;() &#123; [native code] &#125;&#x27;`</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 轮询监听 iframe 的加载</span><br><span class="line">    setInterval(() =&gt; &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        Array.prototype.forEach.call(document.getElementsByTagName(&#x27;iframe&#x27;), (iframe) =&gt; &#123;</span><br><span class="line">          // 若 iframe 使用了 sandbox 进行操作约束，删除原有 iframe，拷贝其备份，删除 sandbox 属性，重新载入</span><br><span class="line">          // 若 iframe 已载入，再修改 sandbox 属性，将修改无效。故通过新建 iframe 的方式绕过</span><br><span class="line">          if (iframe.hasAttribute(&#x27;sandbox&#x27;)) &#123;</span><br><span class="line">            const parentNode = iframe.parentNode;</span><br><span class="line">            const tempIframe = iframe.cloneNode()</span><br><span class="line">            tempIframe.removeAttribute(&quot;sandbox&quot;);</span><br><span class="line">            iframe.remove()</span><br><span class="line">            parentNode.appendChild(tempIframe);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, 1000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    let sumFragment = 0 // 已经捕获的所有片段数</span><br><span class="line">    let isClose = false // 是否关闭</span><br><span class="line">    let isStreamDownload = false // 是否使用流式下载</span><br><span class="line">    let _sourceBufferList = [] // 媒体轨道</span><br><span class="line">    const $showBtn = document.createElement(&#x27;div&#x27;) // 展示按钮</span><br><span class="line">    const $btnDownload = document.createElement(&#x27;div&#x27;) // 下载按钮</span><br><span class="line">    const $btnStreamDownload = document.createElement(&#x27;div&#x27;) // 流式下载按钮</span><br><span class="line">    const $downloadNum = document.createElement(&#x27;div&#x27;) // 已捕获视频片段数</span><br><span class="line">    const $tenRate = document.createElement(&#x27;div&#x27;) // 十倍速播放</span><br><span class="line">    const $closeBtn = document.createElement(&#x27;div&#x27;) // 关闭</span><br><span class="line">    const $container = document.createElement(&#x27;div&#x27;) // 容器</span><br><span class="line">    $closeBtn.innerHTML = `</span><br><span class="line">    &lt;img style=&quot;</span><br><span class="line">      padding-top: 4px;</span><br><span class="line">      width: 24px;</span><br><span class="line">      display: inline-block;</span><br><span class="line">      cursor: pointer;</span><br><span class="line">    &quot; src=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAAk1BMVEUAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////ROyVeAAAAMHRSTlMA1Sq7gPribxkJx6Ey8onMsq+GTe10QF8kqJl5WEcvIBDc0sHAkkk1FgO2ZZ+dj1FHfPqwAAACNElEQVRIx6VW6ZqqMAwtFlEW2Rm3EXEfdZa+/9PdBEvbIVXu9835oW1yjiQlTWQE/iYPuTObOTzMNz4bQFRlY2FgnFXRC/o01mytiafP+BPvQZk56bcLSOXem1jpCy4QgXvRtlEVCARfUP65RM/hp29/+0R7eSbhoHlnffZ8h76e6x1tyw9mxXaJ3nfTVLd89hQr9NfGceJxfLIXmONh6eNNYftNSESRmgkHlEOjmhgBbYcEW08FFQN/ro6dvAczjhgXEdQP76xHEYxM+igQq259gLrCSlwbD3iDtTMy+A4Yuk0B6zV8c+BcO2OgFIp/UvJdG4o/Rp1JQYXeZFflPEFMfvugiFGFXN587YtgX7C8lRGFXPCGGYCCzlkoxJ4xqmi/jrIcdYYh5pwxiwI/gt7lDDFrcLiMKhBJ//W78ENsJgVUsV8wKpjZBXshM6cCW0jbRAilICFxIpgGMmmiWGHSIR6ViY+DPFaqSJCbQ5mbxoZLIlU0Al/cBj6N1uXfFI0okLppi69StmumSFQRP6oIKDedFi3vRDn3j6KozCZlu0DdJb3AupJXNLmqkk9+X9FEHLt1Jq8oi1H5n01AtRlvwQZQl9hmtPY4JEjMDs5ftWJN4Xr4lLrV2OHiUDHCPgvA/Tn/hP4zGUBfjZ3eLJ+NIOfHxi8CMoAQtYfmw93v01O0e7VlqqcCsXML3Vsu94cxnb4c7ML5chG8JIP9b38dENGaj3+x+TpiA/AL/fen8In7H8l3ZjdJQt2TAAAAAElFTkSuQmCC&quot;&gt;`</span><br><span class="line">    $showBtn.innerHTML = `</span><br><span class="line">    &lt;img style=&quot;</span><br><span class="line">      padding-top: 4px;</span><br><span class="line">      width: 24px;</span><br><span class="line">      display: inline-block;</span><br><span class="line">      cursor: pointer;</span><br><span class="line">    &quot; src=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIBAMAAABfdrOtAAAAElBMVEUAAAD///////////////////8+Uq06AAAABXRSTlMA2kCAv5tF5NoAAAErSURBVHja7dzNasJAFIbhz8Tu7R0Eq/vQNHuxzL6YnPu/ldYpAUckxJ8zSnjfdTIPzHrOUawJdqmDJre1S/X7avigbM08kMgMSmt+iPWKbcwTsb3+KswXseOFLb2RnaTgjXTxtpwRq7XMgWz9kZ8cSKcwE6SX+SMGAgICAvJCyHdz2ud0pEx+/BpFaj2kEgQEBAQEBAQEBOT1kXWSkhbvk1vptOLs1LEWNrmVRgIBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBeTayTqpufogxduqM3q2AgICAgICAgICA3IOko4ZXkB/pqOHzhyZBQEBAQLIieVahtDNBDnrLgZT+yC4HUkmtN9JnWUiVZbVWliVhseCJdPqvCH5IV2tQNl4r6Bod+wWq9eeDik+xFQAAAABJRU5ErkJggg==&quot;&gt;`</span><br><span class="line"></span><br><span class="line">    // 十倍速播放</span><br><span class="line">    function _tenRatePlay() &#123;</span><br><span class="line">      let playbackRate = 10</span><br><span class="line">      if ($tenRate.innerHTML === &#x27;十倍速捕获&#x27;) &#123;</span><br><span class="line">        $tenRate.innerHTML = &#x27;恢复正常播放&#x27;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        playbackRate = 1</span><br><span class="line">        $tenRate.innerHTML = &#x27;十倍速捕获&#x27;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      let $domList = document.getElementsByTagName(&#x27;video&#x27;)</span><br><span class="line">      for (let i = 0, length = $domList.length; i &lt; length; i++) &#123;</span><br><span class="line">        const $dom = $domList[i]</span><br><span class="line">        $dom.playbackRate = playbackRate</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取顶部 window title，因可能存在跨域问题，故使用 try catch 进行保护</span><br><span class="line">    function getDocumentTitle() &#123;</span><br><span class="line">      let title = document.title;</span><br><span class="line">      try &#123;</span><br><span class="line">        title = window.top.document.title</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        console.log(error)</span><br><span class="line">      &#125;</span><br><span class="line">      return title</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 流式下载</span><br><span class="line">    function _streamDownload() &#123;</span><br><span class="line">      var _hmt = _hmt || [];</span><br><span class="line">      (function () &#123;</span><br><span class="line">        var hm = document.createElement(&quot;script&quot;);</span><br><span class="line">        hm.src = &quot;https://hm.baidu.com/hm.js?1f12b0865d866ae1b93514870d93ce89&quot;;</span><br><span class="line">        var s = document.getElementsByTagName(&quot;script&quot;)[0];</span><br><span class="line">        s.parentNode.insertBefore(hm, s);</span><br><span class="line">      &#125;)();</span><br><span class="line"></span><br><span class="line">      // 对应状态未下载结束的媒体轨道</span><br><span class="line">      const remainSourceBufferList = []</span><br><span class="line">      _sourceBufferList.forEach((target) =&gt; &#123;</span><br><span class="line">        // 对应的 MSE 状态为已下载完成状态</span><br><span class="line">        if (target.MSEInstance.readyState === &#x27;ended&#x27;) &#123;</span><br><span class="line">          target.streamWriter.close()</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          remainSourceBufferList.push(target)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      // 流式下载，释放已下载完成的媒体轨道，回收内存</span><br><span class="line">      _sourceBufferList = remainSourceBufferList</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 普通下载</span><br><span class="line">    function _download() &#123;</span><br><span class="line">      var _hmt = _hmt || [];</span><br><span class="line">      (function () &#123;</span><br><span class="line">        var hm = document.createElement(&quot;script&quot;);</span><br><span class="line">        hm.src = &quot;https://hm.baidu.com/hm.js?1f12b0865d866ae1b93514870d93ce89&quot;;</span><br><span class="line">        var s = document.getElementsByTagName(&quot;script&quot;)[0];</span><br><span class="line">        s.parentNode.insertBefore(hm, s);</span><br><span class="line">      &#125;)();</span><br><span class="line"></span><br><span class="line">      _sourceBufferList.forEach((target) =&gt; &#123;</span><br><span class="line">        const mime = target.mime.split(&#x27;;&#x27;)[0]</span><br><span class="line">        const type = mime.split(&#x27;/&#x27;)[1]</span><br><span class="line">        const fileBlob = new Blob(target.bufferList, &#123; type: mime &#125;) // 创建一个Blob对象，并设置文件的 MIME 类型</span><br><span class="line">        const a = document.createElement(&#x27;a&#x27;)</span><br><span class="line">        a.download = `$&#123;getDocumentTitle()&#125;.$&#123;type&#125;`</span><br><span class="line">        a.href = URL.createObjectURL(fileBlob)</span><br><span class="line">        a.style.display = &#x27;none&#x27;</span><br><span class="line">        document.body.appendChild(a)</span><br><span class="line">        // 禁止 click 事件冒泡，避免全局拦截</span><br><span class="line">        a.onclick = function (e) &#123;</span><br><span class="line">          e.stopPropagation();</span><br><span class="line">        &#125;</span><br><span class="line">        a.click()</span><br><span class="line">        a.remove()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 监听资源全部录取成功</span><br><span class="line">    let _endOfStream = window.MediaSource.prototype.endOfStream</span><br><span class="line">    window.MediaSource.prototype.endOfStream = function endOfStream() &#123;</span><br><span class="line">      if (isStreamDownload) &#123;</span><br><span class="line">        alert(&#x27;资源全部捕获成功，即将下载！&#x27;)</span><br><span class="line">        setTimeout(_streamDownload) // 等待 MediaSource 状态变更</span><br><span class="line">        _endOfStream.call(this)</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (confirm(&#x27;资源全部捕获成功，即将下载！&#x27;) == true) &#123;</span><br><span class="line">        _download()</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        // 不下载资源</span><br><span class="line">      &#125;</span><br><span class="line">      _endOfStream.call(this)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 录取资源</span><br><span class="line">    let _addSourceBuffer = window.MediaSource.prototype.addSourceBuffer</span><br><span class="line">    window.MediaSource.prototype.addSourceBuffer = function addSourceBuffer(mime) &#123;</span><br><span class="line">      _appendDom()</span><br><span class="line">      let sourceBuffer = _addSourceBuffer.call(this, mime)</span><br><span class="line">      let _append = sourceBuffer.appendBuffer</span><br><span class="line">      let bufferList = []</span><br><span class="line">      const _sourceBuffer = &#123;</span><br><span class="line">        mime,</span><br><span class="line">        bufferList,</span><br><span class="line">        MSEInstance: this,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 如果 streamSaver 已提前加载完成，则初始化对应的 streamWriter</span><br><span class="line">      try &#123;</span><br><span class="line">        if (window.streamSaver) &#123;</span><br><span class="line">          const type = mime.split(&#x27;;&#x27;)[0].split(&#x27;/&#x27;)[1]</span><br><span class="line">          _sourceBuffer.streamWriter = streamSaver.createWriteStream(`$&#123;getDocumentTitle()&#125;.$&#123;type&#125;`).getWriter()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        console.error(error)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      _sourceBufferList.push(_sourceBuffer)</span><br><span class="line">      sourceBuffer.appendBuffer = function (buffer) &#123;</span><br><span class="line">        sumFragment++</span><br><span class="line">        $downloadNum.innerHTML = `已捕获 $&#123;sumFragment&#125; 个片段`</span><br><span class="line"></span><br><span class="line">        if (isStreamDownload &amp;&amp; _sourceBuffer.streamWriter) &#123; // 流式下载</span><br><span class="line">          _sourceBuffer.streamWriter.write(new Uint8Array(buffer));</span><br><span class="line">        &#125; else &#123; // 普通 blob 下载</span><br><span class="line">          bufferList.push(buffer)</span><br><span class="line">        &#125;</span><br><span class="line">        _append.call(this, buffer)</span><br><span class="line">      &#125;</span><br><span class="line">      return sourceBuffer</span><br><span class="line">    &#125;</span><br><span class="line">    window.MediaSource.prototype.addSourceBuffer.toString = function toString() &#123;</span><br><span class="line">      return &#x27;function addSourceBuffer() &#123; [native code] &#125;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 添加操作的 dom</span><br><span class="line">    function _appendDom() &#123;</span><br><span class="line">      if (document.getElementById(&#x27;media-source-extract&#x27;)) &#123;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      $container.style = `</span><br><span class="line">      position: fixed;</span><br><span class="line">      top: 50px;</span><br><span class="line">      right: 50px;</span><br><span class="line">      text-align: right;</span><br><span class="line">      z-index: 9999;</span><br><span class="line">      `</span><br><span class="line">      const baseStyle = `</span><br><span class="line">      float:right;</span><br><span class="line">      clear:both;</span><br><span class="line">      margin-top: 10px;</span><br><span class="line">      padding: 0 20px;</span><br><span class="line">      color: white;</span><br><span class="line">      cursor: pointer;</span><br><span class="line">      font-size: 16px;</span><br><span class="line">      font-weight: bold;</span><br><span class="line">      line-height: 40px;</span><br><span class="line">      text-align: center;</span><br><span class="line">      border-radius: 4px;</span><br><span class="line">      background-color: #3498db;</span><br><span class="line">      box-shadow: 0 3px 6px 0 rgba(0, 0, 0, 0.3);</span><br><span class="line">    `</span><br><span class="line">      $tenRate.innerHTML = &#x27;十倍速捕获&#x27;</span><br><span class="line">      $downloadNum.innerHTML = &#x27;已捕获 0 个片段&#x27;</span><br><span class="line">      $btnStreamDownload.innerHTML = &#x27;特大视频下载，边下载边保存&#x27;</span><br><span class="line">      $btnDownload.innerHTML = &#x27;下载已捕获片段&#x27;</span><br><span class="line">      $btnDownload.id = &#x27;media-source-extract&#x27;</span><br><span class="line">      $tenRate.style = baseStyle</span><br><span class="line">      $downloadNum.style = baseStyle</span><br><span class="line">      $btnDownload.style = baseStyle</span><br><span class="line">      $btnStreamDownload.style = baseStyle</span><br><span class="line">      $btnStreamDownload.style.display = &#x27;none&#x27;</span><br><span class="line">      $showBtn.style = `</span><br><span class="line">      float:right;</span><br><span class="line">      clear:both;</span><br><span class="line">      display: none;</span><br><span class="line">      margin-top: 4px;</span><br><span class="line">      height: 34px;</span><br><span class="line">      width: 34px;</span><br><span class="line">      line-height: 34px;</span><br><span class="line">      text-align: center;</span><br><span class="line">      border-radius: 4px;</span><br><span class="line">      background-color: rgba(0, 0, 0, 0.5);</span><br><span class="line">      `</span><br><span class="line">      $closeBtn.style = `</span><br><span class="line">      float:right;</span><br><span class="line">      clear:both;</span><br><span class="line">      margin-top: 10px;</span><br><span class="line">      height: 34px;</span><br><span class="line">      width: 34px;</span><br><span class="line">      line-height: 34px;</span><br><span class="line">      text-align: center;</span><br><span class="line">      display: inline-block;</span><br><span class="line">      border-radius: 50%;</span><br><span class="line">      background-color: rgba(0, 0, 0, 0.5);</span><br><span class="line">      `</span><br><span class="line"></span><br><span class="line">      $btnDownload.addEventListener(&#x27;click&#x27;, _download)</span><br><span class="line">      $tenRate.addEventListener(&#x27;click&#x27;, _tenRatePlay)</span><br><span class="line"></span><br><span class="line">      // 关闭控制面板</span><br><span class="line">      $closeBtn.addEventListener(&#x27;click&#x27;, function () &#123;</span><br><span class="line">        $downloadNum.style.display = &#x27;none&#x27;</span><br><span class="line">        $btnStreamDownload.style.display = &#x27;none&#x27;</span><br><span class="line">        $btnDownload.style.display = &#x27;none&#x27;</span><br><span class="line">        $closeBtn.style.display = &#x27;none&#x27;</span><br><span class="line">        $tenRate.style.display = &#x27;none&#x27;</span><br><span class="line">        $showBtn.style.display = &#x27;inline-block&#x27;</span><br><span class="line">        isClose = true</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      // 显示控制面板</span><br><span class="line">      $showBtn.addEventListener(&#x27;click&#x27;, function () &#123;</span><br><span class="line">        if (!isStreamDownload) &#123;</span><br><span class="line">          $btnDownload.style.display = &#x27;inline-block&#x27;</span><br><span class="line">          $btnStreamDownload.style.display = &#x27;inline-block&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">        $downloadNum.style.display = &#x27;inline-block&#x27;</span><br><span class="line">        $closeBtn.style.display = &#x27;inline-block&#x27;</span><br><span class="line">        $tenRate.style.display = &#x27;inline-block&#x27;</span><br><span class="line">        $showBtn.style.display = &#x27;none&#x27;</span><br><span class="line">        isClose = false</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      // 启动流式下载</span><br><span class="line">      $btnStreamDownload.addEventListener(&#x27;click&#x27;, function () &#123;</span><br><span class="line">        (function () &#123;</span><br><span class="line">          var hm = document.createElement(&quot;script&quot;);</span><br><span class="line">          hm.src = &quot;https://hm.baidu.com/hm.js?1f12b0865d866ae1b93514870d93ce89&quot;;</span><br><span class="line">          var s = document.getElementsByTagName(&quot;script&quot;)[0];</span><br><span class="line">          s.parentNode.insertBefore(hm, s);</span><br><span class="line">        &#125;)();</span><br><span class="line">        isStreamDownload = true</span><br><span class="line">        $btnDownload.style.display = &#x27;none&#x27;</span><br><span class="line">        $btnStreamDownload.style.display = &#x27;none&#x27;</span><br><span class="line">        _sourceBufferList.forEach(sourceBuffer =&gt; &#123;</span><br><span class="line">          if (!sourceBuffer.streamWriter) &#123;</span><br><span class="line">            const type = sourceBuffer.mime.split(&#x27;;&#x27;)[0].split(&#x27;/&#x27;)[1]</span><br><span class="line">            sourceBuffer.streamWriter = streamSaver.createWriteStream(`$&#123;getDocumentTitle()&#125;.$&#123;type&#125;`).getWriter()</span><br><span class="line">            sourceBuffer.bufferList.forEach(buffer =&gt; &#123;</span><br><span class="line">              sourceBuffer.streamWriter.write(new Uint8Array(buffer));</span><br><span class="line">            &#125;)</span><br><span class="line">            sourceBuffer.bufferList = []</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      document.getElementsByTagName(&#x27;html&#x27;)[0].insertBefore($container, document.getElementsByTagName(&#x27;head&#x27;)[0]);</span><br><span class="line">      $container.appendChild($btnStreamDownload)</span><br><span class="line">      $container.appendChild($downloadNum)</span><br><span class="line">      $container.appendChild($btnDownload)</span><br><span class="line">      $container.appendChild($tenRate)</span><br><span class="line">      $container.appendChild($closeBtn)</span><br><span class="line">      $container.appendChild($showBtn)</span><br><span class="line"></span><br><span class="line">      // 加载 stream 流式下载器</span><br><span class="line">      try &#123;</span><br><span class="line">        let $streamSaver = document.createElement(&#x27;script&#x27;)</span><br><span class="line">        $streamSaver.src = &#x27;https://upyun.luckly-mjw.cn/lib/stream-saver.js&#x27;</span><br><span class="line">        document.body.appendChild($streamSaver);</span><br><span class="line">        $streamSaver.addEventListener(&#x27;load&#x27;, () =&gt; &#123;</span><br><span class="line">          $btnStreamDownload.style.display = &#x27;inline-block&#x27;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; catch (error) &#123;</span><br><span class="line">        console.error(error)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)()</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/Github/%E6%9B%B4%E6%94%B9%20GitHub%20%E7%94%A8%E6%88%B7%E5%90%8D%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/"/>
      <url>/2025/03/08/Github/%E6%9B%B4%E6%94%B9%20GitHub%20%E7%94%A8%E6%88%B7%E5%90%8D%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="更改-GitHub-用户名注意事项"><a href="#更改-GitHub-用户名注意事项" class="headerlink" title="更改 GitHub 用户名注意事项"></a><strong>更改 GitHub 用户名注意事项</strong></h1><h2 id="更改前须知"><a href="#更改前须知" class="headerlink" title="更改前须知"></a>更改前须知</h2><p><strong>首先，更改用户名不会删除仓库或提交历史。</strong></p><p>**旧用户名下的仓库 URL（如 ****<code>https://github.com/旧用户名/repo</code>）会 **自动重定向到新地址</p><p><em><strong>但</strong>：</em> &#x2F;&#x2F;&#x2F;<strong>重定向仅保留几个月，之后可能失效，建议尽快更新所有引用</strong>&#x2F;&#x2F;&#x2F;</p><p>****&#x2F;&#x2F;&#x2F;<strong>如果旧用户名被他人注册，重定向会失效</strong>&#x2F;&#x2F;&#x2F;</p><p>****&#x2F;&#x2F;&#x2F;<strong>依赖旧 URL 的服务（如 CI&#x2F;CD、书签）需手动更新</strong>&#x2F;&#x2F;&#x2F;</p><p><strong>注意</strong>：</p><ul><li><strong>确保本地仓库已与远程同步（</strong><code>git push</code>）。</li><li><strong>导出仓库列表（可选，用于后续检查）。</strong></li></ul><p><strong>检查依赖项</strong>：</p><ul><li><strong>第三方服务（如 CI&#x2F;CD、域名绑定、OAuth 登录）是否依赖你的旧用户名。</strong></li><li><strong>文档、README、外部链接中是否有直接引用旧用户名的 URL。</strong></li></ul><h2 id="更改用户名"><a href="#更改用户名" class="headerlink" title="更改用户名"></a><strong>更改用户名</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GitHub，Settings → Account → Change username</span><br></pre></td></tr></table></figure><h2 id="更改后"><a href="#更改后" class="headerlink" title="更改后"></a>更改后</h2><p><strong>所有本地仓库的远程 URL 需手动更新：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看当前远程 URL（格式为旧用户名）</span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line"># 更新远程 URL（替换为新用户名）</span><br><span class="line">git remote set-url origin https://github.com/新用户名/仓库名.git</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Github </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/Github/%E4%BF%9D%E5%A7%86%E7%BA%A7GitHub%E4%B8%BB%E9%A1%B5%E7%BE%8E%E5%8C%96%E6%95%99%E7%A8%8B/"/>
      <url>/2025/03/08/Github/%E4%BF%9D%E5%A7%86%E7%BA%A7GitHub%E4%B8%BB%E9%A1%B5%E7%BE%8E%E5%8C%96%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="保姆级GitHub主页美化教程"><a href="#保姆级GitHub主页美化教程" class="headerlink" title="保姆级GitHub主页美化教程"></a>保姆级GitHub主页美化教程</h1><p><img src="/upload/image-omub.png" alt="image-omub.png"></p><p><strong>实际上这些都存在一个README文件里</strong></p><p><strong>下面我们来一步一步建设你的GitHub主页</strong></p><h3 id="GitHub中的初始操作"><a href="#GitHub中的初始操作" class="headerlink" title="GitHub中的初始操作"></a>GitHub中的初始操作</h3><p><img src="/upload/image-20241109134411796.png" alt="image-20241109134411796.png"></p><p><img src="/upload/image-20250203234004362.png" alt="image-20250203234004362.png"></p><p>复制仓库地址</p><p><img src="/upload/image-isgp.png" alt="image-isgp.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">找一个你想要存储在本地的文件地址</span><br><span class="line">右键Open Git Bash here</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109140014319.png" alt="image-20241109140014319.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone +Paste把刚才复制的地址粘贴过来    回车</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109140335008.png" alt="image-20241109140335008.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tip:如果有报错很多情况是梯子不稳定，没有连接到git仓库，多关闭刷新反复试试</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109140636576.png" alt="image-20241109140636576.png"></p><h2 id="编译器"><a href="#编译器" class="headerlink" title="编译器"></a>编译器</h2><p><strong>这里拿VS Code示范</strong></p><h3 id="需要安装的插件"><a href="#需要安装的插件" class="headerlink" title="需要安装的插件"></a>需要安装的插件</h3><p><img src="/upload/image-20241109133836426.png" alt="image-20241109133836426.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下载完插件之后</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109134227028.png" alt="image-20241109134227028.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所编写的组件是按顺序排列的</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109135735804.png" alt="image-20241109135735804.png"></p><h4 id="代码结构详解"><a href="#代码结构详解" class="headerlink" title="代码结构详解"></a>代码结构详解</h4><p><img src="/upload/image-20241109141238195.png" alt="image-20241109141238195.png"></p><h4 id="一般格式模板"><a href="#一般格式模板" class="headerlink" title="一般格式模板"></a>一般格式模板</h4><p><strong>（可以先复制到自己的编译器里）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p align=&quot;center&quot;&gt;</span><br><span class="line">  &lt;img src=&quot;&quot; /&gt;</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下面我们来逐一实现组件的代码</span><br></pre></td></tr></table></figure><h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><h3 id="海浪效果边饰"><a href="#海浪效果边饰" class="headerlink" title="海浪效果边饰"></a>海浪效果边饰</h3><p><strong>网站</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://capsule-render.vercel.app/</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241108231511744.png" alt="image-20241108231511744.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">左侧选择完后</span><br><span class="line">点击右侧“Copy”</span><br><span class="line">复制到模板的“src”属性后</span><br></pre></td></tr></table></figure><p><strong>更多具体样式参考（研究ing。。。）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kyechan99/capsule-render?tab=readme-ov-file#color</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241108231452249.png" alt="image-20241108231452249.png"></p><h3 id="打字机动画"><a href="#打字机动画" class="headerlink" title="打字机动画"></a>打字机动画</h3><p><strong>网站</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://readme-typing-svg.demolab.com/demo/</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241108230812485.png" alt="image-20241108230812485.png"></p><h3 id="技术栈图标"><a href="#技术栈图标" class="headerlink" title="技术栈图标"></a>技术栈图标</h3><p><strong>网站（需要挂梯子）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://marwin1991.github.io/profile-technology-icons/</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241108225831578.png" alt="image-20241108225831578.png"></p><h3 id="贡献热度表"><a href="#贡献热度表" class="headerlink" title="贡献热度表"></a>贡献热度表</h3><p><strong>网站</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github-readme-streak-stats.herokuapp.com/demo/</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109150452284.png" alt="image-20241109150452284.png"></p><h3 id="卡片"><a href="#卡片" class="headerlink" title="卡片"></a>卡片</h3><p><strong>网站</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://tools.bugdesigner.cn/#/gen_card</span><br></pre></td></tr></table></figure><h4 id="个人指标模块"><a href="#个人指标模块" class="headerlink" title="个人指标模块"></a>个人指标模块</h4><p><img src="/upload/image-20241108231807726.png" alt="image-20241108231807726.png"></p><p><strong>更多主题</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/anuraghazra/github-readme-stats</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109142125669.png" alt="image-20241109142125669.png"></p><p>**主题修改详情见上文“**<strong>代码结构详解</strong>”</p><p><strong>还是卡片的那个网站</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://tools.bugdesigner.cn/#/gen_card</span><br></pre></td></tr></table></figure><h4 id="常用语言模块"><a href="#常用语言模块" class="headerlink" title="常用语言模块"></a>常用语言模块</h4><p><img src="/upload/image-20241109142657266.png" alt="image-20241109142657266.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注：复制代码需要保证username属性更改为自己的</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">theme属性可以自行添加，和个人指标模块可用的主题一致</span><br></pre></td></tr></table></figure><h4 id="仓库固定模块"><a href="#仓库固定模块" class="headerlink" title="仓库固定模块"></a>仓库固定模块</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">可将某些仓库固定在主页README展示</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109143412576.png" alt="image-20241109143412576.png"></p><p><img src="/upload/image-20241109143443105.png" alt="image-20241109143443105.png"></p><h4 id="WakaTime-统计卡"><a href="#WakaTime-统计卡" class="headerlink" title="WakaTime 统计卡"></a>WakaTime 统计卡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据以上操作，想必你已经收悉了大致流程，该WakaTime的部署方式与上述操作一致</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109143646929.png" alt="image-20241109143646929.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">详情以  https://capsule-render.vercel.app/ 大佬仓库为主</span><br></pre></td></tr></table></figure><h3 id="贪吃蛇"><a href="#贪吃蛇" class="headerlink" title="贪吃蛇"></a>贪吃蛇</h3><p><strong>参考视频：</strong><a href="https://www.bilibili.com/video/BV1W94y1v7cB/?spm_id_from=333.337.search-card.all.click">给Github主页加上贪吃蛇效果，让你的主页与众不同<em>哔哩哔哩</em>bilibili</a></p><p><strong>不太好配置，建议每一步都跟着来</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">创建main.yml文件</span><br><span class="line">文件路径:</span><br><span class="line">.github/workflows/main.yml</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109144506704.png" alt="image-20241109144506704.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将以下内容复制到main.yml文件中</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">name: generate animation</span><br><span class="line"></span><br><span class="line">on:</span><br><span class="line">  # run automatically every 24 hours</span><br><span class="line">  schedule:</span><br><span class="line">    - cron: &#x27;0 */24 * * *&#x27;</span><br><span class="line"></span><br><span class="line">  # allows to manually run the job at any time</span><br><span class="line">  workflow_dispatch:</span><br><span class="line"></span><br><span class="line">  # run on every push on the master branch</span><br><span class="line">  push:</span><br><span class="line">    branches:</span><br><span class="line">      - main</span><br><span class="line"></span><br><span class="line">jobs:</span><br><span class="line">  generate:</span><br><span class="line">    runs-on: ubuntu-latest</span><br><span class="line">    timeout-minutes: 10</span><br><span class="line"></span><br><span class="line">    steps:</span><br><span class="line">      # generates a snake game from a github user (&lt;github_user_name&gt;) contributions graph, output a svg animation at &lt;svg_out_path&gt;</span><br><span class="line">      - name: generate github-contribution-grid-snake.svg</span><br><span class="line">        uses: Platane/snk/svg-only@v3</span><br><span class="line">        with:</span><br><span class="line">          github_user_name: $&#123;&#123; github.repository_owner &#125;&#125;</span><br><span class="line">          outputs: |</span><br><span class="line">            dist/github-contribution-grid-snake.svg</span><br><span class="line">            dist/github-contribution-grid-snake-dark.svg?palette=github-dark</span><br><span class="line">        env:</span><br><span class="line">          GITHUB_TOKEN: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span><br><span class="line"></span><br><span class="line">      # push the content of &lt;build_dir&gt; to a branch</span><br><span class="line">      # the content will be available at https://raw.githubusercontent.com/&lt;github_user&gt;/&lt;repository&gt;/&lt;target_branch&gt;/&lt;file&gt; , or as github page</span><br><span class="line">      - name: push github-contribution-grid-snake.svg to the output branch</span><br><span class="line">        uses: crazy-max/ghaction-github-pages@v3.1.0</span><br><span class="line">        with:</span><br><span class="line">          target_branch: output</span><br><span class="line">          build_dir: dist</span><br><span class="line">        env:</span><br><span class="line">          GITHUB_TOKEN: $&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>README.md贪吃蛇代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意更改用户名</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;picture&gt;</span><br><span class="line">  &lt;source media=&quot;(prefers-color-scheme: dark)&quot; srcset=&quot;https://raw.githubusercontent.com/用户名/用户名/output/github-contribution-grid-snake-dark.svg&quot;&gt;</span><br><span class="line">  &lt;source media=&quot;(prefers-color-scheme: light)&quot; srcset=&quot;https://raw.githubusercontent.com/用户名/用户名/output/github-contribution-grid-snake.svg&quot;&gt;</span><br><span class="line">  &lt;img alt=&quot;github contribution grid snake animation&quot; src=&quot;https://raw.githubusercontent.com/用户名/用户名/output/github-contribution-grid-snake.svg&quot;&gt;</span><br><span class="line">&lt;/picture&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">此时你的预览中看不见贪吃蛇的组件，这是正常现象，我们接着下一步走</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">提交你的本地代码到GitHub仓库，详情见下文“提交本地代码至GitHub”</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">main.yml文件的本质会创建一个output分支并推送代码，但是执行此操作GitHub需要配置一定的权限</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109145536992.png" alt="image-20241109145536992.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">以上方法授予工作流读写权限后</span><br><span class="line">到Action目录，点击Re-run jobs的Re-run，重新执行失败的任务</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109145648691.png" alt="image-20241109145648691.png"></p><p><strong>等待三五分钟之后即可完成贪吃蛇的部署</strong></p><h2 id="提交本地代码至GitHub"><a href="#提交本地代码至GitHub" class="headerlink" title="提交本地代码至GitHub"></a>提交本地代码至GitHub</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">提一嘴Open Git Bash here的地址</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241109143924621.png" alt="image-20241109143924621.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">依次执行(对空格和英文双引号有严格要求)</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;init&quot;</span><br><span class="line">git push</span><br></pre></td></tr></table></figure><h2 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h2><p><strong>到此所有步骤就结束啦，还有一些没提到的组件网站放在这里，大家感兴趣的可以尝试尝试</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://shields.io/</span><br><span class="line">https://quira.sh/</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Github </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/Github/%E6%96%B0%E7%89%88git%E6%8E%A8%E9%80%81%E6%B3%A8%E6%84%8F%E7%82%B9/"/>
      <url>/2025/03/08/Github/%E6%96%B0%E7%89%88git%E6%8E%A8%E9%80%81%E6%B3%A8%E6%84%8F%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="新版git推送注意点"><a href="#新版git推送注意点" class="headerlink" title="新版git推送注意点"></a>新版git推送注意点</h1><p><strong>一切的开始</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure><p><strong>旧版本Git指令会默认创建一个本地的master分支</strong></p><p><img src="/upload/image-20250128151124085.png" alt="image-20250128151124085.png"></p><p><strong>我是win 2.42版本</strong></p><p><img src="/upload/image-20250128151406928.png" alt="image-20250128151406928.png"></p><p><strong>但是</strong></p><p><strong>在较新的GitHub的新仓库中，默认的初始分支名称已经从master变更为main</strong></p><p><strong>如果我们直接一套推送上去会直接推送到远程仓库，会直接推送到远程的master分支上，而当前默认的主分支main上没有东西</strong></p><p><strong>然后我去尝试了一下更新Git版本</strong></p><blockquote><p><strong>访问</strong><a href="https://gitforwindows.org/?spm=5176.28103460.0.0.65235d27rZxmXv">Git for Windows</a>官方网站，安装最新版Git 2.47</p></blockquote><p><strong>然后我发现git init还是默认master分支</strong></p><p><strong>最后还是先养成习惯</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init -b main</span><br></pre></td></tr></table></figure><p><strong>切到指定分支创建</strong></p><p><strong>接下来</strong></p><p><strong>连接远程</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin 仓库地址</span><br></pre></td></tr></table></figure><p><strong>推送三件套</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;注释&quot;</span><br><span class="line">git push -u origin main</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Github </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/Github/git%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/"/>
      <url>/2025/03/08/Github/git%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="git"><a href="#git" class="headerlink" title="git"></a>git</h1><h2 id="git-的运行机制"><a href="#git-的运行机制" class="headerlink" title="git 的运行机制"></a>git 的运行机制</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git分为本地仓库和远程仓库，我们一般情况都是写完代码，commit到本地仓库（生成本地仓的commit ID，代表当前提交代码的版本号），然后push到远程仓库（记录这个版本号）</span><br></pre></td></tr></table></figure><h2 id="git-config-配置"><a href="#git-config-配置" class="headerlink" title="git config(配置)"></a>git config(配置)</h2><p><strong>一个系统只需要配置一次</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;chen&quot;</span><br><span class="line">git config --global user.email &quot;xxx@qq.com&quot;</span><br></pre></td></tr></table></figure><h2 id="文件的状态"><a href="#文件的状态" class="headerlink" title="文件的状态"></a>文件的状态</h2><h4 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure><h5 id="未跟踪"><a href="#未跟踪" class="headerlink" title="未跟踪"></a>未跟踪</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//add .前</span><br></pre></td></tr></table></figure><h5 id="已跟踪"><a href="#已跟踪" class="headerlink" title="已跟踪"></a>已跟踪</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">staged      //暂缓区中的文件状态,也就是index</span><br><span class="line">Unmodified  //commit命令，可以将staged中文件提交到Git仓库</span><br><span class="line">Modified    //修改了某个文件后，会处于Modified状态;</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20240709164956512.png" alt="image-20240709164956512.png"></p><h2 id="SSH密钥"><a href="#SSH密钥" class="headerlink" title="SSH密钥"></a>SSH密钥</h2><p><img src="/upload/image-20240709215925092.png" alt="image-20240709215925092.png"></p><h2 id="获取git仓库"><a href="#获取git仓库" class="headerlink" title="获取git仓库"></a>获取git仓库</h2><h4 id="操作流程图"><a href="#操作流程图" class="headerlink" title="操作流程图"></a>操作流程图</h4><p><img src="/upload/image-20240709165543658.png" alt="image-20240709165543658.png"></p><p><strong>git上创建新仓库</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">界面右上角&quot;+&quot;</span><br><span class="line"></span><br><span class="line">New repository</span><br><span class="line"></span><br><span class="line">仓库名字加描述</span><br><span class="line"></span><br><span class="line">Create repository</span><br></pre></td></tr></table></figure><p><strong>建立本地仓库</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">文件根目录右键:Git Bash</span><br><span class="line"></span><br><span class="line">依次执行以下指令</span><br><span class="line">git init</span><br><span class="line">git add .   //跟踪本地文件,文件存入暂存区</span><br><span class="line">git commit -m &quot;注释&quot;</span><br></pre></td></tr></table></figure><p><strong>关联github仓库</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">到github仓库复制仓库地址</span><br></pre></td></tr></table></figure><p><img src="file:///E:/%E5%9B%BE%E8%A7%A3/github%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80(%E6%8B%9F).webp?lastModify=1724233487"></p><p><img src="/upload/github%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80(%E6%8B%9F).webp" alt="github仓库地址(拟).webp"></p><p><strong>执行指令</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin ...(个人新建仓库地址)</span><br></pre></td></tr></table></figure><p><strong>上传本地代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><p><strong>上传完成</strong></p><p><strong>(如果出现Are you sure you want to continue connecting (yes&#x2F;no)?)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yes</span><br></pre></td></tr></table></figure><h4 id="更新仓库"><a href="#更新仓库" class="headerlink" title="更新仓库"></a>更新仓库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;注释&quot;</span><br><span class="line">git push 仓库地址 master</span><br></pre></td></tr></table></figure><h4 id="克隆仓库"><a href="#克隆仓库" class="headerlink" title="克隆仓库"></a>克隆仓库</h4><p><strong>Code按钮里复制仓库地址</strong></p><p><strong>桌面新建文件夹</strong></p><p><strong>文件夹里开GitBash</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git clone 地址</span><br></pre></td></tr></table></figure><h4 id="日志和版本回退"><a href="#日志和版本回退" class="headerlink" title="日志和版本回退"></a>日志和版本回退</h4><p><strong>校验和</strong>(SHA-1散列,哈希)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//每次提交的唯一id</span><br><span class="line">//由40 个十六进制字符(0-9 和 a-f)组成的字符串，基于 Git 中文件的内容或目录结构计算出来</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20240709181505915.png" alt="image-20240709181505915.png"></p><p><strong>日志</strong> (历史版本记录)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git log     //按空格可以继续往下查看</span><br><span class="line">或</span><br><span class="line">//简洁版</span><br><span class="line">git log --pretty=on</span><br><span class="line">git reflog</span><br></pre></td></tr></table></figure><p><strong>回退</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD^      //回退上个版本</span><br><span class="line">git reset --hard HEAD^^     //回退上上个版本</span><br><span class="line">git reset --hard HEAD~100   //回退上100个版本</span><br><span class="line">git reset --hard 2xwjh73e   //回退到指定commid id(可以只写前7位)</span><br></pre></td></tr></table></figure><h2 id="建立远程仓库连接"><a href="#建立远程仓库连接" class="headerlink" title="建立远程仓库连接"></a>建立远程仓库连接</h2><p><strong>连接</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin 仓库地址</span><br></pre></td></tr></table></figure><p><strong>查看连接</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote</span><br><span class="line">git remote -v</span><br></pre></td></tr></table></figure><h4 id="分支"><a href="#分支" class="headerlink" title="分支"></a><strong>分支</strong></h4><p><img src="/upload/image-20240712211441114.png" alt="image-20240712211441114.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">master  //主线</span><br><span class="line">dev     //开发</span><br><span class="line">release //预发布</span><br><span class="line">hotfix  //线上bug修复</span><br><span class="line">feature </span><br></pre></td></tr></table></figure><p><strong>操作</strong></p><p><img src="/upload/image-20240712211630760.png" alt="image-20240712211630760.png"></p><p><strong>顺序</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">创建分支-&gt;修改文件-&gt;修改后的文件提交到dev中</span><br></pre></td></tr></table></figure><p><strong>创建分支</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init -b dev         //创建新分支,会切换到新分支</span><br><span class="line">git branch &lt;新分支名称&gt;   //创建新分支</span><br></pre></td></tr></table></figure><p><strong>切换分支</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout &lt;新分支&gt;</span><br></pre></td></tr></table></figure><p><strong>创建并切换分支</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b &lt;新分支&gt;</span><br></pre></td></tr></table></figure><p><strong>分支重命名</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -m &lt;旧分支&gt; &lt;新分支&gt;</span><br></pre></td></tr></table></figure><p><strong>删除分支(谨慎)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch -d &lt;分支&gt;  //删除已合并过的分支</span><br><span class="line">git branch -D &lt;分支&gt;  //强制删除分支</span><br></pre></td></tr></table></figure><p><strong>查看版本库有哪些分支</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure><p><strong>查看版本库状态</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line">//没有提交就git add .</span><br></pre></td></tr></table></figure><p><strong>合并到当前分支</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge &lt;需要被合并的分支&gt;</span><br></pre></td></tr></table></figure><p><strong>从指定远程仓库获取</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull origin master(可换) </span><br></pre></td></tr></table></figure><p><strong>如果想直接执行git fetch</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//先给当前分支设置一个跟踪分支</span><br><span class="line">git branch --set-upstream-to=origin/master</span><br><span class="line">git pull</span><br></pre></td></tr></table></figure><p><strong>创建一个分支来跟踪远程分支</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch --track dev origin/master</span><br></pre></td></tr></table></figure><h4 id="fork与PR"><a href="#fork与PR" class="headerlink" title="fork与PR"></a>fork与PR</h4><p><strong>PR</strong> : <em>pull request</em> <em>拉取请求</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">先fork把别人的项目复制到自己的远程仓库里</span><br><span class="line">&lt;&gt;Code获得仓库的地址</span><br><span class="line">电脑创建文件夹,Git Bash打开</span><br><span class="line">git clone &lt;地址&gt;</span><br></pre></td></tr></table></figure><p><strong>查看文件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git ststus</span><br></pre></td></tr></table></figure><p><strong>提交</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;注释&quot;</span><br><span class="line">git push</span><br></pre></td></tr></table></figure><p><strong>合并请求(PR)</strong></p><p><img src="/upload/image-20240712221944550.png" alt="image-20240712221944550.png"></p>]]></content>
      
      
      <categories>
          
          <category> Github </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/Github/GitHub%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA/"/>
      <url>/2025/03/08/Github/GitHub%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="GitHub自动化构建"><a href="#GitHub自动化构建" class="headerlink" title="GitHub自动化构建"></a>GitHub自动化构建</h1><p><strong>通过 GitHub Actions 实现「提交代码 → 自动构建 → 生成 Releases」</strong></p><p><strong>实现步骤</strong></p><blockquote><p>**在本地仓库中创建 **<code>.github/workflows/build.yml</code></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">name: Build and Release</span><br><span class="line"></span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">    tags: </span><br><span class="line">      - &#x27;v*&#x27; # 当打 tag 时触发</span><br><span class="line"></span><br><span class="line">jobs:</span><br><span class="line">  build:</span><br><span class="line">    runs-on: windows-latest</span><br><span class="line"></span><br><span class="line">    steps:</span><br><span class="line">    - uses: actions/checkout@v4</span><br><span class="line"></span><br><span class="line">    - name: Install Node.js</span><br><span class="line">      uses: actions/setup-node@v3</span><br><span class="line">      with:</span><br><span class="line">        node-version: 20</span><br><span class="line"></span><br><span class="line">    - name: Install PNPM</span><br><span class="line">      run: npm install -g pnpm</span><br><span class="line"></span><br><span class="line">    - name: Install Dependencies</span><br><span class="line">      run: pnpm install</span><br><span class="line"></span><br><span class="line">    - name: Build Project</span><br><span class="line">      run: pnpm run build</span><br><span class="line"></span><br><span class="line">    - name: Create Release</span><br><span class="line">      uses: softprops/action-gh-release@v1</span><br><span class="line">      with:</span><br><span class="line">        files: release/*.exe</span><br></pre></td></tr></table></figure><blockquote><p><strong>触发方式</strong>：当你在本地打标签（如 <code>git tag v1.0.0</code>）并推送时，自动构建并发布 Release</p></blockquote><h2 id="远程仓库配置"><a href="#远程仓库配置" class="headerlink" title="远程仓库配置"></a>远程仓库配置</h2><blockquote><p><strong>GitHub -&gt; 你的仓库 -&gt; Settions -&gt; Actions -&gt; General -&gt; 选择Read and write permissions（工作流权限）</strong></p></blockquote><h2 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h2><p><strong>如果你第一次推送代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init -b main</span><br></pre></td></tr></table></figure><p><strong>连接远程</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin 仓库地址</span><br></pre></td></tr></table></figure><p><strong>推送代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;注释&quot;</span><br><span class="line">git push -u origin main</span><br></pre></td></tr></table></figure><p><strong>推送标签（也要搞）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 创建标签（版本号格式推荐 vX.Y.Z）</span><br><span class="line">git tag -a v1.0.0 -m &quot;Release version 1.0.0&quot;</span><br><span class="line">git push origin v1.0.0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Github </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%8D%9A%E5%AE%A2/%E5%8D%9A%E5%AE%A2%E9%9F%B3%E4%B9%90%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0/"/>
      <url>/2025/03/08/%E5%8D%9A%E5%AE%A2/%E5%8D%9A%E5%AE%A2%E9%9F%B3%E4%B9%90%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="博客音乐组件实现"><a href="#博客音乐组件实现" class="headerlink" title="博客音乐组件实现"></a>博客音乐组件实现</h1><p><strong>详情移步 | 安知鱼 | 大佬的博客文章</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.anheyu.com/posts/a76e.html</span><br></pre></td></tr></table></figure><h2 id="一图流"><a href="#一图流" class="headerlink" title="一图流"></a>一图流</h2><p><img src="/upload/image-20250131180643649.png" alt="image-20250131180643649.png"></p><h2 id="开放式公益API"><a href="#开放式公益API" class="headerlink" title="开放式公益API"></a>开放式公益API</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.injahow.cn/meting/?server=:server&amp;type=:type&amp;id=:id&amp;auth=:auth&amp;r=:r</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://meting.qjqq.cn/?server=:server&amp;type=:type&amp;id=:id&amp;auth=:auth&amp;r=:r</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 博客 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/varletconst%E5%8C%BA%E5%88%86/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/varletconst%E5%8C%BA%E5%88%86/</url>
      
        <content type="html"><![CDATA[<h1 id="var-let-const区分"><a href="#var-let-const区分" class="headerlink" title="var&#x2F;let&#x2F;const区分"></a>var&#x2F;let&#x2F;const区分</h1><h5 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h5><p><strong>var 和 let 的作用域规则一样</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">函数外，是全局执行上下文，函数里，是当前函数执行上下文。//声明的变量的作用域只能是全局或者整个函数块的。</span><br></pre></td></tr></table></figure><h5 id="重复声明"><a href="#重复声明" class="headerlink" title="重复声明"></a>重复声明</h5><p><strong>var 允许，let&#x2F;const不允许</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function test() &#123;</span><br><span class="line">  var a = 3;</span><br><span class="line">  var a = 4;</span><br><span class="line">  console.log(a) // 4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>let是块级作用域</strong></p><p><strong>const只能在声明它们的块级作用域中访问</strong></p><p><strong>const&#x2F;let在块级作用域外无法访问内部变量！</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if(true)&#123;</span><br><span class="line">    const a=1;</span><br><span class="line">&#125;</span><br><span class="line">console.log(a)</span><br></pre></td></tr></table></figure><h5 id="绑定全局变量"><a href="#绑定全局变量" class="headerlink" title="绑定全局变量"></a>绑定全局变量</h5><p><strong>在全局环境声明变量，var会在全局对象里新建一个属性，let&#x2F;const不会</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var foo = &#x27;global&#x27;</span><br><span class="line">let bar = &#x27;global&#x27;</span><br><span class="line"></span><br><span class="line">console.log(this.foo) // global</span><br><span class="line">console.log(this.bar) // undefined</span><br></pre></td></tr></table></figure><p><strong>此时let定义的变量实际在test 函数的作用域链上</strong></p><p><img src="/upload/image-20241104212220166.png" alt="image-20241104212220166.png"></p><h5 id="变量提升与暂存死区"><a href="#变量提升与暂存死区" class="headerlink" title="变量提升与暂存死区"></a><strong>变量提升与暂存死区</strong></h5><p><img src="/upload/image-20241104223204685.png" alt="image-20241104223204685.png"></p><p><strong>上述代码的例子中</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var例子就是变量提升，const/let的报错就是暂时性死区</span><br></pre></td></tr></table></figure><p><strong>代码的执行原理</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">创建-&gt;初始化-&gt;赋值</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var 声明的变量在执行上下文创建阶段就会被「创建」和「初始化」，因此对于执行阶段来说，可以在声明之前使用。</span><br><span class="line">let 声明的变量在执行上下文创建阶段只会被「创建」而不会被「初始化」，因此对于执行阶段来说，如果在其定义执行前使用，相当于使用了未被初始化的变量，会报错。</span><br></pre></td></tr></table></figure><p><strong>let 与 const 异同</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">唯一区别就在于 const 声明的是一个只读变量，声明之后不允许改变其值。</span><br><span class="line">因此，const 一旦声明必须初始化，否则会报错。</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/TS%E5%9F%BA%E7%A1%80/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/TS%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="TS"><a href="#TS" class="headerlink" title="TS"></a>TS</h1><h3 id="类型（interface）"><a href="#类型（interface）" class="headerlink" title="类型（interface）"></a>类型（interface）</h3><h5 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let a: string //变量a只能存储字符串</span><br><span class="line">let b: number //变量a只能存储数值</span><br><span class="line">let c: boolean //变量a只能存储布尔值</span><br><span class="line">// 参数x必须是数字，参数y也必须是数字，函数返回值也必须是数字</span><br><span class="line">function demo(x:number,y:number):number&#123;</span><br><span class="line"> return x + y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">string 、 number 、 boolean 、 null 、 undefined 、 bigint 、 symbol 、 object(Array 、Function 、Date ......)</span><br><span class="line">(新)</span><br><span class="line">void 、 never 、 unknown 、 any 、 enum 、 tuple</span><br><span class="line">(自定义)</span><br><span class="line">type 、 interface</span><br></pre></td></tr></table></figure><h3 id="常用类型"><a href="#常用类型" class="headerlink" title="常用类型"></a>常用类型</h3><h5 id="字面量"><a href="#字面量" class="headerlink" title="字面量"></a>字面量</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">值只能是字⾯量值 （值本身）</span><br></pre></td></tr></table></figure><h5 id="any"><a href="#any" class="headerlink" title="any"></a>any</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//显式的any</span><br><span class="line">let a: any</span><br><span class="line">a = 100</span><br><span class="line">a = &#x27;你好&#x27;</span><br><span class="line">a = false</span><br><span class="line"></span><br><span class="line">//隐式的any</span><br><span class="line">let b</span><br><span class="line">b = 100</span><br><span class="line">b = &#x27;你好&#x27;</span><br><span class="line">b = false</span><br><span class="line"></span><br><span class="line">let a</span><br><span class="line">let x: string</span><br><span class="line">x = a // ⽆警告</span><br></pre></td></tr></table></figure><h5 id="unknown"><a href="#unknown" class="headerlink" title="unknown"></a>unknown</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//适⽤于：开始不知道数据的具体类型，后期才能确定数据的类型</span><br><span class="line">let a: unknown</span><br><span class="line">a = 100</span><br><span class="line">a = false</span><br><span class="line">a = &#x27;你好&#x27;</span><br><span class="line"></span><br><span class="line">let x: string</span><br><span class="line">x = a // 警告：不能将“unknown”分配给“string</span><br></pre></td></tr></table></figure><h5 id="never"><a href="#never" class="headerlink" title="never"></a>never</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">let a: never</span><br><span class="line">// 警告</span><br><span class="line">a = 1</span><br><span class="line">a = true</span><br><span class="line">a = undefined</span><br><span class="line">a = null</span><br><span class="line"></span><br><span class="line">//ts可主动推断</span><br><span class="line">if(typeof a === &#x27;string&#x27;)&#123;</span><br><span class="line"> a.toUpperCase()</span><br><span class="line">&#125;else&#123;</span><br><span class="line"> console.log(a) // 推断出此处为never</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//适⽤于：限制函数的返回值</span><br><span class="line">// 限制demo函数不需要有任何返回值，任何值都不⾏，像undeifned、null都不⾏</span><br><span class="line">function demo():never&#123;</span><br><span class="line"> throw new Error(&#x27;程序异常退出&#x27;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="void"><a href="#void" class="headerlink" title="void"></a>void</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//适⽤于：限制函数的返回值</span><br><span class="line">let a:void = undefined</span><br><span class="line">// ⽆警告</span><br><span class="line">function demo1():void&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">// ⽆警告</span><br><span class="line">function demo2():void&#123;</span><br><span class="line"> return</span><br><span class="line">&#125;</span><br><span class="line">// ⽆警告</span><br><span class="line">function demo3():void&#123;</span><br><span class="line"> return undefined</span><br><span class="line">&#125;</span><br><span class="line">// 有警告：不能将类型“number”分配给类型“void”</span><br><span class="line">function demo4():void&#123;</span><br><span class="line"> return 666</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="object（不常用）"><a href="#object（不常用）" class="headerlink" title="object（不常用）"></a>object（不常用）</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">let a:object //a的值可以是任何【⾮原始值类型】，包括：对象、函数、数组等</span><br><span class="line"></span><br><span class="line">// 【⾮原始类型】⽆警告</span><br><span class="line">a = &#123;&#125;</span><br><span class="line">a = &#123;name:&#x27;张三&#x27;&#125;</span><br><span class="line">a = [1,3,5,7,9]</span><br><span class="line">a = function()&#123;&#125;</span><br><span class="line"></span><br><span class="line">// 【原始类型】有警告</span><br><span class="line">a = null // 警告：不能将类型“null”分配给类型“object”</span><br><span class="line">a = undefined // 警告：不能将类型“undefined”分配给类型“object”</span><br><span class="line">a = 1 // 警告：不能将类型“number”分配给类型“object”</span><br><span class="line">a = true // 警告：不能将类型“boolean”分配给类型“object”</span><br><span class="line">a = &#x27;你好&#x27; // 警告：不能将类型“string”分配给类型“object</span><br></pre></td></tr></table></figure><h6 id="限制类型写法"><a href="#限制类型写法" class="headerlink" title="限制类型写法"></a>限制类型写法</h6><p><strong>对象</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let person: &#123; name: string, age?: number&#125; //问号代表可选属性</span><br><span class="line">let car: &#123; price: number; color: string; [k:string]:any&#125;</span><br><span class="line">let student: &#123;</span><br><span class="line"> id: string</span><br><span class="line"> grade:number</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">person = &#123;name:&#x27;张三&#x27;,age:18&#125;</span><br><span class="line">person = &#123;name:&#x27;李四&#x27;&#125;</span><br><span class="line">car = &#123;price:100,color:&#x27;红⾊&#x27;&#125;</span><br><span class="line">student = &#123;id:&#x27;tetqw76te01&#x27;,grade:3&#125;</span><br></pre></td></tr></table></figure><p><strong>函数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let demo: (a: number, b: number) =&gt; number</span><br><span class="line">demo = function(x,y) &#123;</span><br><span class="line"> return x+y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>数组</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let arr1: string[] // 该⾏代码等价于： let arr1: Array&lt;string&gt;</span><br><span class="line">let arr2: number[] // 该⾏代码等价于： let arr2: Array&lt;number&gt;</span><br><span class="line">arr1 = [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]</span><br><span class="line">arr2 = [1,3,5,7,9]</span><br></pre></td></tr></table></figure><h5 id="tuple"><a href="#tuple" class="headerlink" title="tuple"></a>tuple</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//长短固定的数组</span><br><span class="line">let t: [string,number]</span><br><span class="line">t = [&#x27;hello&#x27;,123]</span><br><span class="line">// 警告，不能将类型“[string, number, boolean]”分配给类型“[string, number]”</span><br><span class="line">t = [&#x27;hello&#x27;,123,false]</span><br></pre></td></tr></table></figure><h5 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//枚举</span><br><span class="line">// 定义⼀个枚举</span><br><span class="line">enum Color &#123;</span><br><span class="line"> Red,</span><br><span class="line"> Blue,</span><br><span class="line"> Black,</span><br><span class="line"> Gold</span><br><span class="line">&#125;</span><br><span class="line">// 定义⼀个枚举，并指定其初识数值</span><br><span class="line">enum Color2 &#123;</span><br><span class="line"> Red = 6,</span><br><span class="line"> Blue,</span><br><span class="line"> Black,</span><br><span class="line"> Gold</span><br><span class="line">&#125;</span><br><span class="line">console.log(Color)</span><br><span class="line">/*</span><br><span class="line"> &#123;</span><br><span class="line">     0: &#x27;Red&#x27;, 1: &#x27;Blue&#x27;, 2: &#x27;Black&#x27;, 3: &#x27;Gold&#x27;,</span><br><span class="line">     Red: 0, Blue: 1, Black: 2, Gold: 3</span><br><span class="line"> &#125;</span><br><span class="line">*/</span><br><span class="line">console.log(Color2)</span><br><span class="line">/*</span><br><span class="line"> &#123;</span><br><span class="line">     6: &#x27;Red&#x27;,  7: &#x27;Blue&#x27;, 8: &#x27;Black&#x27;, 9: &#x27;Gold&#x27;,</span><br><span class="line">     Red: 6, Blue: 7, Black: 8, Gold: 9</span><br><span class="line"> &#125;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><p><strong>实例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 定义⼀个phone变量，并设置对⻬进⾏限制</span><br><span class="line">let phone: &#123;name:string,price:number,color:Color&#125;</span><br><span class="line"></span><br><span class="line">phone = &#123;name:&#x27;华为Mate60&#x27;,price:6500,color:Color.Red&#125;</span><br><span class="line">phone = &#123;name:&#x27;iPhone15Pro&#x27;,price:7999,color:Color.Blue&#125;</span><br><span class="line"></span><br><span class="line">if(phone.color === Color.Red)&#123;</span><br><span class="line"> console.log(&#x27;⼿机是红⾊的&#x27;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义类"><a href="#自定义类" class="headerlink" title="自定义类"></a>自定义类</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 性别的枚举</span><br><span class="line">enum Gender &#123;</span><br><span class="line"> Male,</span><br><span class="line"> Female</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ⾃定义⼀个年级类型（⾼⼀、⾼⼆、⾼三）</span><br><span class="line">type Grade = 1 | 2 | 3</span><br><span class="line"></span><br><span class="line">// ⾃定义⼀个学⽣类型</span><br><span class="line">type Student = &#123;</span><br><span class="line"> name:string,</span><br><span class="line"> age:number,</span><br><span class="line"> gender:Gender,</span><br><span class="line"> grade:Grade</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 定义两个学⽣变量：s1、s2</span><br><span class="line">let s1:Student</span><br><span class="line">let s2:Student</span><br><span class="line"></span><br><span class="line">s1 = &#123;name:&#x27;张三&#x27;,age:18,gender:Gender.Male,grade:1&#125;</span><br><span class="line">s2 = &#123;name:&#x27;李四&#x27;,age:18,gender:Gender.Female,grade:2&#125;</span><br></pre></td></tr></table></figure><h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p><strong>常规类</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Person &#123;</span><br><span class="line"> name: string</span><br><span class="line"> age: number</span><br><span class="line"> constructor(name:string,age:number)&#123;//构造函数</span><br><span class="line">     this.name = name</span><br><span class="line">     this.age = age</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const p1 = new Person(&#x27;张三&#x27;,18)</span><br><span class="line">const p2 = new Person(&#x27;李四&#x27;,19)</span><br></pre></td></tr></table></figure><p><strong>继承</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Person &#123; &#125;</span><br><span class="line"></span><br><span class="line">// Teacher类继承Person</span><br><span class="line">class Teacher extends Person &#123; &#125;</span><br><span class="line"></span><br><span class="line">// Student类继承Person</span><br><span class="line">class Student extends Person &#123; &#125;</span><br><span class="line"></span><br><span class="line">// Person实例</span><br><span class="line">const p1 = new Person(&#x27;周杰伦&#x27;,38)</span><br><span class="line">// Student实例</span><br><span class="line">const s1 = new Student(&#x27;张同学&#x27;,18)</span><br><span class="line">const s2 = new Student(&#x27;李同学&#x27;,20)</span><br><span class="line">// Teacher实例</span><br><span class="line">const t1 = new Teacher(&#x27;刘⽼师&#x27;,40)</span><br><span class="line">const t2 = new Teacher(&#x27;孙⽼师&#x27;,50)</span><br></pre></td></tr></table></figure><p><strong>抽象类</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abstract class Person &#123; &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// Person（抽象类）</span><br><span class="line">abstract class Person &#123; &#125;</span><br><span class="line"></span><br><span class="line">// Teacher类继承Person</span><br><span class="line">class Teacher extends Person &#123;</span><br><span class="line"> // 构造器</span><br><span class="line"> constructor(name: string,age: number)&#123;</span><br><span class="line">    super(name,age)</span><br><span class="line"> &#125;</span><br><span class="line"> // ⽅法</span><br><span class="line"> speak()&#123;</span><br><span class="line">    console.log(&#x27;你好！我是⽼师:&#x27;,this.name)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Student类继承Person</span><br><span class="line">class Student extends Person &#123; &#125;</span><br><span class="line">// Person实例</span><br><span class="line">// const p1 = new Person(&#x27;周杰伦&#x27;,38) // 抽象类，不可以new Person</span><br></pre></td></tr></table></figure><h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//限制⼀个类中包含哪些属性和⽅法</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// Person接⼝</span><br><span class="line">interface Person &#123;</span><br><span class="line"> // 属性声明</span><br><span class="line"> name: string</span><br><span class="line"> age: number</span><br><span class="line"> // ⽅法声明</span><br><span class="line"> speak():void</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">// Teacher实现Person接⼝</span><br><span class="line">class Teacher implements Person &#123;</span><br><span class="line"> name: string</span><br><span class="line"> age: number</span><br><span class="line"> // 构造器</span><br><span class="line"> constructor(name: string,age: number)&#123;</span><br><span class="line">     this.name = name</span><br><span class="line">     this.age = age</span><br><span class="line"> &#125;</span><br><span class="line"> // ⽅法</span><br><span class="line"> speak()&#123;</span><br><span class="line">    console.log(&#x27;你好！我是⽼师:&#x27;,this.name)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>举例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 接⼝ —— Person，只能包含抽象⽅法</span><br><span class="line">interface Person &#123;</span><br><span class="line"> // 属性，不写具体值</span><br><span class="line"> name:string</span><br><span class="line"> age:number</span><br><span class="line"> // ⽅法，不写具体实现</span><br><span class="line"> speak():void</span><br><span class="line">&#125;</span><br><span class="line">// 创建Teacher类实现Person接⼝</span><br><span class="line">class Teacher implements Person &#123;</span><br><span class="line"> name:string</span><br><span class="line"> age:number</span><br><span class="line"> constructor(name:string,age:number)&#123;</span><br><span class="line">     this.name = name</span><br><span class="line">     this.age = age</span><br><span class="line"> &#125;</span><br><span class="line"> speak()&#123;</span><br><span class="line">    console.log(&#x27;我在⻜快的⾏⾛中......&#x27;)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="file:///C:/Users/DELL/AppData/Roaming/Typora/typora-user-images/image-20250127173649162.png?lastModify=1738423183" alt="image-20250127173649162"></p><h3 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function test&lt;T&gt;(arg: T): T&#123;</span><br><span class="line">    return arg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 不指名类型，TS会⾃动推断出来</span><br><span class="line">test(10)</span><br><span class="line"></span><br><span class="line">// 指名具体的类型</span><br><span class="line">test&lt;number&gt;(10)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function test&lt;T, K&gt;(a: T, b: K): K&#123;</span><br><span class="line"> return b;</span><br><span class="line">&#125;</span><br><span class="line">// 为多个泛型指定具体⾃值</span><br><span class="line">test&lt;number, string&gt;(10, &quot;hello&quot;);</span><br></pre></td></tr></table></figure><p><strong>类</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class MyClass&lt;T&gt;&#123;</span><br><span class="line"> prop: T;</span><br><span class="line"> constructor(prop: T)&#123;</span><br><span class="line"> this.prop = prop;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>泛型约束</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interface Demo&#123;</span><br><span class="line"> length: number;</span><br><span class="line">&#125;</span><br><span class="line">// 泛型T必须是MyInter的⼦类，即：必须拥有length属性</span><br><span class="line">function test&lt;T extends Demo&gt;(arg: T): number&#123;</span><br><span class="line"> return arg.length;</span><br><span class="line">&#125;</span><br><span class="line">test(10) // 类型“number”的参数不能赋给类型“Demo”的参数</span><br><span class="line">test(&#123;name:&#x27;张三&#x27;&#125;) // 类型“&#123; name: string; &#125;”的参数不能赋给类型“Demo”的参数</span><br><span class="line">test(&#x27;123&#x27;)</span><br><span class="line">test(&#123;name:&#x27;张三&#x27;,length:10&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/%E9%A1%B5%E9%9D%A2circle%E5%8A%A0%E8%BD%BD%E5%8A%A8%E7%94%BB/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/%E9%A1%B5%E9%9D%A2circle%E5%8A%A0%E8%BD%BD%E5%8A%A8%E7%94%BB/</url>
      
        <content type="html"><![CDATA[<h1 id="页面circle加载动画"><a href="#页面circle加载动画" class="headerlink" title="页面circle加载动画"></a>页面circle加载动画</h1><p><img src="/upload/image-20241116165834762.png" alt="image-20241116165834762.png"></p><h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;circle&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;span&gt;loding......&lt;/span&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><h2 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    margin: 0;</span><br><span class="line">    padding: 0;</span><br><span class="line">    box-sizing: border-box;</span><br><span class="line">&#125;</span><br><span class="line">body &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100vh;</span><br><span class="line">    /* border: 10px solid red; */</span><br><span class="line">&#125;</span><br><span class="line">.container &#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: 100%;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">    /* border: 10px solid rgb(0, 132, 255); */</span><br><span class="line">    background-color: black;</span><br><span class="line">&#125;</span><br><span class="line">/* 背景彩色圆圈 */</span><br><span class="line">.circle &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    width: 200px;</span><br><span class="line">    height: 200px;</span><br><span class="line">    display: flex;</span><br><span class="line">    justify-content: center;</span><br><span class="line">    align-items: center;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    /* border: 10px solid rgb(0, 255, 170); */</span><br><span class="line">    background-image: linear-gradient(</span><br><span class="line">        0deg,</span><br><span class="line">        rgb(0, 255, 170),</span><br><span class="line">        rgb(0, 17, 255),</span><br><span class="line">        rgb(255, 0, 255)</span><br><span class="line">    );</span><br><span class="line">    /* !!!动画!!! */</span><br><span class="line">    animation: rotate 2s linear infinite;</span><br><span class="line">&#125;</span><br><span class="line">/* 模糊 */</span><br><span class="line">.circle::before &#123;</span><br><span class="line">    content: &#x27;&#x27;;</span><br><span class="line">    position: absolute;</span><br><span class="line">    width: 200px;</span><br><span class="line">    height: 200px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    /* border: 10px solid rgb(0, 255, 170); */</span><br><span class="line">    background-image: linear-gradient(</span><br><span class="line">        0deg,</span><br><span class="line">        rgb(0, 255, 170),</span><br><span class="line">        rgb(0, 17, 255),</span><br><span class="line">        rgb(255, 0, 255)</span><br><span class="line">    );</span><br><span class="line">    filter: blur(35px);</span><br><span class="line">&#125;</span><br><span class="line">/* 黑圈 */</span><br><span class="line">.circle::after &#123;</span><br><span class="line">    content: &#x27;&#x27;;</span><br><span class="line">    position: absolute;</span><br><span class="line">    width: 180px;</span><br><span class="line">    height: 180px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    background-color: black;</span><br><span class="line">&#125;</span><br><span class="line">/* 文字 */</span><br><span class="line">span &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    color: rgb(255, 255, 255);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="重点"><a href="#重点" class="headerlink" title="重点"></a><em><strong>重点</strong></em></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">animation: rotate 2s linear infinite;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/* 动画 */</span><br><span class="line">@keyframes rotate &#123;</span><br><span class="line">    0% &#123;</span><br><span class="line">        transform: rotate(0deg);</span><br><span class="line">    &#125;</span><br><span class="line">    100% &#123;</span><br><span class="line">        transform: rotate(360deg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/%E9%A1%B5%E9%9D%A2%E9%A2%84%E5%8A%A0%E8%BD%BD/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/%E9%A1%B5%E9%9D%A2%E9%A2%84%E5%8A%A0%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<h1 id="页面预加载"><a href="#页面预加载" class="headerlink" title="页面预加载"></a>页面预加载</h1><p><strong>本文实现了</strong></p><p><strong>1.预加载转圈动画+加载完毕销毁组件</strong></p><p><strong>2.开屏蒙版特效（after资源加载完毕）</strong></p><p><strong>3.主页背景图模糊+缩放动画（after资源加载完毕）</strong></p><h2 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h2><h3 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 加载动画 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;svg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>loding......<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="门板"><a href="#门板" class="headerlink" title="门板"></a><strong>门板</strong></h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 门板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="主页面"><a href="#主页面" class="headerlink" title="主页面"></a><strong>主页面</strong></h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 主页面 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;page&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://haowallpaper.com/link/common/file/previewFileImg/718a61f6cd6efa803ca87eb743fec045718a61f6cd6efa803ca87eb743fec045&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="JS"><a href="#JS" class="headerlink" title="JS"></a>JS</h3><h4 id="预加载工具"><a href="#预加载工具" class="headerlink" title="预加载工具"></a><strong>预加载工具</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;http://libs.baidu.com/jquery/1.8.3/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><h4 id="动态更新"><a href="#动态更新" class="headerlink" title="动态更新"></a><strong>动态更新</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="variable constant_">JS</span>动态更新 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">let</span> left = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.left&#x27;</span>)  <span class="comment">//左门</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">let</span> right = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.right&#x27;</span>)<span class="comment">//右门</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">let</span> page = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.page&#x27;</span>)  <span class="comment">//获取图片对象</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    $(<span class="variable language_">window</span>).<span class="title function_">on</span>(<span class="string">&#x27;load&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        $(<span class="string">&#x27;.svg&#x27;</span>).<span class="title function_">animate</span>(</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="attr">opacity</span>: <span class="number">0</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="number">500</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        )</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            $(<span class="string">&#x27;.svg&#x27;</span>).<span class="title function_">remove</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//remove组件loding后执行</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="comment">//门板开屏动态</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                left.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`translateX(-60vw)`</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                right.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`translateX(60vw)`</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                <span class="comment">//模糊/放缩背景图片效果</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                page.<span class="property">style</span>.<span class="property">animation</span> = <span class="string">`blur-to-clear 2s cubic-bezier(0.62, 0.21, 0.25, 1) 0s 1</span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="language-xml">                        normal backwards running,scale 2s cubic-bezier(0.62, 0.21, 0.25, 1) 0s 1 both`</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            &#125;, <span class="number">200</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;, <span class="number">500</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h3><h4 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a><strong>全局配置</strong></h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* 取消滚动条 */</span></span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="动画函数"><a href="#动画函数" class="headerlink" title="动画函数"></a><strong>动画函数</strong></h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 动画 */</span></span><br><span class="line"><span class="keyword">@keyframes</span> rotate &#123;</span><br><span class="line">    <span class="number">0%</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">0deg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="number">100%</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">360deg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 模糊动画 */</span></span><br><span class="line"><span class="keyword">@keyframes</span> blur-to-clear &#123;</span><br><span class="line">    <span class="number">0%</span> &#123;</span><br><span class="line">        <span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">35px</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="number">100%</span> &#123;</span><br><span class="line">        <span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">0px</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 图片大小变化动画 */</span></span><br><span class="line"><span class="keyword">@keyframes</span> scale &#123;</span><br><span class="line">    <span class="number">0%</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="number">100%</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="包裹加载的样式svg（loding后去除）"><a href="#包裹加载的样式svg（loding后去除）" class="headerlink" title="包裹加载的样式svg（loding后去除）"></a><strong>包裹加载的样式svg（loding后去除）</strong></h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.svg</span> &#123;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">999</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100vw</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: black;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="主页背景"><a href="#主页背景" class="headerlink" title="主页背景"></a><strong>主页背景</strong></h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">img</span><span class="selector-class">.page</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100vw</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">min-width</span>: <span class="number">1080px</span>;</span><br><span class="line">    <span class="attribute">transition</span>: opacity <span class="number">1s</span>;</span><br><span class="line">    <span class="comment">/* 背景图片变化动画(已存入JS) */</span></span><br><span class="line">    <span class="comment">/* animation: blur-to-clear 2s cubic-bezier(0.62, 0.21, 0.25, 1) 0s 1</span></span><br><span class="line"><span class="comment">    normal backwards running,</span></span><br><span class="line"><span class="comment">    scale 2s cubic-bezier(0.62, 0.21, 0.25, 1) 0s 1 both; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="加载圆圈样式"><a href="#加载圆圈样式" class="headerlink" title="加载圆圈样式"></a><strong>加载圆圈样式</strong></h4><p><strong>详细拆分见文章“页面circle加载动画”</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="comment">/* border: 10px solid rgb(0, 132, 255); */</span></span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.circle</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="comment">/* border: 10px solid rgb(0, 255, 170); */</span></span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(</span><br><span class="line">        <span class="number">0deg</span>,</span><br><span class="line">        <span class="built_in">rgb</span>(<span class="number">0</span>, <span class="number">255</span>, <span class="number">170</span>),</span><br><span class="line">        <span class="built_in">rgb</span>(<span class="number">0</span>, <span class="number">17</span>, <span class="number">255</span>),</span><br><span class="line">        <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">/* 动画 */</span></span><br><span class="line">    <span class="attribute">animation</span>: rotate <span class="number">2s</span> linear infinite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 模糊 */</span></span><br><span class="line"><span class="selector-class">.circle</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="comment">/* border: 10px solid rgb(0, 255, 170); */</span></span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">linear-gradient</span>(</span><br><span class="line">        <span class="number">0deg</span>,</span><br><span class="line">        <span class="built_in">rgb</span>(<span class="number">0</span>, <span class="number">255</span>, <span class="number">170</span>),</span><br><span class="line">        <span class="built_in">rgb</span>(<span class="number">0</span>, <span class="number">17</span>, <span class="number">255</span>),</span><br><span class="line">        <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">35px</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 黑圈 */</span></span><br><span class="line"><span class="selector-class">.circle</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">180px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">180px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">    <span class="comment">/* filter: blur(35px); */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="开屏门板"><a href="#开屏门板" class="headerlink" title="开屏门板"></a><strong>开屏门板</strong></h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.left</span> &#123;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">998</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50vw</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">    <span class="attribute">transition</span>: transform <span class="number">1s</span>;</span><br><span class="line">    <span class="attribute">transform-origin</span>: center center;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.right</span> &#123;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">998</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">50vw</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">50vw</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">30</span>, <span class="number">30</span>, <span class="number">30</span>);</span><br><span class="line">    <span class="attribute">transition</span>: transform <span class="number">1s</span>;</span><br><span class="line">    <span class="attribute">transform-origin</span>: center center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/Vue%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/Vue%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="组件通信"><a href="#组件通信" class="headerlink" title="组件通信"></a>组件通信</h2><h3 id="父子双传"><a href="#父子双传" class="headerlink" title="父子双传"></a>父子双传</h3><h5 id="props"><a href="#props" class="headerlink" title="props"></a>props</h5><p><strong>父传子</strong></p><p><img src="/upload/image-20240825201917435-ppsw.png" alt="image-20240825201917435-ppsw.png"></p><p><strong>子传父</strong></p><p><img src="/upload/image-20240825203836739-eekr.png" alt="image-20240825203836739-eekr.png"></p><h5 id="v-model（双向绑定）"><a href="#v-model（双向绑定）" class="headerlink" title="v-model（双向绑定）"></a>v-model（双向绑定）</h5><p><strong>表单</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//用在html标签</span><br><span class="line">&lt;input type=&quot;text&quot; v-model=&quot;username&quot;&gt;</span><br><span class="line"></span><br><span class="line">//用在组件标签上</span><br><span class="line">&lt;组件 v-model=&quot;username&quot;/&gt;</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20240826134133823-jtfn.png" alt="image-20240826134133823-jtfn.png"></p><p><img src="/upload/image-20240826134643288-wved.png" alt="image-20240826134643288-wved.png"></p><h3 id="父传子"><a href="#父传子" class="headerlink" title="父传子"></a>父传子</h3><h5 id="refs"><a href="#refs" class="headerlink" title="$refs"></a>$refs</h5><p><strong>改变子的玩具</strong></p><p><img src="/upload/image-20240826163102996-vnxq.png" alt="image-20240826163102996-vnxq.png"></p><p><strong>让所有子的书变多</strong></p><p><img src="/upload/image-20240826161006792-cmyw.png" alt="image-20240826161006792-cmyw.png"></p><h5 id="默认插槽"><a href="#默认插槽" class="headerlink" title="默认插槽"></a>默认插槽</h5><p><img src="/upload/image-20240826214619312-wydc.png" alt="image-20240826214619312-wydc.png"></p><p><img src="/upload/image-20240826214724976-nytt.png" alt="image-20240826214724976-nytt.png"></p><h5 id="具名插槽"><a href="#具名插槽" class="headerlink" title="具名插槽"></a>具名插槽</h5><p><img src="/upload/image-20240826221750773-jrvs.png" alt="image-20240826221750773-jrvs.png"></p><h3 id="子传父"><a href="#子传父" class="headerlink" title="子传父"></a>子传父</h3><h5 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h5><p><strong>父组件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Child @send-toy=&quot;toy = $event&quot;/&gt;</span><br></pre></td></tr></table></figure><p><strong>子组件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.$emit(&#x27;send-toy&#x27;, 具体数据)</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20240825212202117-gpof.png" alt="image-20240825212202117-gpof.png"></p><h5 id="parent"><a href="#parent" class="headerlink" title="$parent"></a>$parent</h5><p><strong>减少父的房产</strong></p><p><img src="/upload/image-20240826162719642-svvx.png" alt="image-20240826162719642-svvx.png"></p><h5 id="作用域插槽"><a href="#作用域插槽" class="headerlink" title="作用域插槽"></a>作用域插槽</h5><p><strong>params作为对象</strong></p><p><img src="/upload/image-20240827151102500-ymag.png" alt="image-20240827151102500-ymag.png"></p><p><img src="/upload/image-20240827151700297-slyx.png" alt="image-20240827151700297-slyx.png"></p><h3 id="祖传孙"><a href="#祖传孙" class="headerlink" title="祖传孙"></a>祖传孙</h3><h5 id="attrs"><a href="#attrs" class="headerlink" title="$attrs"></a>$attrs</h5><p><img src="/upload/image-20240826144203197-vibc.png" alt="image-20240826144203197-vibc.png"></p><h5 id="provide（配inject）"><a href="#provide（配inject）" class="headerlink" title="provide（配inject）"></a>provide（配inject）</h5><p><img src="/upload/image-20240826172233626-cazp.png" alt="image-20240826172233626-cazp.png"></p><h3 id="孙传组"><a href="#孙传组" class="headerlink" title="孙传组"></a>孙传组</h3><h5 id="inject（配provid）"><a href="#inject（配provid）" class="headerlink" title="inject（配provid）"></a>inject（配provid）</h5><p><img src="/upload/image-20240826172226760-ueqn.png" alt="image-20240826172226760-ueqn.png"></p><h3 id="兄弟传"><a href="#兄弟传" class="headerlink" title="兄弟传"></a>兄弟传</h3><h5 id="mitt"><a href="#mitt" class="headerlink" title="mitt"></a>mitt</h5><p><strong>安装</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mitt</span><br></pre></td></tr></table></figure><p><strong>&#x2F;utils&#x2F;emitter</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//引入mitt</span><br><span class="line">import mitt from &#x27;mitt&#x27;</span><br><span class="line"></span><br><span class="line">// 调用mitt得到emitter，emitter能：绑定事件、触发事件</span><br><span class="line">const emitter = mitt()</span><br><span class="line"></span><br><span class="line">// 暴露emitter</span><br><span class="line">export default emitter</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//绑定事件</span><br><span class="line">emitter.on(&#x27;text&#x27;,()=&gt;&#123;&#125;)</span><br><span class="line">//触发事件</span><br><span class="line">emmiter.emit(&#x27;text&#x27;)</span><br><span class="line">//解绑事件</span><br><span class="line">emmiter.off(&#x27;text&#x27;)</span><br><span class="line">//全部解绑</span><br><span class="line">emmiter.all.clear()</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20240826131941301-xtro.png" alt="image-20240826131941301-xtro.png"></p><h3 id="任意传"><a href="#任意传" class="headerlink" title="任意传"></a>任意传</h3><h5 id="pinia"><a href="#pinia" class="headerlink" title="pinia"></a>pinia</h5><p><strong>搭建</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pinia</span><br></pre></td></tr></table></figure><p><strong>main.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createApp &#125; from &#x27;vue&#x27;</span><br><span class="line">import App from &#x27;./App.vue&#x27;</span><br><span class="line"></span><br><span class="line">/* 引入createPinia，用于创建pinia */</span><br><span class="line">import &#123; createPinia &#125; from &#x27;pinia&#x27;</span><br><span class="line"></span><br><span class="line">/* 创建pinia */</span><br><span class="line">const pinia = createPinia()</span><br><span class="line">const app = createApp(App)</span><br><span class="line"></span><br><span class="line">/* 使用插件 */&#123;&#125;</span><br><span class="line">app.use(pinia)</span><br><span class="line">app.mount(&#x27;#app&#x27;)</span><br></pre></td></tr></table></figure><p><strong>&#x2F;stores&#x2F;first.ts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import &#123;defineStore&#125; from &quot;pinia&quot;;</span><br><span class="line"></span><br><span class="line">import &#123;ref&#125; from &quot;vue&quot;</span><br><span class="line"></span><br><span class="line">export default defineStore(&#x27;first&#x27;,()=&gt;&#123;//创建自己的仓库</span><br><span class="line">    const name = ref(&#x27;pinia&#x27;);</span><br><span class="line">    </span><br><span class="line">    return &#123;name&#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>App.vue</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    import useFristStore from &quot;./stores/first&quot;</span><br><span class="line">    const store = useFirstStore();//自己的仓库</span><br><span class="line">    console.log(store.name);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  </span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/Vue%E8%B7%AF%E7%94%B1/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/Vue%E8%B7%AF%E7%94%B1/</url>
      
        <content type="html"><![CDATA[<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p><img src="/upload/image-20240829155453971.png" alt="image-20240829155453971.png"></p><ul><li><p><code>router/index.ts</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import &#123; creatRouter, createWebHistory &#125; from &#x27;vue-router&#x27;</span><br><span class="line">import 自定义名1 from &#x27;../pages/组件1.vue&#x27;</span><br><span class="line">import 自定义名2 from &#x27;../pages/组件2.vue&#x27;</span><br><span class="line"></span><br><span class="line">export default createRouter(&#123;</span><br><span class="line">    history: createWebHistory(),</span><br><span class="line">    routes:[</span><br><span class="line">        &#123;</span><br><span class="line">            path:&#x27;/自定义路由名1&#x27;</span><br><span class="line">            component:/自定义名1,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path:&#x27;/自定义路由名2&#x27;</span><br><span class="line">            component:/自定义名2,</span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><code>App.vue</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;......&quot;&gt;</span><br><span class="line">        &lt;!-- 导航区 --&gt;</span><br><span class="line">        &lt;router-link active-class=&quot;active&quot; class=&quot;...&quot; to=&quot;/props&quot;&gt;1. props&lt;/router-link&gt;</span><br><span class="line">        &lt;router-link active-class=&quot;active&quot; class=&quot;...&quot; to=&quot;/event&quot;&gt;2. 自定义事件&lt;/router-link&gt;</span><br><span class="line">        ......</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;......&quot;&gt;</span><br><span class="line">        &lt;!-- 占位一个展示区 --&gt;</span><br><span class="line">        &lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot; name=&quot;App&quot;&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></li><li><p><code>main.ts</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createApp &#125; from &#x27;vue&#x27;</span><br><span class="line">import App from &#x27;./App.vue&#x27;</span><br><span class="line">import &#123; createPinia &#125; from &#x27;pinia&#x27;</span><br><span class="line">import router from &#x27;./router/index&#x27;</span><br><span class="line"></span><br><span class="line">// 创建应用</span><br><span class="line">const app = createApp(App)</span><br><span class="line">// 创建pinia</span><br><span class="line">const pinia = createPinia()</span><br><span class="line"></span><br><span class="line">// 安装插件</span><br><span class="line">app.use(pinia)</span><br><span class="line">// 安装路由器</span><br><span class="line">app.use(router)</span><br><span class="line">// 挂载应用</span><br><span class="line">app.mount(&#x27;#app&#x27;)//使用.mount()方法将应用挂载到id为&#x27;app&#x27;的元素上</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/Scss/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/Scss/</url>
      
        <content type="html"><![CDATA[<h1 id="Scss"><a href="#Scss" class="headerlink" title="Scss"></a>Scss</h1><p><strong>Sass使用Ruby语法 : *<em><strong>没有花括号</strong>，<strong>没有分号</strong>，具有</em>*严格的缩进</strong></p><h2 id="基础使用"><a href="#基础使用" class="headerlink" title="基础使用"></a>基础使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install -D sass sass-loader</span><br></pre></td></tr></table></figure><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p><strong>define.scss （一般放在src中的styles文件夹中）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$--primary-color: #123456;</span><br><span class="line">$white-color:$--primary-color-green !default;//这个默认值的优先级降到了最低，当没有其它地方赋值时候，才会选择默认值</span><br></pre></td></tr></table></figure><p><strong>vue组件</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">@import &#x27;@/styles/define.scss&#x27;;</span><br><span class="line">    .box&#123;</span><br><span class="line">        color:$--primary-color;</span><br><span class="line">        background-color:$white-color;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><h3 id="mixin"><a href="#mixin" class="headerlink" title="@mixin"></a>@mixin</h3><p><strong>可以定义一段代码作为模板样式</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@mixin border-radius($radius: 5px, $borderRadius: 8px) &#123;//可以接收传入的参数</span><br><span class="line">  border: &#123;</span><br><span class="line">    radius: $radius;</span><br><span class="line">    top: $borderRadius solid #ff0;</span><br><span class="line">    bottom: $borderRadius solid #f00;</span><br><span class="line">    left: $borderRadius solid #00f;</span><br><span class="line">    right: $borderRadius solid #888;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@include border-radius(5px, 1px);//传入参数，返回计算好的样式</span><br></pre></td></tr></table></figure><h3 id="extend"><a href="#extend" class="headerlink" title="@extend"></a>@extend</h3><p><strong>继承其它代码段</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@mixin btn($width: 50px, $height: 20px, $font-size: 16px) &#123;</span><br><span class="line">  width: $width;</span><br><span class="line">  height: $height;</span><br><span class="line">  font-size: $font-size;</span><br><span class="line">  text-align: center;</span><br><span class="line">  line-height: $height;</span><br><span class="line">  @include border-radius(5px, 1px);</span><br><span class="line">  &amp;:hover &#123;</span><br><span class="line">    opacity: 0.8;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">.btn &#123;</span><br><span class="line">  @include btn(80px, 30px, 12px);</span><br><span class="line">  margin: &#123;</span><br><span class="line">    top: 10px;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">.btn-primary &#123;</span><br><span class="line">  @extend .btn;//继承到了btn的样式</span><br><span class="line">  background-color: $light-blue;</span><br><span class="line">  color: $fontColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Vite配置scss"><a href="#Vite配置scss" class="headerlink" title="Vite配置scss"></a>Vite配置scss</h2><p><strong>配置vite.config.ts</strong></p><p>顺便把@别名路径都配置好了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; fileURLToPath &#125; from &#x27;url&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">export default defineConfig(&#123;</span><br><span class="line">    plugins: [vue()],</span><br><span class="line">    css: &#123;</span><br><span class="line">        preprocessorOptions: &#123;</span><br><span class="line">            scss: &#123;</span><br><span class="line">                additionalData: &#x27;@import &quot;@/styles/define.scss&quot;;&#x27;,</span><br><span class="line">                javascriptEnabled: true,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        alias: &#123;</span><br><span class="line">            &#x27;@&#x27;: fileURLToPath(new URL(&#x27;./src&#x27;, import.meta.url)),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/grid%E7%BD%91%E6%A0%BC%E5%B8%83%E5%B1%80/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/grid%E7%BD%91%E6%A0%BC%E5%B8%83%E5%B1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="CSS定位元素"><a href="#CSS定位元素" class="headerlink" title="CSS定位元素"></a>CSS定位元素</h1><p><img src="/upload/image-20241110163644817.png" alt="image-20241110163644817.png"></p><h1 id="grid网格布局"><a href="#grid网格布局" class="headerlink" title="grid网格布局"></a>grid网格布局</h1><p><strong>新的长度单位：fr</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一般来说 1fr 的意思是“100%的剩余空间”, .25fr 意味着“25%的剩余空间”。当时当 fr 大于 1 的时候，则会重新计算比例来分配。</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241110161821264.png" alt="image-20241110161821264.png"></p><h3 id="grid布局"><a href="#grid布局" class="headerlink" title="grid布局"></a>grid布局</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">display: grid;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grid-template-columns: 1fr 1fr 1fr 1fr;</span><br></pre></td></tr></table></figure><p><strong>等价于（repeat）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grid-template-columns: repeat(4, 1fr);</span><br><span class="line">grid-template-columns: repeat(4, .25fr);</span><br></pre></td></tr></table></figure><p>一般都建议使用 **<code>fr&gt;=1</code> 的情况</p><h3 id="响应式设计"><a href="#响应式设计" class="headerlink" title="响应式设计"></a>响应式设计</h3><p>这里 <code>A</code> 和 <code>D</code> 都是固定的 <code>50px</code>，<code>C</code> 是占总宽度的 <code>20%</code>，剩余空间就可以分配给 <code>B</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.grid-container &#123;</span><br><span class="line">  grid-template-columns: 50px 1fr 20% 50px;</span><br><span class="line">  column-gap: 10px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241110161302301.png" alt="image-20241110161302301.png"></p><h3 id="船新用法"><a href="#船新用法" class="headerlink" title="船新用法"></a>船新用法</h3><p><strong>3*3的网格</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//网格布局</span><br><span class="line">.face &#123;</span><br><span class="line">    display: grid;</span><br><span class="line">    grid-template-rows:repeat(3,1fr);</span><br><span class="line">    grid-template-columns: repeat(3,lfr);</span><br><span class="line">    grid-template-areas:</span><br><span class="line">        &quot;lt . rt&quot;</span><br><span class="line">        &quot;lc cc rc&quot;</span><br><span class="line">        &quot;lb . rb&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//规划块布局</span><br><span class="line">.lt-dot&#123;</span><br><span class="line">    grid-area: lt;</span><br><span class="line">&#125;</span><br><span class="line">.lr-dot&#123;</span><br><span class="line">    grid-area: lr;</span><br><span class="line">&#125;</span><br><span class="line">.lc-dot&#123;</span><br><span class="line">    grid-area: lc;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241110163133135.png" alt="image-20241110163133135.png"></p><h3 id="相比Flex"><a href="#相比Flex" class="headerlink" title="相比Flex"></a>相比Flex</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flex是一维布局，Grid是二维</span><br><span class="line">浏览器对Flex的兼容性更好</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Grid适用于大面积的整体布局</span><br><span class="line">小面积组件Flex更灵活</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/grid+transform%E5%AE%9E%E7%8E%B0%E9%A1%B5%E9%9D%A23D%E9%AA%B0%E5%AD%90/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/grid+transform%E5%AE%9E%E7%8E%B0%E9%A1%B5%E9%9D%A23D%E9%AA%B0%E5%AD%90/</url>
      
        <content type="html"><![CDATA[<h1 id="grid-transform实现页面3D骰子"><a href="#grid-transform实现页面3D骰子" class="headerlink" title="grid+transform实现页面3D骰子"></a>grid+transform实现页面3D骰子</h1><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><h3 id="transform"><a href="#transform" class="headerlink" title="transform"></a><em>transform</em></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform-style: preserve-3d;/*所有子元素在3D空间中呈现*/</span><br></pre></td></tr></table></figure><h3 id="偏移"><a href="#偏移" class="headerlink" title="偏移"></a><em><strong>偏移</strong></em></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform: translateX(90px) translateY(90px) translateZ(90px);/*左右 下上 前后*/</span><br></pre></td></tr></table></figure><h3 id="旋转"><a href="#旋转" class="headerlink" title="旋转"></a><em><strong>旋转</strong></em></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg)</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241110201517099.png" alt="image-20241110201517099.png"></p><h2 id="实战效果"><a href="#实战效果" class="headerlink" title="实战效果"></a><strong>实战效果</strong></h2><h3 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;wrap&quot; id=&quot;dice&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;face face-grid first-face&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;dot cc-dot red&quot;&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;face face-grid second-face&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;dot lt-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rb-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;face face-grid third-face&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;dot lt-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot cc-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rb-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;face face-grid forth-face&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;dot lt-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot lb-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rt-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rb-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;face face-grid fifth-face&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;dot lt-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot lb-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot cc-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rt-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rb-dot&quot;&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;face face-grid sixth-face&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;dot lt-dot red&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot lc-dot red&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot lb-dot red&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rt-dot red&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rc-dot red&quot;&gt;&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;dot rb-dot red&quot;&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">container                       //外层占位容器</span><br><span class="line">    wrap / dice                 //控制旋转</span><br><span class="line">        face / face-grid * 6    //面</span><br><span class="line">            dot / red           //点</span><br></pre></td></tr></table></figure><h3 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h3><h5 id="box-sizing"><a href="#box-sizing" class="headerlink" title="box-sizing"></a><strong>box-sizing</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">div &#123;</span><br><span class="line">    box-sizing: border-box;/*元素的width和height包括content、padding和border的宽度，但不包括margin*/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="渐变边框技术做面"><a href="#渐变边框技术做面" class="headerlink" title="渐变边框技术做面"></a><strong>渐变边框技术做面</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.face &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    width: 120px;</span><br><span class="line">    height: 120px;</span><br><span class="line">    padding: 20px;/*w/h/p都包裹边框的宽度，是从边框的最里往里padding*/</span><br><span class="line">    opacity: 0.95;</span><br><span class="line">    border: 8px solid transparent; /*8px的透明边框，就是渐变边框的宽度*/</span><br><span class="line">    background-clip: padding-box, border-box;/*必要的两项*/</span><br><span class="line">    background-origin: padding-box, border-box;/*必要的两项*/</span><br><span class="line">    background-image: </span><br><span class="line">        linear-gradient(135deg, #e1eeffbb, #f3d5ffbb),</span><br><span class="line">        linear-gradient(135deg, rgb(0, 60, 255), rgb(0, 225, 255), #f0f);/*渐变角度+渐变颜色*/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="grid做点（face-grid）"><a href="#grid做点（face-grid）" class="headerlink" title="grid做点（face-grid）"></a><strong>grid做点（face-grid）</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.face-grid &#123;</span><br><span class="line">    /*骰子点数布局*/</span><br><span class="line">    display: grid;</span><br><span class="line">    grid-template-rows: repeat(3, 1fr);/*行*/</span><br><span class="line">    grid-template-columns: repeat(3, 1fr);/*列*/</span><br><span class="line">    grid-template-areas:</span><br><span class="line">        &#x27;lt . rt&#x27;</span><br><span class="line">        &#x27;lc cc rc&#x27;</span><br><span class="line">        &#x27;lb . rb&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">.lt-dot &#123;</span><br><span class="line">    grid-area: lt;</span><br><span class="line">&#125;</span><br><span class="line">.rt-dot &#123;</span><br><span class="line">    grid-area: rt;</span><br><span class="line">&#125;</span><br><span class="line">.lc-dot &#123;</span><br><span class="line">    grid-area: lc;</span><br><span class="line">&#125;</span><br><span class="line">.cc-dot &#123;</span><br><span class="line">    grid-area: cc;</span><br><span class="line">&#125;</span><br><span class="line">.rc-dot &#123;</span><br><span class="line">    grid-area: rc;</span><br><span class="line">&#125;</span><br><span class="line">.lb-dot &#123;</span><br><span class="line">    grid-area: lb;</span><br><span class="line">&#125;</span><br><span class="line">.rb-dot &#123;</span><br><span class="line">    grid-area: rb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="点状样式（dot-red）"><a href="#点状样式（dot-red）" class="headerlink" title="点状样式（dot&#x2F;red）"></a><strong>点状样式（dot&#x2F;red）</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.dot &#123;/*黑点*/</span><br><span class="line">    display: inline-block;</span><br><span class="line">    width: 25px;</span><br><span class="line">    height: 25px;</span><br><span class="line">    border-radius: 50%;</span><br><span class="line">    background-color: #1759af;</span><br><span class="line">&#125;</span><br><span class="line">.red &#123;/*红点（继承黑点属性）*/</span><br><span class="line">    background-color: rgb(162, 0, 211);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="偏移-旋转面"><a href="#偏移-旋转面" class="headerlink" title="偏移+旋转面"></a><strong>偏移+旋转面</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1面（前） 前移 50%边长</span><br><span class="line">6面（后） 后移 50%边长</span><br><span class="line">2面（左） 左移 50%边长 + Y 90deg</span><br><span class="line">3面（右） 右移 50%边长 + Y 90deg</span><br><span class="line">5面（上） 上移 50%边长 + X 90deg</span><br><span class="line">4面（下） 下移 50%边长 + X 90deg</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.first-face &#123;</span><br><span class="line">    transform: translateZ(60px);</span><br><span class="line">&#125;</span><br><span class="line">.second-face &#123;</span><br><span class="line">    transform: translateX(-60px) rotateY(90deg);</span><br><span class="line">&#125;</span><br><span class="line">.third-face &#123;</span><br><span class="line">    transform: translateX(50%) rotateY(90deg);</span><br><span class="line">&#125;</span><br><span class="line">.forth-face &#123;</span><br><span class="line">    transform: translateY(50%) rotateX(90deg);</span><br><span class="line">&#125;</span><br><span class="line">.fifth-face &#123;</span><br><span class="line">    transform: translateY(-50%) rotateX(90deg);</span><br><span class="line">&#125;</span><br><span class="line">.sixth-face &#123;</span><br><span class="line">    transform: translateZ(-60px);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a><strong>效果图</strong></h5><p><img src="/upload/image-20241115172203521.png" alt="image-20241115172203521.png"></p><h5 id="加点动效（CSS-hover）"><a href="#加点动效（CSS-hover）" class="headerlink" title="加点动效（CSS_hover）"></a><strong>加点动效（CSS_hover）</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.wrap:hover &#123;</span><br><span class="line">    transform: rotateX(300deg) rotateY(0deg) rotateZ(100deg) !important;</span><br><span class="line">    transition: transform 2s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JS实现随机点数"><a href="#JS实现随机点数" class="headerlink" title="JS实现随机点数"></a>JS实现随机点数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    let wrap = document.querySelector(&#x27;.wrap&#x27;)</span><br><span class="line">    let rotateX = 0 // 初始化旋转角度</span><br><span class="line">    let rotateY = 0</span><br><span class="line">    let rotateZ = 0</span><br><span class="line"></span><br><span class="line">    wrap.onclick = function () &#123;</span><br><span class="line">        let x = Math.floor(Math.random() * 10) - 5 //随机数，范围是-5到5</span><br><span class="line">        let y = Math.floor(Math.random() * 10) - 5</span><br><span class="line">        let z = Math.floor(Math.random() * 10) - 5</span><br><span class="line">        rotateX += x * 90</span><br><span class="line">        rotateY += y * 90</span><br><span class="line">        rotateZ += z * 90</span><br><span class="line">        wrap.style.transform = `rotateX($&#123;rotateX&#125;deg) rotateY($&#123;rotateY&#125;deg) rotateZ($&#123;rotateZ&#125;deg)`</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><strong>暂时还不会计算旋转后的点数显示</strong></p><p><strong>等有思路了继续更新</strong></p>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/CSS%E6%90%AD%E5%BB%BA%E9%A1%B5%E9%9D%A23D%E7%A9%BA%E9%97%B4/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/CSS%E6%90%AD%E5%BB%BA%E9%A1%B5%E9%9D%A23D%E7%A9%BA%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<h1 id="CSS搭建页面3D空间"><a href="#CSS搭建页面3D空间" class="headerlink" title="CSS搭建页面3D空间"></a>CSS搭建页面3D空间</h1><p><strong>重磅CSS属性</strong></p><h5 id="transform"><a href="#transform" class="headerlink" title="transform"></a><em>transform</em></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform-style: preserve-3d;/*所有子元素在3D空间中呈现*/</span><br></pre></td></tr></table></figure><p><em><strong>偏移</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform: translateX(90px) translateY(90px) translateZ(90px);/*左右 下上 前后*/</span><br></pre></td></tr></table></figure><p><em><strong>旋转</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg)</span><br></pre></td></tr></table></figure><p><img src="/upload/image-20241110201517099.png" alt="image-20241110201517099.png"></p>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/CSS%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"/>
      <url>/2025/03/08/%E5%9F%BA%E7%A1%80%E5%89%8D%E7%AB%AF/CSS%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h5 id="元素区分"><a href="#元素区分" class="headerlink" title="元素区分"></a>元素区分</h5><p><strong>块元素</strong><strong>div &#x2F; p &#x2F; h &#x2F; ul &#x2F; li</strong></p><p><strong>行内元素</strong><strong>a &#x2F; span &#x2F;br</strong></p><p><strong>行内块元素</strong><strong>img &#x2F; input &#x2F; td</strong></p><h5 id="高度塌陷"><a href="#高度塌陷" class="headerlink" title="高度塌陷"></a>高度塌陷</h5><p><strong>就是外边距margin塌陷</strong></p><p><strong>只会发生在垂直方向，只出现在块级元素上</strong></p><p><strong>解决：子绝父相</strong></p><h5 id="浮动塌陷"><a href="#浮动塌陷" class="headerlink" title="浮动塌陷"></a>浮动塌陷</h5><p><strong>元素一旦****浮动</strong>后，<strong>脱离标准流</strong>，朝着向左或右方向移动，直到自己的<strong>边界紧贴包含块</strong>(一般是父元素)或者其他浮动元素的边界为止</p><p><strong>clear</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">div -&gt;  display:float</span><br><span class="line">    span    //float: left</span><br><span class="line">    span    //若未设置高度，则span浮动于父元素上方，产生高度塌陷</span><br><span class="line">    span</span><br><span class="line">    span</span><br><span class="line">    span</span><br><span class="line">    p   -&gt;  clear: both</span><br><span class="line">div</span><br></pre></td></tr></table></figure><p><strong>创建BFC</strong></p><p>BFC原理详情见文章 “格式化上下文–BFC与IFC”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://154.40.44.42:8090/archives/ge-shi-hua-shang-xia-wen--bfcyu-ifc</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">div -&gt;  display:float / overflow: hidden/auto</span><br><span class="line">    span    //float: left</span><br><span class="line">    span</span><br><span class="line">    span</span><br><span class="line">    span</span><br><span class="line">    span</span><br><span class="line">div</span><br></pre></td></tr></table></figure><p><strong>伪元素（!最推荐!）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">div class=clearfix  父元素</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.clearfix::after&#123;</span><br><span class="line">    content: &#x27;&#x27;     //设置为空元素</span><br><span class="line">    display: block  //设置为块级元素</span><br><span class="line">    clear: both     //clear清除浮动</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="三角形"><a href="#三角形" class="headerlink" title="三角形"></a>三角形</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">w:0</span><br><span class="line">h:0</span><br><span class="line">border: 250px solid transparent</span><br><span class="line">border-方向-color:颜色</span><br></pre></td></tr></table></figure><h5 id="固定宽高比"><a href="#固定宽高比" class="headerlink" title="固定宽高比"></a>固定宽高比</h5><p><strong>需要父元素</strong></p><p><strong>宽高比&#x3D;4:3示例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">w:100%              //为父元素100%</span><br><span class="line">h:0</span><br><span class="line">padding:0</span><br><span class="line">padding-bottom:75%  //为父元素75%</span><br></pre></td></tr></table></figure><h5 id="超出省略"><a href="#超出省略" class="headerlink" title="超出省略"></a>超出省略</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">white-space: nowrap;</span><br><span class="line">text-overflow: ellipsis;</span><br><span class="line">overflow: hidden;</span><br></pre></td></tr></table></figure><h5 id="渐变边框"><a href="#渐变边框" class="headerlink" title="渐变边框"></a>渐变边框</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.box &#123;</span><br><span class="line">    width: 100px;</span><br><span class="line">    height: 100px;</span><br><span class="line">    border: 8px solid transparent; /*8px的透明边框*/</span><br><span class="line">    border-radius: 12px; /*圆角*/</span><br><span class="line">    background-clip: padding-box, border-box;/*background-clip 设置元素的背景是否延伸到边框、内边距盒子、内容盒子下面。背景延伸至边框外沿（但是在边框下层）且背景延伸至内边距（padding）外沿。不会绘制到边框处。*/</span><br><span class="line">    background-origin: padding-box, border-box;/*背景图片的摆放以 border padding 区域为参考*/</span><br><span class="line">    background-image: </span><br><span class="line">        linear-gradient(to right, #fff, #fff),</span><br><span class="line">        linear-gradient(135deg, #f00, #ff0, #f0f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 基础前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>WebRTC实现本地视频通话 | 全流程详解</title>
      <link href="/2025/03/04/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/WebRTC%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E5%85%A8%E6%B5%81%E7%A8%8B/"/>
      <url>/2025/03/04/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/WebRTC%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E8%A7%86%E9%A2%91%E9%80%9A%E8%AF%9D%E5%85%A8%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="WebRTC-实现本地视频通话-全流程详解"><a href="#WebRTC-实现本地视频通话-全流程详解" class="headerlink" title="WebRTC 实现本地视频通话 | 全流程详解"></a>WebRTC 实现本地视频通话 | 全流程详解</h1><p>源码见仓库 <a href="https://github.com/Breezli/WebRTC_Demo">Breezli&#x2F;WebRTC_Demo: 基于 WebRTC 技术实现的本地网页端视频通话</a></p><p>分为前后端两个文件夹</p><blockquote><p>webrtc-client (客户端)</p><p>webrtc-server (服务端)</p></blockquote><h2 id="预先准备"><a href="#预先准备" class="headerlink" title="预先准备"></a>预先准备</h2><h3 id="webrtc-client"><a href="#webrtc-client" class="headerlink" title="webrtc-client"></a>webrtc-client</h3><p>前端页面绘制</p><p><code>依赖下载</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pnpm create vite@latest webrtc-client -- --template vue-ts</span><br><span class="line">pnpm install -D tailwindcss postcss autoprefixer</span><br><span class="line">npx tailwindcss init -p</span><br></pre></td></tr></table></figure><p><code>package.json</code>直通</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webrtc-client&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;module&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-tsc -b &amp;&amp; vite build&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;preview&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite preview&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;socket.io-client&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^4.8.1&quot;</span><span class="punctuation">,</span> <span class="comment">//重要依赖</span></span><br><span class="line"><span class="attr">&quot;vue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.5.13&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;@vitejs/plugin-vue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.2.1&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;@vue/tsconfig&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.7.0&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;autoprefixer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^10.4.20&quot;</span><span class="punctuation">,</span> <span class="comment">//自动添加css前缀</span></span><br><span class="line"><span class="attr">&quot;postcss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^8.4.49&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;tailwindcss&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.4.17&quot;</span><span class="punctuation">,</span> <span class="comment">//tailwindcss样式库</span></span><br><span class="line"><span class="attr">&quot;typescript&quot;</span><span class="punctuation">:</span> <span class="string">&quot;~5.6.2&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^6.0.5&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vue-tsc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.2.0&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><code>App.vue</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;div class=&quot;flex items-center flex-col text-center p-12 h-screen&quot;&gt;</span><br><span class="line">&lt;div class=&quot;relative h-full mb-4&quot;&gt;</span><br><span class="line">&lt;video</span><br><span class="line">ref=&quot;localVideo&quot;</span><br><span class="line">class=&quot;w-96 h-full bg-gray-200 mb-4 object-cover&quot;&gt;&lt;/video&gt;</span><br><span class="line">&lt;video</span><br><span class="line">ref=&quot;remoteVideo&quot;</span><br><span class="line">class=&quot;w-32 h-48 absolute bottom-0 right-0 object-cover&quot;&gt;&lt;/video&gt;</span><br><span class="line">&lt;div</span><br><span class="line">v-if=&quot;caller &amp;&amp; calling&quot;</span><br><span class="line">class=&quot;absolute top-2/3 left-36 flex flex-col items-center&quot;&gt;</span><br><span class="line">&lt;p class=&quot;mb-4 text-white&quot;&gt;等待对方接听...&lt;/p&gt;</span><br><span class="line">&lt;img</span><br><span class="line">@click=&quot;hangUp&quot;</span><br><span class="line">src=&quot;/refuse.svg&quot;</span><br><span class="line">class=&quot;w-16 cursor-pointer&quot;</span><br><span class="line">alt=&quot;&quot; /&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div</span><br><span class="line">v-if=&quot;called &amp;&amp; calling&quot;</span><br><span class="line">class=&quot;absolute top-2/3 left-32 flex flex-col items-center&quot;&gt;</span><br><span class="line">&lt;p class=&quot;mb-4 text-white&quot;&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line">&lt;div class=&quot;flex&quot;&gt;</span><br><span class="line">&lt;img</span><br><span class="line">@click=&quot;hangUp&quot;</span><br><span class="line">src=&quot;/refuse.svg&quot;</span><br><span class="line">class=&quot;w-16 cursor-pointer mr-4&quot;</span><br><span class="line">alt=&quot;&quot; /&gt;</span><br><span class="line">&lt;img</span><br><span class="line">@click=&quot;acceptCall&quot;</span><br><span class="line">src=&quot;/accept.svg&quot;</span><br><span class="line">class=&quot;w-16 cursor-pointer&quot;</span><br><span class="line">alt=&quot;&quot; /&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class=&quot;flex gap-2 mb-4&quot;&gt;</span><br><span class="line">&lt;button</span><br><span class="line">class=&quot;rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white&quot;</span><br><span class="line">@click=&quot;callRemote&quot;&gt;</span><br><span class="line">发起视频</span><br><span class="line">&lt;/button&gt;</span><br><span class="line">&lt;button</span><br><span class="line">class=&quot;rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white&quot;</span><br><span class="line">@click=&quot;hangUp&quot;&gt;</span><br><span class="line">挂断视频</span><br><span class="line">&lt;/button&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p><code>main.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>style.css</code> 这里使用了 tailwind 的样式库</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@tailwind</span> base;</span><br><span class="line"><span class="keyword">@tailwind</span> components;</span><br><span class="line"><span class="keyword">@tailwind</span> utilities;</span><br></pre></td></tr></table></figure><p><code>tailwind.config.js</code> 此配置文件中添加所有模板文件的路径</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">import(&#x27;tailwindcss&#x27;).Config</span>&#125; */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"><span class="attr">content</span>: [<span class="string">&#x27;./index.html&#x27;</span>, <span class="string">&#x27;./src/**/*.&#123;vue,js,ts,jsx,tsx&#125;&#x27;</span>],</span><br><span class="line"><span class="attr">theme</span>: &#123;</span><br><span class="line"><span class="attr">extend</span>: &#123;&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">plugins</span>: [],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到此前端页面绘制完成，可在 3000 端口可启动 node 服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm run start</span><br></pre></td></tr></table></figure><h3 id="webrtc-server"><a href="#webrtc-server" class="headerlink" title="webrtc-server"></a>webrtc-server</h3><p>初始化服务端项目</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm init</span><br></pre></td></tr></table></figure><p><code>socket.io</code> 封装了 websocket 应用创建服务</p><p><code>nodemon</code> 代码改变会自动重启(不用重复地开关)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install socket.io nodemon</span><br></pre></td></tr></table></figure><p><code>package.json</code> 添加<code>start</code>命令，使用<code>nodemon</code>启动项目</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nodemon index.js&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure><p>创建<code>index.js</code>（最初版，之后后端的所有操作都在这个文件上进行）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socket = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>) <span class="comment">//封装了websocket应用创建服务</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>) <span class="comment">//引入http模块</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>() <span class="comment">//创建服务器</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> io = <span class="title function_">socket</span>(server, &#123;</span><br><span class="line"><span class="attr">cors</span>: &#123;</span><br><span class="line"><span class="attr">origin</span>: <span class="string">&#x27;*&#x27;</span>, <span class="comment">// 配置跨域</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/////接下来的主体部分/////</span></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">sock</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接成功...&#x27;</span>)</span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;connectionSuccess&#x27;</span>) <span class="comment">// 向客户端发送连接成功的消息</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接断开&#x27;</span>)</span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;connectionFalse&#x27;</span>) <span class="comment">// 向客户端发送连接断开的消息</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/////接下来的主体部分/////</span></span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;服务器启动成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="插播-socket-重要概念"><a href="#插播-socket-重要概念" class="headerlink" title="!!!插播 socket 重要概念!!!"></a>!!!插播 socket 重要概念!!!</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.emit发送事件</span><br><span class="line">.on监听事件</span><br></pre></td></tr></table></figure><p>常见内置事件说明</p><table><thead><tr><th align="center">事件名称</th><th align="center">触发场景</th><th align="center">使用位置</th></tr></thead><tbody><tr><td align="center">connect</td><td align="center">客户端成功连接到服务端时</td><td align="center">客户端</td></tr><tr><td align="center">connection</td><td align="center">服务端接收到新客户端连接时</td><td align="center">服务端</td></tr><tr><td align="center">disconnect</td><td align="center">连接断开时</td><td align="center">客户端&#x2F;服务端</td></tr><tr><td align="center">error</td><td align="center">连接发生错误时</td><td align="center">客户端&#x2F;服务端</td></tr></tbody></table><p>后端至此搭建完成，可在 3000 端口可启动 node 服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm run start</span><br></pre></td></tr></table></figure><h2 id="前端连接信令服务器"><a href="#前端连接信令服务器" class="headerlink" title="前端连接信令服务器"></a>前端连接信令服务器</h2><p>依靠的就是<code>socket.io-client</code></p><p>接下来我们将在<code>App.vue</code>中开始编写脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, onMounted, onUnmounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; io, Socket &#125; from &#x27;socket.io-client&#x27;</span><br><span class="line"></span><br><span class="line">const socket = ref&lt;Socket&gt;() // 前端Socket实例</span><br><span class="line"></span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">const sock = io(&#x27;localhost:3000&#x27;) // 通过 io(&#x27;localhost:3000&#x27;) 创建的 Socket.IO 客户端实例</span><br><span class="line"></span><br><span class="line">// 连接成功</span><br><span class="line">sock.on(&#x27;connectionSuccess&#x27;, () =&gt; &#123;</span><br><span class="line">console.log(&#x27;连接成功&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">socket.value = sock // 存储Socket实例</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>还记得吗，就在前两步，后端在连接成功后向前端.emit(发送)了 connectionSuccess 事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">sock</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接成功...&#x27;</span>)</span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;connectionSuccess&#x27;</span>) <span class="comment">// 向客户端发送连接成功的消息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>而在此时的前端加入的</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;connectionSuccess&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 接收到服务端发来的connectionSuccess(连接成功)事件</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>前后端交互正式开始</p><h2 id="发起视频请求"><a href="#发起视频请求" class="headerlink" title="发起视频请求"></a>发起视频请求</h2><h3 id="获取本地音视频流"><a href="#获取本地音视频流" class="headerlink" title="获取本地音视频流"></a>获取本地音视频流</h3><p>前端</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getLocalStream</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> stream = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(&#123;</span><br><span class="line"><span class="comment">// 获取音视频流</span></span><br><span class="line"><span class="attr">video</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">audio</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line">localVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = stream <span class="comment">// 将媒体流设置到 video 标签上播放</span></span><br><span class="line">localVideo.<span class="property">value</span>!.<span class="title function_">play</span>() <span class="comment">// 播放音视频流</span></span><br><span class="line">localStream.<span class="property">value</span> = stream <span class="comment">// 存储本地流</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> stream</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="“房间”的概念"><a href="#“房间”的概念" class="headerlink" title="“房间”的概念"></a>“房间”的概念</h3><blockquote><p>不妨先停下来思考一下，为什么在同一个网页，不同的客户端可以看见不同的页面，和实时共享的内容</p></blockquote><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250205190246032.png" alt="image-20250205190246032" style="zoom: 33%;" /><p>我们先来看一看之前给前端写的组件（layout 省略版）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;video ref=&quot;localVideo&quot;&gt;&lt;/video&gt;</span><br><span class="line">//本地视频</span><br><span class="line">&lt;video ref=&quot;remoteVideo&quot;&gt;&lt;/video&gt;</span><br><span class="line">//接收方视频（位于右下角）</span><br><span class="line"></span><br><span class="line">&lt;div v-if=&quot;caller &amp;&amp; calling&quot;&gt;//状态参数---caller:发送方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;等待对方接听...&lt;/p&gt;</span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;//挂断</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div v-if=&quot;called &amp;&amp; calling&quot;&gt;//状态参数---called:接收方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;//挂断</span><br><span class="line">    &lt;img @click=&quot;acceptCall&quot; src=&quot;/accept.svg&quot;/&gt;//接听</span><br><span class="line"></span><br><span class="line">    &lt;button @click=&quot;callRemote&quot;&gt;发起视频&lt;/button&gt;</span><br><span class="line">    &lt;button @click=&quot;hangUp&quot;&gt;挂断视频&lt;/button&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><blockquote><p>不难发现我们是依靠状态参数来控制页面显示的</p></blockquote><p>本项目参数表如下</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> called = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 是否是接收方</span></span><br><span class="line"><span class="keyword">const</span> caller = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 是否是发起方</span></span><br><span class="line"><span class="keyword">const</span> calling = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 呼叫中</span></span><br><span class="line"><span class="keyword">const</span> communicating = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 视频通话中</span></span><br><span class="line"><span class="keyword">const</span> localVideo = ref&lt;<span class="title class_">HTMLVideoElement</span>&gt;() <span class="comment">// video标签实例，播放本人的视频</span></span><br><span class="line"><span class="keyword">const</span> remoteVideo = ref&lt;<span class="title class_">HTMLVideoElement</span>&gt;() <span class="comment">// video标签实例，播放对方的视频</span></span><br><span class="line"><span class="keyword">const</span> localStream = ref&lt;<span class="title class_">MediaStream</span>&gt;() <span class="comment">// 本地流</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> roomId = <span class="string">&#x27;001&#x27;</span> <span class="comment">// 房间ID</span></span><br></pre></td></tr></table></figure><p>顺便带上实例创建</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socket = ref&lt;<span class="title class_">Socket</span>&gt;() <span class="comment">// Socket实例</span></span><br><span class="line"><span class="keyword">const</span> peer = ref&lt;<span class="built_in">any</span>&gt;() <span class="comment">// RTCPeerConnection实例</span></span><br></pre></td></tr></table></figure><p>而对于我们这个项目，<code>房间</code>的概念就很简单</p><blockquote><p>A (左) 向 B (右) 发起接通请求，在 B 接收请求后，双方都将加入这个视频通话的”房间”</p><p>房间 可以通过自主分配 id 划分，每个房间也可以加入很多用户 (如直播系统)</p><p>服务端含有加入房间的操纵代码 sock.join(Id)</p></blockquote><h3 id="加入房间请求"><a href="#加入房间请求" class="headerlink" title="加入房间请求"></a>加入房间请求</h3><p>前端</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;connectionSuccess&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接服务器成功...&#x27;</span>)</span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;joinRoom&#x27;</span>, roomId) <span class="comment">// 前端发送加入房间事件</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>后端</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;joinRoom&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line">sock.<span class="title function_">join</span>(roomId) <span class="comment">// 加入房间</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="发起视频请求-1"><a href="#发起视频请求-1" class="headerlink" title="发起视频请求"></a>发起视频请求</h3><p><strong>A 方按钮触发函数</strong></p><p>前端</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">callRemote</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发起视频&#x27;</span>) <span class="comment">// 状态更新</span></span><br><span class="line">caller.<span class="property">value</span> = <span class="literal">true</span> <span class="comment">// 发送方标记</span></span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">true</span> <span class="comment">// 呼叫中</span></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getLocalStream</span>() <span class="comment">// 获取本地音视频流函数</span></span><br><span class="line">socket.<span class="property">value</span>?.<span class="title function_">emit</span>(<span class="string">&#x27;callRemote&#x27;</span>, roomId) <span class="comment">// 发送视频请求事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后端</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;callRemote&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 收到发送方的视频请求事件</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;receiveCall&#x27;</span>) <span class="comment">// 向这个房间中的所有人广播事件receiveCall</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>前端</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;receiveCall&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 房间内所有接收方监听到视频请求事件</span></span><br><span class="line"><span class="keyword">if</span> (!caller.<span class="property">value</span>) &#123;</span><br><span class="line"><span class="comment">// 非发起方</span></span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">true</span> <span class="comment">// 呼叫中</span></span><br><span class="line">called.<span class="property">value</span> = <span class="literal">true</span> <span class="comment">// 接收方标记</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>此时 A(发起)方启动摄像头和麦克风，并等待对方接听</p><p>B(接收)方出现 接听&#x2F;挂断 按钮</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div v-if=&quot;caller &amp;&amp; calling&quot;&gt;//状态参数---caller:发送方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;等待对方接听...&lt;/p&gt;</span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;//挂断</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div v-if=&quot;called &amp;&amp; calling&quot;&gt;//状态参数---called:接收方---calling:呼叫中</span><br><span class="line">    &lt;p&gt;收到视频邀请...&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">    &lt;img @click=&quot;hangUp&quot; src=&quot;/refuse.svg&quot;/&gt;//挂断</span><br><span class="line">    &lt;img @click=&quot;acceptCall&quot; src=&quot;/accept.svg&quot;/&gt;//接听</span><br><span class="line"></span><br><span class="line">    &lt;button @click=&quot;callRemote&quot;&gt;发起视频&lt;/button&gt;//发起</span><br><span class="line">    &lt;button @click=&quot;hangUp&quot;&gt;挂断视频&lt;/button&gt;//挂断</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><h3 id="接收-挂断-视频"><a href="#接收-挂断-视频" class="headerlink" title="接收 &#x2F; 挂断 视频"></a>接收 &#x2F; 挂断 视频</h3><p><strong><em>趁着现在，我们添上其他按钮绑定的函数</em></strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 挂断视频</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hangUp</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">socket.<span class="property">value</span>.<span class="title function_">emit</span>(<span class="string">&#x27;hangUp&#x27;</span>, roomId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收视频请求（接收方）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">acceptCall</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">socket.<span class="property">value</span>.<span class="title function_">emit</span>(<span class="string">&#x27;acceptCall&#x27;</span>, roomId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><em>接着来看后端怎么处理</em></strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 挂断视频</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;hangUp&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;hangUp&#x27;</span>) <span class="comment">// 向Id房间内所有人广播这个事件</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收视频请求</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;acceptCall&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;acceptCall&#x27;</span>) <span class="comment">// 向Id房间内所有人广播这个事件</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong><em>返回前端，处理我们接收到的 hangUp || acceptCall</em></strong></p><p><strong>挂断视频</strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;hangUp&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">reset</span>() <span class="comment">// 重置状态</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>重置状态函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">reset</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">called.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">caller.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">communicating.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">peer.<span class="property">value</span> = <span class="literal">null</span></span><br><span class="line">localVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = <span class="literal">null</span> <span class="comment">// 关闭本地视频</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = <span class="literal">null</span> <span class="comment">// 关闭远程视频</span></span><br><span class="line">localStream.<span class="property">value</span>?.<span class="title function_">getTracks</span>()[<span class="number">0</span>].<span class="title function_">stop</span>() <span class="comment">// 关闭本地流</span></span><br><span class="line"><span class="comment">// localStream.value = undefined // 关闭本地流（相同效果）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>接受视频请求</strong></p><p>而这个就变复杂了</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;acceptCall&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (caller.<span class="property">value</span>) &#123;</span><br><span class="line"><span class="comment">// 发送方</span></span><br><span class="line">peer.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>() <span class="comment">// 创建RTCPeerConnection对象</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="title function_">addStream</span>(localStream.<span class="property">value</span>) <span class="comment">// 添加本地音视频流</span></span><br><span class="line"></span><br><span class="line">peer.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 获取candidate信息</span></span><br><span class="line"><span class="keyword">if</span> (event.<span class="property">candidate</span>) &#123;</span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, &#123; roomId, <span class="attr">candidate</span>: event.<span class="property">candidate</span> &#125;) <span class="comment">// 向服务器发送candidate信息</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取对方的音视频流</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="property">onaddstream</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">communicating.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">// 拿到对方的视频流</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = event.<span class="property">stream</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="title function_">play</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成offer</span></span><br><span class="line"><span class="keyword">const</span> offer = <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">createOffer</span>(&#123;</span><br><span class="line"><span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>, <span class="comment">// 是否接收对方的音频</span></span><br><span class="line"><span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span>, <span class="comment">// 是否接收对方的视频</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(offer) <span class="comment">// 设置本地描述的offer</span></span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendOffer&#x27;</span>, &#123; roomId, offer &#125;) <span class="comment">// 发送offer</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="交换-SDP-信息和-candidate-信息"><a href="#交换-SDP-信息和-candidate-信息" class="headerlink" title="交换 SDP 信息和 candidate 信息"></a>交换 SDP 信息和 candidate 信息</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><strong><em>SDP</em></strong> ：WebRTC 的一种协议，用于描述<strong>设备支持的媒体格式</strong></p><p><strong><em>candidate</em></strong> ：网络信息</p><p><strong>媒体协商</strong> ：交换 SDP</p><p><strong>ICE</strong> ：WebRTC 的通信机制</p><img src="C:\Users\DELL\Desktop\WebRTC资料\WebRTC\讲义\04.png" alt="04" style="zoom: 50%;" /><p>工作原理</p><blockquote><p>1.双方收集本地网络地址（分 共有 | 私有）+ STUN 和 TURN 服务器获取候选地址</p><p>2.双方通过信令服务器交换这些候选地址</p><p>3.双方使用候选地址进行连接测试，确定最佳的可用地址，开始实时音视频通话</p></blockquote><h3 id="媒体协商"><a href="#媒体协商" class="headerlink" title="媒体协商"></a>媒体协商</h3><p><strong>接下来是最重要的信令交换步骤（WebRTC 核心）</strong></p><p>主要用到以下方法</p><p>媒体协商</p><blockquote><p>createOffer</p><p>createAnswer</p><p>setLocalDesccription</p><p>setRemoteDesccription</p></blockquote><p>重要事件</p><blockquote><p>onicecandidate</p><p>onaddstream</p></blockquote><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250113163924170.png" alt="image-20250113163924170" style="zoom:50%;" /><p>步骤流程重绘（可以对标号有个印象）</p><blockquote><p>预告：所有函数均在前端实现，后端起到向前端广播作用</p></blockquote><img src="E:\QQ缓存/IMG_20250205_220254.jpg" alt="IMG_20250205_220254" style="zoom: 25%;" /><p>紧接着接收方接收到对方同意的消息</p><h3 id="信息交换全程"><a href="#信息交换全程" class="headerlink" title="信息交换全程"></a>信息交换全程</h3><p>前端（发送方）</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;acceptCall&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (caller.<span class="property">value</span>) &#123;<span class="comment">// 发送方</span></span><br><span class="line">        peer.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>()<span class="comment">// 创建RTCPeerConnection对象</span></span><br><span class="line">        peer.<span class="property">value</span>.<span class="title function_">addStream</span>(localStream.<span class="property">value</span>)<span class="comment">// 添加本地音视频流</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取candidate信息</span></span><br><span class="line">        peer.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event.<span class="property">candidate</span>) &#123;</span><br><span class="line">                <span class="comment">// 向服务器发送candidate信息</span></span><br><span class="line">                sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, &#123; roomId, <span class="attr">candidate</span>: event.<span class="property">candidate</span> &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取对方的音视频流</span></span><br><span class="line">        peer.<span class="property">value</span>.<span class="property">onaddstream</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">            calling.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">            communicating.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 拿到对方的视频流</span></span><br><span class="line">            remoteVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = event.<span class="property">stream</span></span><br><span class="line">            remoteVideo.<span class="property">value</span>!.<span class="title function_">play</span>()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ---①---</span><br><span class="line">        <span class="keyword">const</span> offer = <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">createOffer</span>(&#123;<span class="comment">// 生成offer</span></span><br><span class="line">            <span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>, <span class="comment">// 是否接收对方的音频</span></span><br><span class="line">            <span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span>, <span class="comment">// 是否接收对方的视频</span></span><br><span class="line">        &#125;)</span><br><span class="line">        ---②---</span><br><span class="line">        <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(offer)<span class="comment">// 设置本地描述的offer</span></span><br><span class="line">        ---③---</span><br><span class="line">        sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendOffer&#x27;</span>, &#123; roomId, offer &#125;)<span class="comment">// 发送offer !!!注意,这里offer已经当参数传过去了!!!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>后端</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, <span class="function">(<span class="params">&#123; roomId, candidate &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;receiveCandidate&#x27;</span>, candidate) <span class="comment">// 向这个房间里所有人广播candidate信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendOffer&#x27;</span>, <span class="function">(<span class="params">&#123; roomId, offer &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// !!!offer在这里!!!</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;sendOffer&#x27;</span>, offer) <span class="comment">// 向这个房间里所有人广播offer信息 &amp;&amp; 向接收方发送这个offer</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>前端（接收方）</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendOffer&#x27;</span>, <span class="title function_">async</span> (<span class="attr">offer</span>: <span class="built_in">any</span>) =&gt; &#123;<span class="comment">// !!!offer传回前端(判断被标注的接收方)!!!</span></span><br><span class="line">    <span class="keyword">if</span> (called.<span class="property">value</span>) &#123;<span class="comment">// 接收方</span></span><br><span class="line">        <span class="keyword">const</span> stream = <span class="keyword">await</span> <span class="title function_">getLocalStream</span>()<span class="comment">// 获取本地音视频流</span></span><br><span class="line">        peer.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>()<span class="comment">// 接收方创建自己的RTCPeerConnection对象</span></span><br><span class="line">        peer.<span class="property">value</span>.<span class="title function_">addStream</span>(stream)<span class="comment">// 添加本地音视频流</span></span><br><span class="line"></span><br><span class="line">        peer.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;<span class="comment">// 获取candidate信息</span></span><br><span class="line">            <span class="keyword">if</span> (event.<span class="property">candidate</span>) &#123;</span><br><span class="line">                <span class="comment">// 向服务器发送candidate信息</span></span><br><span class="line">                sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, &#123; roomId, <span class="attr">candidate</span>: event.<span class="property">candidate</span> &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取对方的音视频流</span></span><br><span class="line">        peer.<span class="property">value</span>.<span class="property">onaddstream</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">            calling.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">            communicating.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 拿到对方的视频流</span></span><br><span class="line">            remoteVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = event.<span class="property">stream</span></span><br><span class="line">            remoteVideo.<span class="property">value</span>!.<span class="title function_">play</span>()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ---④---</span><br><span class="line">        <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setRemoteDescription</span>(offer)<span class="comment">// 设置远端描述信息</span></span><br><span class="line"></span><br><span class="line">        ---⑤---</span><br><span class="line">        <span class="keyword">const</span> answer = <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">createAnswer</span>()<span class="comment">// 生成answer</span></span><br><span class="line">        ---⑥---</span><br><span class="line">        <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(answer)<span class="comment">// 设置本地描述信息</span></span><br><span class="line">        ---⑦---</span><br><span class="line">        sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendAnswer&#x27;</span>, &#123; roomId, answer &#125;)<span class="comment">// 发送answer !!!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>后端</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, <span class="function">(<span class="params">&#123; roomId, candidate &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// !!!</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;receiveCandidate&#x27;</span>, candidate) <span class="comment">// 向这个房间里所有人广播candidate信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendAnswer&#x27;</span>, <span class="function">(<span class="params">&#123; roomId, answer &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;receiveAnswer&#x27;</span>, answer) <span class="comment">// 向这个房间里所有人广播answer信息 &amp;&amp; 向接收方发送这个answer</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>前端</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;receiveAnswer&#x27;</span>, <span class="function">(<span class="params"><span class="attr">answer</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (caller.<span class="property">value</span>) &#123;<span class="comment">// 发送方</span></span><br><span class="line">        ---⑧---</span><br><span class="line">        peer.<span class="property">value</span>.<span class="title function_">setRemoteDescription</span>(answer)<span class="comment">// 设置远端描述信息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>为了让文章不那么乱，最后再补一下<em>candidate</em></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;receiveCandidate&#x27;</span>, <span class="title function_">async</span> (<span class="attr">candidate</span>: <span class="built_in">any</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">addIceCandidate</span>(candidate) <span class="comment">// 添加candidate信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>一路下来是不是逻辑非常清晰明了 😁 (bushi)</p></blockquote><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>前端 (App.vue)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; io, <span class="title class_">Socket</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;socket.io-client&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> roomId = <span class="string">&#x27;001&#x27;</span> <span class="comment">// 房间ID</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> called = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 是否是接收方</span></span><br><span class="line"><span class="keyword">const</span> caller = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 是否是发起方</span></span><br><span class="line"><span class="keyword">const</span> calling = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 呼叫中</span></span><br><span class="line"><span class="keyword">const</span> communicating = ref&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>) <span class="comment">// 视频通话中</span></span><br><span class="line"><span class="keyword">const</span> localVideo = ref&lt;<span class="title class_">HTMLVideoElement</span>&gt;() <span class="comment">// video标签实例，播放本人的视频</span></span><br><span class="line"><span class="keyword">const</span> remoteVideo = ref&lt;<span class="title class_">HTMLVideoElement</span>&gt;() <span class="comment">// video标签实例，播放对方的视频</span></span><br><span class="line"><span class="keyword">const</span> localStream = ref&lt;<span class="title class_">MediaStream</span>&gt;() <span class="comment">// 本地流</span></span><br><span class="line"><span class="keyword">const</span> socket = ref&lt;<span class="title class_">Socket</span>&gt;() <span class="comment">// Socket实例</span></span><br><span class="line"><span class="keyword">const</span> peer = ref&lt;<span class="built_in">any</span>&gt;() <span class="comment">// RTCPeerConnection实例</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> sock = <span class="title function_">io</span>(<span class="string">&#x27;localhost:3001&#x27;</span>) <span class="comment">// 连接服务器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接成功</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;connectionSuccess&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 进入房间</span></span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;joinRoom&#x27;</span>, roomId)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收方监听收到视频请求事件</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;receiveCall&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!caller.<span class="property">value</span>) &#123;</span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">called.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送方收到同意视频事件</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;acceptCall&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (caller.<span class="property">value</span>) &#123;</span><br><span class="line"><span class="comment">// 发送方</span></span><br><span class="line"><span class="comment">// 创建RTCPeerConnection对象</span></span><br><span class="line">peer.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>()</span><br><span class="line"><span class="comment">// 添加本地音视频流</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="title function_">addStream</span>(localStream.<span class="property">value</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取candidate信息</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (event.<span class="property">candidate</span>) &#123;</span><br><span class="line"><span class="comment">// 向服务器发送candidate信息</span></span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, &#123; roomId, <span class="attr">candidate</span>: event.<span class="property">candidate</span> &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对方的音视频流</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="property">onaddstream</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">communicating.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">// 拿到对方的视频流</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = event.<span class="property">stream</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="title function_">play</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成offer</span></span><br><span class="line"><span class="keyword">const</span> offer = <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">createOffer</span>(&#123;</span><br><span class="line"><span class="attr">offerToReceiveAudio</span>: <span class="literal">true</span>, <span class="comment">// 是否接收对方的音频</span></span><br><span class="line"><span class="attr">offerToReceiveVideo</span>: <span class="literal">true</span>, <span class="comment">// 是否接收对方的视频</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 设置本地描述的offer</span></span><br><span class="line"><span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(offer)</span><br><span class="line"><span class="comment">// 发送offer</span></span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendOffer&#x27;</span>, &#123; roomId, offer &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收方收到offer</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendOffer&#x27;</span>, <span class="title function_">async</span> (<span class="attr">offer</span>: <span class="built_in">any</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (called.<span class="property">value</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> stream = <span class="keyword">await</span> <span class="title function_">getLocalStream</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收方创建自己的RTCPeerConnection对象</span></span><br><span class="line">peer.<span class="property">value</span> = <span class="keyword">new</span> <span class="title class_">RTCPeerConnection</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加本地音视频流</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="title function_">addStream</span>(stream)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取candidate信息</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="property">onicecandidate</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (event.<span class="property">candidate</span>) &#123;</span><br><span class="line"><span class="comment">// 向服务器发送candidate信息</span></span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, &#123; roomId, <span class="attr">candidate</span>: event.<span class="property">candidate</span> &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对方的音视频流</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="property">onaddstream</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 拿到对方的视频流</span></span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">communicating.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = event.<span class="property">stream</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="title function_">play</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置远端描述信息</span></span><br><span class="line"><span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setRemoteDescription</span>(offer)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成answer</span></span><br><span class="line"><span class="keyword">const</span> answer = <span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">createAnswer</span>()</span><br><span class="line"><span class="comment">// 设置本地描述信息</span></span><br><span class="line"><span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">setLocalDescription</span>(answer)</span><br><span class="line"><span class="comment">// 发送answer</span></span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;sendAnswer&#x27;</span>, &#123; roomId, answer &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送方收到接收方的answer</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;receiveAnswer&#x27;</span>, <span class="function">(<span class="params"><span class="attr">answer</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (caller.<span class="property">value</span>) &#123;</span><br><span class="line"><span class="comment">// 设置远端描述信息</span></span><br><span class="line">peer.<span class="property">value</span>.<span class="title function_">setRemoteDescription</span>(answer)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收candidate信息</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;receiveCandidate&#x27;</span>, <span class="title function_">async</span> (<span class="attr">candidate</span>: <span class="built_in">any</span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">await</span> peer.<span class="property">value</span>.<span class="title function_">addIceCandidate</span>(candidate) <span class="comment">// 添加candidate信息</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到挂断视频请求</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;hangUp&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">reset</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">socket.<span class="property">value</span> = sock</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取本地音视频流</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getLocalStream</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="comment">// 获取音视频流</span></span><br><span class="line"><span class="keyword">const</span> stream = <span class="keyword">await</span> navigator.<span class="property">mediaDevices</span>.<span class="title function_">getUserMedia</span>(&#123;</span><br><span class="line"><span class="attr">video</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="attr">audio</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 将媒体流设置到 video 标签上播放</span></span><br><span class="line">localVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = stream</span><br><span class="line"><span class="comment">// 播放音视频流</span></span><br><span class="line">localVideo.<span class="property">value</span>!.<span class="title function_">play</span>()</span><br><span class="line"><span class="comment">// 存储本地流</span></span><br><span class="line">localStream.<span class="property">value</span> = stream</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> stream</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发起视频请求（发起方）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">callRemote</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (calling.<span class="property">value</span> || communicating.<span class="property">value</span>) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line"><span class="comment">// 获取本地音视频流</span></span><br><span class="line"><span class="keyword">await</span> <span class="title function_">getLocalStream</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向服务器发送发起视频请求的事件</span></span><br><span class="line">caller.<span class="property">value</span> = <span class="literal">true</span></span><br><span class="line">socket.<span class="property">value</span>.<span class="title function_">emit</span>(<span class="string">&#x27;callRemote&#x27;</span>, roomId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收视频请求（接受方）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">acceptCall</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="comment">// 向服务器发送接受视频请求的事件</span></span><br><span class="line">socket.<span class="property">value</span>.<span class="title function_">emit</span>(<span class="string">&#x27;acceptCall&#x27;</span>, roomId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂断视频</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hangUp</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">socket.<span class="property">value</span>.<span class="title function_">emit</span>(<span class="string">&#x27;hangUp&#x27;</span>, roomId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态重置</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">reset</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">called.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">caller.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">calling.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">communicating.<span class="property">value</span> = <span class="literal">false</span></span><br><span class="line">peer.<span class="property">value</span> = <span class="literal">null</span></span><br><span class="line">localVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = <span class="literal">null</span> <span class="comment">// 关闭本地视频</span></span><br><span class="line">remoteVideo.<span class="property">value</span>!.<span class="property">srcObject</span> = <span class="literal">null</span> <span class="comment">// 关闭远程视频</span></span><br><span class="line">localStream.<span class="property">value</span>?.<span class="title function_">getTracks</span>()[<span class="number">0</span>].<span class="title function_">stop</span>() <span class="comment">// 关闭本地流</span></span><br><span class="line"><span class="comment">// localStream.value = undefined // 关闭本地流</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后端 (index.js)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socket = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> io = <span class="title function_">socket</span>(server, &#123;</span><br><span class="line"><span class="attr">cors</span>: &#123;</span><br><span class="line"><span class="attr">origin</span>: <span class="string">&#x27;*&#x27;</span>, <span class="comment">// 配置跨域</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">io.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">sock</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接成功...&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向客户端发送连接成功的消息</span></span><br><span class="line">sock.<span class="title function_">emit</span>(<span class="string">&#x27;connectionSuccess&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听客户端进入房间的事件</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;joinRoom&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 加入房间</span></span><br><span class="line">sock.<span class="title function_">join</span>(roomId)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到发送方的视频请求事件</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;callRemote&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 向这个房间中的人广播这个事件</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;receiveCall&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到接收方的同意视频事件</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;acceptCall&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 向这个房间中的人广播这个事件</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;acceptCall&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到发送方的offer</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendOffer&#x27;</span>, <span class="function">(<span class="params">&#123; roomId, offer &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 向接收方发送这个offer</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;sendOffer&#x27;</span>, offer)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到接收方的answer</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendAnswer&#x27;</span>, <span class="function">(<span class="params">&#123; roomId, answer &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 向这个房间中的人广播这个事件</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;receiveAnswer&#x27;</span>, answer)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到发送方的candidate信息</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;sendCandidate&#x27;</span>, <span class="function">(<span class="params">&#123; roomId, candidate &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 向这个房间中的人广播candidate信息</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;receiveCandidate&#x27;</span>, candidate)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到挂断视频请求</span></span><br><span class="line">sock.<span class="title function_">on</span>(<span class="string">&#x27;hangUp&#x27;</span>, <span class="function">(<span class="params">roomId</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 向这个房间中的人广播这个事件</span></span><br><span class="line">io.<span class="title function_">to</span>(roomId).<span class="title function_">emit</span>(<span class="string">&#x27;hangUp&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">3001</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;服务器启动成功&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="项目启动方式"><a href="#项目启动方式" class="headerlink" title="项目启动方式"></a>项目启动方式</h2><p>后端启动服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm start</span><br></pre></td></tr></table></figure><p>前端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pnpm install</span><br><span class="line">pnpm run dev</span><br></pre></td></tr></table></figure><h1 id="WebSocket-NestJS-升级项目-支持不同网络下视频通话"><a href="#WebSocket-NestJS-升级项目-支持不同网络下视频通话" class="headerlink" title="WebSocket+NestJS 升级项目 | 支持不同网络下视频通话"></a>WebSocket+NestJS 升级项目 | 支持不同网络下视频通话</h1><h2 id="项目架构重构"><a href="#项目架构重构" class="headerlink" title="项目架构重构"></a>项目架构重构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├── webrtc-client/       # Vue 前端</span><br><span class="line">│   ├── src/</span><br><span class="line">│   │   ├── App.vue      # 主界面</span><br><span class="line">│   │   └── webrtc.ts    # WebRTC 核心逻辑(从App.vue分离出来)</span><br><span class="line">├── webrtc-server/       # NestJS 后端</span><br><span class="line">│   ├── src/</span><br><span class="line">│   │   ├── signaling/   # 信令服务器模块</span><br><span class="line">│   │   └── main.ts      # 入口文件</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>TS + NodeJS实现axios</title>
      <link href="/2025/03/04/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0axios/"/>
      <url>/2025/03/04/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E4%BB%8E%E9%9B%B6%E5%AE%9E%E7%8E%B0axios/</url>
      
        <content type="html"><![CDATA[<h1 id="TS-NodeJS-实现-axios"><a href="#TS-NodeJS-实现-axios" class="headerlink" title="TS + NodeJS 实现 axios"></a>TS + NodeJS 实现 axios</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/alexjoverm/typescript-library-starter.git ts-axios</span><br></pre></td></tr></table></figure><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><blockquote><p>在浏览器端使用 XMLHttpRequest 对象通讯</p><p>Promise API</p><p>请求响应拦截器</p><p>请求数据和响应数据转换</p><p>请求的取消</p><p>JSON 数据的自动转换</p><p>客户端防止 XSRF</p></blockquote><p>框架工具</p><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250129205459495.png" alt="image-20250129205459495" style="zoom:67%;" /><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250129205721267.png" alt="image-20250129205721267" style="zoom:67%;" /><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250129205345604.png" alt="image-20250129205345604" style="zoom:80%;" /><h3 id="请求代码"><a href="#请求代码" class="headerlink" title="请求代码"></a>请求代码</h3><p>axios 最基本的操作</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">axios</span>(&#123;</span><br><span class="line"><span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line"><span class="attr">url</span>: <span class="string">&#x27;/simple/get&#x27;</span>,</span><br><span class="line"><span class="attr">params</span>: &#123;</span><br><span class="line"><span class="attr">a</span>: <span class="number">1</span>,</span><br><span class="line"><span class="attr">b</span>: <span class="number">2</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>创建入口文件</p><p><code>index.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">axios</span>(<span class="params">config</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> axios</span><br></pre></td></tr></table></figure><p><code>xhr.ts</code></p><blockquote><p><code>xhr</code> 函数用于发送 HTTP 请求的工具函数，基于 XMLHttpRequest API 实现，并提供了一个简单的接口来配置和发送请求。</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">xhr</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; data = <span class="literal">null</span>, url, method = <span class="string">&#x27;get&#x27;</span> &#125; = config <span class="comment">// 解构设置默认值</span></span><br><span class="line"><span class="keyword">const</span> request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>() <span class="comment">// 实例化一个 XMLHttpRequest 对象 并赋值给 request 变量</span></span><br><span class="line">request.<span class="title function_">open</span>(method.<span class="title function_">toUpperCase</span>(), url, <span class="literal">true</span>) <span class="comment">// 调用 open 方法 并传入 method url true 三个参数 并将 method 转换为大写并赋值给 method,url. async:true</span></span><br><span class="line">request.<span class="title function_">send</span>(data) <span class="comment">// 调用 send 方法 并传入 data 参数 并赋值给 request 变量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250130164413743.png" alt="image-20250130164413743"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h2 id="webpack-配置"><a href="#webpack-配置" class="headerlink" title="webpack 配置"></a>webpack 配置</h2><blockquote><p>webpack.config.js</p><p>整体导出一个对象，包含 mode（开发模式），entry，output，module，resolve，plugins 几个关键属性</p></blockquote><h3 id="entry"><a href="#entry" class="headerlink" title="entry"></a><em>entry</em></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">entry</span>: fs.<span class="title function_">readdirSync</span>(__dirname).<span class="title function_">reduce</span>(<span class="function">(<span class="params">entries, dir</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fullDir = path.<span class="title function_">join</span>(__dirname, dir)</span><br><span class="line">    <span class="keyword">const</span> entry = path.<span class="title function_">join</span>(fullDir, <span class="string">&#x27;app.ts&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (fs.<span class="title function_">statSync</span>(fullDir).<span class="title function_">isDirectory</span>() &amp;&amp; fs.<span class="title function_">existsSync</span>(entry)) &#123;</span><br><span class="line">        entries[dir] = [<span class="string">&#x27;webpack-hot-middleware/client&#x27;</span>, entry]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entries</span><br><span class="line">&#125;, &#123;&#125;),</span><br></pre></td></tr></table></figure><blockquote><p>entries 收集了多个目录的入口文件 (app.ts) ，并将每个入口引入一个用于热更新的文件</p><p>entries 是一个对象，key 为目录名</p></blockquote><h3 id="output"><a href="#output" class="headerlink" title="output"></a><em>output</em></h3><blockquote><p>将 entries 的 key 打包成 filename</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;__build__&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&#x27;/__build__/&#x27;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="module"><a href="#module" class="headerlink" title="module"></a><em>module</em></h3><blockquote><p>rules 定义一系列处理不同类型文件的规则</p><p>.ts :<code>tslint-loader</code> 进行预处理 (包括类型检查)</p><p>.tsx :<code>transpileOnly: true</code> 只进行编译而不进行类型检查</p><p>.css :<code>style-loader</code> 将 CSS 注入到 DOM 中，<code>css-loader</code> 处理 CSS 文件中的 <code>@import</code> 和 <code>url()</code></p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\.ts$/</span>,</span><br><span class="line">            <span class="attr">enforce</span>: <span class="string">&#x27;pre&#x27;</span>,</span><br><span class="line">            <span class="attr">use</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">loader</span>: <span class="string">&#x27;tslint-loader&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">            <span class="attr">use</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">loader</span>: <span class="string">&#x27;ts-loader&#x27;</span>,</span><br><span class="line">                    <span class="attr">options</span>: &#123;</span><br><span class="line">                        <span class="attr">transpileOnly</span>: <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">            <span class="attr">use</span>: [<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a><em>resolve</em></h3><blockquote><p>指定在导入模块时可以省略的文件扩展名，Webpack 会自动尝试这些扩展名。</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resolve</span>: &#123;</span><br><span class="line"><span class="attr">extensions</span>: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a><em>plugins</em></h3><blockquote><p>热更新 | 发生错误不打包文件</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugins</span>: [</span><br><span class="line"><span class="keyword">new</span> webpack.<span class="title class_">HotModuleReplacementPlugin</span>(),</span><br><span class="line"><span class="keyword">new</span> webpack.<span class="title class_">NoEmitOnErrorsPlugin</span>(),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h2><h3 id="处理-url-参数-params"><a href="#处理-url-参数-params" class="headerlink" title="处理 url 参数(params)"></a>处理 url 参数(params)</h3><blockquote><p>核心思想：把 params 的 key&amp;value <strong>解构拼接</strong>到 URL 上</p></blockquote><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210214938544.png" alt="image-20250210214938544" style="zoom: 50%;" /><p><code>helpers/url.ts</code></p><h4 id="解构-URL-params"><a href="#解构-URL-params" class="headerlink" title="解构 URL -&gt; params"></a>解构 URL -&gt; params</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">bulidURL</span>(<span class="params"><span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">params</span>?: <span class="built_in">any</span></span>): <span class="built_in">string</span> &#123;<span class="comment">//解构</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>需处理逻辑</strong></p><p><em>没有参数</em></p><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210215202014.png" alt="image-20250210215202014" style="zoom:50%;" /><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!params) &#123;</span><br><span class="line"><span class="comment">// 没有参数 直接返回 url</span></span><br><span class="line"><span class="keyword">return</span> url</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解构-params-key-value"><a href="#解构-params-key-value" class="headerlink" title="解构 params -&gt; key&#x2F;value"></a>解构 params -&gt; key&#x2F;value</h4><p>params 是一个包含请求参数的对象</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例</span></span><br><span class="line"><span class="keyword">const</span> params = &#123;</span><br><span class="line"><span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>,</span><br><span class="line"><span class="attr">age</span>: <span class="number">30</span>,</span><br><span class="line"><span class="attr">hobbies</span>: [<span class="string">&#x27;reading&#x27;</span>, <span class="string">&#x27;coding&#x27;</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体代码</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">parts</span>: <span class="built_in">string</span>[] = [] <span class="comment">// 存放参数的数组</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">keys</span>(params).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123; <span class="comment">// key 依次取到 &#x27;name&#x27;, &#x27;age&#x27;, &#x27;hobbies&#x27; 等值</span></span><br><span class="line">    <span class="keyword">const</span> val = params[key] <span class="comment">// 对象key值所对应的value</span></span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><em>value 为 null 或 undefined</em></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (val === <span class="literal">null</span> || <span class="keyword">typeof</span> val === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>value</em> 为 <em>数组</em></p><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210214959177.png" alt="image-20250210214959177" style="zoom:50%;" /><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> values = [] <span class="comment">// 定义 values 变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(val)) &#123;</span><br><span class="line"><span class="comment">// 如果 value 为数组 直接赋值给 values</span></span><br><span class="line">values = val</span><br><span class="line">key += <span class="string">&#x27;[]&#x27;</span> <span class="comment">// 键名后面添加一个 []</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">values = [val] <span class="comment">// 赋值给 values</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>value</em> 为 <em>Data</em> | <em>字符串</em> | <em>对象</em></p><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210215112025.png" alt="image-20250210215112025" style="zoom:50%;" /><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210215135428.png" alt="image-20250210215135428" style="zoom:50%;" /><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210215027145.png" alt="image-20250210215027145" style="zoom:50%;" /><p>helpers&#x2F;util.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toString = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isDate</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">any</span></span>): val is <span class="title class_">Date</span> &#123;</span><br><span class="line"><span class="keyword">return</span> toString.<span class="title function_">call</span>(val) === <span class="string">&#x27;[object Date]&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isObject</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">any</span></span>): val is <span class="title class_">Object</span> &#123;</span><br><span class="line"><span class="keyword">return</span> val !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> val === <span class="string">&#x27;object&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再回来</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isDate, isObject &#125; <span class="keyword">from</span> <span class="string">&#x27;./util&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">encode</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">encodeURIComponent</span>(val)</span><br><span class="line">.<span class="title function_">replace</span>(<span class="regexp">/%40/g</span>, <span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">.<span class="title function_">replace</span>(<span class="regexp">/%3A/gi</span>, <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">.<span class="title function_">replace</span>(<span class="regexp">/%24/g</span>, <span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">.<span class="title function_">replace</span>(<span class="regexp">/%2C/gi</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">.<span class="title function_">replace</span>(<span class="regexp">/%20/g</span>, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">.<span class="title function_">replace</span>(<span class="regexp">/%5B/gi</span>, <span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">.<span class="title function_">replace</span>(<span class="regexp">/%5D/gi</span>, <span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">values.<span class="title function_">forEach</span>(<span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 遍历 values</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isDate</span>(val)) &#123;</span><br><span class="line"><span class="comment">// value 为日期</span></span><br><span class="line">val = val.<span class="title function_">toISOString</span>() <span class="comment">// 转换为 ISO 格式赋值给 val</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isObject</span>(val)) &#123;</span><br><span class="line"><span class="comment">// value 为对象</span></span><br><span class="line">val = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(val) <span class="comment">// 转换为字符串赋值给 val</span></span><br><span class="line">&#125;</span><br><span class="line">parts.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;encode(key)&#125;</span>=<span class="subst">$&#123;encode(val)&#125;</span>`</span>) <span class="comment">// 特殊字符转码赋值给 parts</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>拼装成 URL</p><blockquote><p>parts.join(‘&amp;’) 效果</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;[<span class="string">&#x27;name=John&#x27;</span>, <span class="string">&#x27;age=30&#x27;</span>, <span class="string">&#x27;hobbies[]=reading&#x27;</span>, <span class="string">&#x27;hobbies[]=coding&#x27;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;name=John&amp;age=30&amp;hobbies[]=reading&amp;hobbies[]=coding&#x27;</span></span><br></pre></td></tr></table></figure></blockquote><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210215213939.png" alt="image-20250210215213939" style="zoom:50%;" /><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250210215227134.png" alt="image-20250210215227134" style="zoom:50%;" /><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> serializedParams = parts.<span class="title function_">join</span>(<span class="string">&#x27;&amp;&#x27;</span>) <span class="comment">// 将 parts 数组中的所有元素连接成一个字符串，并使用 &amp; 作为分隔符</span></span><br><span class="line"><span class="keyword">if</span> (serializedParams) &#123;</span><br><span class="line"><span class="comment">// 如果 serializedParams 不为空 则拼接 url</span></span><br><span class="line"><span class="keyword">const</span> markIndex = url.<span class="title function_">indexOf</span>(<span class="string">&#x27;#&#x27;</span>) <span class="comment">// 查找 URL 中是否存在 # 符号 返回 # 符号在 URL 中的位置索引</span></span><br><span class="line"><span class="keyword">if</span> (markIndex !== -<span class="number">1</span>) &#123;</span><br><span class="line">url = url.<span class="title function_">slice</span>(<span class="number">0</span>, markIndex) <span class="comment">// 使用slice方法将URL截取到哈希部分之前，从而去除哈希部分</span></span><br><span class="line">&#125;</span><br><span class="line">url += (url.<span class="title function_">indexOf</span>(<span class="string">&#x27;?&#x27;</span>) === -<span class="number">1</span> ? <span class="string">&#x27;?&#x27;</span> : <span class="string">&#x27;&amp;&#x27;</span>) + serializedParams <span class="comment">// 确保URL中的查询参数?存在</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理-body-数据"><a href="#处理-body-数据" class="headerlink" title="处理 body 数据"></a>处理 body 数据</h3><p>helpers&#x2F;util.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toString = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isDate</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">any</span></span>): val is <span class="title class_">Date</span> &#123;</span><br><span class="line"><span class="comment">// 判断是否为日期</span></span><br><span class="line"><span class="keyword">return</span> toString.<span class="title function_">call</span>(val) === <span class="string">&#x27;[object Date]&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export function isObject(val: any): val is Object &#123;  // 判断是否为对象</span></span><br><span class="line"><span class="comment">//   return val !== null &amp;&amp; typeof val === &#x27;object&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isPlainObject</span>(<span class="params"><span class="attr">val</span>: <span class="built_in">any</span></span>): val is <span class="title class_">Object</span> &#123;</span><br><span class="line"><span class="comment">// 判断是否为普通对象</span></span><br><span class="line"><span class="keyword">return</span> toString.<span class="title function_">call</span>(val) === <span class="string">&#x27;[object Object]&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>helpers&#x2F;data.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isPlainObject &#125; <span class="keyword">from</span> <span class="string">&#x27;./util&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">transformRequest</span>(<span class="params"><span class="attr">data</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(data)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processConfig</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 config</span></span><br><span class="line">config.<span class="property">url</span> = <span class="title function_">transformURL</span>(config)</span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequestData</span>(config)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformURL</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line"><span class="comment">// 处理 url 返回拼接后的 url</span></span><br><span class="line"><span class="keyword">const</span> &#123; url, params &#125; = config</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">bulidURL</span>(url, params)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformRequestData</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 data</span></span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequest</span>(config.<span class="property">data</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理-header"><a href="#处理-header" class="headerlink" title="处理 header"></a>处理 header</h3><blockquote><p>headers 一般传递诸如认证信息、内容类型等元数据给服务器</p></blockquote><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250212030911535.png" alt="image-20250212030911535" style="zoom:50%;" /><p>helpers&#x2F;header.ts</p><blockquote><p>处理 headers</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">processHeaders</span>(<span class="params"><span class="attr">headers</span>: <span class="built_in">any</span>, <span class="attr">data</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">// processHeaders 函数接收 headers 和 data 两个参数</span></span><br><span class="line"><span class="title function_">normalizeHeaderName</span>(headers, <span class="string">&#x27;Content-Type&#x27;</span>) <span class="comment">// 调用 normalizeHeaderName 函数将 headers 的 Content-Type 属性名规范化</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(data)) &#123;</span><br><span class="line"><span class="comment">// 如果 data 是一个普通对象</span></span><br><span class="line"><span class="keyword">if</span> (headers &amp;&amp; !headers[<span class="string">&#x27;Content-Type&#x27;</span>]) &#123;</span><br><span class="line"><span class="comment">// 如果 headers 不存在 Content-Type 属性</span></span><br><span class="line">headers[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;application/json;charset=utf-8&#x27;</span> <span class="comment">// 设置 Content-Type 属性为 application/json;charset=utf-8</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>Content-Type</code> 是 HTTP 请求头的一部分，用于指示实体主体（即请求或响应的正文部分）的数据类型。它告诉接收方如何解析接收到的数据。例如，当发送 JSON 格式的数据时，通常会将 <code>Content-Type</code> 设置为 <code>application/json</code>，这样接收方就知道应该以 JSON 的形式来解析数据</p></blockquote><p>辅助函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">normalizeHeaderName</span>(<span class="params"><span class="attr">headers</span>: <span class="built_in">any</span>, <span class="attr">normalizedName</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// normalizeHeaderName 函数接收 headers 和 normalizedName 两个参数</span></span><br><span class="line"><span class="keyword">if</span> (!headers) &#123;</span><br><span class="line"><span class="comment">// 如果 headers 不存在</span></span><br><span class="line"><span class="keyword">return</span> <span class="comment">// 直接返回</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">keys</span>(headers).<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 遍历 headers 的所有属性</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">name !== normalizedName &amp;&amp;</span><br><span class="line">name.<span class="title function_">toUpperCase</span>() === normalizedName.<span class="title function_">toUpperCase</span>()</span><br><span class="line">) &#123;</span><br><span class="line"><span class="comment">// 如果属性名不等于 normalizedName 并且属性名的大写形式等于 normalizedName 的大写形式</span></span><br><span class="line">headers[normalizedName] = headers[name] <span class="comment">// 将 headers 的属性名设置为 normalizedName (content-type -&gt; Content-Type)</span></span><br><span class="line"><span class="keyword">delete</span> headers[name] <span class="comment">// 删除 headers 的属性名</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> headers <span class="comment">// 返回 headers</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>types&#x2F;index.ts 加入 headers</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line"><span class="attr">url</span>: <span class="built_in">string</span></span><br><span class="line"><span class="attr">method</span>?: <span class="title class_">Method</span></span><br><span class="line"><span class="attr">data</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">params</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">headers</span>?: <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>index.ts 增添处理逻辑</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processConfig</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 config</span></span><br><span class="line">config.<span class="property">url</span> = <span class="title function_">transformURL</span>(config)</span><br><span class="line">config.<span class="property">headers</span> = <span class="title function_">transformHeaders</span>(config) <span class="comment">// 先处理 headers</span></span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequestData</span>(config) <span class="comment">// 再处理 data</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformHeaders</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">// 处理 headers 调用 processHeaders 方法</span></span><br><span class="line"><span class="keyword">const</span> &#123; headers = &#123;&#125;, data &#125; = config</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">processHeaders</span>(headers, data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xhr.ts 添加 header 处理逻辑</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">xhr</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; data = <span class="literal">null</span>, url, method = <span class="string">&#x27;get&#x27;</span>, headers &#125; = config <span class="comment">// 添加header解构</span></span><br><span class="line"><span class="keyword">const</span> request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>() <span class="comment">// 实例化一个 XMLHttpRequest 对象 并赋值给 request 变量</span></span><br><span class="line">request.<span class="title function_">open</span>(method.<span class="title function_">toUpperCase</span>(), url, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">keys</span>(headers).<span class="title function_">forEach</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 遍历 headers 的所有属性</span></span><br><span class="line"><span class="keyword">if</span> (data === <span class="literal">null</span> &amp;&amp; name.<span class="title function_">toLowerCase</span>() === <span class="string">&#x27;content-type&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">// 如果 data 为 null 并且属性名为 content-type</span></span><br><span class="line"><span class="keyword">delete</span> headers[name] <span class="comment">// 删除 headers 的属性名</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">request.<span class="title function_">setRequestHeader</span>(name, headers[name]) <span class="comment">// 调用 setRequestHeader 方法 并传入 name headers[name] 两个参数 并赋值给 request 变量</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">request.<span class="title function_">send</span>(data) <span class="comment">// 调用 send 方法 并传入 data 参数 并赋值给 request 变量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><blockquote><p>这部分处理实现了</p><p>为 Content-Type 自动添加 application&#x2F;json;charset&#x3D;UTF-8（告知服务端解析的是 JSON 数据）</p></blockquote><h3 id="获取处理-response"><a href="#获取处理-response" class="headerlink" title="获取处理 response"></a>获取处理 response</h3><p>types &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line"><span class="comment">//config接口</span></span><br><span class="line"><span class="attr">url</span>: <span class="built_in">string</span></span><br><span class="line"><span class="attr">method</span>?: <span class="title class_">Method</span></span><br><span class="line"><span class="attr">data</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">params</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">headers</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">responseType</span>?: <span class="title class_">XMLHttpRequestResponseType</span> <span class="comment">//新增</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosResponse</span> &#123;</span><br><span class="line"><span class="comment">//response接口</span></span><br><span class="line"><span class="attr">data</span>: <span class="built_in">any</span></span><br><span class="line"><span class="attr">status</span>: <span class="built_in">number</span></span><br><span class="line"><span class="attr">statusText</span>: <span class="built_in">string</span></span><br><span class="line"><span class="attr">headers</span>: <span class="built_in">any</span></span><br><span class="line"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span><br><span class="line"><span class="attr">request</span>: <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosPromise</span> <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;<span class="title class_">AxiosResponse</span>&gt; &#123;</span><br><span class="line"><span class="comment">//promise接口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xhr.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosPromise</span>, <span class="title class_">AxiosResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">xhr</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// xhr 函数接收一个 config 参数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> <span class="comment">// 返回一个 Promise 对象 并传入 resolve reject 两个参数</span></span><br><span class="line">    <span class="keyword">const</span> &#123; data = <span class="literal">null</span>, url, method = <span class="string">&#x27;get&#x27;</span>, headers, responseType &#125; = config <span class="comment">// 解构赋值拿到变量</span></span><br><span class="line">    <span class="keyword">const</span> request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>() <span class="comment">// 实例化一个 XMLHttpRequest 对象 并赋值给 request 变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (responseType) &#123;</span><br><span class="line">      request.<span class="property">responseType</span> = responseType</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    request.<span class="title function_">open</span>(method.<span class="title function_">toUpperCase</span>(), url, <span class="literal">true</span>) <span class="comment">// 调用 open 方法 并传入 method url true 三个参数 并将 method 转换为大写并赋值给 method,url. async:true异步</span></span><br><span class="line"></span><br><span class="line">    request.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> <span class="title function_">handleLoad</span>(<span class="params"></span>) &#123;<span class="comment">// 调用 onreadystatechange 方法 并传入 handleLoad 函数 并赋值给 request 变量</span></span><br><span class="line">      <span class="keyword">if</span> (request.<span class="property">readyState</span> !== <span class="number">4</span>) &#123;<span class="comment">// 4状态为正确接收到数据 (// 没有收到正确的响应)</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> responseHeaders = request.<span class="title function_">getAllResponseHeaders</span>() <span class="comment">// 调用 getAllResponseHeaders 方法 并赋值给 responseHeaders 变量（后面要处理这个字符串）</span></span><br><span class="line">      <span class="keyword">const</span> responseData = responseType &amp;&amp; responseType !== <span class="string">&#x27;text&#x27;</span> ? request.<span class="property">response</span> : request.<span class="property">responseText</span> <span class="comment">// 调用 responseText 方法 并赋值给 responseData 变量</span></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">response</span>: <span class="title class_">AxiosResponse</span> = &#123;</span><br><span class="line">        <span class="attr">data</span>: responseData,</span><br><span class="line">        <span class="attr">status</span>: request.<span class="property">status</span>,</span><br><span class="line">        <span class="attr">statusText</span>: request.<span class="property">statusText</span>,</span><br><span class="line">        <span class="attr">headers</span>: responseHeaders,</span><br><span class="line">        config,</span><br><span class="line">        request</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">resolve</span>(response) <span class="comment">// 调用 resolve 方法 并传入 response 参数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(headers).<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;<span class="comment">// 遍历 headers 的所有属性</span></span><br><span class="line">      <span class="keyword">if</span> (data === <span class="literal">null</span> &amp;&amp; name.<span class="title function_">toLowerCase</span>() === <span class="string">&#x27;content-type&#x27;</span>) &#123;<span class="comment">// 如果 data 为 null 并且属性名为 content-type</span></span><br><span class="line">        <span class="keyword">delete</span> headers[name] <span class="comment">// 删除 headers 的属性名</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.<span class="title function_">setRequestHeader</span>(name, headers[name]) <span class="comment">// 调用 setRequestHeader 方法 并传入 name headers[name] 两个参数 并赋值给 request 变量</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    request.<span class="title function_">send</span>(data) <span class="comment">// 调用 send 方法 并传入 data 参数 并赋值给 request 变量</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosPromise</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">axios</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="title class_">AxiosPromise</span> &#123;</span><br><span class="line"><span class="comment">// axios 函数接收一个 config 参数</span></span><br><span class="line"><span class="title function_">processConfig</span>(config)</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">xhr</span>(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getAllResponseHeaders</code>方法处理</p><p>XMLHttpRequest 对象的 getAllResponseHeaders 方法获取到的值是如下字符串</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">date<span class="punctuation">:</span>Fri<span class="punctuation">,</span><span class="number">05</span> Apr <span class="number">2019</span> <span class="number">12</span><span class="punctuation">:</span><span class="number">40</span><span class="punctuation">:</span><span class="number">49</span> GMT</span><br><span class="line">etag<span class="punctuation">:</span> W/<span class="string">&quot;d-Ssxx4FRxEutDLwo2+xkkxKc4y0k&#x27;&#x27;</span></span><br><span class="line"><span class="string">connection: keep-alive</span></span><br><span class="line"><span class="string">x-powered-by: Express</span></span><br><span class="line"><span class="string">content-length:13</span></span><br><span class="line"><span class="string">content-type:application/json;charset=utf-8</span></span><br></pre></td></tr></table></figure><blockquote><p>每一行都是以回车和换行符<code>\r\n</code>结束，是每个 header 属性的分隔符</p></blockquote><p>而我们希望解析成的对象结构</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    date<span class="punctuation">:</span>Fri<span class="punctuation">,</span><span class="number">05</span> Apr <span class="number">2019</span> <span class="number">12</span><span class="punctuation">:</span><span class="number">40</span><span class="punctuation">:</span><span class="number">49</span> GMT</span><br><span class="line">etag<span class="punctuation">:</span> W/<span class="string">&quot;d-Ssxx4FRxEutDLwo2+xkkxKc4y0k&#x27;&#x27;,</span></span><br><span class="line"><span class="string">connection: keep-alive,</span></span><br><span class="line"><span class="string">x-powered-by: Express,</span></span><br><span class="line"><span class="string">content-length:13</span></span><br><span class="line"><span class="string">content-type:application/json;charset=utf-8</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>headers.ts 新增 parseHeaders 方法</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHeaders</span>(<span class="params"><span class="attr">headers</span>: <span class="built_in">string</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">// parseHeaders 函数接收 headers 参数</span></span><br><span class="line"><span class="keyword">let</span> parsed = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>) <span class="comment">// 创建一个空对象</span></span><br><span class="line"><span class="keyword">if</span> (!headers) &#123;</span><br><span class="line"><span class="comment">// 如果 headers 不存在</span></span><br><span class="line"><span class="keyword">return</span> parsed <span class="comment">// 返回 parsed</span></span><br><span class="line">&#125;</span><br><span class="line">headers.<span class="title function_">split</span>(<span class="string">&#x27;\r\n&#x27;</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">line</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 遍历 headers 的每一行</span></span><br><span class="line"><span class="keyword">let</span> [key, val] = line.<span class="title function_">split</span>(<span class="string">&#x27;:&#x27;</span>) <span class="comment">// 分割每一行的 key 和 val</span></span><br><span class="line">key = key.<span class="title function_">trim</span>().<span class="title function_">toLowerCase</span>() <span class="comment">// 去掉 key 的空格并将 key 转换为小写</span></span><br><span class="line"><span class="keyword">if</span> (!key) &#123;</span><br><span class="line"><span class="comment">// 如果 key 不存在</span></span><br><span class="line"><span class="keyword">return</span> <span class="comment">// 直接返回</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (val) &#123;</span><br><span class="line"><span class="comment">// 如果 val 存在</span></span><br><span class="line">val = val.<span class="title function_">trim</span>() <span class="comment">// 去掉 val 的空格</span></span><br><span class="line">&#125;</span><br><span class="line">parsed[key] = val <span class="comment">// 将 key 和 val 赋值给 parsed</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> parsed <span class="comment">// 返回 parsed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理响应-data"><a href="#处理响应-data" class="headerlink" title="处理响应 data"></a>处理响应 data</h3><p>不设置 responseType 情况下，服务端返回数据是字符串类型</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data: &quot;&#123;&quot;a&quot;:1,&quot;b&quot;:2&#125;&quot;</span><br></pre></td></tr></table></figure><p>我们要转成对象</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    a<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    b<span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>data.ts 新增 transformResponse 转化函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">transformResponse</span>(<span class="params"><span class="attr">data</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> data === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"><span class="comment">// do nothing</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>index.ts 处理 axios</p><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; transformRequest, transformResponse &#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers/data&#x27;</span> <span class="comment">// 新增引入转化函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">axios</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="title class_">AxiosPromise</span> &#123;</span><br><span class="line"><span class="title function_">processConfig</span>(config)</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">xhr</span>(config).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">//请求结束后对 response data 进行处理</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">transformResponseData</span>(res)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformResponseData</span>(<span class="params"><span class="attr">res</span>: <span class="title class_">AxiosResponse</span></span>): <span class="title class_">AxiosResponse</span> &#123;</span><br><span class="line"><span class="comment">// 处理 response data</span></span><br><span class="line">res.<span class="property">data</span> = <span class="title function_">transformResponse</span>(res.<span class="property">data</span>)</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/// 基础核心功能至此已全部实现 ///</span><br></pre></td></tr></table></figure><h2 id="错误处理-reject-拒回"><a href="#错误处理-reject-拒回" class="headerlink" title="错误处理(reject 拒回)"></a>错误处理(reject 拒回)</h2><h3 id="处理网络错误"><a href="#处理网络错误" class="headerlink" title="处理网络错误"></a>处理网络错误</h3><p>网络不通时发送请求会触发 XMLHttpRequest 对象实例的 error 事件，所以我们可以在 onerror 事件回调函数中捕获此类错误</p><p>xhr.ts 中添加</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onerror</span> = <span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 调用 onerror 方法 并传入 handleError 函数 并赋值给 request 变量</span></span><br><span class="line"><span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Network Error&#x27;</span>)) <span class="comment">// 调用 reject 方法 并传入 Network Error 参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="处理超时错误"><a href="#处理超时错误" class="headerlink" title="处理超时错误"></a>处理超时错误</h3><p>设置一个 timeout，当请求超过某个时间后没收到响应则终止，并触发 timeout 事件</p><blockquote><p>默认超时时间为 0（永不超时，我们首先需要允许程序可配置超时时间</p></blockquote><p>type &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line"><span class="comment">//config接口</span></span><br><span class="line"><span class="attr">url</span>: <span class="built_in">string</span></span><br><span class="line"><span class="attr">method</span>?: <span class="title class_">Method</span></span><br><span class="line"><span class="attr">data</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">params</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">headers</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">responseType</span>?: <span class="title class_">XMLHttpRequestResponseType</span></span><br><span class="line"><span class="attr">timeout</span>?: <span class="built_in">number</span> <span class="comment">// 新增timeout</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>xhr.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">data = <span class="literal">null</span>,</span><br><span class="line">url,</span><br><span class="line">method = <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">headers,</span><br><span class="line">responseType,</span><br><span class="line">timeout,</span><br><span class="line">&#125; = config <span class="comment">// 新增解构</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增逻辑</span></span><br><span class="line"><span class="keyword">if</span> (timeout) &#123;</span><br><span class="line"><span class="comment">// 如果 timeout 存在</span></span><br><span class="line">request.<span class="property">timeout</span> = timeout</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request.<span class="property">ontimeout</span> = <span class="keyword">function</span> <span class="title function_">handleTimeout</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Timeout of <span class="subst">$&#123;timeout&#125;</span> ms exceeded`</span>)) <span class="comment">// 超过 $&#123;timeout&#125; 毫秒 超时</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="状态码处理-200-错误"><a href="#状态码处理-200-错误" class="headerlink" title="状态码处理(!200 错误)"></a>状态码处理(!200 错误)</h3><blockquote><p>处理时机：接收到响应的时候</p></blockquote><p>xhr.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> <span class="title function_">handleLoad</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (request.<span class="property">readyState</span> !== <span class="number">4</span>) &#123;</span><br><span class="line"><span class="comment">// 没有收到正确的响应</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//也就是在这里//</span></span><br><span class="line"><span class="keyword">if</span> (request.<span class="property">status</span> === <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 如果发送网络错误 || 超时错误</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">resolve</span>(response) <span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleResponse</span>(<span class="params"><span class="attr">response</span>: <span class="title class_">AxiosResponse</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 传入处理 response 参数</span></span><br><span class="line"><span class="keyword">if</span> (response.<span class="property">status</span> &gt;= <span class="number">200</span> &amp;&amp; response.<span class="property">status</span> &lt; <span class="number">300</span>) &#123;</span><br><span class="line"><span class="comment">// 状态码 大于等于 200 并且小于 300</span></span><br><span class="line"><span class="title function_">resolve</span>(response) <span class="comment">// 调用 resolve 方法 并传入 response 参数</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Request failed with status code <span class="subst">$&#123;response.status&#125;</span>`</span>)) <span class="comment">// 报错状态码</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="错误信息增强"><a href="#错误信息增强" class="headerlink" title="错误信息增强"></a>错误信息增强</h3><blockquote><p>按照之前的操作，我们实现了对基础错误信息的处理，但我们对外提供的错误信息是十分有限的</p><p>我们希望对外提供的错误信息包括</p><p>错误文本信息（报错显示）</p><p>请求对象配置 config</p><p>错误代码 code</p><p>XMLHttpRequest 对象实例 request</p><p>自定义响应对象 response</p></blockquote><h4 id="创建-AxiosError-类"><a href="#创建-AxiosError-类" class="headerlink" title="创建 AxiosError 类"></a>创建 AxiosError 类</h4><p>types &#x2F; index.ts 定义接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosError</span> <span class="keyword">extends</span> <span class="title class_">Error</span> &#123;</span><br><span class="line"><span class="comment">//error接口</span></span><br><span class="line"><span class="attr">isAxiosError</span>: <span class="built_in">boolean</span></span><br><span class="line"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span><br><span class="line"><span class="attr">code</span>?: <span class="built_in">string</span></span><br><span class="line"><span class="attr">request</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">response</span>?: <span class="title class_">AxiosResponse</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新建 helpers &#x2F; error.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AxiosError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line"><span class="comment">// 定义一个AxiosError类继承Error类 实现AxiosError接口 并设置 isAxiosError为true</span></span><br><span class="line"><span class="attr">isAxiosError</span>: <span class="built_in">boolean</span></span><br><span class="line"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span><br><span class="line"><span class="attr">code</span>?: <span class="built_in">string</span> | <span class="literal">null</span></span><br><span class="line"><span class="attr">request</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">response</span>?: <span class="title class_">AxiosResponse</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params"><span class="comment">//构造函数 接收五个参数赋值给对应的属性 并设置 isAxiosError为true</span></span></span><br><span class="line"><span class="params"><span class="attr">message</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>,</span></span><br><span class="line"><span class="params"><span class="attr">code</span>?: <span class="built_in">string</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params"><span class="attr">request</span>?: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params"><span class="attr">response</span>?: <span class="title class_">AxiosResponse</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">super</span>(message) <span class="comment">//调用父类的构造函数 传入message参数赋值给message属性</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">config</span> = config</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">code</span> = code</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">request</span> = request</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">response</span> = response</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">isAxiosError</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">setPrototypeOf</span>(<span class="variable language_">this</span>, <span class="title class_">AxiosError</span>.<span class="property"><span class="keyword">prototype</span></span>) <span class="comment">// 修复原型链问题</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createError</span>(<span class="params"> <span class="comment">//定义一个createError函数 接收五个参数 并返回一个AxiosError对象</span></span></span><br><span class="line"><span class="params"><span class="attr">message</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>,</span></span><br><span class="line"><span class="params"><span class="attr">code</span>?: <span class="built_in">string</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params"><span class="attr">request</span>?: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params"><span class="attr">response</span>?: <span class="title class_">AxiosResponse</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">AxiosError</span>(message, config, code, request, response)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="createError-方法应用"><a href="#createError-方法应用" class="headerlink" title="createError 方法应用"></a>createError 方法应用</h4><blockquote><p>对错误对象创建的逻辑进行修改</p></blockquote><p>xhr.ts</p><p><strong><em>onerror 修改</em></strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onerror</span> = <span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Network Error&#x27;</span>)) <span class="comment">// 调用 reject 方法 并传入 Network Error 参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>替换为</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">onerror</span> = <span class="keyword">function</span> <span class="title function_">handleError</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="title function_">reject</span>(<span class="title function_">createError</span>(<span class="string">&#x27;Network Error&#x27;</span>, config, <span class="literal">null</span>, request)) <span class="comment">// 传入 &#x27;Network Error&#x27;,config,null,request 参数（事件触发时拿不到response就不传了） 调用 createError 方法并传入参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><em>ontimeout 修改</em></strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">ontimeout</span> = <span class="keyword">function</span> <span class="title function_">handleTimeout</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 调用 ontimeout 方法 并传入 handleTimeout 函数 并赋值给 request 变量</span></span><br><span class="line"><span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Timeout of <span class="subst">$&#123;timeout&#125;</span> ms exceeded`</span>)) <span class="comment">// 调用 reject 方法 并传入 Timeout of $&#123;timeout&#125; ms exceeded 参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>替换为</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">request.<span class="property">ontimeout</span> = <span class="keyword">function</span> <span class="title function_">handleTimeout</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 调用 ontimeout 方法 并传入 handleTimeout 函数 并赋值给 request 变量</span></span><br><span class="line"><span class="title function_">reject</span>(</span><br><span class="line"><span class="title function_">createError</span>(</span><br><span class="line"><span class="string">`Timeout of <span class="subst">$&#123;timeout&#125;</span> ms exceeded`</span>,</span><br><span class="line">config,</span><br><span class="line"><span class="string">&#x27;ECONNABORTED&#x27;</span>,</span><br><span class="line">request</span><br><span class="line">)</span><br><span class="line">) <span class="comment">// 传入 `Timeout of $&#123;timeout&#125; ms exceeded`,config,&#x27;ECONNABORTED&#x27;,request 参数 调用 createError 方法 并传入参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><em>handleResponse 修改</em></strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleResponse</span>(<span class="params"><span class="attr">response</span>: <span class="title class_">AxiosResponse</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 传入处理 response 参数</span></span><br><span class="line"><span class="keyword">if</span> (response.<span class="property">status</span> &gt;= <span class="number">200</span> &amp;&amp; response.<span class="property">status</span> &lt; <span class="number">300</span>) &#123;</span><br><span class="line"><span class="comment">// 状态码 大于等于 200 并且小于 300</span></span><br><span class="line"><span class="title function_">resolve</span>(response) <span class="comment">// 调用 resolve 方法 并传入 response 参数</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Request failed with status code <span class="subst">$&#123;response.status&#125;</span>`</span>)) <span class="comment">// 调用 reject 方法 并传入 Request failed with status code $&#123;response.status&#125; 参数</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>替换为</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleResponse</span>(<span class="params"><span class="attr">response</span>: <span class="title class_">AxiosResponse</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 传入处理 response 参数</span></span><br><span class="line"><span class="keyword">if</span> (response.<span class="property">status</span> &gt;= <span class="number">200</span> &amp;&amp; response.<span class="property">status</span> &lt; <span class="number">300</span>) &#123;</span><br><span class="line"><span class="comment">// 状态码 大于等于 200 并且小于 300</span></span><br><span class="line"><span class="title function_">resolve</span>(response) <span class="comment">// 调用 resolve 方法 并传入 response 参数</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_">reject</span>(</span><br><span class="line"><span class="title function_">createError</span>(</span><br><span class="line"><span class="string">`Request failed with status code <span class="subst">$&#123;response.status&#125;</span>`</span>,</span><br><span class="line">config,</span><br><span class="line"><span class="literal">null</span>,</span><br><span class="line">request,</span><br><span class="line">response</span><br><span class="line">)</span><br><span class="line">) <span class="comment">// 传入 `Request failed with status code $&#123;response.status&#125;`,config,null,request,response 参数 调用 createError 方法 并传入参数</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="接口扩展"><a href="#接口扩展" class="headerlink" title="接口扩展"></a>接口扩展</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><blockquote><p>为了用户更加方便地使用 axios 发送请求，我们可以为所有支持的请求方法扩展一些接口</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[可选项]</span></span><br><span class="line">axios.<span class="property">request</span>(config)</span><br><span class="line">axios.<span class="property">get</span>(url[,config])</span><br><span class="line">axios.<span class="property">delete</span>(url[,config])</span><br><span class="line">axios.<span class="property">head</span>(url[,config])</span><br><span class="line">axios.<span class="property">options</span>(url[,config])</span><br><span class="line">axios.<span class="property">post</span>(url[,datal,config])</span><br><span class="line">axios.<span class="property">put</span>(url[,datal,config])</span><br><span class="line">axios.<span class="property">patch</span>(url[,datal,config])</span><br></pre></td></tr></table></figure><p>types &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line"><span class="comment">//axios接口</span></span><br><span class="line"><span class="title function_">request</span>(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line"><span class="title function_">get</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line"><span class="title function_">delete</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line"><span class="title function_">head</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line"><span class="title function_">options</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line"><span class="title function_">post</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line"><span class="title function_">put</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line"><span class="title function_">patch</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosInstance</span> <span class="keyword">extends</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line"><span class="comment">//axios实例接口 既有函数类型又有属性接口</span></span><br><span class="line">(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建-Axios-ts"><a href="#创建-Axios-ts" class="headerlink" title="创建 Axios.ts"></a>创建 Axios.ts</h3><blockquote><p>存放一些发送请求核心代码</p></blockquote><p>core &#x2F; Axios.ts &#x2F;&#x2F;大写表示是一个类</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosPromise</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line"><span class="title function_">request</span>(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;</span><br><span class="line"><span class="comment">// 实现request方法</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>core &#x2F; dispatchRequest.ts</p><blockquote><p>封装 axios.ts 核心代码</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosPromise</span>, <span class="title class_">AxiosResponse</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"><span class="keyword">import</span> xhr <span class="keyword">from</span> <span class="string">&#x27;../xhr&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; bulidURL &#125; <span class="keyword">from</span> <span class="string">&#x27;../helpers/url&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; transformRequest, transformResponse &#125; <span class="keyword">from</span> <span class="string">&#x27;../helpers/data&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; processHeaders &#125; <span class="keyword">from</span> <span class="string">&#x27;../helpers/header&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">dispatchRequest</span>(<span class="params"></span></span><br><span class="line"><span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">AxiosPromise</span> &#123;</span><br><span class="line"><span class="comment">// dispatchRequest 函数接收一个 config 参数</span></span><br><span class="line"><span class="title function_">processConfig</span>(config)</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">xhr</span>(config).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">//请求结束后对 response data 进行处理</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">transformResponseData</span>(res)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">processConfig</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 config</span></span><br><span class="line">config.<span class="property">url</span> = <span class="title function_">transformURL</span>(config)</span><br><span class="line">config.<span class="property">headers</span> = <span class="title function_">transformHeaders</span>(config) <span class="comment">// 先处理 headers</span></span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequestData</span>(config) <span class="comment">// 再处理 data</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformURL</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line"><span class="comment">// 处理 url 返回拼接后的 url</span></span><br><span class="line"><span class="keyword">const</span> &#123; url, params &#125; = config</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">bulidURL</span>(url, params)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformRequestData</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 data 调用 transformRequest 方法</span></span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequest</span>(config.<span class="property">data</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformHeaders</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">// 处理 headers 调用 processHeaders 方法</span></span><br><span class="line"><span class="keyword">const</span> &#123; headers = &#123;&#125;, data &#125; = config</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">processHeaders</span>(headers, data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformResponseData</span>(<span class="params"><span class="attr">res</span>: <span class="title class_">AxiosResponse</span></span>): <span class="title class_">AxiosResponse</span> &#123;</span><br><span class="line"><span class="comment">// 处理 response data</span></span><br><span class="line">res.<span class="property">data</span> = <span class="title function_">transformResponse</span>(res.<span class="property">data</span>)</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>然后将 xhr.ts 移入 core 文件夹（xhr 也作为核心模块）</p></blockquote><p><strong>部分报错修改</strong> (严格模式)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dispatchRequest.ts</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">bulidURL</span>(url!, params)</span><br><span class="line"></span><br><span class="line"><span class="comment">//xht.ts</span></span><br><span class="line">request.<span class="title function_">open</span>(method.<span class="title function_">toUpperCase</span>(), url!, <span class="literal">true</span>) <span class="comment">// 调用 open 方法传入 method url true 三个参数 并将 method 转换为大写并赋值给 method,url. async:true异步</span></span><br></pre></td></tr></table></figure><blockquote><p>Tips： 断言（ ! ）</p><blockquote><p>TS 中，当你保证某个变量不会为 <code>null</code> 或者 <code>undefined</code>，但编译器却无法推断出来的时候，就可以使用非空断言操作符 ( ! )，不会在运行时进行检查，但要是你做出了错误的保证，在运行时就可能会出现错误。</p></blockquote></blockquote><h3 id="实现-Axios-类中接口"><a href="#实现-Axios-类中接口" class="headerlink" title="实现 Axios 类中接口"></a>实现 Axios 类中接口</h3><p><code>Axios.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosPromise</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"><span class="keyword">import</span> dispatchRequest <span class="keyword">from</span> <span class="string">&#x27;./dispatchRequest&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line">  <span class="title function_">request</span>(...)</span><br><span class="line">  <span class="title function_">get</span>(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <strong><em>request</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">request</span>(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入config参数 并返回AxiosPromise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatchRequest</span>(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong><em>逻辑封装</em></strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_requestMethodWithoutData</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="title class_">Method</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span></span><br><span class="line">): <span class="title class_">AxiosPromise</span> &#123;</span><br><span class="line">    <span class="comment">// 封装_requestMethodWithoutData方法传入method,url和config参数 并返回AxiosPromise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(config || &#123;&#125;, &#123; method, url &#125;)) <span class="comment">// 调用request方法 并传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>实现 <strong><em>get</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">get</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入url和config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_requestMethodWithoutData</span>(<span class="string">&#x27;get&#x27;</span>, url, config) <span class="comment">// 调用方法 传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <strong><em>delete</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">delete</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入url和config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_requestMethodWithoutData</span>(<span class="string">&#x27;delete&#x27;</span>, url, config) <span class="comment">// 调用方法 传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <strong><em>head</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">head</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入url和config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_requestMethodWithoutData</span>(<span class="string">&#x27;head&#x27;</span>, url, config) <span class="comment">// 调用方法 并传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <strong><em>options</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">options</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入url和config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_requestMethodWithoutData</span>(<span class="string">&#x27;options&#x27;</span>, url, config) <span class="comment">// 调用方法 并传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong><em>逻辑封装</em></strong></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_requestMethodWithData</span>(</span><br><span class="line">    <span class="attr">method</span>: <span class="title class_">Method</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">data</span>?: <span class="built_in">any</span>,</span><br><span class="line">    <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span></span><br><span class="line">): <span class="title class_">AxiosPromise</span> &#123;</span><br><span class="line">    <span class="comment">// 封装_requestMethodWithData方法传入method,url,data和config参数 并返回AxiosPromise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(config || &#123;&#125;, &#123; method, url, data &#125;)) <span class="comment">// 调用request方法 并传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>实现 <strong><em>post</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">head</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入url,data和config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_requestMethodWithData</span>(<span class="string">&#x27;post&#x27;</span>, url, data, config) <span class="comment">// 调用方法 并传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <strong><em>put</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">put</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入url,data和config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_requestMethodWithData</span>(<span class="string">&#x27;put&#x27;</span>, url, data, config) <span class="comment">// 调用方法 并传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <strong><em>patch</em></strong> 接口</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">patch</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 传入url,data和config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_requestMethodWithData</span>(<span class="string">&#x27;patch&#x27;</span>, url, data, config) <span class="comment">// 调用方法 并传入一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="混合对象实现"><a href="#混合对象实现" class="headerlink" title="混合对象实现"></a>混合对象实现</h3><blockquote><p>首先这个对象是函数，其次这个对象包括 Axios 类内所有原型属性和实例属性</p></blockquote><p>helpers &#x2F; utils</p><blockquote><p><code>extend</code> 合成函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例</span></span><br><span class="line"><span class="keyword">const</span> target = &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> source = &#123; <span class="attr">b</span>: <span class="number">2</span> &#125;</span><br><span class="line"><span class="keyword">const</span> result = <span class="title function_">extend</span>(target, source)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result) <span class="comment">// 输出: &#123; a: 1, b: 2 &#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>这里我们使用**<em>泛型</em>** <code>T</code> 和 <code>U</code></p><p><code>T</code> 代表目标对象 <code>to</code> 的类型，<code>U</code> 代表源对象 <code>from</code> 的类型</p><p>函数的返回值类型是 <code>T &amp; U</code>，也就是 <code>to</code> 和 <code>from</code> 两个对象类型的交集。</p></blockquote></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> extend&lt;T, U&gt;(<span class="attr">to</span>: T, <span class="attr">from</span>: U): T &amp; U &#123;</span><br><span class="line"><span class="comment">// 合并对象</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="keyword">from</span>) &#123;</span><br><span class="line">;(to <span class="keyword">as</span> T &amp; U)[key] = <span class="keyword">from</span>[key] <span class="keyword">as</span> <span class="built_in">any</span> <span class="comment">//把 from 对象的属性值赋值给 to 对象对应的属性。这里运用了类型断言 as T &amp; U 和 as any，让 TypeScript 编译器认可这种赋值操作。</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> to <span class="keyword">as</span> T &amp; U <span class="comment">//也用了类型断言 as T &amp; U</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工厂函数实现"><a href="#工厂函数实现" class="headerlink" title="工厂函数实现"></a>工厂函数实现</h3><p>处理 axios.ts</p><blockquote><p>删掉内容，只保留 export default axios</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosInstance</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Axios</span> <span class="keyword">from</span> <span class="string">&#x27;./core/Axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; extend &#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers/util&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createInstance</span>(<span class="params"></span>): <span class="title class_">AxiosInstance</span> &#123;</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> <span class="title class_">Axios</span>() <span class="comment">//实例化一个 Axios 对象 并赋值给 context 变量</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span>.<span class="title function_">bind</span>(context) <span class="comment">//调用 request 方法 并传入 context 参数 并赋值给 instance 变量 绑定 this 指向 context</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">extend</span>(instance, context) <span class="comment">//调用 extend 方法 并传入 instance 和 context 参数 实现 instance 对象继承 context 对象</span></span><br><span class="line"><span class="keyword">return</span> instance <span class="keyword">as</span> <span class="title class_">AxiosInstance</span> <span class="comment">//返回 instance 对象 并断言为 AxiosInstance 类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> axios = <span class="title function_">createInstance</span>() <span class="comment">//调用 createInstance 方法 并赋值给 axios 变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> axios</span><br></pre></td></tr></table></figure><h3 id="axios-函数重载"><a href="#axios-函数重载" class="headerlink" title="axios 函数重载"></a>axios 函数重载</h3><blockquote><p>目前我们函数只能存放一个对象</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line">url: &#x27;/extend/post&#x27;,</span><br><span class="line">method: &#x27;post&#x27;,</span><br><span class="line">data:&#123;</span><br><span class="line">msg:&#x27;hi&#x27;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>那么如果 axios 同时含有两个参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">axios(&#x27;/extend/post&#x27;,&#123;</span><br><span class="line">method: &#x27;post&#x27;,</span><br><span class="line">data:&#123;</span><br><span class="line">msg:&#x27;hi&#x27;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></blockquote><p>type &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosInstance</span> <span class="keyword">extends</span> <span class="title class_">Axios</span> &#123;<span class="comment">//axios实例接口 既有函数类型又有属性接口</span></span><br><span class="line">  (<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromis</span>) <span class="comment">//(config单参)</span></span><br><span class="line">  (<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> <span class="comment">//添加：函数重载(url+config双参)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>core &#x2F; Axios.ts</p><blockquote><p>修改 request 方法</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">request</span>(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 实现request方法传入config参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatchRequest</span>(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改为 👇</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">request</span>(<span class="attr">url</span>: <span class="built_in">any</span>, <span class="attr">config</span>: <span class="built_in">any</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 实现request方法传入url？config？参数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> url === <span class="string">&#x27;string&#x27;</span>) &#123; <span class="comment">//url+config双参</span></span><br><span class="line">        <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">            config = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        config.<span class="property">url</span> = url</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//config单参</span></span><br><span class="line">        config = url <span class="comment">//此时的url就是config</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatchRequest</span>(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="响应数据支持泛型"><a href="#响应数据支持泛型" class="headerlink" title="响应数据支持泛型"></a>响应数据支持泛型</h3><blockquote><p>通常情况，我们会将后端返回数据格式单独放入一个接口中</p></blockquote><p>设置泛型，提高类型灵活性</p><p>type &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosResponse</span>&lt;T = <span class="built_in">any</span>&gt; &#123; <span class="comment">//response接口</span></span><br><span class="line">    <span class="attr">data</span>: T</span><br><span class="line">    <span class="attr">status</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="attr">statusText</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">headers</span>: <span class="built_in">any</span></span><br><span class="line">    <span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span><br><span class="line">    <span class="attr">request</span>: <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosPromise</span>&lt;T = <span class="built_in">any</span>&gt; <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;<span class="title class_">AxiosResponse</span>&lt;T&gt;&gt; &#123; <span class="comment">//promise接口</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Axios</span> &#123; <span class="comment">//axios接口</span></span><br><span class="line">    request&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span>&lt;T&gt;</span><br><span class="line">    get&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span>&lt;T&gt;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosInstance</span> <span class="keyword">extends</span> <span class="title class_">Axios</span> &#123; <span class="comment">//axios实例接口 既有函数类型又有属性接口</span></span><br><span class="line">&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span>&lt;T&gt;</span><br><span class="line">&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosPromise</span>&lt;T&gt; <span class="comment">//函数重载</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="拦截器实现"><a href="#拦截器实现" class="headerlink" title="拦截器实现"></a>拦截器实现</h2><blockquote><p>也就是 axios 二次封装中常见的请求拦截器 &amp; 响应拦截器</p><p>我们先回顾一下用户 asios 拦截器是怎么写的</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">baseURL</span>:<span class="string">&#x27;/api</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">instance.interceptors.request.use(res =&gt;&#123;//请求拦截器</span></span><br><span class="line"><span class="string">    console.log(&#x27;</span>res<span class="string">&#x27;,res)</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">instance.interceptors.response.use(res =&gt;&#123;//响应拦截器</span></span><br><span class="line"><span class="string">    console.log(&#x27;</span>res<span class="string">&#x27;,res)</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default instance</span></span><br></pre></td></tr></table></figure><p>Tip：request 是后添加的先执行，response 是先添加的先执行</p></blockquote><h3 id="拦截器管理类"><a href="#拦截器管理类" class="headerlink" title="拦截器管理类"></a>拦截器管理类</h3><p>types &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosInterceptorManager</span>&lt;T&gt; &#123;</span><br><span class="line"><span class="comment">//拦截器接口</span></span><br><span class="line"><span class="title function_">use</span>(<span class="attr">resolved</span>: <span class="title class_">ResolvedFn</span>&lt;T&gt;, <span class="attr">rejected</span>?: <span class="title class_">RejectedFn</span>): <span class="built_in">number</span> <span class="comment">//添加拦截器 返回拦截器id</span></span><br><span class="line"><span class="title function_">eject</span>(<span class="attr">id</span>: <span class="built_in">number</span>): <span class="built_in">void</span> <span class="comment">//删除拦截器 返回拦截器id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ResolvedFn</span>&lt;T = <span class="built_in">any</span>&gt; &#123;</span><br><span class="line"><span class="comment">//成功拦截器接口</span></span><br><span class="line">(<span class="attr">val</span>: T): T | <span class="title class_">Promise</span>&lt;T&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">RejectedFn</span> &#123;</span><br><span class="line"><span class="comment">//失败拦截器接口</span></span><br><span class="line">(<span class="attr">error</span>: <span class="built_in">any</span>): <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>core &#x2F; interceptorManager.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ResolvedFn</span>, <span class="title class_">RejectedFn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Interceptor</span>&lt;T&gt; &#123;</span><br><span class="line"><span class="comment">// 拦截器接口</span></span><br><span class="line"><span class="attr">resolved</span>: <span class="title class_">ResolvedFn</span>&lt;T&gt;</span><br><span class="line"><span class="attr">rejected</span>?: <span class="title class_">RejectedFn</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">InterceptorManager</span>&lt;T&gt; &#123;</span><br><span class="line"><span class="comment">// 拦截器管理类</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">interceptors</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Interceptor</span>&lt;T&gt;&gt; <span class="comment">// 拦截器数组存放的是拦截器对象 每个对象有两个属性 resolved rejected</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 构造函数 初始化拦截器数组</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">interceptors</span> = [] <span class="comment">// 拦截器数组中存放的是拦截器对象</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">use</span>(<span class="attr">resolved</span>: <span class="title class_">ResolvedFn</span>&lt;T&gt;, <span class="attr">rejected</span>?: <span class="title class_">RejectedFn</span>): <span class="built_in">number</span> &#123;</span><br><span class="line"><span class="comment">// 添加拦截器</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line"><span class="comment">// 将拦截器对象添加到拦截器数组中</span></span><br><span class="line">resolved,</span><br><span class="line">rejected,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">length</span> - <span class="number">1</span> <span class="comment">// 返回拦截器的id 用于删除拦截器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">forEach</span>(<span class="attr">fn</span>: <span class="function">(<span class="params"><span class="attr">interceptor</span>: <span class="title class_">Interceptor</span>&lt;T&gt;</span>) =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 遍历拦截器</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">interceptor</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 遍历拦截器数组</span></span><br><span class="line"><span class="keyword">if</span> (interceptor !== <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">// 判断拦截器是否存在</span></span><br><span class="line"><span class="title function_">fn</span>(interceptor) <span class="comment">// 存在则调用fn函数</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">eject</span>(<span class="attr">id</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 删除拦截器 通过id删除拦截器</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">interceptors</span>[id]) &#123;</span><br><span class="line"><span class="comment">// 判断拦截器是否存在</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">interceptors</span>[id] = <span class="literal">null</span> <span class="comment">// 存在则将拦截器置为null</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="链式调用实现"><a href="#链式调用实现" class="headerlink" title="链式调用实现"></a>链式调用实现</h3><p>core &#x2F; Axios.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosPromise</span>,<span class="title class_">AxiosResponse</span>, <span class="title class_">Method</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">InterceptorManager</span> <span class="keyword">from</span> <span class="string">&#x27;./interceptorManager&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Interceptors</span> &#123;</span><br><span class="line">    <span class="attr">request</span>: <span class="title class_">InterceptorManager</span>&lt;<span class="title class_">AxiosRequestConfig</span>&gt;</span><br><span class="line">    <span class="attr">response</span>: <span class="title class_">InterceptorManager</span>&lt;<span class="title class_">AxiosResponse</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line">    <span class="attr">interceptors</span>: <span class="title class_">Interceptors</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interceptors</span> = &#123; <span class="comment">//用户可以通过axios.interceptors.request.use()添加拦截器</span></span><br><span class="line">            <span class="attr">request</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>&lt;<span class="title class_">AxiosRequestConfig</span>&gt;(),</span><br><span class="line">            <span class="attr">response</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>&lt;<span class="title class_">AxiosResponse</span>&gt;()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">request</span>(...)...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完善 request (实现调用链)</p><blockquote><p><img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20250218152615640.png" alt="image-20250218152615640"></p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosPromise</span>, <span class="title class_">AxiosResponse</span>, <span class="title class_">Method</span>,<span class="title class_">ResolvedFn</span>,<span class="title class_">RejectedFn</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">PromiseChain</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="attr">resolved</span>: <span class="title class_">ResolvedFn</span>&lt;T&gt; | (<span class="function">(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>) =&gt;</span> <span class="title class_">AxiosPromise</span>)<span class="comment">//resolved是一个函数类型 接收一个AxiosRequestConfig类型的参数 返回一个AxiosPromise类型的参数</span></span><br><span class="line">    <span class="attr">rejected</span>?: <span class="title class_">RejectedFn</span> <span class="comment">//rejected是一个函数类型 接收一个AxiosRequestConfig类型的参数 返回一个AxiosPromise类型的参数</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="title function_">request</span>(<span class="attr">url</span>: <span class="built_in">any</span>, <span class="attr">config</span>: <span class="built_in">any</span>): <span class="title class_">AxiosPromise</span> &#123;<span class="comment">// 实现request方法传入参数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> url === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">            config = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        config.<span class="property">url</span> = url</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        config = url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">chain</span>:<span class="title class_">PromiseChain</span>&lt;<span class="built_in">any</span>&gt;[] = [</span><br><span class="line">        &#123;<span class="comment">// 创建一个数组chain</span></span><br><span class="line">            <span class="attr">resolved</span>: dispatchRequest,</span><br><span class="line">            <span class="attr">rejected</span>: <span class="literal">undefined</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">interceptor</span> =&gt;</span> &#123;<span class="comment">// 遍历request拦截器</span></span><br><span class="line">        chain.<span class="title function_">unshift</span>(interceptor) <span class="comment">// 将拦截器添加到chain数组的开头</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">interceptor</span> =&gt;</span> &#123;<span class="comment">// 遍历response拦截器</span></span><br><span class="line">        chain.<span class="title function_">push</span>(interceptor) <span class="comment">// 将拦截器添加到chain数组的末尾</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">let</span> promise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(config) <span class="comment">// 创建一个promise对象 并传入config参数</span></span><br><span class="line">    <span class="keyword">while</span> (chain.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="comment">// 遍历chain数组</span></span><br><span class="line">        <span class="keyword">const</span> &#123; resolved, rejected &#125; = chain.<span class="title function_">shift</span>()! <span class="comment">// 取出chain数组的第一个元素</span></span><br><span class="line">              promise = promise.<span class="title function_">then</span>(resolved, rejected) <span class="comment">// 将promise对象的then方法传入resolved和rejected参数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatchRequest</span>(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="合并用户配置"><a href="#合并用户配置" class="headerlink" title="合并用户配置"></a>合并用户配置</h2><blockquote><p>用户在发送请求时可以传入一个配置来决定请求的不同行为</p><p>甚至可以直接修改一些默认配置 (defaults)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="property">defaults</span>.<span class="property">headers</span>.<span class="property">common</span>[<span class="string">&#x27;test&#x27;</span>] = <span class="number">123</span> <span class="comment">//默认对任何类型的请求的header都添加test属性</span></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">headers</span>.<span class="property">post</span>[<span class="string">&#x27;Content-Type&#x27;</span>] =</span><br><span class="line"><span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span> <span class="comment">//默认对post请求的header都添加Content-Type属性</span></span><br><span class="line">axios.<span class="property">defaults</span>.<span class="property">timeout</span> = <span class="number">2000</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="默认配置设置"><a href="#默认配置设置" class="headerlink" title="默认配置设置"></a>默认配置设置</h3><p>defaults.ts 配置默认请求</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">defaults</span>: <span class="title class_">AxiosRequestConfig</span> = &#123;</span><br><span class="line"><span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line"><span class="attr">timeout</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="attr">common</span>: &#123;</span><br><span class="line"><span class="title class_">Accept</span>: <span class="string">&#x27;application/json, text/plain, */*&#x27;</span>, <span class="comment">//通用的请求头 接受的响应类型为json/plain文本*/*表示任意类型 优先级最低</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> methodsNoData = [<span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;head&#x27;</span>, <span class="string">&#x27;options&#x27;</span>]</span><br><span class="line"></span><br><span class="line">methodsNoData.<span class="title function_">forEach</span>(<span class="function">(<span class="params">method</span>) =&gt;</span> &#123;</span><br><span class="line">defaults.<span class="property">headers</span>[method] = &#123;&#125; <span class="comment">//没有数据的请求头 优先级高于通用的请求头</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> methodsWithData = [<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>]</span><br><span class="line"></span><br><span class="line">methodsWithData.<span class="title function_">forEach</span>(<span class="function">(<span class="params">method</span>) =&gt;</span> &#123;</span><br><span class="line">defaults.<span class="property">headers</span>[method] = &#123;</span><br><span class="line"><span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>, <span class="comment">//表单提交的请求头 优先级高于通用的请求头</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defaults</span><br></pre></td></tr></table></figure><p>core &#x2F; Axios.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line">    <span class="attr">defaults</span>: <span class="title class_">AxiosRequestConfig</span></span><br><span class="line">    <span class="attr">interceptors</span>: <span class="title class_">Interceptors</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">initConfig</span>?: <span class="title class_">AxiosRequestConfig</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">defaults</span> = initConfig <span class="comment">// 初始化defaults属性</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interceptors</span> = &#123;</span><br><span class="line">            <span class="comment">//用户可以通过axios.interceptors.request.use()添加拦截器</span></span><br><span class="line">            <span class="attr">request</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>&lt;<span class="title class_">AxiosRequestConfig</span>&gt;(),</span><br><span class="line">            <span class="attr">response</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>&lt;<span class="title class_">AxiosResponse</span>&gt;()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>types &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line">    <span class="attr">defaults</span>: <span class="title class_">AxiosRequestConfig</span> <span class="comment">//默认配置</span></span><br><span class="line">    <span class="attr">interceptors</span>: &#123; <span class="comment">//拦截器</span></span><br><span class="line">        <span class="attr">request</span>: <span class="title class_">AxiosInterceptorManager</span>&lt;<span class="title class_">AxiosRequestConfig</span>&gt;</span><br><span class="line">        <span class="attr">response</span>: <span class="title class_">AxiosInterceptorManager</span>&lt;<span class="title class_">AxiosResponse</span>&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重写 axios.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosInstance</span>, <span class="title class_">AxiosRequestConfig</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Axios</span> <span class="keyword">from</span> <span class="string">&#x27;./core/Axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; extend &#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers/util&#x27;</span></span><br><span class="line"><span class="keyword">import</span> defaults <span class="keyword">from</span> <span class="string">&#x27;./defaults&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createInstance</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="title class_">AxiosInstance</span> &#123;</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> <span class="title class_">Axios</span>(config) <span class="comment">//创建一个 Axios 实例 并传入 config 参数 并赋值给 context 变量</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span>.<span class="title function_">bind</span>(context) <span class="comment">//调用 request 方法 并传入 context 参数 并赋值给 instance 变量 绑定 this 指向 context</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">extend</span>(instance, context) <span class="comment">//调用 extend 方法 并传入 instance 和 context 参数 实现 instance 对象继承 context 对象</span></span><br><span class="line"><span class="keyword">return</span> instance <span class="keyword">as</span> <span class="title class_">AxiosInstance</span> <span class="comment">//返回 instance 对象 并断言为 AxiosInstance 类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> axios = <span class="title function_">createInstance</span>(defaults) <span class="comment">//调用 createInstance 方法 并传入 defaults 参数 并赋值给 axios 变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> axios</span><br></pre></td></tr></table></figure><h3 id="合并策略实现"><a href="#合并策略实现" class="headerlink" title="合并策略实现"></a>合并策略实现</h3><p>创建 core &#x2F; mergeConfig.ts</p><blockquote><p><code>config1</code> 为默认配置</p><p><code>config2</code> 代表用户传入的自定义配置</p><blockquote><p>实现示例 (假设 <code>config1</code> 和 <code>config2</code> 如下：)</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config1 = &#123;</span><br><span class="line"><span class="attr">timeout</span>: <span class="number">1000</span>,</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config2 = &#123;</span><br><span class="line"><span class="attr">timeout</span>: <span class="number">2000</span>,</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="title class_">Authorization</span>: <span class="string">&#x27;Bearer token&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>合并 <code>timeout</code> 属性时，<code>val1</code> 就是 <code>config1.timeout</code> 的值 <code>1000</code>，<code>val2</code> 就是 <code>config2.timeout</code> 的值 <code>2000</code>。</p></blockquote></blockquote><h4 id="timeout-逻辑"><a href="#timeout-逻辑" class="headerlink" title="timeout 逻辑"></a>timeout 逻辑</h4><p>mergeConfig.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> strats = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>) <span class="comment">//合并策略 key为属性名 value为合并策略函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defaultStrat</span>(<span class="params"><span class="attr">val1</span>: <span class="built_in">any</span>, <span class="attr">val2</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">//默认合并策略</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">typeof</span> val2 !== <span class="string">&#x27;undefined&#x27;</span> ? val2 : val1 <span class="comment">//优先取val2 如果val2不存在则取val1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fromVal2Strat</span>(<span class="params"><span class="attr">val1</span>: <span class="built_in">any</span>, <span class="attr">val2</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> val2 !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">//忽略val1 只取val2</span></span><br><span class="line"><span class="keyword">return</span> val2</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stratKeysFromVal2 = [<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;params&#x27;</span>, <span class="string">&#x27;data&#x27;</span>]</span><br><span class="line"></span><br><span class="line">stratKeysFromVal2.<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">//对于url params data属性 只取val2</span></span><br><span class="line">strats[key] = fromVal2Strat</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">mergeConfig</span>(<span class="params"></span></span><br><span class="line"><span class="params"><span class="attr">config1</span>: <span class="title class_">AxiosRequestConfig</span>,</span></span><br><span class="line"><span class="params"><span class="attr">config2</span>?: <span class="title class_">AxiosRequestConfig</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!config2) &#123;</span><br><span class="line">config2 = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> config = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>) <span class="comment">//合并后的配置结果</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> config2) &#123;</span><br><span class="line"><span class="title function_">mergeField</span>(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> config1) &#123;</span><br><span class="line"><span class="keyword">if</span> (!config2[key]) &#123;</span><br><span class="line"><span class="title function_">mergeField</span>(key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergeField</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="keyword">const</span> strat = strats[key] || defaultStrat <span class="comment">//合并策略</span></span><br><span class="line">config[key] = <span class="title function_">strat</span>(config1[key], config2![key])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>types &#x2F; index.ts 添加自动索引</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    [<span class="attr">propName</span>: <span class="built_in">string</span>]: <span class="built_in">any</span> <span class="comment">//字符串自动索引</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="headers-逻辑"><a href="#headers-逻辑" class="headerlink" title="headers 逻辑"></a>headers 逻辑</h4><h5 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deepMergeStrat</span>(<span class="params"><span class="attr">val1</span>: <span class="built_in">any</span>, <span class="attr">val2</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(val2)) &#123;</span><br><span class="line"><span class="comment">//如果val2是对象</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">deepMerge</span>(val1, val2) <span class="comment">//递归合并</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> val2 !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">//如果val2不是对象 且val2存在</span></span><br><span class="line"><span class="keyword">return</span> val2</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(val1)) &#123;</span><br><span class="line"><span class="comment">//如果val2不是对象 且val2不存在 且val1是对象</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">deepMerge</span>(val1) <span class="comment">//递归合并</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> val1 !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">//如果val2不是对象 且val2不存在 且val1不是对象 且val1存在</span></span><br><span class="line"><span class="keyword">return</span> val1</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>deepMerge 工具函数实现</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">deepMerge</span>(<span class="params">...<span class="attr">objs</span>: <span class="built_in">any</span>[]</span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">// 深度合并对象</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">objs.<span class="title function_">forEach</span>(<span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (obj) &#123;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">const</span> val = obj[key]</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(val)) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isPlainObject</span>(result[key])) &#123;</span><br><span class="line">result[key] = <span class="title function_">deepMerge</span>(result[key], val)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">result[key] = <span class="title function_">deepMerge</span>(val)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">result[key] = val</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在请求中应用函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">request</span>(<span class="attr">url</span>: <span class="built_in">any</span>, <span class="attr">config</span>: <span class="built_in">any</span>): <span class="title class_">AxiosPromise</span> &#123; <span class="comment">// 实现request方法传入参数</span></span><br><span class="line">    。。。</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> url === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">            config = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        config.<span class="property">url</span> = url</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        config = url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送请求之前应用</span></span><br><span class="line">    config = <span class="variable language_">this</span>.<span class="title function_">mergeConfig</span>(<span class="variable language_">this</span>.<span class="property">defaults</span>,config) <span class="comment">// 合并config</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">chain</span>:<span class="title class_">PromiseChain</span>&lt;<span class="built_in">any</span>&gt;[] = [</span><br><span class="line">        &#123;<span class="comment">// 创建一个数组chain</span></span><br><span class="line">            <span class="attr">resolved</span>: dispatchRequest,</span><br><span class="line">            <span class="attr">rejected</span>: <span class="literal">undefined</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">    。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h5><blockquote><p>合并后的 headers 是一个复杂对象，多了 common、post、get 等属性</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">headers:&#123;</span><br><span class="line">    common:&#123;</span><br><span class="line">    Accept:&#x27;application/json,text/plain,*/*&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    post: &#123;</span><br><span class="line">    &#x27;Content-Type&#x27;:&#x27;application/x-www-form-urlencoded&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们需要压缩成一级</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">headers:&#123;</span><br><span class="line">Accept:&#x27;application/json,text/plain,*/*&#x27;,</span><br><span class="line">&#x27;Content-Type&#x27;:&#x27;application/x-www-form-urlencoded&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tip：对于 comman 中定义的 header 字段，我们都要提取，而对于 post、get 这类提取，需要和该次请求的方法对应。</p></blockquote><p>headers.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flattenHeaders</span>(<span class="params"><span class="attr">headers</span>: <span class="built_in">any</span>, <span class="attr">method</span>: <span class="title class_">Method</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">// flattenHeaders 函数接收 headers 和 method 参数 将 headers 中的属性名规范化 并删除不必要的属性 并返回一个新的 headers 对象</span></span><br><span class="line"><span class="keyword">if</span> (!headers) &#123;</span><br><span class="line"><span class="comment">// 如果 headers 不存在</span></span><br><span class="line"><span class="keyword">return</span> headers <span class="comment">// 返回 headers</span></span><br><span class="line">&#125;</span><br><span class="line">headers = <span class="title function_">deepMerge</span>(headers, <span class="literal">null</span>) <span class="comment">// 调用 deepMerge 函数将 headers 深度合并</span></span><br><span class="line"><span class="keyword">const</span> methodsToDelete = [</span><br><span class="line"><span class="comment">// 定义一个数组 methodsToDelete 存储需要删除的 headers 属性名</span></span><br><span class="line"><span class="string">&#x27;delete&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;get&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;head&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;options&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;post&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;put&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;patch&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;common&#x27;</span>,</span><br><span class="line">]</span><br><span class="line">methodsToDelete.<span class="title function_">forEach</span>(<span class="function">(<span class="params">method</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// 遍历 methodsToDelete 数组</span></span><br><span class="line"><span class="keyword">delete</span> headers[method] <span class="comment">// 删除 headers 的属性名</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> headers <span class="comment">// 返回 headers</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dispatchRequest.ts 应用函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processConfig</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 config</span></span><br><span class="line">config.<span class="property">url</span> = <span class="title function_">transformURL</span>(config)</span><br><span class="line">config.<span class="property">headers</span> = <span class="title function_">transformHeaders</span>(config) <span class="comment">// 先处理 headers</span></span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequestData</span>(config) <span class="comment">// 再处理 data</span></span><br><span class="line">config.<span class="property">headers</span> = <span class="title function_">flattenHeaders</span>(config.<span class="property">headers</span>, config.<span class="property">method</span>!) <span class="comment">//处理 headers 扁平化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="更多配置"><a href="#更多配置" class="headerlink" title="更多配置"></a>更多配置</h3><h4 id="transfromRequest-transfromResponse"><a href="#transfromRequest-transfromResponse" class="headerlink" title="transfromRequest &amp; transfromResponse"></a>transfromRequest &amp; transfromResponse</h4><blockquote><p>官方 axios 中提供<code>transfromRequest</code>&amp;<code>transfromResponse</code>，值为**<em>一个数组或一个函数</em>**</p><p>这两个属性允许用户在 <strong>数据发送到服务器之前</strong>(只适用于 put、post、patch，而且可以修改 headers 对象) &#x2F; <strong>把响应数据传递给 then 或 catch 之前</strong> 对其修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line">    transformRequest: [</span><br><span class="line">        (function(data) &#123;</span><br><span class="line">            return qs.stringify(data); // 自定义的 transformRequest</span><br><span class="line">        &#125;),</span><br><span class="line">        ...axios.defaults.transformRequest // 保留默认的 transformRequest</span><br><span class="line">    ],</span><br><span class="line">    transformResponse: [</span><br><span class="line">        ...axios.defaults.transformResponse, // 展开默认的 transformResponse</span><br><span class="line">        function(data) &#123;</span><br><span class="line">            if (typeof data === &#x27;object&#x27;) &#123; // 自定义的 transformResponse</span><br><span class="line">                data.b = 2; // 修改响应数据</span><br><span class="line">            &#125;</span><br><span class="line">            return data;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    url: &#x27;/config/post&#x27;, // 请求的 URL</span><br><span class="line">    method: &#x27;post&#x27;, // 请求方法</span><br><span class="line">    data: &#123;</span><br><span class="line">        a: 1 // 请求的数据</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></blockquote><h5 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a>定义接口</h5><p>types &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line"><span class="comment">//config接口</span></span><br><span class="line"><span class="attr">url</span>: <span class="built_in">string</span></span><br><span class="line"><span class="attr">method</span>?: <span class="title class_">Method</span></span><br><span class="line"><span class="attr">data</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">params</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">headers</span>?: <span class="built_in">any</span></span><br><span class="line"><span class="attr">responseType</span>?: <span class="title class_">XMLHttpRequestResponseType</span></span><br><span class="line"><span class="attr">timeout</span>?: <span class="built_in">number</span></span><br><span class="line"><span class="attr">transformRequest</span>?: <span class="title class_">AxiosTransformer</span> | <span class="title class_">AxiosTransformer</span>[] <span class="comment">//请求数据转换函数</span></span><br><span class="line"><span class="attr">transformResponse</span>?: <span class="title class_">AxiosTransformer</span> | <span class="title class_">AxiosTransformer</span>[] <span class="comment">//响应数据转换函数</span></span><br><span class="line"></span><br><span class="line">[<span class="attr">propName</span>: <span class="built_in">string</span>]: <span class="built_in">any</span> <span class="comment">//字符串自动索引</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosTransformer</span> &#123;</span><br><span class="line"><span class="comment">//转换接口</span></span><br><span class="line">(<span class="attr">data</span>: <span class="built_in">any</span>, <span class="attr">headers</span>?: <span class="built_in">any</span>): <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>defaults.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; processHeaders &#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers/header&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; transformRequest, transformResponse &#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers/data&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">defaults</span>: <span class="title class_">AxiosRequestConfig</span> = &#123;</span><br><span class="line"><span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line"><span class="attr">timeout</span>: <span class="number">0</span>,</span><br><span class="line"><span class="attr">headers</span>: &#123;</span><br><span class="line"><span class="attr">common</span>: &#123;</span><br><span class="line"><span class="title class_">Accept</span>: <span class="string">&#x27;application/json, text/plain, */*&#x27;</span>, <span class="comment">//通用的请求头 接受的响应类型为json/plain文本*/*表示任意类型 优先级最低</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="attr">transformRequest</span>: [</span><br><span class="line"><span class="keyword">function</span> (<span class="params"><span class="attr">data</span>: <span class="built_in">any</span>, <span class="attr">headers</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="title function_">processHeaders</span>(headers, data) <span class="comment">//处理请求头</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">transformRequest</span>(data) <span class="comment">//处理请求数据</span></span><br><span class="line">&#125;,</span><br><span class="line">],</span><br><span class="line"><span class="attr">transformResponse</span>: [</span><br><span class="line"><span class="keyword">function</span> (<span class="params"><span class="attr">data</span>: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">transformResponse</span>(data) <span class="comment">//处理响应数据</span></span><br><span class="line">&#125;,</span><br><span class="line">],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="重构-transform-逻辑"><a href="#重构-transform-逻辑" class="headerlink" title="重构 transform 逻辑"></a>重构 transform 逻辑</h5><p>core &#x2F; transform.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosTransformer</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">transform</span>(<span class="params"> <span class="comment">//transform函数接收data headers fns三个参数</span></span></span><br><span class="line"><span class="params"><span class="attr">data</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params"><span class="attr">headers</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params"><span class="attr">fns</span>?: <span class="title class_">AxiosTransformer</span> | <span class="title class_">AxiosTransformer</span>[]</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!fns) &#123;</span><br><span class="line"><span class="comment">//如果没有传入fns 直接返回data</span></span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(fns)) &#123;</span><br><span class="line"><span class="comment">//如果fns不是数组 将其转为数组</span></span><br><span class="line">fns = [fns]</span><br><span class="line">&#125;</span><br><span class="line">fns.<span class="title function_">forEach</span>(<span class="function">(<span class="params">fn</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">//遍历fns数组 依次调用fn函数</span></span><br><span class="line">data = <span class="title function_">fn</span>(data, headers)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>core &#x2F; dispatchRequest.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> transform <span class="keyword">from</span> <span class="string">&#x27;./transform&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processConfig</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 config</span></span><br><span class="line">config.<span class="property">url</span> = <span class="title function_">transformURL</span>(config)</span><br><span class="line">config.<span class="property">headers</span> = <span class="title function_">transformHeaders</span>(config) <span class="comment">// 先处理 headers</span></span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequestData</span>(config) <span class="comment">// 再处理 data</span></span><br><span class="line">config.<span class="property">headers</span> = <span class="title function_">flattenHeaders</span>(config.<span class="property">headers</span>, config.<span class="property">method</span>!) <span class="comment">//处理 headers 扁平化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改为 👇</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processConfig</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 config</span></span><br><span class="line">config.<span class="property">url</span> = <span class="title function_">transformURL</span>(config)</span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transform</span>(config.<span class="property">data</span>, config.<span class="property">headers</span>, config.<span class="property">transformRequest</span>) <span class="comment">//处理 data</span></span><br><span class="line">config.<span class="property">headers</span> = <span class="title function_">flattenHeaders</span>(config.<span class="property">headers</span>, config.<span class="property">method</span>!) <span class="comment">//处理 headers 扁平化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>删掉不用的东西</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; transformRequest, transformResponse &#125; <span class="keyword">from</span> <span class="string">&#x27;../helpers/data&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformRequestData</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line"><span class="comment">// 处理 data 调用 transformRequest 方法</span></span><br><span class="line">config.<span class="property">data</span> = <span class="title function_">transformRequest</span>(config.<span class="property">data</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transformHeaders</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line"><span class="comment">// 处理 headers 调用 processHeaders 方法</span></span><br><span class="line"><span class="keyword">const</span> &#123; headers = &#123;&#125;, data &#125; = config</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">processHeaders</span>(headers, data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改逻辑</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">transformResponseData</span>(<span class="params"><span class="attr">res</span>: <span class="title class_">AxiosResponse</span></span>): <span class="title class_">AxiosResponse</span> &#123;</span><br><span class="line"><span class="comment">// 处理 response data</span></span><br><span class="line">res.<span class="property">data</span> = <span class="title function_">transform</span>(res.<span class="property">data</span>, res.<span class="property">headers</span>, res.<span class="property">config</span>.<span class="property">transformResponse</span>)</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="create"><a href="#create" class="headerlink" title="create"></a>create</h4><blockquote><p>目前为止，我们的 axios 都是一个单例，一旦我们修改了 axios 的默认配置，会影响所有的请求。我们希望提供了一个<code>axios.create</code>的静态接口允许我们创建一个新的 axios 实例，同时允许我们传入新的配置和默认配置合并，并做为新的默认配置。</p></blockquote><h5 id="扩展新的接口"><a href="#扩展新的接口" class="headerlink" title="扩展新的接口"></a>扩展新的接口</h5><p>types &#x2F; index.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosStatic</span> <span class="keyword">extends</span> <span class="title class_">AxiosInstance</span> &#123;</span><br><span class="line"><span class="comment">//axios静态接口</span></span><br><span class="line"><span class="title function_">create</span>(<span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">AxiosInstance</span> <span class="comment">//创建axios实例</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>axios.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosStatic</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./types&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Axios</span> <span class="keyword">from</span> <span class="string">&#x27;./core/Axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; extend &#125; <span class="keyword">from</span> <span class="string">&#x27;./helpers/util&#x27;</span></span><br><span class="line"><span class="keyword">import</span> defaults <span class="keyword">from</span> <span class="string">&#x27;./defaults&#x27;</span></span><br><span class="line"><span class="keyword">import</span> mergeConfig <span class="keyword">from</span> <span class="string">&#x27;./core/mergeConfig&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createInstance</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span></span>): <span class="title class_">AxiosStatic</span> &#123;</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> <span class="title class_">Axios</span>(config) <span class="comment">//创建一个 Axios 实例 并传入 config 参数 并赋值给 context 变量</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span>.<span class="title function_">bind</span>(context) <span class="comment">//调用 request 方法 并传入 context 参数 并赋值给 instance 变量 绑定 this 指向 context</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">extend</span>(instance, context) <span class="comment">//调用 extend 方法 并传入 instance 和 context 参数 实现 instance 对象继承 context 对象</span></span><br><span class="line"><span class="keyword">return</span> instance <span class="keyword">as</span> <span class="title class_">AxiosStatic</span> <span class="comment">//返回 instance 对象 并断言为 AxiosStatic 类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> axios = <span class="title function_">createInstance</span>(defaults) <span class="comment">//调用 createInstance 方法 并传入 defaults 参数 并赋值给 axios 变量</span></span><br><span class="line"></span><br><span class="line">axios.<span class="property">create</span> = <span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">config</span>) &#123;</span><br><span class="line"><span class="comment">//axios.create 方法接收一个 config 参数 并返回一个 createInstance 方法的调用结果 并传入 mergeConfig 方法的调用结果 并传入 defaults 和 config 参数</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">createInstance</span>(<span class="title function_">mergeConfig</span>(defaults, config))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> axios</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>源码探究 runtime-core模块</title>
      <link href="/2025/03/04/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E6%BA%90%E7%A0%81%E6%8E%A2%E7%A9%B6%20runtime-core%E6%A8%A1%E5%9D%97/"/>
      <url>/2025/03/04/%E6%B7%B1%E5%85%A5%E5%89%8D%E7%AB%AF/%E6%BA%90%E7%A0%81%E6%8E%A2%E7%A9%B6%20runtime-core%E6%A8%A1%E5%9D%97/</url>
      
        <content type="html"><![CDATA[<h1 id="源码探究-runtime-core-模块"><a href="#源码探究-runtime-core-模块" class="headerlink" title="源码探究 runtime-core 模块"></a>源码探究 runtime-core 模块</h1><blockquote><p>接下来我们将对这行核心代码的源码进行全流程追踪</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#root&#x27;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>注：在此之前我们已经通过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const rootContainer = document.querySelector(&#x27;#app&#x27;)</span><br></pre></td></tr></table></figure><p>拿到 <strong><em>rootContainer</em></strong> ：<div id="app"></div></p></blockquote><p>拆分成两个步骤</p><blockquote><p>createApp(App)</p><p>.mount(“#root”)</p></blockquote><h2 id="createApp-App"><a href="#createApp-App" class="headerlink" title="createApp(App)"></a>createApp(App)</h2><h3 id="关于-App"><a href="#关于-App" class="headerlink" title="关于 App"></a>关于 App</h3><p>我们先来看用户这边的操作</p><p>App.js</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">App</span> = &#123;</span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// UI逻辑</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_">h</span>(</span><br><span class="line"><span class="comment">// Vue 中的创建虚拟 DOM 的辅助函数,用于创建虚拟 DOM 节点,接收三个参数：</span></span><br><span class="line"><span class="string">&#x27;div&#x27;</span>, <span class="comment">// type：要创建的 HTML 标签名或组件选项对象.</span></span><br><span class="line">&#123; <span class="attr">id</span>: <span class="string">&#x27;root&#x27;</span>, <span class="attr">class</span>: [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;hard&#x27;</span>] &#125;, <span class="comment">// props：标签属性,可以是一个 对象 或 数组.</span></span><br><span class="line"><span class="string">&#x27;hi, &#x27;</span> + <span class="variable language_">this</span>.<span class="property">msg</span> <span class="comment">// children：子节点,可以是 字符串、数字、数组、其他虚拟 DOM 节点.</span></span><br><span class="line">)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 组合式 API 的入口点,用于组合组件的逻辑，例如响应式数据、生命周期钩子、计算属性等</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">msg</span>: <span class="string">&#x27;mini-vue&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这里给 h 辅助函数传入三个参数</p><p><strong><em>type</em></strong>：要创建的 HTML 标签名或组件选项对象(div)</p><p><strong><em>props</em></strong>：标签属性,可以是一个 对象 或 数组</p><p><strong><em>children</em></strong>：子节点,可以是 字符串、数字、数组、其他虚拟 DOM 节点</p></blockquote><p>来看看 h 辅助函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">h</span>(<span class="params"><span class="keyword">type</span>, props, children</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="keyword">type</span>, props, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着 createVNode</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createVNode</span>(<span class="params"><span class="keyword">type</span>, props, children</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> vnode = &#123;</span><br><span class="line"><span class="keyword">type</span>, <span class="comment">// 类型</span></span><br><span class="line">props, <span class="comment">// 属性</span></span><br><span class="line">children, <span class="comment">// 孩子</span></span><br><span class="line"><span class="attr">el</span>: <span class="literal">null</span>, <span class="comment">// 对应的真实dom</span></span><br><span class="line"><span class="attr">component</span>: <span class="literal">null</span>, <span class="comment">// 组件实例</span></span><br><span class="line"><span class="attr">key</span>: props === <span class="literal">null</span> || props === <span class="built_in">void</span> <span class="number">0</span> ? <span class="built_in">void</span> <span class="number">0</span> : props.<span class="property">key</span>, <span class="comment">// 唯一标识</span></span><br><span class="line"><span class="comment">// shapeFlag: getShapeFlag(type), // 类型标识</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>现在 App 的结构就变成了这样</p><p>render()</p><blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type<span class="punctuation">,</span> <span class="comment">// 类型</span></span><br><span class="line">props<span class="punctuation">,</span> <span class="comment">// 属性</span></span><br><span class="line">children<span class="punctuation">,</span> <span class="comment">// 孩子</span></span><br><span class="line">el<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="comment">// 对应的真实dom</span></span><br><span class="line">component<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="comment">// 组件实例</span></span><br><span class="line">key<span class="punctuation">:</span> props === <span class="literal"><span class="keyword">null</span></span> || props === void <span class="number">0</span> ? void <span class="number">0</span> <span class="punctuation">:</span> props.key<span class="punctuation">,</span> <span class="comment">// 唯一标识</span></span><br></pre></td></tr></table></figure></blockquote><p>setup()</p></blockquote><h3 id="关于-createApp"><a href="#关于-createApp" class="headerlink" title="关于 createApp"></a>关于 createApp</h3><blockquote><p>传入结构 App-&gt;rootComponent</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">rootComponent</span>) &#123;</span><br><span class="line"><span class="comment">//rootComponent就是App</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="title function_">mount</span>(<span class="params">rootContainer</span>) &#123;</span><br><span class="line"><span class="comment">//.mount方法的扩展</span></span><br><span class="line"><span class="keyword">const</span> vnode = <span class="title function_">createVNode</span>(rootComponent)</span><br><span class="line"><span class="title function_">render</span>(vnode, rootContainer)</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>由此进入.mount(“#root”)部分</p></blockquote><h2 id="mount-“-root”"><a href="#mount-“-root”" class="headerlink" title=".mount(“#root”)"></a>.mount(“#root”)</h2><blockquote><p>接着看 mount 方法的内部</p><p>&#x2F;&#x2F; 挂载回根容器<br>&#x2F;&#x2F; 先把根组件转换成虚拟节点 vnode<br>&#x2F;&#x2F; 之后所有的操作都会基于 vnode 做处理</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">rootComponent</span>) &#123;</span><br><span class="line"><span class="comment">// rootComponent 就是 &#123;render: ƒ, setup: ƒ&#125;</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="title function_">mount</span>(<span class="params">rootContainer</span>) &#123;</span><br><span class="line"><span class="comment">// rootContainer 就是 div#app</span></span><br><span class="line"><span class="keyword">const</span> vnode = <span class="title function_">createVNode</span>(rootComponent) <span class="comment">// 根组件转换成虚拟节点vnode</span></span><br><span class="line"><span class="title function_">render</span>(vnode, rootContainer) <span class="comment">// 将 vnode 渲染到 container 中</span></span><br><span class="line"><span class="comment">// 之后所有的操作都会基于vnode做处理</span></span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="createVNode"><a href="#createVNode" class="headerlink" title="createVNode"></a>createVNode</h3><blockquote><p>rootComponent 传进来了 {render: ƒ, setup: ƒ}</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createVNode</span>(<span class="params"><span class="keyword">type</span>, props, children</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> vnode = &#123;</span><br><span class="line"><span class="keyword">type</span>, <span class="comment">// 类型</span></span><br><span class="line">props, <span class="comment">// 属性</span></span><br><span class="line">children, <span class="comment">// 孩子</span></span><br><span class="line"><span class="attr">el</span>: <span class="literal">null</span>, <span class="comment">// 对应的真实dom</span></span><br><span class="line"><span class="attr">component</span>: <span class="literal">null</span>, <span class="comment">// 组件实例</span></span><br><span class="line"><span class="attr">key</span>: props === <span class="literal">null</span> || props === <span class="built_in">void</span> <span class="number">0</span> ? <span class="built_in">void</span> <span class="number">0</span> : props.<span class="property">key</span>, <span class="comment">// 唯一标识</span></span><br><span class="line"><span class="comment">// shapeFlag: getShapeFlag(type), // 类型标识</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>现在 {render: ƒ, setup: ƒ} 被挂到了虚拟节点的第一个属性 <strong><em>type</em></strong> 上</p></blockquote><blockquote><p>现在 <strong><em>vnode</em></strong> 的结构就变成了这样</p><p><strong>type</strong></p><blockquote><p>render()</p><blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type<span class="punctuation">,</span> <span class="comment">// 类型</span></span><br><span class="line">props<span class="punctuation">,</span> <span class="comment">// 属性</span></span><br><span class="line">children<span class="punctuation">,</span> <span class="comment">// 孩子</span></span><br><span class="line">el<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="comment">// 对应的真实dom</span></span><br><span class="line">component<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="comment">// 组件实例</span></span><br><span class="line">key<span class="punctuation">:</span> props === <span class="literal"><span class="keyword">null</span></span> || props === void <span class="number">0</span> ? void <span class="number">0</span> <span class="punctuation">:</span> props.key<span class="punctuation">,</span> <span class="comment">// 唯一标识</span></span><br></pre></td></tr></table></figure></blockquote><p>setup()</p></blockquote><p><strong>props</strong></p><p><strong>children</strong></p><p><strong>el</strong></p><p><strong>component</strong></p><p><strong>key</strong></p></blockquote><h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(vnode, rootContainer) <span class="comment">// 将 vnode 渲染到 container 中</span></span><br></pre></td></tr></table></figure><blockquote><p>vnode : 刚才写的结构 👆</p><p>rootContainer : div#app</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line"><span class="comment">// 直接指向patch函数</span></span><br><span class="line"><span class="title function_">patch</span>(vnode, container)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="patch-拆箱回调"><a href="#patch-拆箱回调" class="headerlink" title="patch 拆箱回调"></a>patch 拆箱回调</h3><blockquote><p>拆箱函数，深层回调的起点</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.<span class="property">type</span> === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">// 元素分支</span></span><br><span class="line"><span class="title function_">processElement</span>(vnode, container)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.<span class="property">type</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">// 组件分支</span></span><br><span class="line"><span class="title function_">processComponent</span>(vnode)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="processComponent-组件分支（首次进入）"><a href="#processComponent-组件分支（首次进入）" class="headerlink" title="processComponent 组件分支（首次进入）"></a>processComponent 组件分支（首次进入）</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processComponent</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line"><span class="title function_">mountComponent</span>(vnode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="mountComponent-组件初始化分支"><a href="#mountComponent-组件初始化分支" class="headerlink" title="mountComponent 组件初始化分支"></a>mountComponent 组件初始化分支</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountComponent</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> instance = <span class="title function_">createComponentInstance</span>(vnode) <span class="comment">// 创建组件实例</span></span><br><span class="line"><span class="title function_">setupComponent</span>(instance) <span class="comment">// 处理组件</span></span><br><span class="line"><span class="title function_">setupRenderEffect</span>(instance, vnode, container) <span class="comment">// 处理组件渲染</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="createComponentInstance"><a href="#createComponentInstance" class="headerlink" title="createComponentInstance"></a>createComponentInstance</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createComponentInstance</span>(<span class="params">vnode</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> instance = &#123;</span><br><span class="line">vnode,</span><br><span class="line"><span class="attr">type</span>: vnode.<span class="property">type</span>,</span><br><span class="line"><span class="attr">props</span>: vnode.<span class="property">props</span>,</span><br><span class="line"><span class="attr">slots</span>: vnode.<span class="property">slots</span>, <span class="comment">// 插槽</span></span><br><span class="line"><span class="attr">proxy</span>: <span class="literal">null</span>, <span class="comment">// 代理对象</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>返回的 <strong><em>instance</em></strong> 结构</p><p><strong>vnode</strong>(新增) ：继承当前传过来的整个 vnode 结构</p><p><strong>type</strong></p><blockquote><p>render()</p><blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type<span class="punctuation">,</span> <span class="comment">// 类型</span></span><br><span class="line">props<span class="punctuation">,</span> <span class="comment">// 属性</span></span><br><span class="line">children<span class="punctuation">,</span> <span class="comment">// 孩子</span></span><br><span class="line">el<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="comment">// 对应的真实dom</span></span><br><span class="line">component<span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span> <span class="comment">// 组件实例</span></span><br><span class="line">key<span class="punctuation">:</span> props === <span class="literal"><span class="keyword">null</span></span> || props === void <span class="number">0</span> ? void <span class="number">0</span> <span class="punctuation">:</span> props.key<span class="punctuation">,</span> <span class="comment">// 唯一标识</span></span><br></pre></td></tr></table></figure></blockquote><p>setup()</p></blockquote><p><strong>props</strong></p><p><strong>slots</strong>(新增)</p><p><strong>proxy</strong>(新增)</p><p><strong>children</strong></p><p><strong>el</strong></p><p><strong>component</strong></p><p><strong>key</strong></p></blockquote><h6 id="setupComponent"><a href="#setupComponent" class="headerlink" title="setupComponent"></a>setupComponent</h6><blockquote><p>instance 的结构见上 👆</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupComponent</span>(<span class="params">instance</span>) &#123;</span><br><span class="line"><span class="comment">// 初始化组件</span></span><br><span class="line"><span class="title function_">initProps</span>(instance)</span><br><span class="line"><span class="title function_">initSlots</span>(instance)</span><br><span class="line"><span class="title function_">setupStatefulComponent</span>(instance) <span class="comment">// 处理组件的setup</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>setupStatefulComponent</strong></p><blockquote><p>按这个例子来说，解构出来的 setup 结构为</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ƒ <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;mini-vue&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span> <span class="comment">// 先拿到组件 &#123;render: ƒ, setup: ƒ&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span> <span class="comment">//解构出setup(结构见上面注释)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (setup) &#123;</span><br><span class="line"><span class="comment">// setCurrentInstance(instance)</span></span><br><span class="line"><span class="keyword">const</span> setupResult = <span class="title function_">setup</span>() <span class="comment">// &#123;msg: &#x27;mini-vue&#x27;&#125;</span></span><br><span class="line"><span class="comment">// setCurrentInstance(null)</span></span><br><span class="line"><span class="title function_">handleSetupResult</span>(instance, setupResult) <span class="comment">// instance &amp; &#123;msg: &#x27;mini-vue&#x27;&#125;</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_">finishComponentSetup</span>(instance)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面这个先留个坑🕳后面看</span></span><br><span class="line">instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(instance, &#123;</span><br><span class="line"><span class="comment">// 创建代理对象</span></span><br><span class="line"><span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; setup, props &#125; = target</span><br><span class="line"><span class="keyword">if</span> (key <span class="keyword">in</span> setup) &#123;</span><br><span class="line"><span class="keyword">return</span> setup[key]</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (key <span class="keyword">in</span> props) &#123;</span><br><span class="line"><span class="keyword">return</span> props[key]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key)</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>如果 setup 存在</strong></p><p>handleSetupResult （处理组件的 setup）</p><blockquote><p>传入 instance &amp; {msg: ‘mini-vue’}</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleSetupResult</span>(<span class="params"><span class="attr">instance</span>: <span class="built_in">any</span>, <span class="attr">setupResult</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> setupResult === <span class="string">&#x27;object&#x27;</span> &amp;&amp; setupResult !== <span class="literal">null</span>) &#123;</span><br><span class="line">instance.<span class="property">setupState</span> = setupResult <span class="comment">// instance新增属性setupState</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">finishComponentSetup</span>(instance) <span class="comment">// 处理组件的render</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>finishComponentSetup （处理组件的 render）</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">finishComponentSetup</span>(<span class="params">instance</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span> <span class="comment">// 先拿到组件 &#123;render: ƒ, setup: ƒ&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Component</span>.<span class="property">render</span>) &#123;</span><br><span class="line">instance.<span class="property">render</span> = <span class="title class_">Component</span>.<span class="property">render</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">instance.<span class="property">render</span> = instance.<span class="property">vnode</span>.<span class="property">render</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这里 instance 又新增了 render 属性</p></blockquote><p><strong>如果 setup 不存在</strong></p><blockquote><p>直接处理组件的 render</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">finishComponentSetup</span>(instance)</span><br></pre></td></tr></table></figure><blockquote><p>到这里就是组件初始化的最底层了，接下来我们回到 <em>mountComponent</em> 完成 <em>setupRenderEffect</em> 部分</p></blockquote><h6 id="setupRenderEffect"><a href="#setupRenderEffect" class="headerlink" title="setupRenderEffect"></a>setupRenderEffect</h6><blockquote><p>要传入三个参数 <strong><em>instance</em></strong>, <strong><em>vnode</em></strong>, <strong><em>container</em></strong></p><p>已知 <strong>container</strong> 作为容器为<div id="app"></div></p><p>到这里我们先梳理一下目前 <strong>instance</strong> &amp; <strong>vnode</strong> 内部的参数</p><table><thead><tr><th align="left">instance</th><th align="left">vnode</th><th align="center">属性</th></tr></thead><tbody><tr><td align="left">✅</td><td align="left">✅</td><td align="center">children</td></tr><tr><td align="left">✅</td><td align="left">✅</td><td align="center">component</td></tr><tr><td align="left">✅</td><td align="left">✅</td><td align="center">el</td></tr><tr><td align="left">✅</td><td align="left">✅</td><td align="center">key</td></tr><tr><td align="left">✅</td><td align="left">✅</td><td align="center">props</td></tr><tr><td align="left">✅ 内部是右边 vnode 的前五个属性</td><td align="left">⛔</td><td align="center"><strong><em>vnode</em></strong></td></tr><tr><td align="left">✅ { render: ƒ, setup: ƒ }</td><td align="left">✅ { render: ƒ, setup: ƒ }</td><td align="center"><strong><em>type</em></strong></td></tr><tr><td align="left">✅</td><td align="left">⛔</td><td align="center">proxy</td></tr><tr><td align="left">✅</td><td align="left">⛔</td><td align="center">slots</td></tr><tr><td align="left">✅ { msg: ‘mini-vue’ }</td><td align="left">⛔</td><td align="center">setupState</td></tr></tbody></table></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setupRenderEffect</span>(<span class="params"><span class="attr">instance</span>: <span class="built_in">any</span>, <span class="attr">vnode</span>: <span class="built_in">any</span>, <span class="attr">container</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"><span class="comment">//我们先看这一部分</span></span><br><span class="line"><span class="keyword">const</span> &#123; proxy &#125; = instance</span><br><span class="line"><span class="keyword">const</span> subTree = instance.<span class="property">render</span>.<span class="title function_">call</span>(proxy) <span class="comment">// 注意!是这个时候去调用render里的h函数了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// vnode -&gt; patch</span></span><br><span class="line"><span class="comment">// vnode -&gt; element -&gt; mountElement</span></span><br><span class="line"><span class="comment">// patch(subTree, container)</span></span><br><span class="line"><span class="comment">// vnode.el = subTree.el</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回顾 h 函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">h</span>(<span class="params"><span class="keyword">type</span>, props, children</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="keyword">type</span>, props, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>再看这时候的 type, props, children 也就是用户样例</p><p>type：’div’</p><p>props：{ id: ‘root’, class: [‘red’, ‘hard’] }</p><p>children：’hi, mini-vue’</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createVNode</span>(<span class="params"><span class="keyword">type</span>, props, children</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> vnode = &#123;</span><br><span class="line"><span class="keyword">type</span>, <span class="comment">// 传入类型</span></span><br><span class="line">props, <span class="comment">// 传入属性</span></span><br><span class="line">children, <span class="comment">// 传入子节点</span></span><br><span class="line"><span class="attr">el</span>: <span class="literal">null</span>,</span><br><span class="line"><span class="attr">component</span>: <span class="literal">null</span>,</span><br><span class="line"><span class="attr">key</span>: props === <span class="literal">null</span> || props === <span class="built_in">void</span> <span class="number">0</span> ? <span class="built_in">void</span> <span class="number">0</span> : props.<span class="property">key</span>, <span class="comment">// 唯一标识</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>那么接下来的 <strong><em>subTree</em></strong> 结构就是</p><p><strong>type</strong> &#x3D; ‘div’</p><p><strong>props</strong> &#x3D; { id: ‘root’, class: [‘red’, ‘hard’] }</p><p><strong>children</strong> &#x3D; ‘hi, mini-vue’</p><p><strong>el</strong></p><p><strong>component</strong></p><p><strong>key</strong></p></blockquote><blockquote><p>以及 <strong><em>container</em></strong> 结构</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span> <span class="attr">class</span>=<span class="string">&quot;red, hard&quot;</span>&gt;</span>hi, mini-vue<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></blockquote><p>返回 <strong>setupRenderEffect</strong> 函数，继续看下面的逻辑</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setupRenderEffect</span>(<span class="params"><span class="attr">instance</span>: <span class="built_in">any</span>, <span class="attr">vnode</span>: <span class="built_in">any</span>, <span class="attr">container</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line"><span class="comment">// const &#123; proxy &#125; = instance</span></span><br><span class="line"><span class="comment">// const subTree = instance.render.call(proxy) // 注意!是这个时候去调用render里的h函数了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// vnode -&gt; patch</span></span><br><span class="line"><span class="comment">// vnode -&gt; element -&gt; mountElement</span></span><br><span class="line"><span class="title function_">patch</span>(subTree, container) <span class="comment">//传入subtree container</span></span><br><span class="line">vnode.<span class="property">el</span> = subTree.<span class="property">el</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时调用 <strong><em>patch</em></strong> 回调拆箱</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.<span class="property">type</span> === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">// 元素分支 &lt;-这次进这个</span></span><br><span class="line"><span class="title function_">processElement</span>(vnode, container) <span class="comment">// 此时的 vnode.type 已经是&#x27;div&#x27;了</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.<span class="property">type</span> === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">// 组件分支</span></span><br><span class="line"><span class="title function_">processComponent</span>(vnode)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>快进到下面的 processElement 元素分支</p></blockquote><h5 id="updateComponent-更新分支"><a href="#updateComponent-更新分支" class="headerlink" title="updateComponent 更新分支"></a>updateComponent 更新分支</h5><blockquote><p><strong><em>!!! 第一次看先掠过这一部分,先看后文 ‘processElement 元素分支’ 实现拆箱 !!!</em></strong></p></blockquote><h4 id="processElement-元素分支"><a href="#processElement-元素分支" class="headerlink" title="processElement 元素分支"></a>processElement 元素分支</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processElement</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line"><span class="title function_">mountElement</span>(vnode, container)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="mountElement-元素初始化分支"><a href="#mountElement-元素初始化分支" class="headerlink" title="mountElement 元素初始化分支"></a>mountElement 元素初始化分支</h5><blockquote><p>若以首次样例传入为例，进入文本节点</p><p>若以二次样例传入为例，进入数组节点</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountElement</span>(<span class="params">vnode, container</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(vnode.<span class="property">type</span>) <span class="comment">// 创建真实dom &lt;div&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="keyword">const</span> &#123; children, props &#125; = vnode</span><br><span class="line"><span class="comment">// (首次)解构为</span></span><br><span class="line"><span class="comment">// &#x27;hi, mini-vue&#x27;</span></span><br><span class="line"><span class="comment">// &#123; id: &#x27;root&#x27;, class: [&#x27;red&#x27;, &#x27;hard&#x27;] &#125;</span></span><br><span class="line"><span class="comment">// (二次)解构为</span></span><br><span class="line"><span class="comment">// [h(&#x27;p&#x27;, &#123; class: &#x27;red&#x27; &#125;, &#x27;hi&#x27;), h(&#x27;p&#x27;, &#123; class: &#x27;blue&#x27; &#125;, &#x27;mini-vue&#x27;)]</span></span><br><span class="line"><span class="comment">// &#123; id: &#x27;root&#x27;, class: [&#x27;red&#x27;, &#x27;hard&#x27;] &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line"><span class="comment">// 文本节点(首次样例)</span></span><br><span class="line">el.<span class="property">textContent</span> = children <span class="comment">// 直接把&#x27;hi, mini-vue&#x27;插入到&lt;div&gt;&lt;/div&gt;下0位处</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(children)) &#123;</span><br><span class="line"><span class="comment">// 数组节点(二次样例)</span></span><br><span class="line"><span class="title function_">mountChildren</span>(vnode, el) <span class="comment">// 拆分数组 + patch回调 (此时el是&lt;p&gt;,container是&lt;div&gt;)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (props) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line"><span class="comment">// 遍历key</span></span><br><span class="line"><span class="keyword">const</span> val = props[key] <span class="comment">// 拿到属性值val</span></span><br><span class="line">el.<span class="title function_">setAttribute</span>(key, val) <span class="comment">// Web内置API,把键值对嵌入div标签</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">container.<span class="title function_">append</span>(el) <span class="comment">// Web内置API,把el挂载到容器中</span></span><br><span class="line"><span class="comment">// (首次)挂载为</span></span><br><span class="line"><span class="comment">// container : &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">// el : &lt;div id=&quot;root&quot; class=&quot;red,hard&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">// (二次)挂载为</span></span><br><span class="line"><span class="comment">// container : &lt;div id=&quot;root&quot; class=&quot;red,hard&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="comment">// el : &lt;p class=&quot;...&quot;&gt;&lt;/p&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>(首次样例) for (const key in props) 的过程</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span> <span class="attr">class</span>=<span class="string">&quot;red,hard&quot;</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>(首次样例) container.append(el) 的结果</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- container --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&gt; 0 =</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span> <span class="attr">class</span>=<span class="string">&quot;red, hard&quot;</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&gt; &gt; 0 = hi, mini-vue</span><br></pre></td></tr></table></figure></blockquote><p>此时返回 <strong><em>setupRenderEffect</em></strong> 的最后一行</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnode.<span class="property">el</span> = subTree.<span class="property">el</span></span><br></pre></td></tr></table></figure><blockquote><p>此时打开 html 网页，就可以看到屏幕上的 hi, mini-vue 字样了</p></blockquote><p><strong><em>!!! 二次复盘 !!!</em></strong></p><blockquote><p>现在我们将 h 的 children 参数改成数组</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="title function_">h</span>(</span><br><span class="line"><span class="comment">// 创建虚拟 DOM 节点,接收三个参数</span></span><br><span class="line"><span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">&#123; <span class="attr">id</span>: <span class="string">&#x27;root&#x27;</span>, <span class="attr">class</span>: [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;hard&#x27;</span>] &#125;,</span><br><span class="line"><span class="comment">// &#x27;hi, mini-vue&#x27; //string类型</span></span><br><span class="line">[<span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;red&#x27;</span> &#125;, <span class="string">&#x27;hi&#x27;</span>), <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;blue&#x27;</span> &#125;, <span class="string">&#x27;mini-vue&#x27;</span>)] <span class="comment">// array类型</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>并且在 index.html 中添加 css 样式</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.red</span> &#123;</span></span><br><span class="line"><span class="language-css"><span class="attribute">color</span>: red;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.blue</span> &#123;</span></span><br><span class="line"><span class="language-css"><span class="attribute">color</span>: blue;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></blockquote><p>还记得 children 判断类型的分支吗，就在刚写的 <strong><em>mountElement</em></strong> 函数里，返回去再看看，看完再回到这里</p><h6 id="mountChildren"><a href="#mountChildren" class="headerlink" title="mountChildren"></a>mountChildren</h6><blockquote><p>所以现在二次样例中的数据如下</p><p><strong>vnode.children</strong> 子节点标签数组</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;[<span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;red&#x27;</span> &#125;, <span class="string">&#x27;hi&#x27;</span>), <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;blue&#x27;</span> &#125;, <span class="string">&#x27;mini-vue&#x27;</span>)]</span><br></pre></td></tr></table></figure><p><strong>container</strong> 根容器</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountChildren</span>(<span class="params"><span class="attr">vnode</span>: <span class="built_in">any</span>, <span class="attr">container</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">vnode.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params"><span class="attr">v</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">patch</span>(v, container) <span class="comment">// 递归处理children</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>取出来的 <strong><em>v</em></strong> 依此是</p><table><thead><tr><th align="center"></th><th align="center">第一次 (调用 h)</th><th align="center">第二次 (调用 h)</th></tr></thead><tbody><tr><td align="center"><strong>type</strong></td><td align="center">p</td><td align="center">p</td></tr><tr><td align="center"><strong>props</strong></td><td align="center">{ class: ‘ red ‘ }</td><td align="center">{ class: ‘ blue ‘ }</td></tr><tr><td align="center"><strong>children</strong></td><td align="center">‘ hi ‘</td><td align="center">‘ mini-vue ‘</td></tr></tbody></table></blockquote>]]></content>
      
      
      <categories>
          
          <category> 深入前端 </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
