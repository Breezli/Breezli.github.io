<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>pnpm dev 的背后（vite构建） | 松风狸 | Breezli</title><meta name="keywords" content="前端, 博客"><meta name="author" content="Breezli"><meta name="copyright" content="Breezli"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="pnpm dev 的背后（vite构建）"><meta name="application-name" content="pnpm dev 的背后（vite构建）"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="pnpm dev 的背后（vite构建）"><meta property="og:url" content="http://example.com/2025/09/07/%E5%B7%A5%E5%85%B7/Vite%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%8C%E5%90%8E/index.html"><meta property="og:site_name" content="松风狸 | Breezli"><meta property="og:description" content="pnpm dev (执行启动命令)执行 pnpm dev 时，pnpm 包管理器会查找 package.json 中 scripts 下的 dev 命令并执行它（通常是 vite &amp;#x2F; vite serve） 123&amp;quot;scripts&amp;quot;: &amp;#123;    &amp;quot;d"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2025/08/22/68a756bf71c99.png"><meta property="article:author" content="Breezli"><meta property="article:tag" content="前端, 博客"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2025/08/22/68a756bf71c99.png"><meta name="description" content="pnpm dev (执行启动命令)执行 pnpm dev 时，pnpm 包管理器会查找 package.json 中 scripts 下的 dev 命令并执行它（通常是 vite &amp;#x2F; vite serve） 123&amp;quot;scripts&amp;quot;: &amp;#123;    &amp;quot;d"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/09/07/%E5%B7%A5%E5%85%B7/Vite%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%8C%E5%90%8E/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css#fontawesome_animation 如果有就会加载，示例值：https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"春梦随云散，飞花逐水流          ......","backTitle":"草木缱绻，风月无边              ......"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"api","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["💻 前端技术学者","📕 红迷","🌄 旅行爱好者","🎨 国画九级选手","💤 睡觉居士","📜 诗词爱好者"]},
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Breezli","link":"链接: ","source":"来源: 松风狸 | Breezli","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '松风狸 | Breezli',
  title: 'pnpm dev 的背后（vite构建）',
  postAI: '',
  pageFillDescription: 'pnpm dev (执行启动命令), 确定 vite 启动时模式（mode）, 加载.env文件, 过滤出 VITE_ 开头的变量, 注入import.meta.env到客户端, 配置解析与合并, 命令行（CLI）, defineConfig, 合并, config 钩子, configResolved 钩子, 插件系统初始化与构建, 插件排序, 排序逻辑, 指定模式, 总结, 依赖预构建, 建立开发服务器, 注入中间件, 什么是中间件, Vite 的操作, 请求处理（核心）, 请求拦截, 插件流水线执行（核心）, resolveId(specifier), load(id), transform(code id), 处理子资源请求, resolveId(specifier), load(id), transform(code id), 流程总结, 热模块更新, 服务器感知, WebSocket 更新, 浏览器（客户端）接收, 热替换（局部更新）, 总结执行启动命令执行时包管理器会查找中下的命令并执行它通常是这实际上调用了的二进制文件这个会引连到的模块接着模块使用库来解析命令行参数如并根据命令创建相应的开发服务器或执行构建确定启动时模式在启动时会首先确定当前的运行模式默认为开发你也可以通过命令行手动指定模式运行模式决定了加载哪些环境变量文件加载文件随后按照以下顺序查找和加载环境变量文件如最高优先级且不会提交到如全局默认配置所有变量都会被注入到的中是的全局对象所以仅在服务端生效插播的是个啥就是一个普通的对象而它是的一个属性专门存环境变量它大概是这样的你可以把它看成的备忘录存着环境端口接口密钥等数据好了现在回归正题比如我在某文件需要知道这些参数来判断当前的运行环境我在脚本文件用的最多生产环境开发环境测试环境压缩的插件生产环境下删除连续语句生产环境下删除函数参数生产环境下删除语句生产环境下删除语句生产环境下进行次压缩开发环境下进行次压缩定义全局变量用于在压缩代码时进行条件编译但是这些变量不能暴露给浏览器不然任何访问你网站的人就能看到数据库密码秘钥等过滤出开头的变量只有以为前缀的变量才会通过暴露给你的客户端源码看上面的例子比如是内部会对此做筛选类似于以下这样只保留开头的然后把这个对象注入到前端代码中变成可访问注入到客户端就是由筛出来的所以和一样作为客户端的备忘录对比运行环境服务端浏览器客户端使用位置服务器构建脚本组件值定义在文件操作系统筛选并注入变量范围所有变量只能访问开头的配置解析与合并回归主线处理完环境变量下一步就是合并配置会合并处理以下的配置生成最终的构建配置对象命令行项目设置的命令行参数优先级最高例如会把这些建议解析成一个对象读取并执行获取导出的结果也就是合并会把两者合并优先级更高钩子在最终配置确定前插件可以通过插件的钩子修改配置和的二次封装是一个道理会合并你的配置自定义插件钩子已经是当前合并后的配置就是之前说的备忘录当前修改配置二次封装展开已有配置新增新增全局常量配置结果是并且这个最终的配置对象会被冻结防止后续被修改钩子在配置确定后插件可以根据插件的钩子读取存储最终解析的配置只读当前钩子只读就是最终确定的配置解构赋值服务器在端口启动不能修改无效插件系统初始化与构建的功能几乎都由插件提供包括内置插件而这些插件就会涉及到排序先行的问题内部规定了什么插件应该优先执行解析插件排序排序逻辑插件会根据属性排序执行在核心插件之前调用代码转换插件别名处理插件作用解析别名代码转换重写导入路径内部文件需要先转成文件核心才能识别要确保在文件被解析前先处理语法无默认在核心插件之后调用大多数插件作用把编译成函数提取注入代码默认顺序无因为它处理的是已经被分好的单文件子请求必须在核心插件之后在构建插件之后调用打包后处理插件生成报告插件作用打包后处理压缩混淆等生成报告默认插件需要等所有代码打包完成后才能分析最终的大小这一块由于加了细节写的有点乱可以先看看下面的总结指定模式插件还可以通过指定只在特定模式下生效只在开发模式启用只在时生效在开发服务器上注册接口只在构建模式启用只在时生效构建完成后对目录进行压缩总结类型典型用途真实例子预处理路径解析语法转换普通处理默认组件编译资源处理后处理打包分析压缩模式控制开发专用功能插件模式控制构建优化压缩插件依赖预构建的开发服务器基于实现了真正的按需编译但很多包还是格式为了解决兼容性和性能问题会进行依赖预构建主要是为了优化兼容性将或格式的依赖项转换为格式以便在浏览器中通过正常加载性能将有许多内部模块的依赖项如转换为单个模块减少浏览器需要发出的请求数预构建后的依赖会被缓存到目录下这是启动快的一个原因它只处理你自己写的代码依赖项已经预打包好了建立开发服务器使用作为底层框架创建一个开发服务器启用功能监听指定端口如处理所有静态资源请求图片等启动用于热更新伪代码处理等用于注入中间件什么是中间件中间件就是在浏览器向请求文件过程中的中间检查站一个中间件就是一个函数类似于这种请求对象相应对象放行函数不调用相当于直接拦截放行继续后续处理的开发服务器底层基于一个轻量级框架而的核心就是中间件机制它的结构就像这样浏览器请求插件注册的中间件接口拦截插件注册的中间件转换插件注册的中间件静态资源重定向其他插件中间件核心中间件处理中间件静态资源服务中间件模块请求处理中间件核心中间件处理中间件返回响应给浏览器的操作的规则是先注册的插件先执行插件可以通过钩子插件开发者已定义好向的服务器注册自己的中间件比如插件效果当你在浏览器访问根本不会去请求后端而是直接返回数据向的服务器注册有人请求了是的中间件容器没有请求被拦截或是记录日志不做操作拦截所有开头的请求放行交给下一个处理如果你在中间件里了响应比如数据后面的中间件包括核心就不会执行请求处理核心当浏览器请求一个文件如时不是简单地返回文件内容而是通过插件系统动态转换最终返回一段可执行的模块而这个过程会产生对子资源的额外请求这是理解处理文件的关键请求拦截浏览器发起的开发服务器拦截该请求不直接读取文件返回而是开启模块解析和转换流程插件流水线执行核心通过风格的插件接口依次调用注册的插件钩子顺序如下解析模块依赖关系时如调用插件的钩子确定对应的真实路径如内部调用模块路径解析后需要读取原始内容调用插件的钩子获取文件原始字符串内部调用返回当对加载的原始内容进行转换时将和传给所有插件的钩子按顺序执行转换不自己转换文件这里是把交给插件处理注在阶段会自动注入支持内部调用你的代码当插件发现是文件时就会介入处理处理子资源请求文件内部还有分块也就是浏览器继续发起请求再次拦截这个请求并重复之前的流程插件识别到将其标记为一个虚拟模块返回原样或特殊标识可能返回空字符串或不调用某些插件直接在处理当插件发现特殊标识就知道这是模板请求会使用将模板编译为函数这是插件的功能返回给浏览器的内容流程总结浏览器服务器调用转换返回包含浏览器解析发现新浏览器服务器再次提取模板编译为函数返回函数代码浏览器组件加载完成热模块更新最大的特点就是拥有极快的热更新的热更新本质是在运行时动态替换模块代码更新主要包含以下过程服务器感知使用监听文件是内存中的依赖图记录着谁了谁现在代表所有依赖这个文件的模块触发更新更新服务器更新类型如通过广播浏览器端的会监听这个消息浏览器客户端接收注入的代码发起新的请求带时间戳防止缓存请求新的模块内容创建一个模块对象用于调用这里是真正的热替换发生的地方模块已更新热替换局部更新这是通过框架的渲染机制实现的如果接触过框架源码就可以理解就是框架内部根据差异实现热替换的算法所以只负责送新模块而局部更新的实现是源于框架渲染机制总结详情查找中下的命令并执行执行命令调用的二进制文件引连到的模块确定按顺序查找和加载注入变量到过滤变量到合并插件配置合并指令配置通过自定义插件初始化插件系统按照排序插件可通过指定模式启动服务器创建开发服务器实例注册中间件根据的顺序调用所有插件的钩子浏览器请求文件按需热更新向浏览器推送新模块并利用框架机制热替换',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-07 12:35:19',
  postMainColor: '#3e39c9ff',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/512.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">松风狸 | Breezli</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/?id=13242559326&amp;server=netease"><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-cube faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 梦境</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-plant-fill faa-tada" style="font-size: 0.9em;"></i><span> 簪花人间</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/cinema/"><i class="anzhiyufont anzhiyu-icon-book faa-tada" style="font-size: 0.9em;"></i><span> 匣中秋水</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/gallerygroup/"><i class="anzhiyufont anzhiyu-icon-instagram faa-tada" style="font-size: 0.9em;"></i><span> 彩云霁月</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 社交</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-rocket faa-tada" style="font-size: 0.9em;"></i><span> 游戏</span></a></li></ul></div></div></div><div id="nav-right"><div id="nav-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">18</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">31</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div id="console-naoDark"><div class="container"><div class="components"><div class="main-button"><div class="moon"></div><div class="moon"></div><div class="moon"></div></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="daytime-backgrond"></div><div class="cloud"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="cloud-light"><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div><div class="cloud-son"></div></div><div class="stars"><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star big"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star medium"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div><div class="star small"><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div><div class="star-son"></div></div></div></div></div></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url">工具</a></span><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">pnpm dev 的背后（vite构建）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-09-07T04:33:46.894Z" title="发表于 2025-09-07 12:33:46">2025-09-07</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-09-07T04:35:19.616Z" title="更新于 2025-09-07 12:35:19">2025-09-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="pnpm dev 的背后（vite构建）"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为成都"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>成都</span></div></div></div><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/09/07/%E5%B7%A5%E5%85%B7/Vite%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%8C%E5%90%8E/"><header><a class="post-meta-categories" href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url">工具</a><h1 id="CrawlerTitle" itemprop="name headline">pnpm dev 的背后（vite构建）</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Breezli</span><time itemprop="dateCreated datePublished" datetime="2025-09-07T04:33:46.894Z" title="发表于 2025-09-07 12:33:46">2025-09-07</time><time itemprop="dateCreated datePublished" datetime="2025-09-07T04:35:19.616Z" title="更新于 2025-09-07 12:35:19">2025-09-07</time></header><h2 id="pnpm-dev-执行启动命令"><a href="#pnpm-dev-执行启动命令" class="headerlink" title="pnpm dev (执行启动命令)"></a>pnpm dev (执行启动命令)</h2><p>执行 <code>pnpm dev</code> 时，pnpm 包管理器会查找 <code>package.json</code> 中 <code>scripts</code> 下的 <code>dev</code> 命令并执行它（通常是 <code>vite</code> &#x2F; <code>vite serve</code>）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这实际上调用了 Vite 的二进制文件 <code>node_modules/.bin/vite</code>（这个会引连到 Vite 的 CLI 模块 <code>vite/src/node/cli.ts</code>）</p>
<p>   接着</p>
<p>   CLI 模块使用 <code>[cac](https://github.com/cacjs/cac)</code> 库来解析命令行参数（如 <code>--port</code>、<code>--open</code>）</p>
<p>   并根据命令（<code>serve</code>, <code>build</code>, <code>preview</code>）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-tsc -b &amp;&amp; vite build&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;preview&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite preview&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>   创建相应的 Vite 开发服务器或执行构建</p>
</blockquote>
<h2 id="确定-vite-启动时模式（mode）"><a href="#确定-vite-启动时模式（mode）" class="headerlink" title="确定 vite 启动时模式（mode）"></a>确定 vite 启动时模式（mode）</h2><p>Vite 在启动时，会首先确定当前的运行模式，默认为 <code>development</code>（开发）</p>
<p>你也可以通过命令行手动指定模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vite --mode production</span><br><span class="line">vite --mode <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p><strong>运行模式决定了 Vite 加载哪些</strong> <strong><code>.env</code></strong> <strong>环境变量文件</strong></p>
<h3 id="加载-env文件"><a href="#加载-env文件" class="headerlink" title="加载.env文件"></a>加载.env文件</h3><p>随后，按照以下顺序查找和加载环境变量文件</p>
<ol>
<li><p><code>.env.$&#123;mode&#125;.local</code> （如 <code>.env.development.local</code>）(<strong>最高优先级，且不会提交到 git [<em>.gitignore</em>]</strong>)</p>
</li>
<li><p><code>.env.$&#123;mode&#125;</code>（如 <code>.env.d</code>）</p>
</li>
<li><p><code>.env.local</code></p>
</li>
<li><p><code>.env</code> （全局默认配置）</p>
</li>
</ol>
<p>root &#x2F; env.d.ts</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">PROD</span>: <span class="built_in">boolean</span>;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">DEV</span>: <span class="built_in">boolean</span>;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> <span class="attr">TEST</span>: <span class="built_in">boolean</span>;</span><br></pre></td></tr></table></figure>

<p><strong>所有变量都会被注入到 Node.js 的</strong> <strong><code>process.env</code></strong> 中**（<code>process</code> 是 Node.js 的全局对象，所以仅在服务端生效）</p>
<blockquote>
<p>插播：<strong>Node.js 的 process.env 是个啥</strong></p>
<p>  就是一个普通的 JS 对象，而 <code>env</code> 它是 <code>process</code> 的一个属性，专门存环境变量</p>
<p>  它大概是这样的👇</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(process.env);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    NODE_ENV: &#x27;development&#x27;,</span><br><span class="line">    PORT: &#x27;3000&#x27;,</span><br><span class="line">    DATABASE_URL: &#x27;postgresql://localhost:5432/mydb&#x27;,</span><br><span class="line">    VITE_API_URL: &#x27;https://dev-api.example.com&#x27;,</span><br><span class="line">    SECRET_KEY: &#x27;abcdefg123456&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  你可以把它看成 <strong>NodeJS</strong> 的备忘录，存着环境，端口，接口，密钥等数据</p>
</blockquote>
<p>好了现在回归正题</p>
<blockquote>
<p>比如我在某文件需要知道这些参数来判断当前的运行环境👇（我在build脚本文件用的最多）</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isProd = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span> <span class="comment">// 生产环境</span></span><br><span class="line"><span class="keyword">const</span> isDev = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span> <span class="comment">// 开发环境</span></span><br><span class="line"><span class="keyword">const</span> isTest = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;test&#x27;</span> <span class="comment">// 测试环境</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">terser</span>(&#123; <span class="comment">// 压缩JS的插件</span></span><br><span class="line">        <span class="attr">compress</span>: &#123;</span><br><span class="line">            <span class="attr">sequences</span>: isProd, <span class="comment">// 生产环境下删除连续语句</span></span><br><span class="line">            <span class="attr">arguments</span>: isProd, <span class="comment">// 生产环境下删除函数参数</span></span><br><span class="line">            <span class="attr">drop_console</span>: isProd &amp;&amp; [<span class="string">&#x27;log&#x27;</span>], <span class="comment">// 生产环境下删除 console.log 语句</span></span><br><span class="line">            <span class="attr">drop_debugger</span>: isProd, <span class="comment">// 生产环境下删除 debugger 语句</span></span><br><span class="line">            <span class="attr">passes</span>: isProd ? <span class="number">4</span> : <span class="number">1</span>, <span class="comment">// 生产环境下进行 4 次压缩，开发环境下进行 1 次压缩</span></span><br><span class="line">            <span class="attr">global_defs</span>: &#123; <span class="comment">// 定义全局变量，用于在压缩代码时进行条件编译</span></span><br><span class="line">                <span class="string">&#x27;@DEV&#x27;</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(isDev),</span><br><span class="line">                <span class="string">&#x27;@PROD&#x27;</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(isProd),</span><br><span class="line">                <span class="string">&#x27;@TEST&#x27;</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(isTest),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        ......</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p><strong>但是！这些变量不能暴露给浏览器</strong>，不然任何访问你网站的人F12就能看到数据库密码、API 秘钥等……</p>
<h3 id="过滤出-VITE-开头的变量"><a href="#过滤出-VITE-开头的变量" class="headerlink" title="过滤出 VITE_ 开头的变量"></a>过滤出 VITE_ 开头的变量</h3><blockquote>
<p>只有以 <code>VITE_</code> 为前缀的变量才会通过 <code>import.meta.env</code> 暴露给你的客户端源码 （看上面的例子，比如是 <code>VITE_API_URL</code>）</p>
<p>  （Vite 内部会对此做筛选，类似于以下这样）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> clientEnv = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(process.<span class="property">env</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.<span class="title function_">startsWith</span>(<span class="string">&#x27;VITE_&#x27;</span>)) &#123;</span><br><span class="line">        clientEnv[key] = value  <span class="comment">// 只保留 VITE_ 开头的</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  然后，Vite 把这个 <code>clientEnv</code> 对象注入到前端代码中，变成</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">env</span>.<span class="property">VITE_API_URL</span>  <span class="comment">// 可访问</span></span><br><span class="line"><span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">env</span>.<span class="property">DB_PASSWORD</span>   <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure></blockquote>
<h3 id="注入import-meta-env到客户端"><a href="#注入import-meta-env到客户端" class="headerlink" title="注入import.meta.env到客户端"></a>注入import.meta.env到客户端</h3><blockquote>
<p><code>import.meta.env</code> 就是由 <code>process.env</code> 筛出来的，所以和 <code>process.env</code> 一样，<code>import.meta.env</code> 作为<strong>客户端</strong>的备忘录</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>对比</td>
<td><code>process.env</code></td>
<td><code>import.meta.env</code></td>
</tr>
<tr>
<td><strong>运行环境</strong></td>
<td>Node.js（服务端）</td>
<td>浏览器（客户端）</td>
</tr>
<tr>
<td><strong>使用位置</strong></td>
<td>Vite 服务器、构建脚本</td>
<td>Vue&#x2F;React 组件</td>
</tr>
<tr>
<td><strong>值定义在</strong></td>
<td><code>.env</code> 文件 + 操作系统</td>
<td>Vite 筛选并注入</td>
</tr>
<tr>
<td><strong>变量范围</strong></td>
<td>所有变量</td>
<td>只能访问 <code>VITE_</code> 开头的</td>
</tr>
</tbody></table>
<h2 id="配置解析与合并"><a href="#配置解析与合并" class="headerlink" title="配置解析与合并"></a>配置解析与合并</h2><blockquote>
<p>回归主线，处理完环境变量，下一步就是合并配置</p>
</blockquote>
<p>Vite 会<strong>合并&amp;处理以下的配置</strong>，<strong>生成最终的构建配置对象</strong></p>
<h3 id="命令行（CLI）"><a href="#命令行（CLI）" class="headerlink" title="命令行（CLI）"></a>命令行（CLI）</h3><p>项目设置的<strong>命令行参数</strong>（优先级最高）</p>
<p>例如 <code>vite --port 5000 --open --host</code>，Vite 会把这些建议解析成一个对象：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cliOptions = &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">5000</span>,</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">host</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="defineConfig"><a href="#defineConfig" class="headerlink" title="defineConfig"></a>defineConfig</h3><p>Vite 读取并执行 vite.config.ts，获取导出的 <strong><code>defineConfig</code></strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [<span class="title function_">vue</span>()],</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">        <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">        <span class="attr">open</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>结果也就是</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> configFromFile = &#123;</span><br><span class="line">    <span class="attr">plugins</span>: [vuePlugin],</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">        <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">        <span class="attr">open</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h3><p>Vite 会把<strong>两者合并</strong>，<strong>CLI 优先级更高</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mergedConfig = &#123;</span><br><span class="line">    <span class="attr">plugins</span>: [vuePlugin],</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">        <span class="attr">port</span>: <span class="number">5000</span>,</span><br><span class="line">        <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">host</span>: <span class="literal">true</span> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="config-钩子"><a href="#config-钩子" class="headerlink" title="config 钩子"></a>config 钩子</h3><p>在最终配置确定前，插件可以通过插件的 <code>config</code> 钩子修改配置（和 <code>axios</code> 的二次封装是一个道理，会合并你的配置）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义插件</span></span><br><span class="line"><span class="keyword">const</span> myPlugin = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;my-plugin&#x27;</span>,</span><br><span class="line">    <span class="title function_">config</span>(<span class="params">config, env</span>) &#123; <span class="comment">// config 钩子；config 已经是当前合并后的配置；env 就是之前说的备忘录（process.env）</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前 mode:&#x27;</span>, env.<span class="property">mode</span>) <span class="comment">// &#x27;development&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="comment">// 修改配置（二次封装）</span></span><br><span class="line">            <span class="attr">server</span>: &#123;</span><br><span class="line">                ...config.<span class="property">server</span>, <span class="comment">// 展开已有 server 配置</span></span><br><span class="line">                <span class="attr">proxy</span>: &#123; <span class="comment">// 新增 proxy</span></span><br><span class="line">                    <span class="string">&#x27;/api&#x27;</span>: <span class="string">&#x27;http://localhost:8080&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">define</span>: &#123; <span class="comment">// 新增全局常量</span></span><br><span class="line">                <span class="attr">__MY_APP_VERSION__</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;1.0.0&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置结果是</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> afterPluginConfig = &#123;</span><br><span class="line">    <span class="attr">plugins</span>: [vuePlugin],</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">        <span class="attr">port</span>: <span class="number">5000</span>,</span><br><span class="line">        <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">host</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">proxy</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;/api&#x27;</span>: <span class="string">&#x27;http://localhost:8080&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">define</span>: &#123;</span><br><span class="line">        <span class="attr">__MY_APP_VERSION__</span>: <span class="string">&#x27;&quot;1.0.0&quot;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>并且这个最终的配置对象会被<strong>冻结（frozen）</strong>，防止后续被修改</p>
</blockquote>
<h3 id="configResolved-钩子"><a href="#configResolved-钩子" class="headerlink" title="configResolved 钩子"></a>configResolved 钩子</h3><p>在配置确定后，插件可以根据插件的 <code>configResolved</code> 钩子读取存储最终解析的配置（只读）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myPlugin = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;my-plugin&#x27;</span>,</span><br><span class="line">    <span class="title function_">config</span>(<span class="params">config, env</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;当前 mode:&#x27;</span>, env.<span class="property">mode</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">server</span>: &#123;</span><br><span class="line">                ...config.<span class="property">server</span>,</span><br><span class="line">                <span class="attr">proxy</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;/api&#x27;</span>: <span class="string">&#x27;http://localhost:8080&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">define</span>: &#123;</span><br><span class="line">                <span class="attr">__MY_APP_VERSION__</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="string">&#x27;1.0.0&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">configResolved</span>(<span class="params">resolvedConfig</span>) &#123; <span class="comment">// configResolved 钩子（只读）；resolvedConfig 就是最终确定的配置</span></span><br><span class="line">        <span class="keyword">const</span> &#123; server, define, plugins &#125; = resolvedConfig <span class="comment">// 解构赋值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (server.<span class="property">port</span> === <span class="number">5000</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;服务器在 5000 端口启动&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (define.<span class="property">__MY_APP_VERSION__</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">version</span> = define.<span class="property">__MY_APP_VERSION__</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不能修改</span></span><br><span class="line">        <span class="comment">// resolvedConfig.server.port = 6000 // 无效</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="插件系统初始化与构建"><a href="#插件系统初始化与构建" class="headerlink" title="插件系统初始化与构建"></a>插件系统初始化与构建</h2><p><strong>Vite 的功能几乎都由插件提供</strong>（包括内置插件）</p>
<p>而这些插件就会涉及到<strong>排序先行</strong>的问题，vite内部规定了什么插件应该优先执行解析</p>
<h3 id="插件排序"><a href="#插件排序" class="headerlink" title="插件排序"></a>插件排序</h3><h4 id="排序逻辑"><a href="#排序逻辑" class="headerlink" title="排序逻辑"></a>排序逻辑</h4><p>插件会根据 <code>enforce</code> 属性排序执行</p>
<ul>
<li><p><strong><code>enforce: &#39;pre&#39;</code></strong>：在 Vite <strong>核心插件之前</strong>调用【<em>代码转换插件，别名处理插件 …</em>】</p>
  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> react <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-react&#x27;</span> <span class="comment">// 作用：解析别名、代码转换、重写导入路径</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">react</span>() <span class="comment">// 内部 enforce: &#x27;pre&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>    &gt; <code>.jsx</code> 文件需要先转成 <code>.js</code> 文件 Vite 核心才能识别，<code>react</code> 要确保在 <code>.jsx</code> 文件被解析前先处理 JSX 语法</p>
</li>
<li><p><strong>无</strong> <code>enforce**</code>（默认）：在 Vite <strong>核心插件之后</strong>调用【<em>大多数插件 …</em>】</p>
  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span> <span class="comment">// 作用：把&lt;template&gt;编译成render函数、提取&lt;script&gt;、注入HMR代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">vue</span>() <span class="comment">// 默认顺序，无 enforce</span></span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>    &gt; 因为它处理的是已经被分好的单 <code>.vue</code> 文件子请求，必须在核心插件之后</p>
</li>
<li><p><strong><code>enforce: &#39;post&#39;</code></strong>：在 Vite <strong>构建插件之后</strong>调用【<em>打包后处理插件，生成报告插件 …</em>】</p>
  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; visualizer &#125; <span class="keyword">from</span> <span class="string">&#x27;rollup-plugin-visualizer&#x27;</span> <span class="comment">// 作用：打包后处理（压缩、混淆等）、生成报告</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">vue</span>(),</span><br><span class="line">        <span class="title function_">visualizer</span>(&#123;</span><br><span class="line">            <span class="attr">open</span>: <span class="literal">true</span></span><br><span class="line">        &#125;) <span class="comment">// 默认 enforce: &#x27;post&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>    &gt; <code>visualizer</code> 插件需要等所有代码打包完成后，才能分析最终的 bundle 大小</p>
</li>
</ul>
<blockquote>
<p>这一块由于加了细节写的有点乱，可以先看看下面的 总结</p>
</blockquote>
<h4 id="指定模式"><a href="#指定模式" class="headerlink" title="指定模式"></a>指定模式</h4><p>插件还可以通过 <code>apply</code> 指定只在特定模式下生效</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apply</span>: <span class="string">&#x27;serve&#x27;</span>     <span class="comment">// 只在开发模式（dev）启用</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mockPlugin = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;vite-plugin-mock&#x27;</span>,</span><br><span class="line">    <span class="attr">apply</span>: <span class="string">&#x27;serve&#x27;</span>, <span class="comment">// 只在 pnpm dev 时生效</span></span><br><span class="line">    <span class="title function_">configureServer</span>(<span class="params">server</span>) &#123;</span><br><span class="line">        <span class="comment">// 在开发服务器上注册 mock 接口</span></span><br><span class="line">        server.<span class="property">middlewares</span>.<span class="title function_">use</span>(<span class="string">&#x27;/api/users&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">            res.<span class="title function_">end</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>([&#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span> &#125;]))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apply</span>: <span class="string">&#x27;build&#x27;</span>     <span class="comment">// 只在构建模式启用</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compressPlugin = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;vite-plugin-compress&#x27;</span>,</span><br><span class="line">    <span class="attr">apply</span>: <span class="string">&#x27;build&#x27;</span>, <span class="comment">// 只在 pnpm build 时生效</span></span><br><span class="line">    <span class="title function_">closeBundle</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 构建完成后，对 dist 目录进行 gzip 压缩</span></span><br><span class="line">        <span class="title function_">execSync</span>(<span class="string">&#x27;gzip -r dist/&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>类型</td>
<td><code>enforce</code></td>
<td>典型用途</td>
<td>真实例子</td>
</tr>
<tr>
<td>预处理</td>
<td><code>&#39;pre&#39;</code></td>
<td>路径解析、语法转换</td>
<td><code>@vitejs/plugin-react</code></td>
</tr>
<tr>
<td>普通处理</td>
<td>默认</td>
<td>组件编译、资源处理</td>
<td><code>@vitejs/plugin-vue</code></td>
</tr>
<tr>
<td>后处理</td>
<td><code>&#39;post&#39;</code></td>
<td>打包分析、压缩</td>
<td><code>rollup-plugin-visualizer</code></td>
</tr>
<tr>
<td>模式控制</td>
<td><code>apply: &#39;serve&#39;</code></td>
<td>开发专用功能</td>
<td>Mock 插件</td>
</tr>
<tr>
<td>模式控制</td>
<td><code>apply: &#39;build&#39;</code></td>
<td>构建优化</td>
<td>Gzip 压缩插件</td>
</tr>
</tbody></table>
<h2 id="依赖预构建"><a href="#依赖预构建" class="headerlink" title="依赖预构建"></a>依赖预构建</h2><p>Vite 的开发服务器基于 <strong>ESModule</strong>，实现了真正的按需编译，但很多 npm 包还是 CommonJS（CJS）格式</p>
<p>为了解决兼容性和性能问题，vite 会进行<strong>依赖预构建</strong>，主要是为了优化👇</p>
<ul>
<li><p><strong>兼容性</strong>：将 CommonJS 或 UMD 格式的依赖项转换为 ESM 格式，以便在浏览器中通过 <code>&lt;script type=&quot;module&quot;&gt;</code> 正常加载</p>
</li>
<li><p><strong>性能</strong>：将有许多内部模块的 ESM 依赖项（如 lodash-es）转换为单个模块，减少浏览器需要发出的 HTTP 请求数</p>
</li>
</ul>
<p><strong>预构建后的依赖会被缓存到</strong> <strong><code>node_modules/.vite</code></strong> <strong>目录下</strong></p>
<blockquote>
<p>这是 vite 启动快的一个原因，它只处理你自己写的代码，依赖项已经“预打包”好了</p>
</blockquote>
<h2 id="建立开发服务器"><a href="#建立开发服务器" class="headerlink" title="建立开发服务器"></a>建立开发服务器</h2><blockquote>
<p>Vite 使用 <strong>Connect</strong> 作为底层框架，创建一个开发服务器</p>
</blockquote>
<p>启用功能：</p>
<ul>
<li><p>监听指定端口（如 <code>localhost:3000</code>）</p>
</li>
<li><p>处理所有静态资源请求（HTML、JS、CSS、图片等）</p>
</li>
<li><p>启动 <strong>WebSocket</strong>，用于 HMR（热更新）</p>
  <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码</span></span><br><span class="line"><span class="keyword">const</span> server =  <span class="title function_">connect</span>()</span><br><span class="line">server.<span class="title function_">use</span>(<span class="title function_">serveStatic</span>())</span><br><span class="line">server.<span class="title function_">use</span>(handleModuleRequest) <span class="comment">// 处理 .vue, .ts 等</span></span><br><span class="line"><span class="title function_">createWebSocketServer</span>() <span class="comment">// 用于 HMR</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="注入中间件"><a href="#注入中间件" class="headerlink" title="注入中间件"></a>注入中间件</h2><h3 id="什么是中间件"><a href="#什么是中间件" class="headerlink" title="什么是中间件"></a>什么是中间件</h3><blockquote>
<p>中间件就是在 <code>浏览器</code> 向 <code>vite</code> 请求文件过程中的 ”<strong>中间检查站</strong>“</p>
<p>  一个中间件就是一个函数，类似于这种👇</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">myMiddleware</span>(<span class="params">req, res, next</span>) &#123; <span class="comment">// 请求对象，相应对象，放行函数</span></span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">url</span> === <span class="string">&#x27;/hello&#x27;</span>) &#123; <span class="comment">// 不调用 next()，相当于直接拦截</span></span><br><span class="line">        res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span> &#125;)</span><br><span class="line">        res.<span class="title function_">end</span>(<span class="string">&#x27;Hello from middleware!&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>() <span class="comment">// 放行，继续后续处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote>
<p>Vite 的开发服务器底层基于 <strong>Connect</strong>（一个轻量级 Node.js 框架），而 Connect 的核心就是中间件机制</p>
<p>它的结构就像这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">浏览器请求</span><br><span class="line">     ↓</span><br><span class="line">[插件注册的中间件 1] → Mock 接口拦截 /api/*</span><br><span class="line">     ↓</span><br><span class="line">[插件注册的中间件 2] → React JSX 转换</span><br><span class="line">     ↓</span><br><span class="line">[插件注册的中间件 3] → 静态资源重定向</span><br><span class="line">     ↓</span><br><span class="line">……（其他插件中间件）</span><br><span class="line">     ↓</span><br><span class="line">[Vite 核心中间件]</span><br><span class="line">     ├── 1. HTML 处理中间件</span><br><span class="line">     ├── 2. 静态资源服务中间件</span><br><span class="line">     ├── 3. 模块请求处理中间件（核心！）</span><br><span class="line">     ├── 4. HMR WebSocket 中间件</span><br><span class="line">     └── 5. 404 处理中间件</span><br><span class="line">     ↓</span><br><span class="line">返回响应给浏览器</span><br></pre></td></tr></table></figure>

<h3 id="Vite-的操作"><a href="#Vite-的操作" class="headerlink" title="Vite 的操作"></a>Vite 的操作</h3><p>Vite 的规则是 <strong>先注册的插件先执行</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">mockPlugin</span>(), </span><br><span class="line">        <span class="title function_">reactPlugin</span>(), </span><br><span class="line">        <span class="title function_">legacyPlugin</span>(),</span><br><span class="line">        <span class="title function_">myCustomPlugin</span>()</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>插件可以通过 <strong><code>configureServer</code></strong> 钩子**（插件开发者已定义好）向 Vite 的服务器注册自己的中间件</p>
<blockquote>
<p>比如 mock 插件</p>
<p>效果：当你在浏览器访问 <code>/api/users</code>，根本不会去请求后端，而是直接返回 mock 数据</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mockPlugin = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;vite-plugin-mock&#x27;</span>,</span><br><span class="line">    <span class="title function_">configureServer</span>(<span class="params">server</span>) &#123; <span class="comment">// 向 Vite 的服务器注册 server</span></span><br><span class="line">        <span class="comment">// 有人请求了 /api/users</span></span><br><span class="line">        server.<span class="property">middlewares</span>.<span class="title function_">use</span>(<span class="string">&#x27;/api/users&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123; <span class="comment">// middlewares 是 Connect 的中间件容器</span></span><br><span class="line">            res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;)</span><br><span class="line">            res.<span class="title function_">end</span>(</span><br><span class="line">                <span class="title class_">JSON</span>.<span class="title function_">stringify</span>([</span><br><span class="line">                    &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">&#x27;Alice&#x27;</span> &#125;,</span><br><span class="line">                    &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">&#x27;Bob&#x27;</span> &#125;</span><br><span class="line">                ])</span><br><span class="line">            )</span><br><span class="line">            <span class="comment">// 没有 next()，请求被拦截</span></span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 或是记录日志，不做操作</span></span><br><span class="line">        server.<span class="property">middlewares</span>.<span class="title function_">use</span>(<span class="string">&#x27;/api/*&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;拦截所有 /api/ 开头的请求&#x27;</span>)</span><br><span class="line">            <span class="title function_">next</span>() <span class="comment">// 放行，交给下一个处理</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>⚠️ 如果你在<strong>中间件里 <strong><code>return</code></strong> 了响应</strong>（比如 mock 数据），<strong>后面的中间件</strong>（包括 Vite 核心）就<strong>不会执行</strong></p>
</blockquote>
<h2 id="请求处理（核心）"><a href="#请求处理（核心）" class="headerlink" title="请求处理（核心）"></a>请求处理（核心）</h2><p>当浏览器请求一个文件（如 <code>App.vue</code>）时，Vite 不是简单地返回文件内容，而是通过 <strong>插件系统动态转换</strong>，最终<strong>返回一段可执行的 JS</strong> 模块。而这个过程会<strong>产生对子资源的额外请求</strong>，这是理解 Vite 处理 <code>.vue</code> 文件的关键</p>
<h3 id="请求拦截"><a href="#请求拦截" class="headerlink" title="请求拦截"></a>请求拦截</h3><p><strong>浏览器发起：****<code>GET /src/App.vue</code></strong></p>
<p>Vite 的开发服务器拦截该请求，不直接读取文件返回，而是 <strong>开启模块解析和转换流程</strong></p>
<h3 id="插件流水线执行（核心）"><a href="#插件流水线执行（核心）" class="headerlink" title="插件流水线执行（核心）"></a>插件流水线执行（核心）</h3><p>Vite 通过 Rollup 风格的插件接口，依次调用注册的插件钩子，顺序如下：</p>
<h4 id="resolveId-specifier"><a href="#resolveId-specifier" class="headerlink" title="resolveId(specifier)"></a><code>resolveId</code>(specifier)</h4><p><em>解析模块依赖关系时（如</em> <code>import &#39;./App.vue&#39;</code><em>）</em></p>
<p>调用插件的 <code>resolveId</code> 钩子，<strong>确定</strong> <code>&#39;./App.vue&#39;</code> 对应的<strong>真实路径</strong>（如 <code>/project/src/App.vue</code>）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vite 内部调用</span></span><br><span class="line"><span class="keyword">const</span> resolved = <span class="keyword">await</span> pluginContainer.<span class="title function_">resolveId</span>(<span class="string">&#x27;./App.vue&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="load-id"><a href="#load-id" class="headerlink" title="load(id)"></a><code>load</code>(id)</h4><p><em>模块路径解析后</em></p>
<p>需要读取原始内容，调用插件的 <code>load</code> 钩子，<strong>获取文件原始字符串</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vite 内部调用</span></span><br><span class="line"><span class="keyword">const</span> code = <span class="keyword">await</span> pluginContainer.<span class="title function_">load</span>(<span class="string">&#x27;/project/src/App.vue&#x27;</span>)</span><br><span class="line"><span class="comment">// 返回：&#x27;&lt;script&gt;...&lt;\/script&gt;&lt;template&gt;...&lt;\/template&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="transform-code-id"><a href="#transform-code-id" class="headerlink" title="transform(code, id)"></a><code>transform</code>(code, id)</h4><p><em>当对加载的原始内容进行转换时</em></p>
<p>将 <code>code</code> 和 <code>id</code> 传给所有插件的 <code>transform</code> 钩子，<strong>按顺序执行转换</strong></p>
<blockquote>
<p><strong>Vite不自己转换</strong> <strong><code>.vue</code></strong> 文件，这里是把 <strong><code>code</code></strong> 交给 <strong><code>@vitejs/plugin-vue</code></strong> <strong>插件处理</strong></p>
<p>注：<code>@vitejs/plugin-vue</code> 在 <code>transform</code> 阶段会自动注入 HMR 支持</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vite 内部调用</span></span><br><span class="line"><span class="keyword">let</span> result = code <span class="comment">// 你的代码</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> plugins) &#123;</span><br><span class="line">    <span class="keyword">if</span> (plugin.<span class="property">transform</span>) &#123;</span><br><span class="line">        result = <span class="keyword">await</span> plugin.<span class="title function_">transform</span>(result, id)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当 <code>@vitejs/plugin-vue</code> 插件发现 <code>id</code> 是 <code>.vue</code> 文件时，就会介入处理</p>
</blockquote>
<h3 id="处理子资源请求"><a href="#处理子资源请求" class="headerlink" title="处理子资源请求"></a>处理子资源请求</h3><blockquote>
<p><code>vue</code> 文件内部还有分块，也就是 <code>template</code>，<code>script</code>，<code>style</code></p>
</blockquote>
<p><strong>浏览器继续发起请求：****<code>GET /src/App.vue?type=template</code></strong></p>
<p>Vite 再次拦截这个请求，并重复之前的流程</p>
<h4 id="resolveId-specifier-1"><a href="#resolveId-specifier-1" class="headerlink" title="resolveId(specifier)"></a><code>resolveId</code>(specifier)</h4><p>插件（<code>@vitejs/plugin-vue</code>）识别到 <code>?type=template</code>，将其标记为一个虚拟模块，返回原样或特殊标识<code>load</code>(id)</p>
<h4 id="load-id-1"><a href="#load-id-1" class="headerlink" title="load(id)"></a><code>load</code>(id)</h4><p>可能返回空字符串，或不调用（某些插件直接在 <code>transform</code> 处理）</p>
<h4 id="transform-code-id-1"><a href="#transform-code-id-1" class="headerlink" title="transform(code, id)"></a><code>transform</code>(code, id)</h4><blockquote>
<p>当 <code>@vitejs/plugin-vue</code> 插件发现特殊标识id，就知道这是模板请求</p>
<p>会使用 <code>@vue/compiler-dom</code> 将模板编译为 <code>render</code> 函数（这是vue插件的功能）</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回给浏览器的内容</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> render = <span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">_ctx, _cache</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="title function_">_openBlock</span>(), <span class="title function_">_createBlock</span>(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">        <span class="title function_">_createTextVNode</span>(<span class="string">&quot;Count: &quot;</span> + <span class="title function_">_toDisplayString</span>(_ctx.<span class="property">count</span>), <span class="number">1</span>)</span><br><span class="line">    ]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="流程总结"><a href="#流程总结" class="headerlink" title="流程总结"></a>流程总结</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">浏览器</span><br><span class="line">   ↓ GET /src/App.vue</span><br><span class="line">Vite 服务器</span><br><span class="line">   ↓ 调用 resolveId → load → transform</span><br><span class="line">@vitejs/plugin-vue 转换：返回 JS，包含 import &#x27;./?type=template&#x27;</span><br><span class="line">   ↓ 浏览器解析 JS，发现新 import</span><br><span class="line">浏览器</span><br><span class="line">   ↓ GET /src/App.vue?type=template</span><br><span class="line">Vite 服务器</span><br><span class="line">   ↓ 再次 resolveId / transform</span><br><span class="line">@vitejs/plugin-vue：提取模板，编译为 render 函数</span><br><span class="line">   ↓ 返回 render 函数代码</span><br><span class="line">浏览器：组件加载完成</span><br></pre></td></tr></table></figure>

<h2 id="热模块更新"><a href="#热模块更新" class="headerlink" title="热模块更新"></a>热模块更新</h2><p>Vite 最大的特点就是拥有极快的热更新（HMR），Vite的热更新本质是 <strong>在运行时动态替换模块代码</strong></p>
<p>更新主要包含以下过程</p>
<h3 id="服务器感知"><a href="#服务器感知" class="headerlink" title="服务器感知"></a>服务器感知</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> watcher = chokidar.<span class="title function_">watch</span>(root, &#123; ... &#125;) <span class="comment">// Vite 使用 chokidar 监听文件</span></span><br><span class="line"></span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;change&#x27;</span>, <span class="title function_">async</span> (file) =&gt; &#123; <span class="comment">// file: /project/src/App.vue</span></span><br><span class="line">    <span class="keyword">const</span> modules = moduleGraph.<span class="title function_">getModulesByFile</span>(file) <span class="comment">// moduleGraph 是 Vite 内存中的“依赖图”，记录着谁 import 了谁；现在modules代表所有依赖这个file文件的模块</span></span><br><span class="line">    <span class="title function_">updateModules</span>(file, modules) <span class="comment">// 触发更新</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="WebSocket-更新"><a href="#WebSocket-更新" class="headerlink" title="WebSocket 更新"></a>WebSocket 更新</h3><p>Vite 服务器</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateModules</span>(<span class="params">file, modules</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> updates = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> mod <span class="keyword">of</span> modules) &#123;</span><br><span class="line">        updates.<span class="title function_">push</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;update&#x27;</span>,        <span class="comment">// 更新类型</span></span><br><span class="line">            <span class="attr">path</span>: mod.<span class="property">url</span>,         <span class="comment">// 如 /src/App.vue</span></span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ws.<span class="title function_">send</span>(&#123; <span class="comment">// 通过 WebSocket 广播</span></span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;update&#x27;</span>,</span><br><span class="line">        updates</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器端的 <code>vite/client</code> 会监听这个消息</p>
</blockquote>
<h3 id="浏览器（客户端）接收"><a href="#浏览器（客户端）接收" class="headerlink" title="浏览器（客户端）接收"></a>浏览器（客户端）接收</h3><p>vite&#x2F;client 注入的代码</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ws.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>)</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">type</span> === <span class="string">&#x27;update&#x27;</span>) &#123;</span><br><span class="line">        data.<span class="property">updates</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">update</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 发起新的 HTTP 请求，带时间戳防止缓存</span></span><br><span class="line">            <span class="title function_">fetchUpdate</span>(update.<span class="property">path</span>, update.<span class="property">timestamp</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchUpdate</span>(<span class="params">path, timestamp</span>) &#123;</span><br><span class="line">    <span class="comment">// 请求新的模块内容</span></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;path&#125;</span>?t=<span class="subst">$&#123;timestamp&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> code = <span class="keyword">await</span> response.<span class="title function_">text</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个模块对象</span></span><br><span class="line">    <span class="keyword">const</span> mod = &#123;</span><br><span class="line">        <span class="attr">id</span>: path,</span><br><span class="line">        code,</span><br><span class="line">        <span class="attr">getters</span>: [] <span class="comment">// 用于 HMR accept</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 hot.accept</span></span><br><span class="line">    <span class="keyword">const</span> &#123; hot &#125; = <span class="keyword">import</span>.<span class="property">meta</span></span><br><span class="line">    hot.<span class="title function_">accept</span>(path, <span class="function">(<span class="params">newMod</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这里是真正的“热替换”发生的地方</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;模块已更新:&#x27;</span>, path)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="热替换（局部更新）"><a href="#热替换（局部更新）" class="headerlink" title="热替换（局部更新）"></a>热替换（局部更新）</h3><p><strong>这是通过框架（Vue&#x2F;React）的渲染机制实现的</strong></p>
<blockquote>
<p>如果接触过框架源码就可以理解，就是框架内部根据DOM差异实现热替换的diff算法</p>
</blockquote>
<p>所以，<strong>Vite 只负责送新模块</strong>，而局部更新的实现是源于框架渲染机制</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>详情</td>
</tr>
<tr>
<td><strong>pnpm dev</strong></td>
<td>查找 <code>package.json</code> 中 <code>scripts</code> 下的 <code>dev</code> 命令并执行</td>
</tr>
<tr>
<td><strong>执行 vite 命令</strong></td>
<td>调用 Vite 的二进制文件 <code>node_modules/.bin/vite</code>（引连到 Vite 的 CLI 模块 <code>vite/src/node/cli.ts</code>）</td>
</tr>
<tr>
<td><strong>确定 mode</strong></td>
<td>按顺序查找和加载 <code>.env</code>，注入变量到 <code>process.env</code>，过滤变量到 <code>import.meta.env</code>，</td>
</tr>
<tr>
<td><strong>合并插件配置</strong></td>
<td>合并 <code>CLI</code>指令 &amp; <code>vite.config.ts</code>配置，通过<code>config</code>，<code>configResolved</code> 自定义插件</td>
</tr>
<tr>
<td><strong>初始化插件系统</strong></td>
<td>按照 <code>pre</code>、<code>normal</code>、<code>post</code> 排序插件（可通过 <code>apply: &#39;serve&#39;/&#39;build&#39;</code> 指定模式 ）</td>
</tr>
<tr>
<td><strong>启动服务器</strong></td>
<td>创建开发服务器（Koa&#x2F;Connect 实例）</td>
</tr>
<tr>
<td><strong>注册中间件</strong></td>
<td>根据 <code>vite.config.ts/plugin</code> 的顺序，调用所有插件的 <code>configureServer</code> 钩子</td>
</tr>
<tr>
<td><strong>浏览器请求文件</strong></td>
<td>按需 transform（.vue&#x2F;.ts → JS）</td>
</tr>
<tr>
<td><strong>热更新</strong></td>
<td>向浏览器推送新模块，并利用框架机制热替换DOM</td>
</tr>
</tbody></table>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="/img/512.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="/img/512.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Breezli</div><div class="post-copyright__author_desc">“松间听风，忽见灵狸”</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/09/07/%E5%B7%A5%E5%85%B7/Vite%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%8C%E5%90%8E/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/09/07/%E5%B7%A5%E5%85%B7/Vite%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%8C%E5%90%8E/')">pnpm dev 的背后（vite构建）</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2025/09/07/%E5%B7%A5%E5%85%B7/Vite%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%8C%E5%90%8E/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=undefined&amp;url=http://example.com/2025/09/07/%E5%B7%A5%E5%85%B7/Vite%E6%9E%84%E5%BB%BA%E7%9A%84%E8%83%8C%E5%90%8E/&amp;pic=undefined" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">松风狸 | Breezli</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2025/04/03/67ede29ce7fe1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/07/%E5%B7%A5%E5%85%B7/Vercel%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/08/22/68a756bf4717d.png" onerror="onerror=null;src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Vercel 部署服务</div></div></a></div><div class="next-post pull-right"><a href="/2025/10/27/%E6%8A%80%E6%9C%AF%E6%8E%A2%E7%B4%A2/Threejs-%E5%9F%BA%E7%A1%80%E5%9C%BA%E6%99%AF/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/10/27/68ff2174ced1e.png" onerror="onerror=null;src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">基础场景</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="/img/512.png" onerror="this.onerror=null;this.src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://emotion.acs.pw/emotion/QQ/129.gif" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">错位的人格，错位的才情；</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">错位的时代，错位的人生。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">在错误的路口抢夺正确的结果，</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">用虚假的手段寻回真实的自己。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">在诗意，自由的“美丽新世界”。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Breezli</h1><div class="author-info__desc">“松间听风，忽见灵狸”</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/Breezli" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/3546391152429457" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2025/08/09/68973be4ebc88.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2025/08/09/68973be4eca94.png) center center / 100% no-repeat"></div></div></div></div><div class="card-widget card-countdown"><div class="item-headline"><i></i><span></span></div><div class="item-content"><div class="cd-count-left">
  <span class="cd-text">距离</span>
  <span class="cd-name" id="eventName"></span>
  <span class="cd-time" id="daysUntil"></span>
  <span class="cd-date" id="eventDate"></span>
</div>
<div id="countRight" class="cd-count-right"></div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#pnpm-dev-%E6%89%A7%E8%A1%8C%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.</span> <span class="toc-text">pnpm dev (执行启动命令)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A-vite-%E5%90%AF%E5%8A%A8%E6%97%B6%E6%A8%A1%E5%BC%8F%EF%BC%88mode%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">确定 vite 启动时模式（mode）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-env%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">加载.env文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%87%BA-VITE-%E5%BC%80%E5%A4%B4%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.</span> <span class="toc-text">过滤出 VITE_ 开头的变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5import-meta-env%E5%88%B0%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.3.</span> <span class="toc-text">注入import.meta.env到客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E4%B8%8E%E5%90%88%E5%B9%B6"><span class="toc-number">3.</span> <span class="toc-text">配置解析与合并</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%EF%BC%88CLI%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">命令行（CLI）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defineConfig"><span class="toc-number">3.2.</span> <span class="toc-text">defineConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%88%E5%B9%B6"><span class="toc-number">3.3.</span> <span class="toc-text">合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-%E9%92%A9%E5%AD%90"><span class="toc-number">3.4.</span> <span class="toc-text">config 钩子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#configResolved-%E9%92%A9%E5%AD%90"><span class="toc-number">3.5.</span> <span class="toc-text">configResolved 钩子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E6%9E%84%E5%BB%BA"><span class="toc-number">4.</span> <span class="toc-text">插件系统初始化与构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E6%8E%92%E5%BA%8F"><span class="toc-number">4.1.</span> <span class="toc-text">插件排序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E9%80%BB%E8%BE%91"><span class="toc-number">4.1.1.</span> <span class="toc-text">排序逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">指定模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.1.3.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E9%A2%84%E6%9E%84%E5%BB%BA"><span class="toc-number">5.</span> <span class="toc-text">依赖预构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E5%BC%80%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.</span> <span class="toc-text">建立开发服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">注入中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">7.1.</span> <span class="toc-text">什么是中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vite-%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">7.2.</span> <span class="toc-text">Vite 的操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">请求处理（核心）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA"><span class="toc-number">8.1.</span> <span class="toc-text">请求拦截</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%89%A7%E8%A1%8C%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-number">8.2.</span> <span class="toc-text">插件流水线执行（核心）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#resolveId-specifier"><span class="toc-number">8.2.1.</span> <span class="toc-text">resolveId(specifier)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#load-id"><span class="toc-number">8.2.2.</span> <span class="toc-text">load(id)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transform-code-id"><span class="toc-number">8.2.3.</span> <span class="toc-text">transform(code, id)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%AD%90%E8%B5%84%E6%BA%90%E8%AF%B7%E6%B1%82"><span class="toc-number">8.3.</span> <span class="toc-text">处理子资源请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#resolveId-specifier-1"><span class="toc-number">8.3.1.</span> <span class="toc-text">resolveId(specifier)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#load-id-1"><span class="toc-number">8.3.2.</span> <span class="toc-text">load(id)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transform-code-id-1"><span class="toc-number">8.3.3.</span> <span class="toc-text">transform(code, id)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">8.4.</span> <span class="toc-text">流程总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E6%A8%A1%E5%9D%97%E6%9B%B4%E6%96%B0"><span class="toc-number">9.</span> <span class="toc-text">热模块更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%84%9F%E7%9F%A5"><span class="toc-number">9.1.</span> <span class="toc-text">服务器感知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket-%E6%9B%B4%E6%96%B0"><span class="toc-number">9.2.</span> <span class="toc-text">WebSocket 更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89%E6%8E%A5%E6%94%B6"><span class="toc-number">9.3.</span> <span class="toc-text">浏览器（客户端）接收</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E6%9B%BF%E6%8D%A2%EF%BC%88%E5%B1%80%E9%83%A8%E6%9B%B4%E6%96%B0%EF%BC%89"><span class="toc-number">9.4.</span> <span class="toc-text">热替换（局部更新）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number"></span> <span class="toc-text">总结</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E5%B0%8F%E7%BA%A2%E4%B9%A6%E4%B8%80%E9%9D%A2/" title="小红书 10.16 一面 (50min)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/04/03/67ede29ce7fe1.png" onerror="this.onerror=null;this.src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="小红书 10.16 一面 (50min)"/></a><div class="content"><a class="title" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E5%B0%8F%E7%BA%A2%E4%B9%A6%E4%B8%80%E9%9D%A2/" title="小红书 10.16 一面 (50min)">小红书 10.16 一面 (50min)</a><time datetime="2025-10-27T07:57:48.198Z" title="发表于 2025-10-27 15:57:48">2025-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E7%BE%8E%E5%9B%A2%E4%B8%80%E9%9D%A2/" title="美团 10.14 一面 (1h)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/04/03/67ede29ce7fe1.png" onerror="this.onerror=null;this.src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="美团 10.14 一面 (1h)"/></a><div class="content"><a class="title" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E7%BE%8E%E5%9B%A2%E4%B8%80%E9%9D%A2/" title="美团 10.14 一面 (1h)">美团 10.14 一面 (1h)</a><time datetime="2025-10-27T07:57:25.140Z" title="发表于 2025-10-27 15:57:25">2025-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E7%99%BE%E5%BA%A6%E4%BA%8C%E9%9D%A2/" title="百度 9.30 二面 (35min)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/04/03/67ede29ce7fe1.png" onerror="this.onerror=null;this.src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="百度 9.30 二面 (35min)"/></a><div class="content"><a class="title" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E7%99%BE%E5%BA%A6%E4%BA%8C%E9%9D%A2/" title="百度 9.30 二面 (35min)">百度 9.30 二面 (35min)</a><time datetime="2025-10-27T07:57:15.094Z" title="发表于 2025-10-27 15:57:15">2025-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E7%99%BE%E5%BA%A6%E4%B8%80%E9%9D%A2/" title="百度 9.20 一面 (1h)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/04/03/67ede29ce7fe1.png" onerror="this.onerror=null;this.src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="百度 9.20 一面 (1h)"/></a><div class="content"><a class="title" href="/2025/10/27/%E9%9D%A2%E7%BB%8F/2025%E7%99%BE%E5%BA%A6%E4%B8%80%E9%9D%A2/" title="百度 9.20 一面 (1h)">百度 9.20 一面 (1h)</a><time datetime="2025-10-27T07:56:52.003Z" title="发表于 2025-10-27 15:56:52">2025-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/27/%E6%8A%80%E6%9C%AF%E6%8E%A2%E7%B4%A2/Electron%E5%8E%9F%E7%90%86/" title="Electron 基础原理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://bu.dusays.com/2025/03/05/67c7e99f9aef7.png" onerror="this.onerror=null;this.src='https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif'" alt="Electron 基础原理"/></a><div class="content"><a class="title" href="/2025/10/27/%E6%8A%80%E6%9C%AF%E6%8E%A2%E7%B4%A2/Electron%E5%8E%9F%E7%90%86/" title="Electron 基础原理">Electron 基础原理</a><time datetime="2025-10-27T07:51:25.160Z" title="发表于 2025-10-27 15:51:25">2025-10-27</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 By <a class="footer-bar-link" href="/" title="Breezli" target="_blank">Breezli</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  if (true) { 
    window.typed = new Typed("#footer-type-tips", {
      strings: ["总思念，紫竹萧萧月如钩，溪光摇荡屋如舟","思念那，青山在，绿水流。","-----","花繁一瞬，形色浮云","撇去眼前浮云，方得心之自由。","-----","即使最后归于空寂","过程之间的有情","也同样动容。","-----"],
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50
    })
  } else {
    document.getElementById("footer-type-tips").innerHTML = '总思念，紫竹萧萧月如钩，溪光摇荡屋如舟'
  }
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">81</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">使用</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://docs.anheyu.com/" title="安知鱼主题"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://docs.anheyu.com/favicon.ico" alt="安知鱼主题"/><span class="back-menu-item-text">安知鱼主题</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://7bu.top/" title="去不图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;https://bu.dusays.com/2025/03/05/67c7f047dfa72.gif&quot;" data-lazy-src="https://7bu.top/favicon.ico" alt="去不图床"/><span class="back-menu-item-text">去不图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/?id=13242559326&amp;server=netease"><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/charts/"><i class="anzhiyufont anzhiyu-icon-cube faa-tada" style="font-size: 0.9em;"></i><span> 统计</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 梦境</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-plant-fill faa-tada" style="font-size: 0.9em;"></i><span> 簪花人间</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/cinema/"><i class="anzhiyufont anzhiyu-icon-book faa-tada" style="font-size: 0.9em;"></i><span> 匣中秋水</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/gallerygroup/"><i class="anzhiyufont anzhiyu-icon-instagram faa-tada" style="font-size: 0.9em;"></i><span> 彩云霁月</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 社交</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-rocket faa-tada" style="font-size: 0.9em;"></i><span> 游戏</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="13242559326" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.5"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=13242559326&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>var meting_api = "https://meting.qjqq.cn/?server=:server&type=:type&id=:id&auth=:auth&r=:r";
</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  //- const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  const grt = new Date("2025-3-1");
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);

  const ascll = [
    `   原来我这几十年的岁月，不过只是这样一个简单的故事.`,
    `
                                                                         
██████╗ ██████╗ ███████╗███████╗███████╗██╗     ██╗
██╔══██╗██╔══██╗██╔════╝██╔════╝╚══███╔╝██║     ██║
██████╔╝██████╔╝█████╗  █████╗    ███╔╝ ██║     ██║
██╔══██╗██╔══██╗██╔══╝  ██╔══╝   ███╔╝  ██║     ██║
██████╔╝██║  ██║███████╗███████╗███████╗███████╗██║
╚═════╝ ╚═╝  ╚═╝╚══════╝╚══════╝╚══════╝╚══════╝╚═╝

    `,
    "   已上线", dnum, "天",
    "©2025 By 松风狸 V1.6.14",
  ];

  setTimeout(
    Log.bind(
      console,
      "%c ⚡ %c 你正在访问 Breezli 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}%c\n`,
      "color:#ffb07c",
      "color:#ffb07c",
      "color:#ffb07c",
      "color:#ffb07c",
      "color:#ffb07c",
      "color:#ffb07c",
      "color:#425AEF"
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好,旅行客。", "color:white; background-color:#4f90d9", ""));
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script type="text/javascript" src="https://player.dogecloud.com/js/loader"></script><script src="/countdown/countdown.js" defer></script><script src="https://cdn.bootcdn.net/ajax/libs/echarts/4.9.0-rc.1/echarts.min.js" defer></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>